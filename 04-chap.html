<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Mixture Models – Modern Statistics for Modern Biology</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./imgs/msmb-favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-af5ec82acda093b5ee751184164e9432.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-d63985d606c7f07261ad561a6cfde940.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="msmb.css">
<meta property="og:title" content="4&nbsp; Mixture Models – Modern Statistics for Modern Biology">
<meta property="og:description" content="If you are a biologist and want to get the best out of the powerful methods of modern computational statistics, this is your book.">
<meta property="og:image" content="https://www.huber.embl.de/msmb/imgs/MSFMB-Cover2-cropped.jpg">
<meta property="og:site_name" content="Modern Statistics for Modern Biology">
<meta name="twitter:title" content="4&nbsp; Mixture Models – Modern Statistics for Modern Biology">
<meta name="twitter:description" content="If you are a biologist and want to get the best out of the powerful methods of modern computational statistics, this is your book.">
<meta name="twitter:image" content="https://www.huber.embl.de/msmb/imgs/MSFMB-Cover2-cropped.jpg">
<meta name="twitter:card" content="summary">
<script type="text/javascript">
  var _paq = _paq || [];
  
  // Call disableCookies before calling trackPageView 
  _paq.push(['disableCookies']);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u='//tr-denbi.embl.de/heimdall/';
    _paq.push(['setTrackerUrl', u+'p.php']);
    _paq.push(['setSiteId', '26']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'p.js'; s.parentNode.insertBefore(g,s);
  })();
</script>

</head>

<body class="floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Modern Statistics for Modern Biology</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-chapters" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Chapters</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-chapters">    
        <li>
    <a class="dropdown-item" href="./index.html">
 <span class="dropdown-text">Home</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./00-chap.html">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./01-chap.html">
 <span class="dropdown-text">Generative Models for Discrete Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02-chap.html">
 <span class="dropdown-text">Statistical Modeling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03-chap.html">
 <span class="dropdown-text">Data visualization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04-chap.html">
 <span class="dropdown-text">Mixture Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05-chap.html">
 <span class="dropdown-text">Clustering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06-chap.html">
 <span class="dropdown-text">Testing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07-chap.html">
 <span class="dropdown-text">Multivariate Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./08-chap.html">
 <span class="dropdown-text">High-Throughput Count Data &amp; Generalized Linear Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09-chap.html">
 <span class="dropdown-text">Multivariate methods for heterogeneous data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10-chap.html">
 <span class="dropdown-text">Networks and Trees</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./11-chap.html">
 <span class="dropdown-text">Image data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./12-chap.html">
 <span class="dropdown-text">Supervised Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./13-chap.html">
 <span class="dropdown-text">Design of High Throughput Experiments and their Analyses</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./14-chap.html">
 <span class="dropdown-text">Statistical Concordance</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./15-chap.html">
 <span class="dropdown-text">Acknowledgements</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./16-chap.html">
 <span class="dropdown-text">References</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sections</h2>
   
  <ul class="collapse">
  <li><a href="#goals-for-this-chapter" id="toc-goals-for-this-chapter" class="nav-link active" data-scroll-target="#goals-for-this-chapter"><span class="header-section-number">4.1</span> Goals for this chapter</a></li>
  <li><a href="#finite-mixtures" id="toc-finite-mixtures" class="nav-link" data-scroll-target="#finite-mixtures"><span class="header-section-number">4.2</span> Finite mixtures</a></li>
  <li><a href="#empirical-distributions-and-the-nonparametric-bootstrap" id="toc-empirical-distributions-and-the-nonparametric-bootstrap" class="nav-link" data-scroll-target="#empirical-distributions-and-the-nonparametric-bootstrap"><span class="header-section-number">4.3</span> Empirical distributions and the nonparametric bootstrap</a></li>
  <li><a href="#infinite-mixtures" id="toc-infinite-mixtures" class="nav-link" data-scroll-target="#infinite-mixtures"><span class="header-section-number">4.4</span> Infinite mixtures</a></li>
  <li><a href="#summary-of-this-chapter" id="toc-summary-of-this-chapter" class="nav-link" data-scroll-target="#summary-of-this-chapter"><span class="header-section-number">4.5</span> Summary of this chapter</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">4.6</span> Further reading</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">4.7</span> Exercises</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-mixtures" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Mixture Models</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/t_distribution.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="imgs/t_distribution.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div></div></div>
<p>One of the main challenges of biological data analysis is dealing with heterogeneity. The quantities we are interested in often do not show a simple, unimodal “textbook distribution”. For example, in the last part of <a href="02-chap.html" class="quarto-xref"><span>Chapter 2</span></a> we saw how the histogram of sequence scores in <a href="02-chap.html#fig-ScoreMixture-1" class="quarto-xref">Figure&nbsp;<span>2.27</span></a> had two separate modes, one for CpG-islands and one for non-islands. We can see the data as a simple mixture of a few (in this case: two) components. We call these <em>finite mixtures</em>. Other mixtures can involve almost as many components as we have observations. These we call <em>infinite mixtures</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;We will see that—as for so many modeling choices–the right complexity of the mixture is in the eye of the beholder and often depends on the amount of data and the resolution and smoothness we want to attain.</p></div></div><p>In <a href="01-chap.html" class="quarto-xref"><span>Chapter 1</span></a> we saw how a simple generative model with a Poisson distribution led us to make useful inference in the detection of an epitope. Unfortunately, a satisfactory fit to real data with such a simple model is often out of reach. However, simple models such as the normal or Poisson distributions can serve as building blocks for more realistic models using the mixing framework that we cover in this chapter. Mixtures occur naturally for flow cytometry data, biometric measurements, RNA-Seq, ChIP-Seq, microbiome and many other types of data collected using modern biotechnologies. In this chapter we will learn from simple examples how to build more realistic models of distributions using mixtures.</p>
<section id="goals-for-this-chapter" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="goals-for-this-chapter"><span class="header-section-number">4.1</span> Goals for this chapter</h2>
<p>In this chapter we will:</p>
<ul>
<li><p>Generate our own mixture model data from distributions composed of two normal populations.</p></li>
<li><p>See how the Expectation-Maximization (EM) algorithm enables us to “reverse engineer” the underlying mixtures in dataset.</p></li>
<li><p>Use a special type of mixture called zero-inflation for data such as ChIP-Seq data that have many extra zeros.</p></li>
<li><p>Discover the empirical cumulative distribution: a special mixture that we can build from observed data. This will enable us to see how we can simulate the variability of our estimates using the bootstrap.</p></li>
<li><p>Build the Laplace distribution as an instance of an infinite mixture model with many components. We will use it to model promoter lengths and microarray intensities.</p></li>
<li><p>Have our first encounter with the gamma-Poisson distribution, a hierarchical model useful for RNA-Seq data. We will see it comes naturally from mixing different Poisson distributed sources.</p></li>
<li><p>See how mixture models enable us to choose data transformations.</p></li>
</ul>
</section>
<section id="finite-mixtures" class="level2 page-columns page-full" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="finite-mixtures"><span class="header-section-number">4.2</span> Finite mixtures</h2>
<section id="simple-examples-and-computer-experiments" class="level3 page-columns page-full" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="simple-examples-and-computer-experiments"><span class="header-section-number">4.2.1</span> Simple examples and computer experiments</h3>
<p>Here is a first example of a mixture model with two equal-sized components. The generating process has two steps:</p>
<p><strong>Flip a fair coin.</strong></p>
<p>If it comes up heads: Generate a random number from a normal distribution with mean 1 and variance 0.25.</p>
<p>If it comes up tails: Generate a random number from a normal distribution with mean 3 and variance 0.25. The histogram shown in <a href="#fig-twocoins" class="quarto-xref">Figure&nbsp;<span>4.1</span></a> was produced by repeating these two steps 10000 times using the following code.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>coinflips <span class="ot">=</span> (<span class="fu">runif</span>(<span class="dv">10000</span>) <span class="sc">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(coinflips)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>coinflips
FALSE  TRUE 
 5003  4997 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>oneFlip <span class="ot">=</span> <span class="cf">function</span>(fl, <span class="at">mean1 =</span> <span class="dv">1</span>, <span class="at">mean2 =</span> <span class="dv">3</span>, <span class="at">sd1 =</span> <span class="fl">0.5</span>, <span class="at">sd2 =</span> <span class="fl">0.5</span>) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (fl) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">rnorm</span>(<span class="dv">1</span>, mean1, sd1)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">rnorm</span>(<span class="dv">1</span>, mean2, sd2)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>fairmix <span class="ot">=</span> <span class="fu">vapply</span>(coinflips, oneFlip, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">value =</span> fairmix), <span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_histogram</span>(<span class="at">fill =</span> <span class="st">"purple"</span>, <span class="at">binwidth =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-twocoins" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-twocoins-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-twocoins-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;4.1: Histogram of 10,000 random draws from a fair mixture of two normals. The left hand part of the histogram is dominated by numbers generated from (A), on the right from (B)."><img src="04-chap_files/figure-html/fig-twocoins-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-twocoins-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.1: Histogram of 10,000 random draws from a fair mixture of two normals. The left hand part of the histogram is dominated by numbers generated from (A), on the right from (B).
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-mixtures-vector" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.1
</div>
</div>
<div class="callout-body-container callout-body">
<p>How can you use R’s vectorized syntax to remove the <code>vapply</code>-loop and generate the <code>fairmix</code> vector more efficiently?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>means <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>sds   <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>values <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(coinflips),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">mean =</span> <span class="fu">ifelse</span>(coinflips, means[<span class="dv">1</span>], means[<span class="dv">2</span>]),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">sd   =</span> <span class="fu">ifelse</span>(coinflips, sds[<span class="dv">1</span>],   sds[<span class="dv">2</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div id="wrn-mixtures-notice" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Using your improved code, use one million coin flips and make a histogram with 200 bins. What do you notice?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fair <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">coinflips =</span> (<span class="fu">runif</span>(<span class="fl">1e6</span>) <span class="sc">&gt;</span> <span class="fl">0.5</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">values =</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(coinflips),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mean =</span> <span class="fu">ifelse</span>(coinflips, means[<span class="dv">1</span>], means[<span class="dv">2</span>]),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">sd   =</span> <span class="fu">ifelse</span>(coinflips, sds[<span class="dv">1</span>],   sds[<span class="dv">2</span>])))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fair, <span class="fu">aes</span>(<span class="at">x =</span> values)) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_histogram</span>(<span class="at">fill =</span> <span class="st">"purple"</span>, <span class="at">bins =</span> <span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-limitinghistogram" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-limitinghistogram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-limitinghistogram-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;4.2: Similar to Figure&nbsp;fig-twocoins, but with one million observations."><img src="04-chap_files/figure-html/fig-limitinghistogram-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:33.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-limitinghistogram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.2: Similar to <a href="#fig-twocoins" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>, but with one million observations.
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-limitinghistogram" class="quarto-xref">Figure&nbsp;<span>4.2</span></a> illustrates that as we increase the number of bins and the number of observations per bin, the histogram approaches a smooth curve. This smooth limiting curve is called the <strong>density</strong> function of the random variable <code>fair$values</code>.</p>
</div>
</div>
</div>
<p>The density function for a normal <span class="math inline">\(N(\mu,\sigma)\)</span> random variable can be written explicitly. We usually call it</p>
<p><span class="math display">\[
\phi(x)=\frac{1}{\sigma \sqrt{2\pi}}e^{-\frac{1}{2}(\frac{x-\mu}{\sigma})^2}.
\]</span></p>
<div id="wrn-mixtures-overlaydensity" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.3
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="a">
<li>Plot a histogram of those values of <code>fair$values</code> for which <code>coinflips</code> is <code>TRUE</code>. Hint: use <code>y = ..density..</code> in the call to <code>aes</code> (which means that the vertical axis is to show the proportion of counts) and set the binwidth to 0.01.</li>
<li>Overlay the line corresponding to <span class="math inline">\(\phi(z)\)</span>.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dplyr<span class="sc">::</span><span class="fu">filter</span>(fair, coinflips), <span class="fu">aes</span>(<span class="at">x =</span> values)) <span class="sc">+</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">fill =</span> <span class="st">"purple"</span>, <span class="at">binwidth =</span> <span class="fl">0.01</span>) <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm, <span class="at">color =</span> <span class="st">"red"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> means[<span class="dv">1</span>], <span class="at">sd =</span> sds[<span class="dv">1</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-overlaydensity" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-overlaydensity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-overlaydensity-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;4.3: Histogram of half a million draws from the normal distribution N(\mu=1,\sigma^2=0.5^2). The curve is the theoretical density \phi(x) calculated using the function dnorm."><img src="04-chap_files/figure-html/fig-overlaydensity-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:33.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-overlaydensity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.3: Histogram of half a million draws from the normal distribution <span class="math inline">\(N(\mu=1,\sigma^2=0.5^2)\)</span>. The curve is the theoretical density <span class="math inline">\(\phi(x)\)</span> calculated using the function <code>dnorm</code>.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>In fact we can write the mathematical formula for the density of all of <code>fair$values</code> (the limiting curve that the histograms tend to look like) as a sum of the two densities.</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-eqhalfhalf"><span class="math display">\[
f(x)=\frac{1}{2}\phi_1(x)+\frac{1}{2}\phi_2(x),
\tag{4.1}\]</span></span></p>
<p>where <span class="math inline">\(\phi_1\)</span> is the density of the normal <span class="math inline">\(N(\mu_1=1,\sigma^2=0.25)\)</span> and <span class="math inline">\(\phi_2\)</span> is the density of the normal <span class="math inline">\(N(\mu_2=3,\sigma^2=0.25)\)</span>. <a href="#fig-twodensity" class="quarto-xref">Figure&nbsp;<span>4.4</span></a> was generated by the following code.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>fairtheory <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">5</span>, <span class="at">length.out =</span> <span class="dv">1000</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">f =</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">dnorm</span>(x, <span class="at">mean =</span> means[<span class="dv">1</span>], <span class="at">sd =</span> sds[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">dnorm</span>(x, <span class="at">mean =</span> means[<span class="dv">2</span>], <span class="at">sd =</span> sds[<span class="dv">2</span>]))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fairtheory, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> f)) <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"mixture density"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-twodensity" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-twodensity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-twodensity-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;4.4: The theoretical density of the mixture."><img src="04-chap_files/figure-html/fig-twodensity-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="280"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-twodensity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.4: The theoretical density of the mixture.
</figcaption>
</figure>
</div>
</div></div></div>
<p>In this case, the mixture model is extremely visible as the two component distributions have little overlap. <a href="#fig-twodensity" class="quarto-xref">Figure&nbsp;<span>4.4</span></a> shows two distinct peaks: we call this a <strong>bimodal</strong> distribution. In practice, in many cases the separation between the mixture components is not so obvious—but nevertheless relevant.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-histmystery" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-histmystery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-histmystery-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;4.5: A mixture of two normals that is harder to recognize."><img src="04-chap_files/figure-html/fig-histmystery-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="280"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-histmystery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.5: A mixture of two normals that is harder to recognize.
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-mixtures-mystery" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.4
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="#fig-histmystery" class="quarto-xref">Figure&nbsp;<span>4.5</span></a> is a histogram of a fair mixture of two normals with the same variances. Can you guess the two <em>mean</em> parameters of the component distributions? Hint: you can use trial and error, and simulate various mixtures to see if you can make a matching histogram. Looking at the R code for the chapter will show you exactly how the data were generated.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The following code colors in red the points that were generated from the <em>heads</em> coin flips and in blue those from the <em>tails</em>. Its output, in <a href="#fig-betterhistogram-1" class="quarto-xref">Figure&nbsp;<span>4.6</span></a>, shows the two underlying distributions.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mystery, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  coinflips values
  &lt;lgl&gt;      &lt;dbl&gt;
1 FALSE       2.40
2 FALSE       1.66
3 TRUE        1.22</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>br <span class="ot">=</span> <span class="fu">with</span>(mystery, <span class="fu">seq</span>(<span class="fu">min</span>(values), <span class="fu">max</span>(values), <span class="at">length.out =</span> <span class="dv">30</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mystery, <span class="fu">aes</span>(<span class="at">x =</span> values)) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(mystery, coinflips),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">breaks =</span> br) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(mystery, <span class="sc">!</span>coinflips),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">fill =</span> <span class="st">"darkblue"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">breaks =</span> br) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-betterhistogram-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-betterhistogram-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-betterhistogram-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;4.6: The mixture from Figure&nbsp;fig-histmystery, but with the two components colored in red and blue."><img src="04-chap_files/figure-html/fig-betterhistogram-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:33.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-betterhistogram-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.6: The mixture from <a href="#fig-histmystery" class="quarto-xref">Figure&nbsp;<span>4.5</span></a>, but with the two components colored in red and blue.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>In <a href="#fig-betterhistogram-1" class="quarto-xref">Figure&nbsp;<span>4.6</span></a>, the bars from the two component distributions are plotted on top of each other. A different way of showing the components is <a href="#fig-comparecomponents-1" class="quarto-xref">Figure&nbsp;<span>4.7</span></a>, produced by the code below.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mystery, <span class="fu">aes</span>(<span class="at">x =</span> values, <span class="at">fill =</span> coinflips)) <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(mystery, coinflips),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">breaks =</span> br) <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(mystery, <span class="sc">!</span>coinflips),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">fill =</span> <span class="st">"darkblue"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">breaks =</span> br) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">fill =</span> <span class="st">"purple"</span>, <span class="at">breaks =</span> br, <span class="at">alpha =</span> <span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-comparecomponents-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-comparecomponents-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-comparecomponents-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure&nbsp;4.7: As Figure&nbsp;fig-betterhistogram-1, with stacked bars for the two mixture components."><img src="04-chap_files/figure-html/fig-comparecomponents-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="280"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-comparecomponents-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.7: As <a href="#fig-betterhistogram-1" class="quarto-xref">Figure&nbsp;<span>4.6</span></a>, with stacked bars for the two mixture components.
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-mixtures-myst2" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.5
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why do the bars in <a href="#fig-comparecomponents-1" class="quarto-xref">Figure&nbsp;<span>4.7</span></a>, but not those in <a href="#fig-betterhistogram-1" class="quarto-xref">Figure&nbsp;<span>4.6</span></a> have the same heights as in <a href="#fig-histmystery" class="quarto-xref">Figure&nbsp;<span>4.5</span></a>?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>In Figures <a href="#fig-comparecomponents-1" class="quarto-xref"><span>4.7</span></a> and <a href="#fig-histmystery" class="quarto-xref"><span>4.5</span></a>, each count occupies a different piece of vertical space in a bin. In <a href="#fig-betterhistogram-1" class="quarto-xref">Figure&nbsp;<span>4.6</span></a>, in the overlapping (darker) region, some of the counts falling within the same bin are overplotted.</p>
</div>
</div>
</div>
<p>In Figures <a href="#fig-betterhistogram-1" class="quarto-xref"><span>4.6</span></a> and <a href="#fig-comparecomponents-1" class="quarto-xref"><span>4.7</span></a>, we were able to use the <code>coinflips</code> column in the data to disentangle the components. In real data, this information is missing.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/book_icon.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="A book-long treatment on the subject of finite mixtures [@mclachlan2004]."><img src="imgs/book_icon.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="126" alt="A book-long treatment on the subject of finite mixtures (McLachlan and Peel 2004)."></a></p>
</figure>
</div>
<figcaption>A book-long treatment on the subject of finite mixtures <span class="citation" data-cites="mclachlan2004">(<a href="16-chap.html#ref-mclachlan2004" role="doc-biblioref">McLachlan and Peel 2004</a>)</span>.</figcaption>
</figure>
</div>
</div></div></div>
</section>
<section id="discovering-the-hidden-class-labels" class="level3 page-columns page-full" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="discovering-the-hidden-class-labels"><span class="header-section-number">4.2.2</span> Discovering the hidden class labels</h3>
<p>We use a method called the <em>expectation-maximization (EM) algorithm</em> to infer the value of the hidden groupings. The EM algorithm is a popular iterative procedure that alternates between pretending we know one part of the solution to compute the other part, and pretending the other part is known and computing the first part, and so on, until convergence. More concretely, it alternates between</p>
<ul>
<li><p>pretending we know the probabilities with which each observation belongs to the different mixture components and, from this, estimating the parameters of the components, and</p></li>
<li><p>pretending we know the parameters of the mixture components and estimating the probabilities with which each observation belongs to the components.</p></li>
</ul>
<p>Let’s take a simple example. We measure a variable <span class="math inline">\(x\)</span> on a series of objects that we think come from two groups, although we do not know the group labels. We start by <em>augmenting</em><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> the data with the unobserved (latent) group label, which we will call <span class="math inline">\(U\)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;Adding another variable which was not measured, called a hidden or <strong>latent variable</strong>.</p></div></div><p>We are interested in finding the values of <span class="math inline">\(U\)</span> and the unknown parameters <span class="math inline">\(\theta\)</span> of the underlying distribution of the groups. We will use the maximum likelihood approach introduced in <a href="02-chap.html" class="quarto-xref"><span>Chapter 2</span></a> to estimate the parameters that make the data <span class="math inline">\(x\)</span> the most likely. We can write the probability densities</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-eqeqmix"><span class="math display">\[
p(x,u\,|\,\theta) = p(x\,|\,u,\theta)\,p(u\,|\,\theta).
\tag{4.2}\]</span></span></p>
<section id="mixture-of-normals" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="mixture-of-normals">Mixture of normals</h4>
<p>For instance, we could generalize our previous mixture model with two normal distributions <a href="#eq-mixtures-eqhalfhalf" class="quarto-xref">Equation&nbsp;<span>4.1</span></a> by allowing non-equal mixture fractions,</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-twonormals"><span class="math display">\[
f(x)=\lambda\phi_1(x)+(1-\lambda)\phi_2(x),
\tag{4.3}\]</span></span></p>
<p>for <span class="math inline">\(\lambda\in[0,1]\)</span>. Similarly as above, <span class="math inline">\(\phi_k\)</span> is the density of the normal <span class="math inline">\(N(\mu_k,\sigma_k^2)\)</span> for <span class="math inline">\(k=1\)</span> and <span class="math inline">\(k=2\)</span>, respectively. Then, the parameter vector <span class="math inline">\(\theta\)</span> is a five-tuple of the two means, the two standard deviations, and the mixture parameter <span class="math inline">\(\lambda\)</span>. In other words, <span class="math inline">\(\theta=(\mu_1,\mu_2,\sigma_1,\sigma_2,\lambda)\)</span>. Here is an example of data generated according to such a model. The labels are denoted by <span class="math inline">\(u\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mus <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>u <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">2</span>, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(lambda, <span class="dv">1</span><span class="sc">-</span>lambda))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(u), <span class="at">mean =</span> mus[u])</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>dux <span class="ot">=</span> <span class="fu">tibble</span>(u, x)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dux)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
      u     x
  &lt;int&gt; &lt;dbl&gt;
1     2 0.303
2     2 2.65 
3     1 0.484
4     2 3.04 
5     2 1.10 
6     2 1.96 </code></pre>
</div>
</div>
<p>If we know the labels <span class="math inline">\(u\)</span>, we can estimate the parameters using separate MLEs for each group. The overall likelihood is</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-factorizedlikelihood"><span class="math display">\[
p(x, u \,|\, \theta) =
\left( \prod_{\{i:\,u_i=1\}} \phi_1(x_i) \right) \times
\left( \prod_{\{i:\,u_i=2\}} \phi_2(x_i) \right).
\tag{4.4}\]</span></span></p>
<p>Its maximization can be split into three independent pieces: we find <span class="anchored-eq" data-anchor-id="eq-mixtures" class="math inline">\(\mu_1\)</span> and <span class="math inline">\(\sigma_1\)</span> by maximizing the first bracketed expression on the right hand side of <a href="#eq-mixtures-factorizedlikelihood" class="quarto-xref">Equation&nbsp;<span>4.4</span></a>, <span class="math inline">\(\mu_2\)</span> and <span class="math inline">\(\sigma_2\)</span> by maximizing the second, and <span class="math inline">\(\lambda\)</span> from the empirical frequencies of the labels:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">group_by</span>(dux, u) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">mu =</span> <span class="fu">mean</span>(x), <span class="at">sigma =</span> <span class="fu">sd</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
      u     mu sigma
  &lt;int&gt;  &lt;dbl&gt; &lt;dbl&gt;
1     1 -0.558  1.05
2     2  1.41   1.04</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dux<span class="sc">$</span>u) <span class="sc">/</span> <span class="fu">nrow</span>(dux)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   1    2 
0.55 0.45 </code></pre>
</div>
</div>
<div id="wrn-mixtures-mixprop" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.6
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose we knew the mixing proportion <span class="math inline">\(\lambda=\frac{1}{2}\)</span>, but not the <span class="math inline">\(u_i\)</span>, so that the density is <span class="math inline">\(\frac{1}{2}\phi_1(x)+\frac{1}{2}\phi_2(x)\)</span>. Try writing out the (log) likelihood. What prevents us from solving for the MLE explicitly here?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>See, e.g., the chapter on <em>Mixture Models</em> in <span class="citation" data-cites="CosmaShalizi2017">Shalizi (<a href="16-chap.html#ref-CosmaShalizi2017" role="doc-biblioref">2017</a>)</span> for the computation of the likelihood of a finite mixture of normals. “If we try to estimate the mixture model, then, we’re doing weighted maximum likelihood, with weights given by the posterior label probabilities. These, to repeat, depend on the parameters we are trying to estimate, so there seems to be a vicious circle.”</p>
</div>
</div>
</div>
<p>In many cases we neither know the <span class="math inline">\(u\)</span> labels nor the mixture proportions. What we can do is start with an initial guess for the labels and pretend to know them, estimate the parameters as above, and then go through an iterative cycle, updating at each step our current best guess of the labels and the parameters until our estimates no longer substantially change (i.e., until they seem to have converged) and the likelihood has reached an optimum.</p>
<p>In fact we can do something more elaborate and replace the “hard” labels <span class="anchored-eq" data-anchor-id="eq-mixtures" class="math inline">\(u\)</span> for each observation (it is either in group 1 or 2) by membership weights that sum up to 1. The mixture model <a href="#eq-mixtures-twonormals" class="quarto-xref"><span>4.3</span></a> suggests that we interpret</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-membershipweights"><span class="math display">\[
w(x, 1) = \frac{\lambda\phi_1(x)}{\lambda\phi_1(x)+(1-\lambda)\phi_2(x)}
\tag{4.5}\]</span></span></p>
<p>as the probability that an observation with value <span class="math inline">\(x\)</span> was generated by the first mixture component, and analogously <span class="math inline">\(w(x, 2) = 1 - w(x, 1)\)</span> for the second component. In other words, while <span class="math inline">\(\lambda\)</span> is the prior probability that an observation that we have not yet seen comes from mixture component 1, <span class="math inline">\(w(x,1)\)</span> is the corresponding posterior probability once we have observed its value <span class="math inline">\(x\)</span>. This suggests the following iterative algorithm:</p>
<p><strong>E step</strong>: Assuming that <span class="anchored-eq" data-anchor-id="eq-mixtures" class="math inline">\(\theta\)</span> (i.e., the means, standard deviations and <span class="math inline">\(\lambda\)</span>) is known, evaluate the membership weights <a href="#eq-mixtures-membershipweights" class="quarto-xref"><span>4.5</span></a>.</p>
<p><strong>M step</strong>: Given the membership weights of each observation <span class="math inline">\(x_i\)</span>, determine a new, improved maximum likelihood estimate of <span class="math inline">\(\theta\)</span>.</p>
<p>Iterate until <span class="math inline">\(\theta\)</span> and the likelihood have converged. At this point, please check out <a href="#imp-mixtures-emstepbystep" class="quarto-xref">Exercise&nbsp;<span>4.1</span></a> for a worked out demonstration with code. In fact, this algorithm is far more general than our particular application example here. A very readable exposition is presented by <span class="citation" data-cites="Bishop:PRML">(<a href="16-chap.html#ref-Bishop:PRML" role="doc-biblioref">Bishop 2006</a>)</span>, here some of the highlights:</p>
<p>Our goal is to maximize the marginal likelihood of a probabilistic model that involves an observed variable <span class="math inline">\(x\)</span>, an unobserved variable <span class="math inline">\(u\)</span> and some parameter <span class="math inline">\(\theta\)</span>. In our simple example, <span class="math inline">\(u\)</span> is a categorical variable with two possible values, and <span class="math inline">\(x\)</span> a real number. In general, both <span class="math inline">\(x\)</span> and <span class="math inline">\(u\)</span> can be a tuple of multiple individual variables (i.e., they can be multivariate) of any variable type. The marginal likelihood is computed by taking the expectation (i.e., a weighted average) across all possible values of <span class="math inline">\(u\)</span>:</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-marglike1"><span class="math display">\[
L_\text{marg}(\theta; x) =
\int_U p(x, u\,|\,\theta) \, \text{d}U.
\tag{4.6}\]</span></span></p>
<p>In our specific example, the integration amounts to (probabilistically) averaging over all possible membership configurations, and thus, to the weighted sum taking into account the membership weights,</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-marglike2"><span class="math display">\[
L_\text{marg}(\theta; x) =
\prod_{i=1}^n \sum_{u=1}^2 p(x_i, u\,|\,\theta) \, w(x_i, u\,|\,\theta).
\tag{4.7}\]</span></span></p>
<p>Directly maximizing this quantity is intractable.</p>
<p>Something we do have a grip on, given the data and our current parameter estimate <span class="math inline">\(\theta_t\)</span>, is the conditional distribution of the latent variable, <span class="math inline">\(p(u\,|\,x, \theta_t)\)</span>. We can use it to find the expectation of the complete data log likelihood <span class="math inline">\(\log p(x, u\,|\,\theta)\)</span> evaluated for some general parameter value <span class="math inline">\(\theta\)</span>. This expectation is often denoted as</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-defQ"><span class="math display">\[
Q(\theta, \theta_t) = \int_U \log p(x, u\,|\,\theta) \, p(u\,|\, x, \theta_t) \, \text{d}U.
\tag{4.8}\]</span></span></p>
<p>In the M step, we determine the revised parameter estimate <span class="math inline">\(\theta_{t+1}\)</span> by maximizing this function,</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-MstepwithQ"><span class="math display">\[
\theta_{t+1} = \arg \max_\theta \, Q(\theta, \theta_t).
\tag{4.9}\]</span></span></p>
<p>The E step consists of computing <span class="math inline">\(p(u\,|\, x, \theta_t)\)</span>, the essential ingredient of <span class="math inline">\(Q\)</span>.</p>
<p>These two steps (E and M) are iterated until the improvements are small; this is a numerical indication that we are close to a flattening of the likelihood and have reached a maximum. The iteration trajectory, but hopefully not the point that we arrive at, will depend on the starting point. This is analogous to a hike to the top of a mountain, which can start at different places and may take different routes, but always leads to the top of the hill—as long as there is only one hilltop and not several. Thus, as a precaution, it is good practice to repeat such a procedure several times from different starting points and make sure that we always get the same answer.</p>
<div id="wrn-mixtures-mixtures-empackages" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.7
</div>
</div>
<div class="callout-body-container callout-body">
<p>Several R packages provide EM implementations, including <strong><a href="https://cran.r-project.org/web/packages/mclust/">mclust</a></strong>, <strong><a href="https://cran.r-project.org/web/packages/EMcluster/">EMcluster</a></strong> and <strong><a href="https://cran.r-project.org/web/packages/EMMIXskew/">EMMIXskew</a></strong>. Choose one and run the EM function several times with different starting values. Then use the function <code>normalmixEM</code> from the <strong><a href="https://cran.r-project.org/web/packages/mixtools/">mixtools</a></strong> package to compare the outputs.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Here we show the output from <strong><a href="https://cran.r-project.org/web/packages/mixtools/">mixtools</a></strong>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mixtools"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span> <span class="sc">-</span><span class="fl">0.2</span>, <span class="at">sd =</span> <span class="fl">0.5</span>),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>( <span class="dv">50</span>, <span class="at">mean =</span>  <span class="fl">0.5</span>, <span class="at">sd =</span>   <span class="dv">1</span>))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>gm <span class="ot">=</span> <span class="fu">normalmixEM</span>(y, <span class="at">k =</span> <span class="dv">2</span>, </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lambda =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">mu =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.01</span>, <span class="fl">0.01</span>), </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">sigma =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>number of iterations= 134 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(gm, <span class="fu">c</span>(lambda, mu, sigma, loglik))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]    0.9263    0.0737   -0.1859    1.9216    0.6134    0.4746 -170.5662</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>The EM algorithm is very instructive:</p>
<ol type="1">
<li><p>We saw a first example of <em>soft</em> averaging, where we don’t decide whether an observation belongs to one group or another, but allow it to participate in several groups by using membership probabilities as weights, and thus obtain more nuanced estimates <span class="citation" data-cites="Slonim:2005">(<a href="16-chap.html#ref-Slonim:2005" role="doc-biblioref">Slonim et al. 2005</a>)</span>.</p></li>
<li><p>It shows us how we can tackle a difficult problem with too many unknowns by alternating between solving simpler problems.</p></li>
<li><p>We were able to consider a data generating model with hidden variables, and still estimate its parameters. We could do so even without explicitly commiting on the values of the hidden variables: we took a (weighted) average over them, in the Expecation step of <a href="#eq-mixtures-defQ" class="quarto-xref">Equation&nbsp;<span>4.8</span></a>, embodied by the membership probabilities. This basic idea is so powerful that it is the starting point for many more advanced algorithms in machine learning <span class="citation" data-cites="Bishop:PRML">(<a href="16-chap.html#ref-Bishop:PRML" role="doc-biblioref">Bishop 2006</a>)</span>.</p></li>
<li><p>It can be extended to the more general case of model averaging <span class="citation" data-cites="hoeting1999">(<a href="16-chap.html#ref-hoeting1999" role="doc-biblioref">Hoeting et al. 1999</a>)</span>. It can be sometimes beneficial to consider several models simultaneously if we are unsure which one is relevant for our data. We can combine them together into a weighted model. The weights are provided by the likelihoods of the models.</p></li>
</ol>
</section>
</section>
<section id="models-for-zero-inflated-data" class="level3 page-columns page-full" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="models-for-zero-inflated-data"><span class="header-section-number">4.2.3</span> Models for zero inflated data</h3>
<p>Ecological and molecular data often come in the form of counts. For instance, this may be the number of individuals from each of several species at each of several locations. Such data can often be seen as a mixture of two scenarios: if the species is not present, the count is necessarily zero, but <em>if</em> the species is present, the number of individuals we observe varies, with a random sampling distribution; this distribution may also include zeros. We model this as a mixture:</p>
<p><span class="anchored-eq" data-anchor-id="eq-ihpqxnkvgazs" id="eq-ihpqxnkvgazs"><span class="math display">\[
f_{\text{zi}}(x) = \lambda \, \delta(x) + (1-\lambda) \, f_{\text{count}}(x),
\tag{4.10}\]</span></span></p>
<p>where <span class="math inline">\(\delta\)</span> is Dirac’s delta function, which represents a probability distribution that has all its mass at 0. The zeros from the first mixture component are called “structural”: in our example, they occur because certain species do not live in certain habitats. The second component, <span class="math inline">\(f_{\text{count}}\)</span> may also include zeros and other small numbers, simply due to random sampling. The R packages <strong><a href="https://cran.r-project.org/web/packages/pscl/">pscl</a></strong> <span class="citation" data-cites="Zeileis:2008">(<a href="16-chap.html#ref-Zeileis:2008" role="doc-biblioref">Zeileis, Kleiber, and Jackman 2008</a>)</span> and <strong><a href="https://cran.r-project.org/web/packages/zicounts/">zicounts</a></strong> provide many examples and functions for working with <strong>zero inflated</strong> counts.</p>
<section id="example-chip-seq-data" class="level4 unnumbered page-columns page-full">
<h4 class="unnumbered anchored" data-anchor-id="example-chip-seq-data">Example: ChIP-Seq data</h4>
<p>Let’s consider the example of ChIP-Seq data. These data are sequences of pieces of DNA that are obtained from chromatin immunoprecipitation (ChIP). This technology enables the mapping of the locations along genomic DNA of transcription factors, nucleosomes, histone modifications, chromatin remodeling enzymes, chaperones, polymerases and other protein. It was the main technology used by the Encyclopedia of DNA Elements (ENCODE) Project. Here we use an example <span class="citation" data-cites="Kuan2011statistical">(<a href="16-chap.html#ref-Kuan2011statistical" role="doc-biblioref">Kuan et al. 2011</a>)</span> from the <strong><a href="https://bioconductor.org/packages/mosaicsExample/">mosaicsExample</a></strong> package, which shows data measured on chromosome 22 from ChIP-Seq of antibodies for the STAT1 protein and the H3K4me3 histone modification applied to the GM12878 cell line. Here we do not show the code to construct the <code>binTFBS</code> object; it is shown in the source code file for this chapter and follows the vignette of the <strong><a href="https://bioconductor.org/packages/mosaics/">mosaics</a></strong> package.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>binTFBS</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Summary: bin-level data (class: BinData)
----------------------------------------
- # of chromosomes in the data: 1
- total effective tag counts: 462479
  (sum of ChIP tag counts of all bins)
- control sample is incorporated
- mappability score is NOT incorporated
- GC content score is NOT incorporated
- uni-reads are assumed
----------------------------------------</code></pre>
</div>
</div>
<p>From this object, we can create the histogram of per-bin counts.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>bincts <span class="ot">=</span> <span class="fu">print</span>(binTFBS)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bincts, <span class="fu">aes</span>(<span class="at">x =</span> tagCount)) <span class="sc">+</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"forestgreen"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-chipseqzeros" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-chipseqzeros-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-chipseqzeros-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure&nbsp;4.8: The number of binding sites found in 200nt windows along chromosome 22 in a ChIP-Seq dataset."><img src="04-chap_files/figure-html/fig-chipseqzeros-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="280"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-chipseqzeros-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.8: The number of binding sites found in 200nt windows along chromosome 22 in a ChIP-Seq dataset.
</figcaption>
</figure>
</div>
</div></div></div>
<p>We see in <a href="#fig-chipseqzeros" class="quarto-xref">Figure&nbsp;<span>4.8</span></a> that there are many zeros, although from this plot it is not immediately obvious whether the number of zeros is really extraordinary, given the frequencies of the other small numbers (<span class="math inline">\(1,2,...\)</span>).</p>
<div id="wrn-mixtures-loghist" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.8
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="a">
<li>Redo the histogram of the counts using a logarithm base 10 scale on the <span class="math inline">\(y\)</span>-axis.<br>
</li>
<li>Estimate <span class="math inline">\(\pi_0\)</span>, the proportion of bins with zero counts.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center" data-warning.known="[&quot;transformation introduced infinite values&quot;,&quot;rows containing missing values&quot;]">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bincts, <span class="fu">aes</span>(<span class="at">x =</span> tagCount)) <span class="sc">+</span> <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"forestgreen"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ChipseqHistlogY" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ChipseqHistlogY-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-ChipseqHistlogY-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure&nbsp;4.9: As Figure&nbsp;fig-chipseqzeros, but using a logarithm base 10 scale on the y-axis. The fraction of zeros seems elevated compared to that of ones, twos, …"><img src="04-chap_files/figure-html/fig-ChipseqHistlogY-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:33.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ChipseqHistlogY-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.9: As <a href="#fig-chipseqzeros" class="quarto-xref">Figure&nbsp;<span>4.8</span></a>, but using a logarithm base 10 scale on the <span class="math inline">\(y\)</span>-axis. The fraction of zeros seems elevated compared to that of ones, twos, …
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="more-than-two-components" class="level3 page-columns page-full" data-number="4.2.4">
<h3 data-number="4.2.4" class="anchored" data-anchor-id="more-than-two-components"><span class="header-section-number">4.2.4</span> More than two components</h3>
<p>So far we have looked at mixtures of two components. We can extend our description to cases where there may be more. For instance, when weighing N=7,000 nucleotides obtained from mixtures of deoxyribonucleotide monophosphates (each type has a different weight, measured with the same standard deviation sd=3), we might observe the histogram (shown in <a href="#fig-nucleotideweights-1" class="quarto-xref">Figure&nbsp;<span>4.10</span></a>) generated by the following code.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>masses <span class="ot">=</span> <span class="fu">c</span>(<span class="at">A =</span>  <span class="dv">331</span>, <span class="at">C =</span>  <span class="dv">307</span>, <span class="at">G =</span>  <span class="dv">347</span>, <span class="at">T =</span>  <span class="dv">322</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>probs  <span class="ot">=</span> <span class="fu">c</span>(<span class="at">A =</span> <span class="fl">0.12</span>, <span class="at">C =</span> <span class="fl">0.38</span>, <span class="at">G =</span> <span class="fl">0.36</span>, <span class="at">T =</span> <span class="fl">0.14</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>N  <span class="ot">=</span> <span class="dv">7000</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>sd <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>nuclt   <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">length</span>(probs), N, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> probs)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>quadwts <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(nuclt),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">mean =</span> masses[nuclt],</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">sd   =</span> sd)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">quadwts =</span> quadwts), <span class="fu">aes</span>(<span class="at">x =</span> quadwts)) <span class="sc">+</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"purple"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-nucleotideweights-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nucleotideweights-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-nucleotideweights-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure&nbsp;4.10: Simulation of 7,000 nucleotide mass measurements."><img src="04-chap_files/figure-html/fig-nucleotideweights-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nucleotideweights-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.10: Simulation of 7,000 nucleotide mass measurements.
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-mixtures-mixture4N" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.9
</div>
</div>
<div class="callout-body-container callout-body">
<p>Repeat this simulation experiment with <span class="math inline">\(N=1000\)</span> nucleotide measurements. What do you notice in the histogram?</p>
</div>
</div>
<div id="wrn-mixtures-mixture4NB" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.10
</div>
</div>
<div class="callout-body-container callout-body">
<p>What happens when <span class="math inline">\(N=7000\)</span> but the standard deviation is 10?</p>
</div>
</div>
<div id="wrn-mixtures-mixture4NC" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.11
</div>
</div>
<div class="callout-body-container callout-body">
<p>Plot the theoretical density curve for the distribution simulated in <a href="#fig-nucleotideweights-1" class="quarto-xref">Figure&nbsp;<span>4.10</span></a>.</p>
</div>
</div>
<p>In this case, as we have enough measurements with good enough precision, we are able to distinguish the four nucleotides and decompose the distribution shown in <a href="#fig-nucleotideweights-1" class="quarto-xref">Figure&nbsp;<span>4.10</span></a>. With fewer data and/or more noisy measurements, the four modes and the distribution component might be less clear.</p>
</section>
</section>
<section id="empirical-distributions-and-the-nonparametric-bootstrap" class="level2 page-columns page-full" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="empirical-distributions-and-the-nonparametric-bootstrap"><span class="header-section-number">4.3</span> Empirical distributions and the nonparametric bootstrap</h2>
<p>In this section, we will consider an extreme case of mixture models, where we model our sample of <span class="math inline">\(n\)</span> data points as a mixture of <span class="math inline">\(n\)</span> point masses. We could use almost any set of data here; to be concrete, we use Darwin’s <em>Zea Mays</em> data<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> in which he compared the heights of 15 pairs of <em>Zea Mays</em> plants (15 self-hybridized versus 15 crossed). The data are available in the <strong><a href="https://cran.r-project.org/web/packages/HistData/">HistData</a></strong> package, and we plot the distribution of the 15 differences in height:</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;They were collected by Darwin who asked his cousin, Francis Galton to analyse them. R.A. Fisher re-analysed the same data using a paired t-test <span class="citation" data-cites="bulmer2003">(<a href="16-chap.html#ref-bulmer2003" role="doc-biblioref">Bulmer 2003</a>)</span>. We will get back to this example in <a href="13-chap.html" class="quarto-xref"><span>Chapter 13</span></a>.</p></div></div><div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"HistData"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>ZeaMays<span class="sc">$</span>diff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  6.125 -8.375  1.000  2.000  0.750  2.875  3.500  5.125  1.750  3.625
[11]  7.000  3.000  9.375  7.500 -6.000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ZeaMays, <span class="fu">aes</span>(<span class="at">x =</span> diff, <span class="at">ymax =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">15</span>, <span class="at">ymin =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"forestgreen"</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-ecdfZea" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ecdfZea-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-ecdfZea-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13" title="Figure&nbsp;4.11: The observed sample can be seen as a mixture of point masses at each of the values (real point masses would be bars without any width whatsoever)."><img src="04-chap_files/figure-html/fig-ecdfZea-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ecdfZea-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.11: The observed sample can be seen as a mixture of point masses at each of the values (real point masses would be bars without any width whatsoever).
</figcaption>
</figure>
</div>
</div></div></div>
<p>In <a href="03-chap.html#sec-graphics-ecdf" class="quarto-xref"><span>Section 3.6.7</span></a> we saw that the empirical cumulative distribution function (ECDF) for a sample of size <span class="math inline">\(n\)</span> is</p>
<p><span class="anchored-eq" data-anchor-id="eq-Mix" id="eq-Mix-ecdf"><span class="math display">\[
\hat{F}_n(x)=  \frac{1}{n}\sum_{i=1}^n {\mathbb 1}_{x \leq x_i},
\tag{4.11}\]</span></span></p>
<p>and we saw ECDF plots in <a href="03-chap.html#fig-graphics-onedecdf" class="quarto-xref">Figure&nbsp;<span>3.24</span></a>. We can also write the <em>density</em> of our sample as</p>
<p><span class="anchored-eq" data-anchor-id="eq-Mix" id="eq-Mix-eden"><span class="math display">\[
\hat{f}_n(x) =\frac{1}{n}\sum_{i=1}^n \delta_{x_i}(x)
\tag{4.12}\]</span></span></p>
<div class="page-columns page-full"><p>In general, the density of a probability distribution is the derivative (if it exists) of the distribution function. We have applied this principle here: the density of the distribution defined by <a href="#eq-Mix-ecdf" class="quarto-xref">Equation&nbsp;<span class="anchored-eq" data-anchor-id="eq-Mix">4.11</span></a> is <a href="#eq-Mix-eden" class="quarto-xref">Equation&nbsp;<span>4.12</span></a>. We could do this since one can consider the function <span class="math inline">\(\delta_a\)</span> the “derivative” of the step function <span class="math inline">\({\mathbb 1}_{x \leq a}\)</span>: it is completely flat almost everywhere, except at the one point <span class="math inline">\(a\)</span> where there is the step, and where its value is “infinite” . <a href="#eq-Mix-eden" class="quarto-xref">Equation&nbsp;<span>4.12</span></a> highlights that our data sample can be considered a mixture of <span class="math inline">\(n\)</span> <strong>point masses</strong> at the observed values <span class="math inline">\(x_1,x_2,..., x_{n}\)</span>, such as in <a href="#fig-ecdfZea" class="quarto-xref">Figure&nbsp;<span>4.11</span></a>.</p><div class="no-row-height column-margin column-container"><span class="margin-aside">There is a bit of advanced mathematics (beyond standard calculus) required for this to make sense, which is however beyond the scope of our treatment here.</span></div></div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-samplingdist" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-samplingdist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/BootstrapPrincipleNew.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14" title="Figure&nbsp;4.12: The value of a statistic \tau is estimated from data (the grey matrices) generated from an underlying distribution F. Different samples from F lead to different data, and so to different values of the estimate \hat{\tau}: this is called sampling variability. The distribution of all the \hat{\tau}’s is the sampling distribution."><img src="imgs/BootstrapPrincipleNew.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-samplingdist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.12: The value of a statistic <span class="math inline">\(\tau\)</span> is estimated from data (the grey matrices) generated from an underlying distribution <span class="math inline">\(F\)</span>. Different samples from <span class="math inline">\(F\)</span> lead to different data, and so to different values of the estimate <span class="math inline">\(\hat{\tau}\)</span>: this is called <strong>sampling variability</strong>. The distribution of all the <span class="math inline">\(\hat{\tau}\)</span>’s is the <strong>sampling distribution</strong>.
</figcaption>
</figure>
</div>
</div></div></div>
<p>Statistics of our sample, such as the mean, minimum or median, can now be written as a function of the ECDF, for instance, <span class="math inline">\(\bar{x} = \int \delta_{x_i}(x)\,\text{d}x\)</span>. As another instance, if <span class="math inline">\(n\)</span> is an odd number, the median is <span class="math inline">\(x_{(\frac{n+1}{2})}\)</span>, the value right in the middle of the ordered list.</p>
<p>The true <strong>sampling distribution</strong> of a statistic <span class="math inline">\(\hat{\tau}\)</span> is often hard to know as it requires many different data samples from which to compute the statistic; this is shown in <a href="#fig-samplingdist" class="quarto-xref">Figure&nbsp;<span>4.12</span></a>.</p>
<p>The <strong>bootstrap</strong> principle approximates the true sampling distribution of <span class="math inline">\(\hat{\tau}\)</span> by creating new samples drawn from the empirical distribution built from the original sample (<a href="#fig-bootpple" class="quarto-xref">Figure&nbsp;<span>4.13</span></a>). We <em>reuse</em> the data (by considering it a mixture distribution of <span class="math inline">\(\delta\)</span>s) to create new “datasets” by taking samples and looking at the sampling distribution of the statistics <span class="math inline">\(\hat{\tau}^*\)</span> computed on them. This is called the <strong>nonparametric bootstrap</strong> resampling approach, see <span class="citation" data-cites="Efron:1994">Bradley Efron and Tibshirani (<a href="16-chap.html#ref-Efron:1994" role="doc-biblioref">1994</a>)</span> for a complete reference. It is very versatile and powerful method that can be applied to basically any statistic, no matter how complicated it is. We will see example applications of this method, in particular to clustering, in <a href="05-chap.html" class="quarto-xref"><span>Chapter 5</span></a>.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-bootpple" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bootpple-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/BootstrapPrinciple2New.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15" title="Figure&nbsp;4.13: The bootstrap simulates the sampling variability by drawing samples not from the underlying true distribution F (as in Figure&nbsp;fig-samplingdist), but from the empirical distribution function \hat{F}_n."><img src="imgs/BootstrapPrinciple2New.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bootpple-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.13: The bootstrap simulates the sampling variability by drawing samples not from the underlying true distribution <span class="math inline">\(F\)</span> (as in <a href="#fig-samplingdist" class="quarto-xref">Figure&nbsp;<span>4.12</span></a>), but from the empirical distribution function <span class="math inline">\(\hat{F}_n\)</span>.
</figcaption>
</figure>
</div>
</div></div></div>
<p>Using these ideas, let’s try to estimate the sampling distribution of the median of the Zea Mays differences we saw in <a href="#fig-ecdfZea" class="quarto-xref">Figure&nbsp;<span>4.11</span></a>. We use similar simulations to those in the previous sections: Draw <span class="math inline">\(B=1000\)</span> samples of size 15 from the 15 values (each being a component in the 15-component mixture). Then compute the 1000 medians of each of these samples of 15 values and look at their distribution: this is the bootstrap sampling distribution of the median.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>B <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>meds <span class="ot">=</span> <span class="fu">replicate</span>(B, {</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">15</span>, <span class="dv">15</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median</span>(ZeaMays<span class="sc">$</span>diff[i])</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">medians =</span> meds), <span class="fu">aes</span>(<span class="at">x =</span> medians)) <span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"purple"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-bootmedian" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bootmedian-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-bootmedian-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16" title="Figure&nbsp;4.14: The bootstrap sampling distribution of the median of the Zea Mays differences."><img src="04-chap_files/figure-html/fig-bootmedian-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bootmedian-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.14: The bootstrap sampling distribution of the median of the Zea Mays differences.
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-mixtures-ci99" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.12
</div>
</div>
<div class="callout-body-container callout-body">
<p>Estimate a 99% confidence interval for the median based on these simulations. What can you conclude from looking at the overlap between this interval and 0?</p>
</div>
</div>
<div id="wrn-mixtures-bootci99" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.13
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use the <strong><a href="https://cran.r-project.org/web/packages/bootstrap/">bootstrap</a></strong> package to redo the same analysis using the function <code>bootstrap</code> for both <code>median</code> and <code>mean</code>. What differences do you notice between the sampling distribution of the mean and the median?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"bootstrap"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bootstrap</span>(ZeaMays<span class="sc">$</span>diff, B, mean)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bootstrap</span>(ZeaMays<span class="sc">$</span>diff, B, median)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<section id="why-nonparametric" class="level4 unnumbered page-columns page-full">
<h4 class="unnumbered anchored" data-anchor-id="why-nonparametric">Why nonparametric?</h4>
<p>In theoretical statistics, nonparametric methods are those that have infinitely many degrees of freedom or numbers of unknown parameters.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123"></a></p>
</figure>
</div>
</div></div></div>
<div class="page-columns page-full"><p> In practice, we do not wait for infinity; when the number of parameters becomes as large or larger than the amount of data available, we say the method is nonparametric. The bootstrap uses a mixture with <span class="math inline">\(n\)</span> components, so with a sample of size <span class="math inline">\(n\)</span>, it qualifies as a nonparametric method.</p><div class="no-row-height column-margin column-container"><span class="margin-aside">Despite their name, nonparametric methods are not methods that do not use parameters: all statistical methods estimate unknown quantities.</span></div></div>
<div id="wrn-mixtures-boothowmany" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.14
</div>
</div>
<div class="callout-body-container callout-body">
<p>If the sample is composed of <span class="math inline">\(n=3\)</span> different values, how many different bootstrap resamples are possible? Answer the same question with <span class="math inline">\(n=15\)</span>.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-24-contents" aria-controls="callout-24" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-24" class="callout-24-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The set of all bootstrap resamples is equivalent to the set of all vectors of <span class="math inline">\(n\)</span> integers whose sum is <span class="math inline">\(n\)</span>. Denote by <span class="math inline">\(\mathbf{k} = (k_1,k_2,...,k_n)\)</span> the number of times the observations <span class="math inline">\(x_1,x_2,..., x_n\)</span> occur in a bootstrap sample. We can think of each <span class="math inline">\(k_i\)</span> as a box (as in the multinomial distribution), and there are <span class="math inline">\(n\)</span> boxes in which to drop <span class="math inline">\(n\)</span> balls. We can count the number of configurations by counting the number of ways of separating <span class="math inline">\(n\)</span> balls into the boxes, i.e.&nbsp;by writing down <span class="math inline">\(n\)</span> times an <code>o</code> (for the balls) and <span class="math inline">\(n-1\)</span> times a separator <code>|</code> between them. So we have <span class="math inline">\(2n-1\)</span> positions to fill, for which we must choose either <code>o</code> (a ball) or <code>|</code> (a separator). For <span class="math inline">\(n=3\)</span>, a possible placement would be <code>oo||o</code>, which corresponds to <span class="math inline">\(\mathbf{k} = (2,0,1)\)</span>. In general, this number is <span class="math inline">\({2n-1} \choose {n-1}\)</span>, and thus the answers for <span class="math inline">\(n=3\)</span> and <span class="math inline">\(15\)</span> are:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">N3 =</span> <span class="fu">choose</span>(<span class="dv">5</span>, <span class="dv">3</span>), <span class="at">N15 =</span> <span class="fu">choose</span>(<span class="dv">29</span>, <span class="dv">15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      N3      N15 
      10 77558760 </code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="wrn-mixtures-errortypes" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.15
</div>
</div>
<div class="callout-body-container callout-body">
<p>What are the two types of error that can occur when using the bootstrap as it is implemented in the <strong><a href="https://cran.r-project.org/web/packages/bootstrap/">bootstrap</a></strong> package? Which parameter can you modify to improve one of them?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-26-contents" aria-controls="callout-26" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-26" class="callout-26-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Monte Carlo simulations of subsets of the data by resampling randomly approximate the exhaustive bootstrap <span class="citation" data-cites="Diaconis1994">(<a href="16-chap.html#ref-Diaconis1994" role="doc-biblioref">Diaconis and Holmes 1994</a>)</span>. Increasing the size of <code>nboot</code> argument in the <code>bootstrap</code> function reduces the Monte Carlo error, however, the exhaustive bootstrap is still not exact: we are still using an approximate distribution function, that of the data instead of the true distribution. If the sample size is small or the original sample biased, the approximation can still be quite poor, no matter how large we choose <code>nboot</code>.</p>
</div>
</div>
</div>
</section>
</section>
<section id="infinite-mixtures" class="level2 page-columns page-full" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="infinite-mixtures"><span class="header-section-number">4.4</span> Infinite mixtures</h2>
<p>Sometimes mixtures can be useful even if we don’t aim to assign a label to each observation or, to put it differently, if we allow as many `labels’ as there are observations. If the number of mixture components is as big as (or bigger than) the number of observations, we say we have an <strong>infinite mixture</strong>. Let’s look at some examples.</p>
<section id="infinite-mixture-of-normals" class="level3 page-columns page-full" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="infinite-mixture-of-normals"><span class="header-section-number">4.4.1</span> Infinite mixture of normals</h3>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-LaplacePortrait" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-LaplacePortrait-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/LaplacePortrait_web.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18" title="Figure&nbsp;4.15: Laplace knew already that the probability density f_X(y)=\frac{1}{2\phi}\exp\left(-\frac{|y-\theta|}{\phi}\right),\qquad\phi>0 has the median as its location parameter \theta and the median absolute deviation (MAD) as its scale parameter \phi."><img src="imgs/LaplacePortrait_web.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-LaplacePortrait-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.15: Laplace knew already that the probability density <span class="math display">\[f_X(y)=\frac{1}{2\phi}\exp\left(-\frac{|y-\theta|}{\phi}\right),\qquad\phi&gt;0\]</span> has the median as its location parameter <span class="math inline">\(\theta\)</span> and the median absolute deviation (MAD) as its scale parameter <span class="math inline">\(\phi\)</span>.
</figcaption>
</figure>
</div>
</div></div></div>
<p>Consider the following two-level data generating scheme:</p>
<p><strong>Level 1</strong> Create a sample of <code>W</code>s from an exponential distribution.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>w <span class="ot">=</span> <span class="fu">rexp</span>(<span class="dv">10000</span>, <span class="at">rate =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Level 2</strong> The <span class="math inline">\(w\)</span>s serve as the variances of normal variables with mean <span class="math inline">\(\mu\)</span> generated using <code>rnorm</code>.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>mu  <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>lps <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(w), <span class="at">mean =</span> mu, <span class="at">sd =</span> <span class="fu">sqrt</span>(w))</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(lps), <span class="fu">aes</span>(<span class="at">x =</span> lps)) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">fill =</span> <span class="st">"purple"</span>, <span class="at">binwidth =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-Laplacedistribution" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Laplacedistribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-Laplacedistribution-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19" title="Figure&nbsp;4.16: Data sampled from a Laplace distribution."><img src="04-chap_files/figure-html/fig-Laplacedistribution-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="240"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Laplacedistribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.16: Data sampled from a Laplace distribution.
</figcaption>
</figure>
</div>
</div></div></div>
<p>This turns out to be a rather useful distribution. It has well-understood properties and is named after Laplace, who proved that the median is a good estimator of its location parameter <span class="math inline">\(\theta\)</span> and that the median absolute deviation can be used to estimate its scale parameter <span class="math inline">\(\phi\)</span>. From the formula in the caption of <a href="#fig-LaplacePortrait" class="quarto-xref">Figure&nbsp;<span>4.15</span></a> we see that the <span class="math inline">\(L_1\)</span> distance (absolute value of the difference) holds a similar position in the Laplace density as the <span class="math inline">\(L_2\)</span> (square of the difference) does for the normal density.</p>
<p>Conversely, in Bayesian regression<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>, having a Laplace distribution as a prior on the coefficients amounts to an <span class="math inline">\(L_1\)</span> penalty, called the <em>lasso</em> <span class="citation" data-cites="Tibshirani1996">(<a href="16-chap.html#ref-Tibshirani1996" role="doc-biblioref">Tibshirani 1996</a>)</span>, while a normal distribution as a prior leads to an <span class="math inline">\(L_2\)</span> penalty, called ridge regression.</p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;Don’t worry if you are not familiar with this, in that case just skip this sentence.</p></div></div><div id="wrn-mixtures-Laplacemixt" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.16
</div>
</div>
<div class="callout-body-container callout-body">
<p>Write a random variable whose distribution is the symmetric Laplace as a function of normal and exponential random variables.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-28-contents" aria-controls="callout-28" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-28" class="callout-28-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We can write the hierarchical model with variances generated as exponential variables, <span class="math inline">\(W\)</span>, as:</p>
<p><span class="anchored-eq" data-anchor-id="eq-uqxjoanhtgbs" id="eq-uqxjoanhtgbs"><span class="math display">\[
X = \sqrt{W} \cdot Z, \qquad W \sim Exp(1), \qquad Z \sim N(0,1).
\tag{4.13}\]</span></span></p>
</div>
</div>
</div>
<section id="asymmetric-laplace" class="level4 unnumbered page-columns page-full">
<h4 class="unnumbered anchored" data-anchor-id="asymmetric-laplace">Asymmetric Laplace</h4>
<p>In the Laplace distribution, the variances of the normal components depend on <span class="math inline">\(W\)</span>, while the means are unaffected. A useful extension adds another parameter <span class="math inline">\(\theta\)</span> that controls the locations or centers of the components. We generate data <code>alps</code> from a hierarchical model with <span class="math inline">\(W\)</span> an exponential variable; the output shown in <a href="#fig-ALaplacedistribution" class="quarto-xref">Figure&nbsp;<span>4.17</span></a> is a histogram of normal <span class="math inline">\(N(\theta+w\mu,\sigma w)\)</span> random numbers, where the <span class="math inline">\(w\)</span>’s themselves were randomly generated from an exponential distribution with mean <span class="math inline">\(1\)</span> as shown in the code:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> <span class="fl">0.3</span>; sigma <span class="ot">=</span> <span class="fl">0.4</span>; theta <span class="ot">=</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>w  <span class="ot">=</span> <span class="fu">rexp</span>(<span class="dv">10000</span>, <span class="dv">1</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>alps <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(w), theta <span class="sc">+</span> mu <span class="sc">*</span> w, sigma <span class="sc">*</span> <span class="fu">sqrt</span>(w))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(alps), <span class="fu">aes</span>(<span class="at">x =</span> alps)) <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">fill =</span> <span class="st">"purple"</span>, <span class="at">binwidth =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-ALaplacedistribution" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ALaplacedistribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-ALaplacedistribution-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20" title="Figure&nbsp;4.17: Histogram of data generated from an asymmetric Laplace distribution – a scale mixture of many normals whose means and variances are dependent. We write X \sim AL(\theta, \mu, \sigma)."><img src="04-chap_files/figure-html/fig-ALaplacedistribution-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="240"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ALaplacedistribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.17: Histogram of data generated from an asymmetric Laplace distribution – a scale mixture of many normals whose means and variances are dependent. We write <span class="math inline">\(X \sim AL(\theta, \mu, \sigma)\)</span>.
</figcaption>
</figure>
</div>
</div></div></div>
<p>Such hierarchical mixture distributions, where every instance of the data has its own mean and variance, are useful models in many biological settings. Examples are shown in <a href="#fig-promoterlengthsandexpression" class="quarto-xref">Figure&nbsp;<span>4.18</span></a>.</p>
<div id="fig-promoterlengthsandexpression" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-promoterlengthsandexpression-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="quarto-layout-row page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-promoterlengthsandexpression" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-promoterlengthsandexpression-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-promoterlengthsandexpression-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/LaplaceMixturePromoterLengths.png" class="lightbox" data-gallery="fig-promoterlengthsandexpression" title="Figure&nbsp;4.18&nbsp;(a): The lengths of the promoters shorter than 2000bp from Saccharomyces cerevisiae as studied by @Kristiansson2009."><img src="imgs/LaplaceMixturePromoterLengths.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-ref-parent="fig-promoterlengthsandexpression"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-promoterlengthsandexpression-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) The lengths of the promoters shorter than 2000bp from Saccharomyces cerevisiae as studied by <span class="citation" data-cites="Kristiansson2009">Kristiansson et al. (<a href="16-chap.html#ref-Kristiansson2009" role="doc-biblioref">2009</a>)</span>.
</figcaption>
</figure>
</div>
</div></div></div>
<div class="quarto-layout-row page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-promoterlengthsandexpression" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-promoterlengthsandexpression-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-promoterlengthsandexpression-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/tcellhist.png" class="lightbox" data-gallery="fig-promoterlengthsandexpression" title="Figure&nbsp;4.18&nbsp;(b): The log-ratios of microarray gene expression measurements for 20,000 genes [@Purdom2005]."><img src="imgs/tcellhist.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-ref-parent="fig-promoterlengthsandexpression"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-promoterlengthsandexpression-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) The log-ratios of microarray gene expression measurements for 20,000 genes <span class="citation" data-cites="Purdom2005">(<a href="16-chap.html#ref-Purdom2005" role="doc-biblioref">Purdom and Holmes 2005</a>)</span>.
</figcaption>
</figure>
</div>
</div></div></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-promoterlengthsandexpression-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.18: Histogram of real data. Both distributions can be modeled by asymmetric Laplace distributions.
</figcaption>
</figure>
</div>
<div id="wrn-mixtures-logratio" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.17
</div>
</div>
<div class="callout-body-container callout-body">
<p>Looking at the log-ratio of gene expression values from a microarray, one gets a distribution as shown on the right of <a href="#fig-promoterlengthsandexpression" class="quarto-xref">Figure&nbsp;<span>4.18</span></a>. How would one explain that the data have a histogram of this form?</p>
</div>
</div>
<p>The Laplace distribution is an example of where the consideration of the generative process indicates how the variance and mean are linked. The expectation value and variance of an asymmetric Laplace distribution <span class="math inline">\(AL(\theta, \mu, \sigma)\)</span> are</p>
<p><span class="anchored-eq" data-anchor-id="eq-kimxbflrcdgn" id="eq-kimxbflrcdgn"><span class="math display">\[
E(X)=\theta+\mu\quad\quad\text{and}\quad\quad\text{var}(X)=\sigma^2+\mu^2.
\tag{4.14}\]</span></span></p>
<p>Note the variance is dependent on the mean, unless <span class="math inline">\(\mu = 0\)</span> (the case of the symmetric Laplace Distribution). This is the feature of the distribution that makes it useful. Having a mean-variance dependence is very common for physical measurements, be they microarray fluorescence intensities, peak heights from a mass spectrometer, or reads counts from high-throughput sequencing, as we’ll see in the next section.</p>
</section>
</section>
<section id="infinite-mixtures-of-poisson-variables." class="level3 page-columns page-full" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="infinite-mixtures-of-poisson-variables."><span class="header-section-number">4.4.2</span> Infinite mixtures of Poisson variables.</h3>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-three-worlds-web" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-three-worlds-web-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/three-worlds_web.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-23" title="Figure&nbsp;4.19: How to count the fish in a lake? MC Escher."><img src="imgs/three-worlds_web.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-three-worlds-web-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.19: How to count the fish in a lake? MC Escher.
</figcaption>
</figure>
</div>
</div></div></div>
<p>A similar two-level hierarchical model is often also needed to model real-world count data. At the lower level, simple Poisson and binomial distributions serve as the building blocks, but their parameters may depend on some underlying (latent) process. In ecology, for instance, we might be interested in variations of fish species in all the lakes in a region. We sample the fish species in each lake to estimate their true abundances, and that could be modeled by a Poisson. But the true abundances will vary from lake to lake. And if we want to see whether, for instance, changes in climate or altitude play a role, we need to disentangle such systematic effects from random lake-to-lake variation. The different Poisson rate parameters <span class="math inline">\(\lambda\)</span> can be modeled as coming from a distribution of rates. Such a hierarchical model also enables us to add supplementary steps in the hierarchy, for instance we could be interested in many different types of fish, model altitude and other environmental factors separately, etc.</p>
<p>Further examples of sampling schemes that are well modeled by mixtures of Poisson variables include applications of high-throughput sequencing, such as RNA-Seq, which we will cover in detail in <a href="08-chap.html" class="quarto-xref"><span>Chapter 8</span></a>, or 16S rRNA-Seq data used in microbial ecology.</p>
</section>
<section id="sec-gammadist" class="level3 page-columns page-full" data-number="4.4.3">
<h3 data-number="4.4.3" class="anchored" data-anchor-id="sec-gammadist"><span class="header-section-number">4.4.3</span> Gamma distribution: two parameters (shape and scale)</h3>
<p>Now we are getting to know a new distribution that we haven’t seen before. The gamma distribution is an extension of the (one-parameter) exponential distribution, but it has two parameters, which makes it more flexible. It is often useful as a building block for the upper level of a hierarchical model. The gamma distribution is positive-valued and continuous. While the density of the exponential has its maximum at zero and then simply decreases towards 0 as the value goes to infinity, the density of the gamma distribution has its maximum at some finite value. Let’s explore it by simulation examples. The histograms in <a href="#fig-gammahist1" class="quarto-xref">Figure&nbsp;<span>4.20</span></a> were generated by the following lines of code:</p>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rgamma</span>(<span class="dv">10000</span>, <span class="at">shape =</span> <span class="dv">2</span>, <span class="at">rate =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)),</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill=</span> <span class="st">"purple"</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rgamma</span>(<span class="dv">10000</span>, <span class="at">shape =</span> <span class="dv">10</span>, <span class="at">rate =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">2</span>)),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill=</span> <span class="st">"purple"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-gammahist1" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-gammahist1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="quarto-layout-row page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-gammahist1" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-gammahist1-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-gammahist1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-gammahist1-1.png" class="lightbox" data-gallery="fig-gammahist1" title="Figure&nbsp;4.20&nbsp;(a): gamma(2,\frac{1}{3})"><img src="04-chap_files/figure-html/fig-gammahist1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-ref-parent="fig-gammahist1" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-gammahist1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) gamma<span class="math inline">\((2,\frac{1}{3})\)</span>
</figcaption>
</figure>
</div>
</div></div></div>
<div class="quarto-layout-row page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-gammahist1" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-gammahist1-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-gammahist1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-gammahist1-2.png" class="lightbox" data-gallery="fig-gammahist1" title="Figure&nbsp;4.20&nbsp;(b): gamma(10,\frac{3}{2})"><img src="04-chap_files/figure-html/fig-gammahist1-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-ref-parent="fig-gammahist1" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-gammahist1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) gamma<span class="math inline">\((10,\frac{3}{2})\)</span>
</figcaption>
</figure>
</div>
</div></div></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gammahist1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.20: Histograms of random samples of gamma distributions. The gamma is a flexible two parameter distribution: <a href="http://en.wikipedia.org/wiki/Gamma_distribution">see Wikipedia</a>.
</figcaption>
</figure>
</div>
<section id="sec:gammapoisson" class="level4 unnumbered page-columns page-full">
<h4 class="unnumbered anchored" data-anchor-id="sec:gammapoisson">Gamma–Poisson mixture: a hierarchical model</h4>
<ol type="1">
<li><p>Generate a set of parameters: <span class="math inline">\(\lambda_1,\lambda_2,...\)</span> from a gamma distribution.</p></li>
<li><p>Use these to generate a set of Poisson(<span class="math inline">\(\lambda_i\)</span>) random variables, one for each <span class="math inline">\(\lambda_1\)</span>.</p></li>
</ol>
<!-- -->
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">=</span> <span class="fu">rgamma</span>(<span class="dv">10000</span>, <span class="at">shape =</span> <span class="dv">10</span>, <span class="at">rate =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>gp <span class="ot">=</span> <span class="fu">rpois</span>(<span class="fu">length</span>(lambda), <span class="at">lambda =</span> lambda)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">x =</span> gp), <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill=</span> <span class="st">"purple"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-generatepoissongamma" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-generatepoissongamma-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-generatepoissongamma-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-26" title="Figure&nbsp;4.21: Histogram of gp, generated via a gamma-Poisson hierachical model."><img src="04-chap_files/figure-html/fig-generatepoissongamma-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-generatepoissongamma-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.21: Histogram of <code>gp</code>, generated via a gamma-Poisson hierachical model.
</figcaption>
</figure>
</div>
</div></div></div>
<p>The resulting values are said to come from a gamma–Poisson mixture. <a href="#fig-generatepoissongamma" class="quarto-xref">Figure&nbsp;<span>4.21</span></a> shows the histogram of <code>gp</code>.</p>
<div id="wrn-mixtures-distfit" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.18
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="a">
<li>Are the values generated from such a gamma–Poisson mixture continuous or discrete ?<br>
</li>
<li>What is another name for this distribution? Hint: Try the different distributions provided by the <code>goodfit</code> function from the <strong><a href="https://cran.r-project.org/web/packages/vcd/">vcd</a></strong> package.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-31-contents" aria-controls="callout-31" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-31" class="callout-31-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"vcd"</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>ofit <span class="ot">=</span> <span class="fu">goodfit</span>(gp, <span class="st">"nbinomial"</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ofit, <span class="at">xlab =</span> <span class="st">""</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>ofit<span class="sc">$</span>par</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$size
[1] 9.911829

$prob
[1] 0.5963857</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-goofy" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-goofy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-goofy-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-27" title="Figure&nbsp;4.22: Goodness of fit plot. The rootogram shows the theoretical probabilities of the gamma-Poisson distribution (a.k.a. negative binomial) as red dots and the square roots of the observed frequencies as the height of the rectangular bars. The bars all end close to the horizontal axis, which indicates a good fit to the negative binomial distribution."><img src="04-chap_files/figure-html/fig-goofy-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-goofy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.22: Goodness of fit plot. The <strong>rootogram</strong> shows the theoretical probabilities of the gamma-Poisson distribution (a.k.a. negative binomial) as red dots and the square roots of the observed frequencies as the height of the rectangular bars. The bars all end close to the horizontal axis, which indicates a good fit to the negative binomial distribution.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>In R, and in some other places, the gamma-Poisson distribution travels under the alias name of <strong>negative binomial distribution</strong>. The two names are synonyms; the second one alludes to the fact that <a href="#eq-mixtures-eqmix-defnb" class="quarto-xref">Equation&nbsp;<span>4.15</span></a> bears some formal similarities to the probabilities of a binomial distribution. The first name, gamma–Poisson distribution, is more indicative of its generating mechanism, and that’s what we will use in the rest of the book. It is a discrete distribution, that means that it takes values only on the natural numbers (in contrast to the gamma distribution, which covers the whole positive real axis). Its probability distribution is</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-eqmix-defnb"><span class="math display">\[
\text{P}(K=k)=\left(\begin{array}{c}k+a-1\\k\end{array}\right) \, p^a \, (1-p)^k,
\tag{4.15}\]</span></span></p>
<p>which depends on the two parameters <span class="math inline">\(a\in\mathbb{R}^+\)</span> and <span class="math inline">\(p\in[0,1]\)</span>. Equivalently, the two parameters can be expressed by the mean <span class="math inline">\(\mu=pa/(1-p)\)</span> and a parameter called the <strong>dispersion</strong> <span class="math inline">\(\alpha=1/a\)</span>. The variance of the distribution depends on these parameters, and is <span class="math inline">\(\mu+\alpha\mu^2\)</span>.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-mixtures-dgammapois" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-cap-location="margin" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-mixtures-dgammapois-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-mixtures-dgammapois-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-28" title="Figure&nbsp;4.23: Visualization of the hierarchical model that generates the gamma-Poisson distribution. The top panel shows the density of a gamma distribution with mean 50 (vertical black line) and variance 30. Assume that in one particular experimental replicate, the value 60 is realized. This is our latent variable. The observable outcome is distributed according to the Poisson distribution with that rate parameter, shown in the middle panel. In one particular experiment the outcome may be, say, 55, indicated by the dashed green line. Overall, if we repeat these two subsequent random process many times, the outcomes will be distributed as shown in the bottom panel – the gamma-Poisson distribution."><img src="04-chap_files/figure-html/fig-mixtures-dgammapois-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-mixtures-dgammapois-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.23: Visualization of the hierarchical model that generates the gamma-Poisson distribution. The top panel shows the density of a gamma distribution with mean 50 (vertical black line) and variance 30. Assume that in one particular experimental replicate, the value 60 is realized. This is our latent variable. The observable outcome is distributed according to the Poisson distribution with that rate parameter, shown in the middle panel. In one particular experiment the outcome may be, say, 55, indicated by the dashed green line. Overall, if we repeat these two subsequent random process many times, the outcomes will be distributed as shown in the bottom panel – the gamma-Poisson distribution.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="wrn-mixtures-mathnb" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.19
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you are more interested in analytical derivations than illustrative simulations, try writing out the mathematical derivation of the gamma-Poisson probability distribution.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-33-contents" aria-controls="callout-33" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-33" class="callout-33-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Recall that the final distribution is the result of a two step process:</p>
<ol type="1">
<li>Generate a <span class="math inline">\(\text{gamma}(a,b)\)</span> distributed number, call it <span class="math inline">\(x\)</span>, from the density</li>
</ol>
<p><span class="anchored-eq" data-anchor-id="eq-jeqvwlfnabxs" id="eq-jeqvwlfnabxs"><span class="math display">\[
f_\Gamma(x, a, b)=\frac{b^a}{\Gamma(a)}\,x^{a-1}\,e^{-b x},
\tag{4.16}\]</span></span></p>
<p>where <span class="math inline">\(\Gamma\)</span> is the so-called <span class="math inline">\(\Gamma\)</span>-function, <span class="math inline">\(\Gamma(a)=\int_0^\infty x^{a-1}\,e^{-x}\,\text{d}x\)</span> (not to be confused with the gamma distribution, even though there is this incidental relation).</p>
<ol start="2" type="1">
<li>Generate a number <span class="math inline">\(k\)</span> from the Poisson distribution with rate <span class="math inline">\(x\)</span>. The probability distribution is</li>
</ol>
<p><span class="math display">\[
f_{\text{Pois}}(k, \lambda=x)=\frac{x^{k}e^{-x}}{k!}
\]</span></p>
<p>If <span class="math inline">\(x\)</span> only took on a finite set of values, we could solve the problem simply by summing over all the possible cases, each weighted by their probability according to <span class="math inline">\(f_\Gamma\)</span>. But <span class="math inline">\(x\)</span> is continuous, so we have to write the sum out as an integral instead of a discrete sum. We call the distribution of <span class="math inline">\(K\)</span> the marginal. Its probability mass function is</p>
<p><span class="math display">\[
\begin{aligned}
P(K=k)&amp;=&amp;\int_{x=0}^{\infty} \, f_{\text{Pois}}(k, \lambda=x)\; f_\Gamma(x, a, b) \;dx\\
&amp;=&amp; \int_{x=0}^{\infty} \frac{x^{k}e^{-x}}{k!}\;\frac{b^a}{\Gamma(a)} x^{a-1}e^{-bx}\; dx
\end{aligned}
\]</span></p>
<p>Collect terms and move terms independent of <span class="math inline">\(x\)</span> outside the integral</p>
<p><span class="math display">\[
P(K=k)=\frac{b^a}{\Gamma(a)\,k!} \int_{x=0}^{\infty} x^{k+a-1}e^{-(b+1)x} dx
\]</span></p>
<p>Because we know the gamma density sums to one: <span class="math inline">\(\int_0^\infty x^{k+a-1}e^{-(b+1)x} dx = \frac{\Gamma(k+a)}{(b+1)^{k+a}}\)</span></p>
<p><span class="math display">\[
\begin{aligned}
P(K=k)
&amp;=&amp;\frac{\Gamma(k+a)}{\Gamma(a)\Gamma(k+1)}\frac{b^a}{(b+1)^{a}(b+1)^k}
={k+a-1\choose k}\left(\frac{b}{b+1}\right)^a\left(1-\frac{b}{b+1}\right)^k
\end{aligned}
\]</span></p>
<p>where in the last line we used that <span class="anchored-eq" data-anchor-id="eq-mixtures" class="math inline">\(\Gamma(v+1)=v!\)</span>. This is the same as Equation (<a href="#eq-mixtures-eqmix-defnb" class="quarto-xref"><span>4.15</span></a>), the gamma-Poisson with size parameter <span class="math inline">\(a\)</span> and probability <span class="math inline">\(p=\frac{b}{b+1}\)</span>.</p>
</div>
</div>
</div>
</section>
</section>
<section id="sec-mixtures-vst" class="level3 page-columns page-full" data-number="4.4.4">
<h3 data-number="4.4.4" class="anchored" data-anchor-id="sec-mixtures-vst"><span class="header-section-number">4.4.4</span> Variance stabilizing transformations</h3>
<div class="page-columns page-full"><p>A key issue we need to control when we analyse experimental data is how much variability there is between repeated measurements of the same underlying true value, i.e., between replicates. This will determine whether and how well we can see any true differences, i.e., between different conditions. Data that arise through the type of hierarchical models we have studied in this chapter often turn out to have very heterogeneous variances, and this can be a challenge. We will see how in such cases <strong>variance-stabilizing transformations</strong> <span class="citation" data-cites="Anscombe1948">(<a href="16-chap.html#ref-Anscombe1948" role="doc-biblioref">Anscombe 1948</a>)</span> can help. Let’s start with a series of Poisson variables with rates from 10 to 100:</p><div class="no-row-height column-margin column-container"><span class="margin-aside">Note how we construct the dataframe (or, more precisely, the <em>tibble</em>) <code>simdat</code>: the output of the <code>lapply</code> loop is a list of <em>tibble</em>s, one for each value of <code>lam</code>. With the pipe operator <code>|&gt;</code> we send it to the function <code>bind_rows</code> (from the <strong><a href="https://cran.r-project.org/web/packages/dplyr/">dplyr</a></strong> package). The result is a dataframe of all the list elements neatly stacked on top of each other.</span></div></div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">10</span>), <span class="cf">function</span>(lam)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">n =</span> <span class="fu">rpois</span>(<span class="dv">200</span>, <span class="at">lambda =</span> lam),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">sqrt(n)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sqrt</span>(n),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">lambda =</span> lam)) <span class="sc">|&gt;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">!</span>lambda)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simdat, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(lambda), <span class="at">y =</span> value)) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="fu">expression</span>(lambda)) <span class="sc">+</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>() <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(name), <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-seriesofpoisson" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-seriesofpoisson-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-seriesofpoisson-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-29" title="Figure&nbsp;4.24: Poisson distributed measurement data, for eight different choices of the mean lambda. In the upper panel, the y-axis is proportional to the data; in the lower panel, it is on a square-root scale. Note how the distribution widths change in the first case, but less so in the second."><img src="04-chap_files/figure-html/fig-seriesofpoisson-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="240"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-seriesofpoisson-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.24: Poisson distributed measurement data, for eight different choices of the mean <code>lambda</code>. In the upper panel, the <span class="math inline">\(y\)</span>-axis is proportional to the data; in the lower panel, it is on a square-root scale. Note how the distribution widths change in the first case, but less so in the second.
</figcaption>
</figure>
</div>
</div></div></div>
<div class="page-columns page-full"><p>The data that we see in the upper panel of <a href="#fig-seriesofpoisson" class="quarto-xref">Figure&nbsp;<span>4.24</span></a> are an example of what is called <strong>heteroscedasticity</strong>: the standard deviations (or, equivalently, the variance) of our data is different in different regions of our data space. In particular, it increases along the <span class="math inline">\(x\)</span>-axis, with the mean. For the Poisson distribution, we indeed know that the standard deviation is the square root of the mean; for other types of data, there may be other dependencies. This can be a problem if we want to apply subsequent analysis techniques (for instance, regression, or a statistical test) that are based on assuming that the variances are the same. In <a href="#fig-seriesofpoisson" class="quarto-xref">Figure&nbsp;<span>4.24</span></a>, the numbers of replicates for each value of lambda are quite large. In practice, this is not always the case. Moreover, the data are usually not explicitly stratified by a known mean as in our simulation, so the heteroskedasticity may be harder to see, even though it is there. However, as we see in the lower panel of <a href="#fig-seriesofpoisson" class="quarto-xref">Figure&nbsp;<span>4.24</span></a>, if we simply apply the square root transformation, then the transformed variables will have approximately the same variance. This works even if we do not know the underlying mean for each observation, the square root transformation does not need this information. We can verify this more quantitatively, as in the following code, which shows the standard deviations of the sampled values <code>n</code> and <code>sqrt(n)</code> for the difference choices of <code>lambda</code>.</p><div class="no-row-height column-margin column-container"><span class="margin-aside">The standard deviation of the square root transformed values is consistently around 0.5, so we would use the transformation <code>2*sqrt(n)</code> to achieve unit variance.</span></div></div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise</span>(<span class="fu">group_by</span>(simdat, name, lambda), <span class="fu">sd</span>(value)) <span class="sc">|&gt;</span> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">values_from =</span> <span class="st">`</span><span class="at">sd(value)</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   lambda     n `sqrt(n)`
    &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
 1     10  2.95     0.478
 2     20  4.19     0.470
 3     30  5.62     0.521
 4     40  5.99     0.473
 5     50  7.69     0.546
 6     60  7.59     0.492
 7     70  8.69     0.520
 8     80  8.99     0.505
 9     90  9.44     0.498
10    100  9.84     0.495</code></pre>
</div>
</div>
<p>Another example, now using the gamma-Poisson distribution, is shown in <a href="#fig-seriesofnb" class="quarto-xref">Figure&nbsp;<span>4.25</span></a>. We generate gamma-Poisson variables <code>u</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> and plot the 95% confidence intervals around the mean.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;To catch a greater range of values for the mean value <code>mu</code>, without creating too dense a sequence, we use a geometric series: <span class="math inline">\(\mu_{i+1} = 2\mu_i\)</span>.</p></div></div><div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>muvalues <span class="ot">=</span> <span class="dv">2</span><span class="sc">^</span><span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>simgp <span class="ot">=</span> <span class="fu">lapply</span>(muvalues, <span class="cf">function</span>(mu) {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">=</span> <span class="fu">rnbinom</span>(<span class="at">n =</span> <span class="fl">1e4</span>, <span class="at">mu =</span> mu, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">mean =</span> <span class="fu">mean</span>(u), <span class="at">sd =</span> <span class="fu">sd</span>(u),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">lower =</span> <span class="fu">quantile</span>(u, <span class="fl">0.025</span>),</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper =</span> <span class="fu">quantile</span>(u, <span class="fl">0.975</span>),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">mu =</span> mu)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  } ) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">as.data.frame</span>(simgp), <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    mean       sd lower upper mu
1 0.9965 1.106440     0     4  1
2 2.0233 1.748503     0     6  2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simgp, <span class="fu">aes</span>(<span class="at">x =</span> mu, <span class="at">y =</span> mean, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper)) <span class="sc">+</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_errorbar</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-seriesofnb" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-seriesofnb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-seriesofnb-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-30" title="Figure&nbsp;4.25: gamma-Poisson distributed measurement data, for a range of \mu from 1 to 1024."><img src="04-chap_files/figure-html/fig-seriesofnb-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="240"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-seriesofnb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.25: gamma-Poisson distributed measurement data, for a range of <span class="math inline">\(\mu\)</span> from 1 to 1024.
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-mixtures-nbtransform" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.20
</div>
</div>
<div class="callout-body-container callout-body">
<p>How can we find a transformation for these data that stabilizes the variance, similar to the square root function for the Poisson distributed data?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-35-contents" aria-controls="callout-35" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-35" class="callout-35-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>If we divide the values that correspond to <code>mu[1]</code> (and which are centered around <code>simgp$mean[1]</code>) by their standard deviation <code>simgp$sd[1]</code>, the values that correspond to <code>mu[2]</code> (and which are centered around <code>simgp$mean[2]</code>) by their standard deviation <code>simgp$sd[2]</code>, and so on, then the resulting values will have, by construction, a standard deviation (and thus variance) of 1. And rather than defining 11 separate transformations, we can achieve our goal by defining one single piecewise linear <em>and</em> continuous function that has the appropriate slopes at the appropriate values.</p>
</div>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>simgp <span class="ot">=</span> <span class="fu">mutate</span>(simgp,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">slopes =</span> <span class="dv">1</span> <span class="sc">/</span> sd,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">trsf   =</span> <span class="fu">cumsum</span>(slopes <span class="sc">*</span> mean))</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simgp, <span class="fu">aes</span>(<span class="at">x =</span> mean, <span class="at">y =</span> trsf)) <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-pcwlin-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pcwlin-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-pcwlin-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-31" title="Figure&nbsp;4.26: Piecewise linear function that stabilizes the variance of the data in Figure&nbsp;fig-seriesofnb."><img src="04-chap_files/figure-html/fig-pcwlin-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="240"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pcwlin-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.26: Piecewise linear function that stabilizes the variance of the data in <a href="#fig-seriesofnb" class="quarto-xref">Figure&nbsp;<span>4.25</span></a>.
</figcaption>
</figure>
</div>
</div></div></div>
<p>We see in <a href="#fig-pcwlin-1" class="quarto-xref">Figure&nbsp;<span>4.26</span></a> that this function has some resemblance to a square root function in particular at its lower end. At the upper end, it seems to look more like a logarithm. The more mathematically inclined will see that an elegant extension of these numerical calculations can be done through a little calculus known as the <strong>delta method</strong>, as follows.</p>
<p>Call our transformation function <span class="math inline">\(g\)</span>, and assume it’s differentiable (that’s not a very strong assumption: pretty much any function that we might consider reasonable here is differentiable). Also call our random variables <span class="math inline">\(X_i\)</span>, with means <span class="math inline">\(\mu_i\)</span> and variances <span class="math inline">\(v_i\)</span>, and we assume that <span class="math inline">\(v_i\)</span> and <span class="math inline">\(\mu_i\)</span> are related by a functional relationship <span class="math inline">\(v_i = v(\mu_i)\)</span>. Then, for values of <span class="math inline">\(X_i\)</span> in the neighborhood of its mean <span class="math inline">\(\mu_i\)</span>,</p>
<p><span class="anchored-eq" data-anchor-id="eq-vntodgbfqzyu" id="eq-vntodgbfqzyu"><span class="math display">\[
g(X_i) = g(\mu_i) + g'(\mu_i) (X_i-\mu_i) + ...
\tag{4.17}\]</span></span></p>
<p>where the dots stand for higher order terms that we can neglect. The variances of the transformed values are then</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-eqvarmean"><span class="math display">\[
\begin{align}
\text{Var}(g(X_i)) &amp;\simeq g'(\mu_i)^2\\
\text{Var}(X_i) &amp;= g'(\mu_i)^2 \, v(\mu_i),
\end{align}
\tag{4.18}\]</span></span></p>
<p>where we have used the rules <span class="math inline">\(\text{Var}(X-c)=\text{Var}(X)\)</span> and <span class="math inline">\(\text{Var}(cX)=c^2\,\text{Var}(X)\)</span> that hold whenever <span class="math inline">\(c\)</span> is a constant number. Requiring that this be constant leads to the differential equation</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-diffeqvst"><span class="math display">\[
g'(x) = \frac{1}{\sqrt{v(x)}}.
\tag{4.19}\]</span></span></p>
<p>For a given mean-variance relationship <span class="math inline">\(v(\mu)\)</span>, we can solve this for the function <span class="math inline">\(g\)</span>. Let’s check this for some simple cases:</p>
<ul>
<li><p>if <span class="math inline">\(v(\mu)=\mu\)</span> (Poisson), we recover <span class="math inline">\(g(x)=\sqrt{x}\)</span>, the square root transformation.</p></li>
<li><p>If <span class="anchored-eq" data-anchor-id="eq-mixtures" class="math inline">\(v(\mu)=\alpha\,\mu^2\)</span>, solving the differential equation <a href="#eq-mixtures-diffeqvst" class="quarto-xref"><span>4.19</span></a> gives <span class="math inline">\(g(x)=\log(x)\)</span>. This explains why the logarithm transformation is so popular in many data analysis applications: it acts as a variance stabilizing transformation whenever the data have a constant coefficient of variation, that is, when the standard deviation is proportional to the mean.</p></li>
</ul>
<div id="wrn-mixtures-otherdelta" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;4.21
</div>
</div>
<div class="callout-body-container callout-body">
<p>What is the variance-stabilizing transformation associated with <span class="math inline">\(v(\mu) = \mu + \alpha\,\mu^2\)</span>?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-37-contents" aria-controls="callout-37" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-37" class="callout-37-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>To solve the differential equation <a href="#eq-mixtures-diffeqvst" class="quarto-xref"><span>4.19</span></a> with this function <span class="math inline">\(v(\cdot)\)</span>, we need to compute the integral</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-diffeqvstgammapoisson"><span class="math display">\[\label{eq:}
\int \frac{dx}{\sqrt{x + \alpha x^2}}.
\tag{4.20}\]</span></span></p>
<p>A closed form expression can be looked up in a reference table such as <span class="citation" data-cites="BronsteinSemendjajew">(<a href="16-chap.html#ref-BronsteinSemendjajew" role="doc-biblioref">Bronštein and Semendjajew 1979</a>)</span>. These authors provide the general solution</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-bronstein"><span class="math display">\[
\int \frac{dx}{\sqrt{ax^2+bx+c}} = \frac{1}{\sqrt{a}}
\ln\left(2\sqrt{a(ax^2+bx+c)}+2ax+b\right) + \text{const.},
\tag{4.21}\]</span></span></p>
<p>into which we can plug in our special case <span class="math inline">\(a=\alpha\)</span>, <span class="math inline">\(b=1\)</span>, <span class="math inline">\(c=0\)</span>, to obtain the variance-stabilizing transformation</p>
<p><span class="anchored-eq" data-anchor-id="eq-mixtures" id="eq-mixtures-vstgammapoisson"><span class="math display">\[
\begin{align}
g_\alpha(x)
&amp;= \frac{1}{2\sqrt{\alpha}}
   \ln\left(2\sqrt{\alpha x (\alpha x+1)} + 2\alpha x + 1\right) \\
&amp;= \frac{1}{2\sqrt{\alpha}}
   {\displaystyle \operatorname {arcosh}} (2\alpha x+1).\\
\end{align}
\tag{4.22}\]</span></span></p>
<p>For the second line in <a href="#eq-mixtures-vstgammapoisson" class="quarto-xref">Equation&nbsp;<span class="anchored-eq" data-anchor-id="eq-mixtures">4.22</span></a>, we used the identity <span class="math inline">\({\displaystyle \operatorname {arcosh}}(z) = \ln\left(z+\sqrt{z^2-1}\right)\)</span>. In the limit of <span class="math inline">\(\alpha\to0\)</span>, we can use the linear approximation <span class="math inline">\(\ln(1+\varepsilon)=\varepsilon+O(\varepsilon^2)\)</span> to see that <span class="math inline">\(g_0(x)=\sqrt{x}\)</span>. Note that if <span class="math inline">\(g_\alpha\)</span> is a variance-stabilizing transformation, then so is <span class="math inline">\(ug_\alpha+v\)</span> for any pair of numbers <span class="math inline">\(u\)</span> and <span class="math inline">\(v\)</span>, and we have used this freedom to insert an extra factor <span class="math inline">\(\frac{1}{2}\)</span> for reasons that become apparent in the following. You can verify that the function <span class="math inline">\(g_\alpha\)</span> from <a href="#eq-mixtures-vstgammapoisson" class="quarto-xref">Equation&nbsp;<span>4.22</span></a> fulfills condition <a href="#eq-mixtures-diffeqvst" class="quarto-xref"><span>4.19</span></a> by computing its derivative, which is an elementary calculation. We can plot it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">=</span> <span class="cf">function</span>(x, a) </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span> (a<span class="sc">==</span><span class="dv">0</span>, </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(x), </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span>(<span class="dv">2</span><span class="sc">*</span><span class="fu">sqrt</span>(a) <span class="sc">*</span> <span class="fu">sqrt</span>(x<span class="sc">*</span>(a<span class="sc">*</span>x<span class="sc">+</span><span class="dv">1</span>)) <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>a<span class="sc">*</span>x<span class="sc">+</span><span class="dv">1</span>) <span class="sc">/</span> (<span class="dv">2</span><span class="sc">*</span><span class="fu">sqrt</span>(a)))</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>x  <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.05</span><span class="sc">*</span><span class="dv">2</span><span class="sc">^</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>)), <span class="cf">function</span>(a) </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> x, <span class="at">a =</span> a, <span class="at">y =</span> <span class="fu">f</span>(x, a))) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">col =</span> <span class="fu">factor</span>(a))) <span class="sc">+</span> </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">col =</span> <span class="fu">expression</span>(alpha))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plotvstgammapoisson-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plotvstgammapoisson-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-plotvstgammapoisson-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-32" title="Figure&nbsp;4.27: Graph of the function Equation&nbsp;eq-mixtures-vstgammapoisson for different choices of \alpha."><img src="04-chap_files/figure-html/fig-plotvstgammapoisson-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plotvstgammapoisson-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.27: Graph of the function <a href="#eq-mixtures-vstgammapoisson" class="quarto-xref">Equation&nbsp;<span>4.22</span></a> for different choices of <span class="math inline">\(\alpha\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>and empirically verify the equivalence of two terms in <a href="#eq-mixtures-vstgammapoisson" class="quarto-xref">Equation&nbsp;<span>4.22</span></a>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">=</span> <span class="cf">function</span>(x, a) <span class="fu">ifelse</span> (a<span class="sc">==</span><span class="dv">0</span>, <span class="fu">sqrt</span>(x), <span class="fu">acosh</span>(<span class="dv">2</span><span class="sc">*</span>a<span class="sc">*</span>x <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">/</span> (<span class="dv">2</span><span class="sc">*</span><span class="fu">sqrt</span>(a)))  </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(df, <span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">f2</span>(x,a) <span class="sc">-</span> y)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8.881784e-16</code></pre>
</div>
</div>
<p>As we see in <a href="#fig-plotvstgammapoisson-1" class="quarto-xref">Figure&nbsp;<span>4.27</span></a>, for small values of <span class="math inline">\(x\)</span>, <span class="math inline">\(g_\alpha(x)\approx \sqrt{x}\)</span> (independently of <span class="math inline">\(\alpha\)</span>), whereas for large values (<span class="math inline">\(x\to\infty\)</span>) and <span class="math inline">\(\alpha&gt;0\)</span>, it behaves like a logarithm:</p>
<p><span class="math display">\[
\begin{align}
&amp;\frac{1}{2\sqrt{\alpha}}\ln\left(2\sqrt{\alpha\left(\alpha x^2+x\right)}+2\alpha x+1\right)\\
\approx&amp;\frac{1}{2\sqrt{\alpha}} \ln\left(2\sqrt{\alpha^2x^2}+2\alpha x\right)\\
=&amp;\frac{1}{2\sqrt{\alpha}}\ln\left(4\alpha x\right)\\
=&amp;\frac{1}{2\sqrt{\alpha}}\ln x+\text{const.}
\end{align}
\]</span></p>
<p>We can verify this empirically by, say,</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">f</span>(<span class="fl">1e6</span>, a) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15.196731 10.259171  7.600903</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span><span class="fu">sqrt</span>(a)) <span class="sc">*</span> (<span class="fu">log</span>(<span class="fl">1e6</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="dv">4</span><span class="sc">*</span>a))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15.196728 10.259170  7.600902</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="summary-of-this-chapter" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="summary-of-this-chapter"><span class="header-section-number">4.5</span> Summary of this chapter</h2>
<p>We have given motivating examples and ways of using mixtures to model biological data. We saw how the EM algorithm is an interesting example of fitting a difficult-to-estimate probabilistic model to data by iterating between partial, simpler problems.</p>
<section id="finite-mixture-models" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="finite-mixture-models">Finite mixture models</h4>
<p>We have seen how to model mixtures of two or more normal distributions with different means and variances. We have seen how to decompose a given sample of data from such a mixture, even without knowing the latent variable, using the EM algorithm. The EM approach requires that we know the parametric form of the distributions and the number of components. In <a href="05-chap.html" class="quarto-xref"><span>Chapter 5</span></a>, we will see how we can find groupings in data even without relying on such information – this is then called clustering. We can keep in mind that there is a strong conceptual relationship between clustering and mixture modeling.</p>
</section>
<section id="common-infinite-mixture-models" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="common-infinite-mixture-models">Common infinite mixture models</h4>
<p>Infinite mixture models are good for constructing new distributions (such as the gamma-Poisson or the Laplace) out of more basic ones (such as binomial, normal, Poisson). Common examples are</p>
<ul>
<li><p>mixtures of normals (often with a hierarchical model on the means and the variances);</p></li>
<li><p>beta-binomial mixtures – where the probability <span class="math inline">\(p\)</span> in the binomial is generated according to a <span class="math inline">\(\text{beta}(a, b)\)</span> distribution;</p></li>
<li><p>gamma-Poisson for read counts (see <a href="08-chap.html" class="quarto-xref"><span>Chapter 8</span></a>);</p></li>
<li><p>gamma-exponential for PCR.</p></li>
</ul>
</section>
<section id="applications" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="applications">Applications</h4>
<p>Mixture models are useful whenever there are several layers of experimental variability. For instance, at the lowest layer, our measurement precision may be limited by basic physical detection limits, and these may be modeled by a Poisson distribution in the case of a counting-based assay, or a normal distribution in the case of the continuous measurement. On top of there may be one (or more) layers of instrument-to-instrument variation, variation in the reagents, operator variaton etc.</p>
<p>Mixture models reflect that there is often heterogeneous amounts of variability (variances) in the data. In such cases, suitable data transformations, i.e., variance stabilizing transformations, are necessary before subsequent visualization or analysis. We’ll study in depth an example for RNA-Seq in <a href="08-chap.html" class="quarto-xref"><span>Chapter 8</span></a>, and this also proves useful in the normalization of next generation reads in microbial ecology <span class="citation" data-cites="mcmurdie2014">(<a href="16-chap.html#ref-mcmurdie2014" role="doc-biblioref">McMurdie and Holmes 2014</a>)</span>.</p>
<p>Another important application of mixture modeling is the two-component model in multiple testing – we will come back to this in <a href="06-chap.html" class="quarto-xref"><span>Chapter 6</span></a>.</p>
</section>
<section id="the-ecdf-and-bootstrapping" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="the-ecdf-and-bootstrapping">The ECDF and bootstrapping</h4>
<p>We saw that by using the observed sample as a mixture we could generate many simulated samples that inform us about the sampling distribution of an estimate. This method is called the bootstrap and we will return to it several times, as it provides a way of evaluating estimates even when a closed form expression is not available (we say it is non-parametric).</p>
</section>
</section>
<section id="further-reading" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="further-reading"><span class="header-section-number">4.6</span> Further reading</h2>
<p>A useful book-long treatment of finite mixture models is by <span class="citation" data-cites="mclachlan2004">McLachlan and Peel (<a href="16-chap.html#ref-mclachlan2004" role="doc-biblioref">2004</a>)</span>; for the EM algorithm, see also the book by <span class="citation" data-cites="mclachlan2007algorithm">McLachlan and Krishnan (<a href="16-chap.html#ref-mclachlan2007algorithm" role="doc-biblioref">2007</a>)</span>. A recent book that presents all EM type algorithms within the Majorize-Minimization (MM) framework is by <span class="citation" data-cites="lange2016mm">Lange (<a href="16-chap.html#ref-lange2016mm" role="doc-biblioref">2016</a>)</span>.</p>
<p>There are in fact mathematical reasons why many natural phenomena can be seen as mixtures: this occurs when the observed events are exchangeable (the order in which they occur doesn’t matter). The theory underlying this is quite mathematical, a good way to start is to look at the Wikipedia entry and the paper by <span class="citation" data-cites="diaconis1980finite">Diaconis and Freedman (<a href="16-chap.html#ref-diaconis1980finite" role="doc-biblioref">1980</a>)</span>.</p>
<p>In particular, we use mixtures for high-throughput data. You will see examples in Chapters <a href="08-chap.html" class="quarto-xref"><span>8</span></a> and <a href="11-chap.html" class="quarto-xref"><span>11</span></a>.</p>
<p>The bootstrap can be used in many situations and is a very useful tool to know about, a friendly treatment is given in <span class="citation" data-cites="efront">(<a href="16-chap.html#ref-efront" role="doc-biblioref">B. Efron and Tibshirani 1993</a>)</span>.</p>
<p>A historically interesting paper is the original article on variance stabilization by <span class="citation" data-cites="Anscombe1948">Anscombe (<a href="16-chap.html#ref-Anscombe1948" role="doc-biblioref">1948</a>)</span>, who proposed ways of making variance stabilizing transformations for Poisson and gamma-Poisson random variables. Variance stabilization is explained using the delta method in many standard texts in theoretical statistics, e.g., those by <span class="citation" data-cites="Rice:2007">Rice (<a href="16-chap.html#ref-Rice:2007" role="doc-biblioref">2006, chap. 6</a>)</span> and <span class="citation" data-cites="Kery2015">Kéry and Royle (<a href="16-chap.html#ref-Kery2015" role="doc-biblioref">2015, 35</a>)</span>.</p>
<p><span class="citation" data-cites="Kery2015">Kéry and Royle (<a href="16-chap.html#ref-Kery2015" role="doc-biblioref">2015</a>)</span> provide a nice exploration of using R to build hierarchical models for abundance estimation in niche and spatial ecology.</p>
</section>
<section id="exercises" class="level2 page-columns page-full" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="exercises"><span class="header-section-number">4.7</span> Exercises</h2>
<div id="imp-mixtures-emstepbystep" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;4.1
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>The EM algorithm step by step.</strong> As an example dataset, we use the values in the file <code>Myst.rds</code>. As always, it is a good idea to first visualize the data. The histogram is shown in <a href="#fig-EMillustrate-1" class="quarto-xref">Figure&nbsp;<span>4.28</span></a>. We are going to model these data as a mixture of two normal distributions with unknown means and standard deviations, and unknown mixture fraction. We’ll call the two components A and B.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>mx <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="st">"../data/Myst.rds"</span>)<span class="sc">$</span>yvar</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(mx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:1800] 0.3038 0.0596 -0.0204 0.1849 0.2842 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(mx), <span class="fu">aes</span>(<span class="at">x =</span> mx)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.025</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<p>We start by randomly assigning the membership weights for each of the values in <code>mx</code> for each of the components</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>wA <span class="ot">=</span> <span class="fu">runif</span>(<span class="fu">length</span>(mx))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>wB <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> wA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also need to set up some housekeeping variables: <code>iter</code> counts over the iterations of the EM algorithm; <code>loglik</code> stores the current log-likelihood; <code>delta</code> stores the change in the log-likelihood from the previous iteration to the current one. We also define the parameters <code>tolerance</code>, <code>miniter</code> and <code>maxiter</code> of the algorithm.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>iter      <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>loglik    <span class="ot">=</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>delta     <span class="ot">=</span> <span class="sc">+</span><span class="cn">Inf</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>tolerance <span class="ot">=</span> <span class="fl">1e-12</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>miniter   <span class="ot">=</span> <span class="dv">50</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>maxiter   <span class="ot">=</span> <span class="dv">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Study the code below and answer the following questions:</p>
<ol type="a">
<li><p>Which lines correspond to the E-step, which to the M-step?</p></li>
<li><p>What is the role of <code>tolerance</code>, <code>miniter</code> and <code>maxiter</code>?</p></li>
<li><p>Compare the result of what we are doing here to the output of the <code>normalmixEM</code> function from the <strong><a href="https://cran.r-project.org/web/packages/mixtools/">mixtools</a></strong> package.</p></li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span>((delta <span class="sc">&gt;</span> tolerance) <span class="sc">&amp;&amp;</span> (iter <span class="sc">&lt;=</span> maxiter) <span class="sc">||</span> (iter <span class="sc">&lt;</span> miniter)) {</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">=</span> <span class="fu">mean</span>(wA)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  muA <span class="ot">=</span> <span class="fu">weighted.mean</span>(mx, wA)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  muB <span class="ot">=</span> <span class="fu">weighted.mean</span>(mx, wB)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  sdA <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">weighted.mean</span>((mx <span class="sc">-</span> muA)<span class="sc">^</span><span class="dv">2</span>, wA))</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  sdB <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">weighted.mean</span>((mx <span class="sc">-</span> muB)<span class="sc">^</span><span class="dv">2</span>, wB))</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  pA   <span class="ot">=</span>    lambda    <span class="sc">*</span> <span class="fu">dnorm</span>(mx, <span class="at">mean =</span> muA, <span class="at">sd =</span> sdA)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  pB   <span class="ot">=</span> (<span class="dv">1</span> <span class="sc">-</span> lambda) <span class="sc">*</span> <span class="fu">dnorm</span>(mx, <span class="at">mean =</span> muB, <span class="at">sd =</span> sdB)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  ptot <span class="ot">=</span> pA <span class="sc">+</span> pB</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  wA   <span class="ot">=</span> pA <span class="sc">/</span> ptot</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>  wB   <span class="ot">=</span> pB <span class="sc">/</span> ptot</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>  loglikOld <span class="ot">=</span> loglik</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>  loglik <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">log</span>(pA <span class="sc">+</span> pB))</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">=</span> <span class="fu">abs</span>(loglikOld <span class="sc">-</span> loglik)</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  iter <span class="ot">=</span> iter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>iter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 447</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(lambda, muA, muB, sdA, sdB)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  0.4756 -0.1694  0.1473  0.0983  0.1498</code></pre>
</div>
</div>
</div>
</div>
<div class="no-row-height column-margin column-container"><div class="cell-output-display callout-margin-content">
<div id="fig-EMillustrate-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-EMillustrate-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-EMillustrate-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-33" title="Figure&nbsp;4.28: Histogram of mx, our example data for the EM algorithm."><img src="04-chap_files/figure-html/fig-EMillustrate-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="200"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-EMillustrate-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.28: Histogram of <code>mx</code>, our example data for the EM algorithm.
</figcaption>
</figure>
</div>
</div></div><div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-39-contents" aria-controls="callout-39" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-39" class="callout-39-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The first five lines in the <code>while</code> loop implement the <em>Maximization step</em>. Given the current values of <code>wA</code> and <code>wB</code>, we estimate the parameters of the mixture model using the maximum-likelihood estimators: the mixture fraction <code>lambda</code> by the mean of <code>wA</code>, and the parameters of the two normal distribution components (<code>muA</code>, <code>sdA</code>) and (<code>muB</code>, <code>sdB</code>) by the sample means and the sample standard deviations. To take into account the membership weights, we use the weighted mean (function <code>weighted.mean</code>) and standard deviation.</p>
<p>Next comes the <em>Expectation step</em>. For each of the elements in the data vector <code>mx</code>, we compute the probability densities <code>pA</code> and <code>pB</code> for the generative distribution models A and B, using the normal density function <code>dnorm</code>, weighted by the mixture fractions <code>lambda</code> and <code>(1-lambda)</code>, respectively. From this, we compute the updated membership weights <code>wA</code> and <code>wB</code>, according to <a href="#eq-mixtures-membershipweights" class="quarto-xref">Equation&nbsp;<span>4.5</span></a>.</p>
<p>Given the membership weights and the parameters, the logarithmic likelihood <code>loglik</code> is easily computed, and the <code>while</code> loop iterates these steps.</p>
<p>The termination criterion for the loop is based on <code>delta</code>, the change in the likelihood. The loop can end if this becomes smaller than <code>tolerance</code>. This is a simple way of checking whether the algorithm has converged. The additional conditions on <code>iter</code> make sure that at least <code>miniter</code> iterations are run, and that the loop always stops after <code>maxiter</code> iterations. The latter is to make sure that the loop terminates in finite time no matter what. (“Professional” implementations of such iterative algorithms typically work a bit harder to decide what is the best time to stop.)</p>
<p>Finally, let’s compare our estimates to those from the function <code>normalmixEM</code> from the <strong><a href="https://cran.r-project.org/web/packages/mixtools/">mixtools</a></strong> package.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>gm <span class="ot">=</span> mixtools<span class="sc">::</span><span class="fu">normalmixEM</span>(mx, <span class="at">k =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>number of iterations= 215 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(gm, <span class="fu">c</span>(lambda[<span class="dv">1</span>], mu, sigma))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  0.4757 -0.1694  0.1473  0.0983  0.1498</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="imp-mixtures-whylog" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;4.2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why do we often consider the logarithm of the likelihood rather than the likelihood? E.g., in the EM code above, why did we work with the probabilities on the logarithmic scale?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-41-contents" aria-controls="callout-41" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-41" class="callout-41-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Likelihoods often (whenever the data points are sampled independently) take the form of a product. This is, for instance, the case in <a href="#eq-mixtures-factorizedlikelihood" class="quarto-xref">Equation&nbsp;<span>4.4</span></a>. Calculating the derivative, for likelihood optimisation, would then require application of the product rule. On the logarithmic scale, the product turns into a sum, and the derivative of a sum is simply the sum of the derivatives of the individual summands.</p>
<p>An additional reason comes from the way computers implement arithmetic. They commonly use a floating point representation of numbers with a finite number of bits. E.g., the IEEE 754-2008 standard uses 64 bits for a <em>double-precision</em> number: 1 bit for the sign, 52 for the mantissa (also called significand), 11 for the exponent. Multiplication between such numbers implies addition of the exponents, but the range of the exponent is only <span class="math inline">\(0\)</span> to <span class="math inline">\(2^{11}-1=2047\)</span>. Even likelihoods that involve only a few hundred data points can lead to arithmetic overflow or other problems with precision. On the logarithmic scale, where the product is a sum, the workload tends to be better distributed between mantissa and exponent, and log-likelihoods even with millions of data points to be handled with reasonable precision.</p>
<p>See also Gregory Gundersen’s post on the <a href="https://gregorygundersen.com/blog/2020/02/09/log-sum-exp/">Log-Sum-Exp Trick for normalizing vectors of log probabilities</a>.</p>
</div>
</div>
</div>
<div id="imp-mixtures-comparenb" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;4.3
</div>
</div>
<div class="callout-body-container callout-body">
<p>Compare the theoretical values of the gamma-Poisson distribution with parameters given by the estimates in <code>ofit$par</code> in <a href="#sec-gammadist" class="quarto-xref"><span>Section 4.4.3</span></a> to the data used for the estimation using a QQ-plot.</p>
</div>
</div>
<div id="imp-mixtures-regressionmixt" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;4.4
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Mixture modeling examples for regression</strong>. The <strong><a href="https://cran.r-project.org/web/packages/flexmix/">flexmix</a></strong> package <span class="citation" data-cites="Grun2012">(<a href="16-chap.html#ref-Grun2012" role="doc-biblioref">Grün, Scharl, and Leisch 2012</a>)</span> enables us to cluster and fit regressions to the data at the same time. The standard M-step <code>FLXMRglm</code> of <strong><a href="https://cran.r-project.org/web/packages/flexmix/">flexmix</a></strong> is an interface to R’s generalized linear modeling facilities (the <code>glm</code> function). Load the package and an example dataset.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"flexmix"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"NPreg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="a">
<li><p>First, plot the data and try to guess how the points were generated.</p></li>
<li><p>Fit a two component mixture model using the commands</p></li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">=</span> <span class="fu">flexmix</span>(yn <span class="sc">~</span> x <span class="sc">+</span> <span class="fu">I</span>(x<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> NPreg, <span class="at">k =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="a">
<li><p>Look at the estimated parameters of the mixture components and make a truth table that cross-classifies true classes versus cluster memberships. What does the summary of the object <code>m1</code> show us?</p></li>
<li><p>Plot the data again, this time coloring each point according to its estimated class.</p></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-44-contents" aria-controls="callout-44" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-44" class="callout-44-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(NPreg, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> yn)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-npreg" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-npreg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-npreg-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-34" title="Figure&nbsp;4.29: The points seem to come from two different generative processes, one is linear; the other quadratic."><img src="04-chap_files/figure-html/fig-npreg-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:33.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-npreg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.29: The points seem to come from two different generative processes, one is linear; the other quadratic.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The components are:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>modeltools<span class="sc">::</span><span class="fu">parameters</span>(m1, <span class="at">component =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      Comp.1
coef.(Intercept) -0.20998685
coef.x            4.81807854
coef.I(x^2)       0.03613061
sigma             3.47665584</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>modeltools<span class="sc">::</span><span class="fu">parameters</span>(m1, <span class="at">component =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     Comp.2
coef.(Intercept) 14.7167886
coef.x            9.8468507
coef.I(x^2)      -0.9683734
sigma             3.4795657</code></pre>
</div>
</div>
<p>The parameter estimates of both components are close to the true values. A cross-tabulation of true classes and cluster memberships can be obtained by</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(NPreg<span class="sc">$</span>class, modeltools<span class="sc">::</span><span class="fu">clusters</span>(m1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   
     1  2
  1 95  5
  2  5 95</code></pre>
</div>
</div>
<p>For our example data, the ratios of both components are approximately 0.7, indicating the overlap of the classes at the cross-section of line and parabola.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The summary shows the estimated prior probabilities <span class="math inline">\(\hat\pi_k\)</span>, the number of observations assigned to the two clusters, the number of observations where <span class="math inline">\(p_{nk}&gt;\delta\)</span> (with a default of <span class="math inline">\(\delta=10^{-4}\)</span>), and the ratio of the latter two numbers. For well-separated components, a large proportion of observations with non-vanishing posteriors <span class="math inline">\(p_{nk}\)</span> should be assigned to their cluster, giving a ratio close to 1.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>NPreg <span class="ot">=</span> <span class="fu">mutate</span>(NPreg, <span class="at">gr =</span> <span class="fu">factor</span>(class))</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(NPreg, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> yn, <span class="at">group =</span> gr)) <span class="sc">+</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> gr, <span class="at">shape =</span> gr)) <span class="sc">+</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">scale_colour_hue</span>(<span class="at">l =</span> <span class="dv">40</span>, <span class="at">c =</span> <span class="dv">180</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-npregC" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-npregC-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04-chap_files/figure-html/fig-npregC-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-35" title="Figure&nbsp;4.30: Regression example using flexmix with the points colored according to their estimated class. You can see that at the intersection we have an `identifiability’ problem: we cannot distinguish points that belong to the straight line from ones that belong to the parabole."><img src="04-chap_files/figure-html/fig-npregC-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-npregC-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.30: Regression example using <code>flexmix</code> with the points colored according to their estimated class. You can see that at the intersection we have an `identifiability’ problem: we cannot distinguish points that belong to the straight line from ones that belong to the parabole.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="imp-mixtures-hierarchicalnoise" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;4.5
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Other hierarchical noise models:</strong><br>
Find two papers that explore the use of other infinite mixtures for modeling molecular biology technological variation.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-46-contents" aria-controls="callout-46" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-46" class="callout-46-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The paper by <span class="citation" data-cites="Chen2011">Chen, Xie, and Story (<a href="16-chap.html#ref-Chen2011" role="doc-biblioref">2011</a>)</span> explores an exponential-Poisson model for modeling background noise in bead arrays. <span class="citation" data-cites="Wills2013">Wills et al. (<a href="16-chap.html#ref-Wills2013" role="doc-biblioref">2013</a>)</span> compares several Poisson mixture models.</p>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Anscombe1948" class="csl-entry" role="listitem">
Anscombe, Francis J. 1948. <span>“The Transformation of <span>P</span>oisson, Binomial and Negative-Binomial Data.”</span> <em>Biometrika</em>, 246–54.
</div>
<div id="ref-Bishop:PRML" class="csl-entry" role="listitem">
Bishop, Christopher M. 2006. <em>Pattern Recognition and Machine Learning</em>. Springer.
</div>
<div id="ref-BronsteinSemendjajew" class="csl-entry" role="listitem">
Bronštein, Il’ja N., and Konstantin A Semendjajew. 1979. <em>Taschenbuch Der Mathematik</em>. B.G. Teubner Verlagsgesellschaft, Leipzig; Verlag Nauka, Moscow.
</div>
<div id="ref-bulmer2003" class="csl-entry" role="listitem">
Bulmer, Michael George. 2003. <em>Francis Galton: Pioneer of Heredity and Biometry</em>. JHU Press.
</div>
<div id="ref-Chen2011" class="csl-entry" role="listitem">
Chen, Min, Yang Xie, and Michael Story. 2011. <span>“An Exponential-Gamma Convolution Model for Background Correction of <span>I</span>llumina <span>BeadArray</span> Data.”</span> <em>Communications in Statistics-Theory and Methods</em> 40 (17): 3055–69.
</div>
<div id="ref-diaconis1980finite" class="csl-entry" role="listitem">
Diaconis, Persi, and David Freedman. 1980. <span>“Finite Exchangeable Sequences.”</span> <em>The Annals of Probability</em>, 745–64.
</div>
<div id="ref-Diaconis1994" class="csl-entry" role="listitem">
Diaconis, Persi, and Susan Holmes. 1994. <span>“Gray Codes for Randomization Procedures.”</span> <em>Statistics and Computing</em> 4 (4): 287–302.
</div>
<div id="ref-Efron:1994" class="csl-entry" role="listitem">
Efron, Bradley, and Robert J Tibshirani. 1994. <em>An Introduction to the Bootstrap</em>. CRC press.
</div>
<div id="ref-efront" class="csl-entry" role="listitem">
Efron, B., and R. Tibshirani. 1993. <em>An Introduction to the Bootstrap</em>. Chapman &amp; Hall/CRC.
</div>
<div id="ref-Grun2012" class="csl-entry" role="listitem">
Grün, Bettina, Theresa Scharl, and Friedrich Leisch. 2012. <span>“Modelling Time Course Gene Expression Data with Finite Mixtures of Linear Additive Models.”</span> <em>Bioinformatics</em> 28 (2): 222–28. <a href="https://doi.org/10.1093/bioinformatics/btr653">https://doi.org/10.1093/bioinformatics/btr653</a>.
</div>
<div id="ref-hoeting1999" class="csl-entry" role="listitem">
Hoeting, Jennifer A, David Madigan, Adrian E Raftery, and Chris T Volinsky. 1999. <span>“Bayesian Model Averaging: A Tutorial.”</span> <em>Statistical Science</em>, 382–401.
</div>
<div id="ref-Kery2015" class="csl-entry" role="listitem">
Kéry, Marc, and J Andrew Royle. 2015. <em>Applied Hierarchical Modeling in Ecology: Analysis of Distribution, Abundance and Species Richness in r and BUGS: Volume 1: Prelude and Static Models</em>. Academic Press.
</div>
<div id="ref-Kristiansson2009" class="csl-entry" role="listitem">
Kristiansson, Erik, Michael Thorsen, Markus J Tamás, and Olle Nerman. 2009. <span>“Evolutionary Forces Act on Promoter Length: Identification of Enriched Cis-Regulatory Elements.”</span> <em>Molecular Biology and Evolution</em> 26 (6): 1299–1307.
</div>
<div id="ref-Kuan2011statistical" class="csl-entry" role="listitem">
Kuan, Pei Fen, Dongjun Chung, Guangjin Pan, James A Thomson, Ron Stewart, and Sündüz Keleş. 2011. <span>“A Statistical Framework for the Analysis of <span>ChIP-Seq</span> Data.”</span> <em>Journal of the American Statistical Association</em> 106 (495): 891–903.
</div>
<div id="ref-lange2016mm" class="csl-entry" role="listitem">
Lange, Kenneth. 2016. <em>MM Optimization Algorithms</em>. SIAM.
</div>
<div id="ref-mclachlan2007algorithm" class="csl-entry" role="listitem">
McLachlan, Geoffrey, and Thriyambakam Krishnan. 2007. <em>The <span>EM</span> Algorithm and Extensions</em>. Vol. 382. John Wiley &amp; Sons.
</div>
<div id="ref-mclachlan2004" class="csl-entry" role="listitem">
McLachlan, Geoffrey, and David Peel. 2004. <em>Finite Mixture Models</em>. John Wiley &amp; Sons.
</div>
<div id="ref-mcmurdie2014" class="csl-entry" role="listitem">
McMurdie, Paul J, and Susan Holmes. 2014. <span>“Waste Not, Want Not: Why Rarefying Microbiome Data Is Inadmissible.”</span> <em>PLoS Computational Biology</em> 10 (4): e1003531.
</div>
<div id="ref-Purdom2005" class="csl-entry" role="listitem">
Purdom, Elizabeth, and Susan P Holmes. 2005. <span>“Error Distribution for Gene Expression Data.”</span> <em>Statistical Applications in Genetics and Molecular Biology</em> 4 (1).
</div>
<div id="ref-Rice:2007" class="csl-entry" role="listitem">
Rice, John. 2006. <em>Mathematical Statistics and Data Analysis</em>. Cengage Learning.
</div>
<div id="ref-CosmaShalizi2017" class="csl-entry" role="listitem">
Shalizi, Cosma. 2017. <em>Advanced Data Analysis from an Elementary Point of View</em>. Cambridge University Press. <a href="https://www.stat.cmu.edu/~cshalizi/ADAfaEPoV/ADAfaEPoV.pdf">https://www.stat.cmu.edu/~cshalizi/ADAfaEPoV/ADAfaEPoV.pdf</a>.
</div>
<div id="ref-Slonim:2005" class="csl-entry" role="listitem">
Slonim, Noam, Gurinder Singh Atwal, Gašper Tkačik, and William Bialek. 2005. <span>“Information-Based Clustering.”</span> <em>PNAS</em> 102 (51): 18297–302.
</div>
<div id="ref-Tibshirani1996" class="csl-entry" role="listitem">
Tibshirani, Robert. 1996. <span>“Regression Shrinkage and Selection via the Lasso.”</span> <em>Journal of the Royal Statistical Society. Series B (Methodological)</em>, 267–88.
</div>
<div id="ref-Wills2013" class="csl-entry" role="listitem">
Wills, Quin F, Kenneth J Livak, Alex J Tipping, Tariq Enver, Andrew J Goldson, Darren W Sexton, and Chris Holmes. 2013. <span>“Single-Cell Gene Expression Analysis Reveals Genetic Associations Masked in Whole-Tissue Experiments.”</span> <em>Nature Biotechnology</em> 31 (8): 748–52.
</div>
<div id="ref-Zeileis:2008" class="csl-entry" role="listitem">
Zeileis, Achim, Christian Kleiber, and Simon Jackman. 2008. <span>“Regression Models for Count Data in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 27 (8). <a href="http://www.jstatsoft.org/v27/i08/">http://www.jstatsoft.org/v27/i08/</a>.
</div>
</div>
</section>


<p>Page built at 01:33 on 2025-09-01 using R version 4.5.1 (2025-06-13)</p></main> <!-- /main --></p><p class="build-date">
Support for maintaining the online version of this book is provided by <a href="http://www.denbi.de">de.NBI</a>
  <img src="imgs/denbi.png" style="vertical-align: text-top;height: 16px"><br>
For website support please contact msmith@embl.de
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
  const anchorJS_eq = new window.AnchorJS();
  anchorJS_eq.options = {
    placement: 'left',
    class: 'eq-link',
    icon: icon
  };
  anchorJS_eq.add('.anchored-eq');
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/www\.huber\.embl\.de\/msmb");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>
