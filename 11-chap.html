<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>11&nbsp; Image data – Modern Statistics for Modern Biology</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./imgs/msmb-favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-af5ec82acda093b5ee751184164e9432.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-d63985d606c7f07261ad561a6cfde940.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="msmb.css">
<meta property="og:title" content="11&nbsp; Image data – Modern Statistics for Modern Biology">
<meta property="og:description" content="If you are a biologist and want to get the best out of the powerful methods of modern computational statistics, this is your book.">
<meta property="og:image" content="https://www.huber.embl.de/msmb/11-chap_files/figure-html/fig-voronoiPaint-1.png">
<meta property="og:site_name" content="Modern Statistics for Modern Biology">
<meta property="og:image:height" content="261">
<meta property="og:image:width" content="181">
<meta name="twitter:title" content="11&nbsp; Image data – Modern Statistics for Modern Biology">
<meta name="twitter:description" content="If you are a biologist and want to get the best out of the powerful methods of modern computational statistics, this is your book.">
<meta name="twitter:image" content="https://www.huber.embl.de/msmb/11-chap_files/figure-html/fig-voronoiPaint-1.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:image-height" content="261">
<meta name="twitter:image-width" content="181">
<script type="text/javascript">
  var _paq = _paq || [];
  
  // Call disableCookies before calling trackPageView 
  _paq.push(['disableCookies']);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u='//tr-denbi.embl.de/heimdall/';
    _paq.push(['setTrackerUrl', u+'p.php']);
    _paq.push(['setSiteId', '26']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'p.js'; s.parentNode.insertBefore(g,s);
  })();
</script>

</head>

<body class="floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Modern Statistics for Modern Biology</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-chapters" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Chapters</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-chapters">    
        <li>
    <a class="dropdown-item" href="./index.html">
 <span class="dropdown-text">Home</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./00-chap.html">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./01-chap.html">
 <span class="dropdown-text">Generative Models for Discrete Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02-chap.html">
 <span class="dropdown-text">Statistical Modeling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03-chap.html">
 <span class="dropdown-text">Data visualization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04-chap.html">
 <span class="dropdown-text">Mixture Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05-chap.html">
 <span class="dropdown-text">Clustering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06-chap.html">
 <span class="dropdown-text">Testing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07-chap.html">
 <span class="dropdown-text">Multivariate Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./08-chap.html">
 <span class="dropdown-text">High-Throughput Count Data &amp; Generalized Linear Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09-chap.html">
 <span class="dropdown-text">Multivariate methods for heterogeneous data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10-chap.html">
 <span class="dropdown-text">Networks and Trees</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./11-chap.html">
 <span class="dropdown-text">Image data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./12-chap.html">
 <span class="dropdown-text">Supervised Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./13-chap.html">
 <span class="dropdown-text">Design of High Throughput Experiments and their Analyses</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./14-chap.html">
 <span class="dropdown-text">Statistical Concordance</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./15-chap.html">
 <span class="dropdown-text">Acknowledgements</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./16-chap.html">
 <span class="dropdown-text">References</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sections</h2>
   
  <ul class="collapse">
  <li><a href="#goals-for-this-chapter" id="toc-goals-for-this-chapter" class="nav-link active" data-scroll-target="#goals-for-this-chapter"><span class="header-section-number">11.1</span> Goals for this chapter</a></li>
  <li><a href="#loading-images" id="toc-loading-images" class="nav-link" data-scroll-target="#loading-images"><span class="header-section-number">11.2</span> Loading images</a></li>
  <li><a href="#displaying-images" id="toc-displaying-images" class="nav-link" data-scroll-target="#displaying-images"><span class="header-section-number">11.3</span> Displaying images</a></li>
  <li><a href="#how-are-images-stored-in-r" id="toc-how-are-images-stored-in-r" class="nav-link" data-scroll-target="#how-are-images-stored-in-r"><span class="header-section-number">11.4</span> How are images stored in R?</a></li>
  <li><a href="#writing-images-to-file" id="toc-writing-images-to-file" class="nav-link" data-scroll-target="#writing-images-to-file"><span class="header-section-number">11.5</span> Writing images to file</a></li>
  <li><a href="#sec-manip" id="toc-sec-manip" class="nav-link" data-scroll-target="#sec-manip"><span class="header-section-number">11.6</span> Manipulating images</a></li>
  <li><a href="#spatial-transformations" id="toc-spatial-transformations" class="nav-link" data-scroll-target="#spatial-transformations"><span class="header-section-number">11.7</span> Spatial transformations</a></li>
  <li><a href="#sec-linearfilters" id="toc-sec-linearfilters" class="nav-link" data-scroll-target="#sec-linearfilters"><span class="header-section-number">11.8</span> Linear filters</a></li>
  <li><a href="#sec-images-adapthresh" id="toc-sec-images-adapthresh" class="nav-link" data-scroll-target="#sec-images-adapthresh"><span class="header-section-number">11.9</span> Adaptive thresholding</a></li>
  <li><a href="#morphological-operations-on-binary-images" id="toc-morphological-operations-on-binary-images" class="nav-link" data-scroll-target="#morphological-operations-on-binary-images"><span class="header-section-number">11.10</span> Morphological operations on binary images</a></li>
  <li><a href="#sec-segbin" id="toc-sec-segbin" class="nav-link" data-scroll-target="#sec-segbin"><span class="header-section-number">11.11</span> Segmentation of a binary image into objects</a></li>
  <li><a href="#sec-voronoi" id="toc-sec-voronoi" class="nav-link" data-scroll-target="#sec-voronoi"><span class="header-section-number">11.12</span> Voronoi tessellation</a></li>
  <li><a href="#sec-bodies" id="toc-sec-bodies" class="nav-link" data-scroll-target="#sec-bodies"><span class="header-section-number">11.13</span> Segmenting the cell bodies</a></li>
  <li><a href="#sec-featextract" id="toc-sec-featextract" class="nav-link" data-scroll-target="#sec-featextract"><span class="header-section-number">11.14</span> Feature extraction</a></li>
  <li><a href="#sec-spatstat" id="toc-sec-spatstat" class="nav-link" data-scroll-target="#sec-spatstat"><span class="header-section-number">11.15</span> Spatial statistics: point processes</a></li>
  <li><a href="#sec-intensity" id="toc-sec-intensity" class="nav-link" data-scroll-target="#sec-intensity"><span class="header-section-number">11.16</span> First order effects: the intensity</a></li>
  <li><a href="#second-order-effects-spatial-dependence" id="toc-second-order-effects-spatial-dependence" class="nav-link" data-scroll-target="#second-order-effects-spatial-dependence"><span class="header-section-number">11.17</span> Second order effects: spatial dependence</a></li>
  <li><a href="#summary-of-this-chapter" id="toc-summary-of-this-chapter" class="nav-link" data-scroll-target="#summary-of-this-chapter"><span class="header-section-number">11.18</span> Summary of this chapter</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">11.19</span> Further reading</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">11.20</span> Exercises</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-images" class="quarto-section-identifier"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Image data</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/chap13-colorLabelscellbodies.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="imgs/chap13-colorLabelscellbodies.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div></div></div>
<p>Images are a rich source of data. In this chapter, we will see how quantitative information can be extracted from images, and how we can use statistical methods to summarize and understand the data. The goal of the chapter is to show that getting started working with image data is easy – if you are able to handle the basic R environment, you are ready to start working with images. That said, this chapter is not a general introduction to image analysis. The field is extensive; it touches many areas of signal processing, information theory, mathematics, engineering and computer science, and there are excellent books that present a systematic overview.</p>
<p>We will mainly study series of two-dimensional images, in particular, images of cells. We will learn how to identify the cells’ positions and shapes and how to quantitatively measure characteristics of the identified shapes and patterns, such as sizes, intensities, color distributions and relative positions. Such information can then be used in down-stream analyses: for instance, we can compare cells between different conditions, say under the effect of different drugs, or in different stages of differentiation and growth; or we can measure how the objects in the image relate to each other, e.g., whether they like to cluster together or repel each other, or whether certain characteristics tend to be shared between neighboring objects, indicative of cell-to-cell communication. In the language of genetics, what this means is that we can use images as complex phenotypes or as multivariate quantitative traits.</p>
<p>We will here not touch upon image analysis in more than two dimensions: we won’t consider 3D segmentation and registration, nor temporal tracking. These are sophisticated tasks for which specialized software would likely perform better than what we could assemble in the scope of this chapter.</p>
<p>There are similarities between data from high-throughput imaging and other high-throughput data in genomics. Batch effects tend to play a role, for instance because of changes in staining efficiency, illumination or many other factors. We’ll need to take appropriate precautions in our experimental design and analysis choices. In principle, the intensity values in an image can be calibrated in physical units, corresponding, say to radiant energy or fluorophore concentration; however this is not always done in practice in biological imaging, and perhaps also not needed. Somewhat easier to achieve and clearly valuable is a calibration of the spatial dimensions of the image, i.e., the conversion factor between pixel units and metric distances.</p>
<section id="goals-for-this-chapter" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="goals-for-this-chapter"><span class="header-section-number">11.1</span> Goals for this chapter</h2>
<p>In this chapter we will:</p>
<ul>
<li><p>Learn how to read, write and manipulate images in R.</p></li>
<li><p>Understand how to apply filters and transformations to images.</p></li>
<li><p>Combine these skills to do segmentation and feature extraction; we will use cell segmentation as an example.</p></li>
<li><p>Learn how to use statistical methods to analyse spatial distributions and dependencies.</p></li>
<li><p>Get to know the most basic distribution for a spatial point process: the homogeneous Poisson process.</p></li>
<li><p>Recognize whether your data fit that basic assumption or whether they show evidence of clumping or exclusion.</p></li>
</ul>
</section>
<section id="loading-images" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="loading-images"><span class="header-section-number">11.2</span> Loading images</h2>
<p>A useful toolkit for handling images in R is the Bioconductor package <strong><a href="https://bioconductor.org/packages/EBImage/">EBImage</a></strong> <span class="citation" data-cites="EBImage">(<a href="16-chap.html#ref-EBImage" role="doc-biblioref">Pau et al. 2010</a>)</span>. We start out by reading in a simple picture to demonstrate the basic functions.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"EBImage"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>imagefile <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">"images"</span>, <span class="st">"mosquito.png"</span>, <span class="at">package =</span> <span class="st">"MSMB"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>mosq <span class="ot">=</span> <span class="fu">readImage</span>(imagefile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong><a href="https://bioconductor.org/packages/EBImage/">EBImage</a></strong> currently supports three image file formats: <code>jpeg</code>, <code>png</code> and <code>tiff</code>. Above, we loaded a sample image from the <strong><a href="https://bioconductor.org/packages/MSMB/">MSMB</a></strong> package. When you are working with your own data, you do not need that package, just provide the name(s) of your file(s) to the <code>readImage</code> function. As you will see later in this chapter, <code>readImage</code> can read multiple images in one go, which are then all assembled into a single image data object. For this to work, the images need to have the same dimensions and color mode.</p>
<div id="wrn-images-RBioFormats" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.1
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <strong>RBioFormats</strong> package (available on GitHub: <a href="https://github.com/aoles/RBioFormats" class="uri">https://github.com/aoles/RBioFormats</a>) provides functionality for reading and writing many more image file formats. How many different file formats are supported?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>See the manual page of the <code>read.image</code> function in the <strong>RBioFormats</strong> package (note that this is distinct from <code>EBImage::readImage</code>) and the online documentation of the Bio-Formats project on the website of The Open Microscopy Environment, <a href="http://www.openmicroscopy.org/site/support/bio-formats5.5/supported-formats.html" class="uri">http://www.openmicroscopy.org/site/support/bio-formats5.5/supported-formats.html</a>.</p>
</div>
</div>
</div>
</section>
<section id="displaying-images" class="level2 page-columns page-full" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="displaying-images"><span class="header-section-number">11.3</span> Displaying images</h2>
<p>Let’s visualize the image that we just read in. The basic function is <code>EBImage::display</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>EBImage<span class="sc">::</span><span class="fu">display</span>(mosq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The above command opens the image in a window of your web browser (as set by <code>getOption("browser")</code>). Using the mouse or keyboard shortcuts, you can zoom in and out of the image, pan and cycle through multiple image frames.</p>
<p>Alternatively, we can also display the image using R’s built-in plotting by calling <code>display</code> with the argument <code>method = "raster"</code>. The image then goes to the current device. In this way, we can combine image data with other plotting functionality, for instance, to add text labels.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>EBImage<span class="sc">::</span><span class="fu">display</span>(mosq)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x =</span> <span class="dv">85</span>, <span class="at">y =</span> <span class="dv">800</span>, <span class="at">label =</span> <span class="st">"A mosquito"</span>, <span class="at">adj =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"orange"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-mosquito" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosquito-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-mosquito-1.jpeg" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;11.1: Mosquito discovered deceased in the suburbs of Decatur, Georgia (credit: CDC / Janice Haney Carr)."><img src="11-chap_files/figure-html/fig-mosquito-1.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosquito-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.1: Mosquito discovered deceased in the suburbs of Decatur, Georgia (credit: CDC / Janice Haney Carr).
</figcaption>
</figure>
</div>
</div></div></div>
<p>The resulting plot is shown in <a href="#fig-mosquito" class="quarto-xref">Figure&nbsp;<span>11.1</span></a>. As usual, the graphics displayed in an R device can be saved using the <strong><a href="https://cran.r-project.org/web/packages/base/">base</a></strong> R functions <code>dev.print</code> or <code>dev.copy</code>.</p>
<p>Note that we can also read and view color images, see <a href="#fig-hiv" class="quarto-xref">Figure&nbsp;<span>11.2</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>imagefile <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">"images"</span>, <span class="st">"hiv.png"</span>, <span class="at">package =</span> <span class="st">"MSMB"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>hivc <span class="ot">=</span> <span class="fu">readImage</span>(imagefile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>EBImage<span class="sc">::</span><span class="fu">display</span>(hivc, <span class="at">method =</span> <span class="st">"raster"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-hiv" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hiv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-hiv-1.jpeg" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;11.2: Scanning electron micrograph of HIV-1 virions budding from a cultured lymphocyte (credit: CDC / C. Goldsmith, P. Feorino, E.L. Palmer, W.R. McManus)."><img src="11-chap_files/figure-html/fig-hiv-1.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hiv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.2: Scanning electron micrograph of HIV-1 virions budding from a cultured lymphocyte (credit: CDC / C. Goldsmith, P. Feorino, E.L. Palmer, W.R. McManus).
</figcaption>
</figure>
</div>
</div></div></div>
<p>Furthermore, if an image has multiple frames, they can be displayed all at once in a grid arrangement by specifying the function argument <code>all = TRUE</code> (<a href="#fig-image-oneminus" class="quarto-xref">Figure&nbsp;<span>11.3</span></a>),</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>nuc <span class="ot">=</span> <span class="fu">readImage</span>(<span class="fu">system.file</span>(<span class="st">"images"</span>, <span class="st">"nuclei.tif"</span>, <span class="at">package =</span> <span class="st">"EBImage"</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>EBImage<span class="sc">::</span><span class="fu">display</span>(<span class="dv">1</span> <span class="sc">-</span> nuc, <span class="at">all =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-image-oneminus" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-image-oneminus-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-image-oneminus-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;11.3: Tiled display of four images of cell nuclei from the EBImage package."><img src="11-chap_files/figure-html/fig-image-oneminus-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-image-oneminus-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.3: Tiled display of four images of cell nuclei from the <strong><a href="https://bioconductor.org/packages/EBImage/">EBImage</a></strong> package.
</figcaption>
</figure>
</div>
</div>
</div>
<!-- #| fig-cap-location: margin -->
<p>or we can just view a single frame, for instance, the second one.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>EBImage<span class="sc">::</span><span class="fu">display</span>(<span class="dv">1</span> <span class="sc">-</span> nuc, <span class="at">frame =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="wrn-images-oneminus" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why did we pass the argument <code>1 - nuc</code> to the <code>display</code> function in the code for <a href="#fig-image-oneminus" class="quarto-xref">Figure&nbsp;<span>11.3</span></a>? How does it look if we display <code>nuc</code> directly?</p>
</div>
</div>
</section>
<section id="how-are-images-stored-in-r" class="level2 page-columns page-full" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="how-are-images-stored-in-r"><span class="header-section-number">11.4</span> How are images stored in R?</h2>
<p>Let’s dig into what’s going on by first identifying the class of the image object.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(mosq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Image"
attr(,"package")
[1] "EBImage"</code></pre>
</div>
</div>
<p>So we see that this object has the class <em>Image</em>. This is not one of the base R classes, rather, it is defined by the package <strong><a href="https://bioconductor.org/packages/EBImage/">EBImage</a></strong>. We can find out more about this class through the help browser or by typing <code>class ? Image</code>. The class is derived from the base R class <em>array</em>, so you can do with <em>Image</em> objects everything that you can do with R arrays; in addition, they have some extra features and behaviors<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;In R’s parlance, the extra features are called <strong>slots</strong> and the behaviors are called methods; methods are a special kind of function.</p></div></div><div id="wrn-images-slotsmethods" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.3
</div>
</div>
<div class="callout-body-container callout-body">
<p>How can you find out what the slots of an <em>Image</em> object are and which methods can be applied to it?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The class definition is easy, it is accessed with <code>showClass("Image")</code>. Finding all the methods applicable to the <em>Image</em> class by an analogous call to an R function is painful; your best bet is to consult the manual page of the class and see which methods the author chose to mention.</p>
</div>
</div>
</div>
<p>The dimensions of the image can be extracted using the <code>dim</code> method, just like for regular arrays.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(mosq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1400  952</code></pre>
</div>
</div>
<p>The <code>hist</code> method has been redefined<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> compared to the ordinary <code>hist</code> function for arrays: it uses different and possibly more useful defaults (<a href="#fig-mosqhist" class="quarto-xref">Figure&nbsp;<span>11.4</span></a>).</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;In object oriented parlance, <em>overloaded</em>.</p></div></div><div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(mosq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-mosqhist" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mosqhist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-mosqhist-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;11.4: Histogram of the pixel intensities in mosq. Note that the range is between 0 and 1."><img src="11-chap_files/figure-html/fig-mosqhist-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosqhist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.4: Histogram of the pixel intensities in <code>mosq</code>. Note that the range is between 0 and 1.
</figcaption>
</figure>
</div>
</div></div></div>
<p>If we want to directly access the data matrix as an R <em>array</em>, we can use the accessor function <code>imageData</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">imageData</span>(mosq)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]      [,2]      [,3]      [,4]      [,5]      [,6]
[1,] 0.1960784 0.1960784 0.1960784 0.1960784 0.1960784 0.1960784
[2,] 0.1960784 0.1960784 0.1960784 0.1960784 0.1960784 0.1960784
[3,] 0.1960784 0.1960784 0.2000000 0.2039216 0.2000000 0.1960784</code></pre>
</div>
</div>
<p>A useful summary of an <em>Image</em> object is printed if we simply type the object’s name.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mosq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Image 
  colorMode    : Grayscale 
  storage.mode : double 
  dim          : 1400 952 
  frames.total : 1 
  frames.render: 1 

imageData(object)[1:5,1:6]
          [,1]      [,2]      [,3]      [,4]      [,5]      [,6]
[1,] 0.1960784 0.1960784 0.1960784 0.1960784 0.1960784 0.1960784
[2,] 0.1960784 0.1960784 0.1960784 0.1960784 0.1960784 0.1960784
[3,] 0.1960784 0.1960784 0.2000000 0.2039216 0.2000000 0.1960784
[4,] 0.1960784 0.1960784 0.2039216 0.2078431 0.2000000 0.1960784
[5,] 0.1960784 0.2000000 0.2117647 0.2156863 0.2000000 0.1921569</code></pre>
</div>
</div>
<p>Now let us look at the color image.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>hivc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Image 
  colorMode    : Color 
  storage.mode : double 
  dim          : 1400 930 3 
  frames.total : 3 
  frames.render: 1 

imageData(object)[1:5,1:6,1]
     [,1] [,2] [,3] [,4] [,5] [,6]
[1,]    0    0    0    0    0    0
[2,]    0    0    0    0    0    0
[3,]    0    0    0    0    0    0
[4,]    0    0    0    0    0    0
[5,]    0    0    0    0    0    0</code></pre>
</div>
</div>
<p>The two images differ by their property <code>colorMode</code>, which is <code>Grayscale</code> for <code>mosq</code> and <code>Color</code> for <code>hivc</code>. What is the point of this property? It turns out to be convenient when we are dealing with stacks of images. If <code>colorMode</code> is <code>Grayscale</code>, then the third and all higher dimensions of the array are considered as separate image frames corresponding, for instance, to different <span class="math inline">\(z\)</span>-positions, time points, replicates, etc. On the other hand, if <code>colorMode</code> is <code>Color</code>, then the third dimension is assumed to hold different color channels, and only the fourth and higher dimensions – if present – are used for multiple image frames. In <code>hivc</code>, there are three color channels, which correspond to the red, green and blue intensities of our photograph. However, this does not necessarily need to be the case, there can be any number of color channels.</p>
<div id="wrn-images-storenuc" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.4
</div>
</div>
<div class="callout-body-container callout-body">
<p>Describe how R stores the data <code>nuc</code>.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>nuc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Image 
  colorMode    : Grayscale 
  storage.mode : double 
  dim          : 510 510 4 
  frames.total : 4 
  frames.render: 4 

imageData(object)[1:5,1:6,1]
           [,1]       [,2]       [,3]       [,4]       [,5]       [,6]
[1,] 0.06274510 0.07450980 0.07058824 0.08235294 0.10588235 0.09803922
[2,] 0.06274510 0.05882353 0.07843137 0.09019608 0.09019608 0.10588235
[3,] 0.06666667 0.06666667 0.08235294 0.07843137 0.09411765 0.09411765
[4,] 0.06666667 0.06666667 0.07058824 0.08627451 0.08627451 0.09803922
[5,] 0.05882353 0.06666667 0.07058824 0.08235294 0.09411765 0.10588235</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(<span class="fu">imageData</span>(nuc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 510 510   4</code></pre>
</div>
</div>
<p>We see that we have 4 frames in total, which correspond to the 4 separate images (<code>frames.render</code>).</p>
</div>
</div>
</div>
</section>
<section id="writing-images-to-file" class="level2 page-columns page-full" data-number="11.5">
<h2 data-number="11.5" class="anchored" data-anchor-id="writing-images-to-file"><span class="header-section-number">11.5</span> Writing images to file</h2>
<p>Directly saving images to disk in the array representation that we saw in the previous section would lead to large file sizes – in most cases, needlessly large. It is common to use compression algorithms to reduce the storage consumption. There are two main types of image<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> compression:</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;In an analogous way, this is also true for movies and music.</p></div></div><ul>
<li><p>Lossless compression: it is possible to exactly reconstruct the original image data from the compressed file. Simple priciples of lossless compression are: (i) do not spend more bits on representing a pixel than needed (e.g., the pixels in the <code>mosq</code> image have a range of 256 gray scale values, and this could be represented by 8 bits, although <code>mosq</code> stores them in a 64-bit numeric format<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>); and (2) identify patterns (such as those that you saw above in the printed pixel values for <code>mosq</code> and <code>hivc</code>) and represent them by much shorter to write down rules instead.</p></li>
<li><p>Lossy compression: additional savings are made compared to lossless compression by dropping details that a human viewer would be unlikely to notice anyway.</p></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;While this is somewhat wasteful of memory, it is more compatible with the way the rest of R works, and is rarely a limiting factor on modern computer hardware.</p></div><div id="fn5"><p><sup>5</sup>&nbsp;<a href="https://en.wikipedia.org/wiki/Portable_Network_Graphics" class="uri">https://en.wikipedia.org/wiki/Portable_Network_Graphics</a></p></div><div id="fn6"><p><sup>6</sup>&nbsp;<a href="https://en.wikipedia.org/wiki/JPEG" class="uri">https://en.wikipedia.org/wiki/JPEG</a></p></div></div><p>An example for a storage format with lossless compression is PNG<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>, an example for lossy compression is the JPEG<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> format. While JPEG is good for your holiday pictures, it is good practice to store scientific images in a lossless format.</p>
<p>We read the image <code>hivc</code> from a file in PNG format, so let’s now write it out as a JPEG file. The lossiness is specified by the <em>quality</em> parameter, which can lie between 1 (worst) and 100 (best).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>output_file <span class="ot">=</span> <span class="fu">file.path</span>(<span class="fu">tempdir</span>(), <span class="st">"hivc.jpeg"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">writeImage</span>(hivc, output_file, <span class="at">quality =</span> <span class="dv">85</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similarly, we could have written the image as a <code>TIFF</code> file and chosen among several compression algorithms (see the manual page of the <code>writeImage</code> and <code>writeTiff</code> functions). The package <strong>RBioFormats</strong> lets you write to many further image file formats.</p>
<div id="wrn-images-size" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.5
</div>
</div>
<div class="callout-body-container callout-body">
<p>How big is the <code>hivc</code> object in R’s memory? How big is the JPEG file? How much RAM would you expect a three color, 16 Megapixel image to occupy?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(hivc) <span class="sc">|&gt;</span> <span class="fu">format</span>(<span class="at">units =</span> <span class="st">"Mb"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "29.8 Mb"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">object.size</span>(hivc) <span class="sc">/</span> <span class="fu">prod</span>(<span class="fu">dim</span>(hivc))) <span class="sc">|&gt;</span> <span class="fu">format</span>() <span class="sc">|&gt;</span> <span class="fu">paste</span>(<span class="st">"per pixel"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "8 bytes per pixel"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">file.info</span>( output_file )<span class="sc">$</span>size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 294904</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dv">16</span> <span class="sc">*</span> <span class="dv">3</span> <span class="sc">*</span> <span class="dv">8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 384</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="sec-manip" class="level2 page-columns page-full" data-number="11.6">
<h2 data-number="11.6" class="anchored" data-anchor-id="sec-manip"><span class="header-section-number">11.6</span> Manipulating images</h2>
<p>Now that we know that images are stored as arrays of numbers in R, our method of manipulating images becomes clear – simple algebra! For example, we can take our original image, shown again in <a href="#fig-manip1" class="quarto-xref">Figure&nbsp;<span>11.5</span></a>a, and flip the bright areas to dark and vice versa by multiplying the image with -1 <a href="#fig-manip1" class="quarto-xref">Figure&nbsp;<span>11.5</span></a>b).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>mosqinv <span class="ot">=</span> <span class="fu">normalize</span>(<span class="sc">-</span>mosq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="wrn-images-normalize" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.6
</div>
</div>
<div class="callout-body-container callout-body">
<p>What does the function <code>normalize</code> do?</p>
</div>
</div>
<p>We could also adjust the contrast through multiplication (<a href="#fig-manip1" class="quarto-xref">Figure&nbsp;<span>11.5</span></a>c) and the gamma-factor through exponentiation <a href="#fig-manip1" class="quarto-xref">Figure&nbsp;<span>11.5</span></a>d).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>mosqcont <span class="ot">=</span> mosq <span class="sc">*</span> <span class="dv">3</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>mosqexp <span class="ot">=</span> mosq <span class="sc">^</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-manip1" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-manip1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-manip1" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-manip1-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-manip1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-manip1-1.jpeg" class="lightbox" data-gallery="fig-manip1" title="Figure&nbsp;11.5&nbsp;(a): "><img src="11-chap_files/figure-html/fig-manip1-1.jpeg" id="fig-manip1-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-manip1" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-manip1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-manip1" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-manip1-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-manip1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-manip1-2.jpeg" class="lightbox" data-gallery="fig-manip1" title="Figure&nbsp;11.5&nbsp;(b): "><img src="11-chap_files/figure-html/fig-manip1-2.jpeg" id="fig-manip1-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-manip1" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-manip1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-manip1" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-manip1-3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-manip1-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-manip1-3.jpeg" class="lightbox" data-gallery="fig-manip1" title="Figure&nbsp;11.5&nbsp;(c): "><img src="11-chap_files/figure-html/fig-manip1-3.jpeg" id="fig-manip1-3" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-manip1" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-manip1-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-manip1" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-manip1-4" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-manip1-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-manip1-4.jpeg" class="lightbox" data-gallery="fig-manip1" title="Figure&nbsp;11.5&nbsp;(d): "><img src="11-chap_files/figure-html/fig-manip1-4.jpeg" id="fig-manip1-4" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-manip1" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-manip1-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-manip1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.5: The original mosquito image (a) and three different image transformations: (b) subtraction, (c) multiplication, (d) power transformation.
</figcaption>
</figure>
</div>
<p>Furthermore, we can crop, threshold and transpose images with matrix operations (<a href="#fig-manip5" class="quarto-xref">Figure&nbsp;<span>11.6</span></a>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>mosqcrop   <span class="ot">=</span> mosq[<span class="dv">100</span><span class="sc">:</span><span class="dv">438</span>, <span class="dv">112</span><span class="sc">:</span><span class="dv">550</span>]</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>mosqthresh <span class="ot">=</span> mosq <span class="sc">&gt;</span> <span class="fl">0.5</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>mosqtransp <span class="ot">=</span> <span class="fu">transpose</span>(mosq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-nrow="1" data-layout-align="center" data-fig-cap-location="margin">
<div id="fig-manip5" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-manip5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-manip5" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-manip5-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-manip5-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-manip5-1.png" class="lightbox" data-gallery="fig-manip5" title="Figure&nbsp;11.6&nbsp;(a): "><img src="11-chap_files/figure-html/fig-manip5-1.png" id="fig-manip5-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-manip5" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-manip5-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-manip5" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-manip5-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-manip5-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-manip5-2.png" class="lightbox" data-gallery="fig-manip5" title="Figure&nbsp;11.6&nbsp;(b): "><img src="11-chap_files/figure-html/fig-manip5-2.png" id="fig-manip5-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-manip5" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-manip5-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-manip5" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-manip5-3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-manip5-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-manip5-3.png" class="lightbox" data-gallery="fig-manip5" title="Figure&nbsp;11.6&nbsp;(c): "><img src="11-chap_files/figure-html/fig-manip5-3.png" id="fig-manip5-3" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-manip5" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-manip5-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-manip5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.6: Three further image transformations: (a) cropping, (b) thresholding, (c) transposition.
</figcaption>
</figure>
</div>
</div>
<div id="wrn-images-mosqthresh" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.7
</div>
</div>
<div class="callout-body-container callout-body">
<p>What data type is <code>mosqthresh</code>, the result of the thresholding?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>It is an <em>Image</em> object whose pixels are binary values represented by an R array of type <em>logical</em>. You can inspect the object by typing its name into the console.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>mosqthresh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Image 
  colorMode    : Grayscale 
  storage.mode : logical 
  dim          : 1400 952 
  frames.total : 1 
  frames.render: 1 

imageData(object)[1:5,1:6]
      [,1]  [,2]  [,3]  [,4]  [,5]  [,6]
[1,] FALSE FALSE FALSE FALSE FALSE FALSE
[2,] FALSE FALSE FALSE FALSE FALSE FALSE
[3,] FALSE FALSE FALSE FALSE FALSE FALSE
[4,] FALSE FALSE FALSE FALSE FALSE FALSE
[5,] FALSE FALSE FALSE FALSE FALSE FALSE</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="wrn-images-transpose" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.8
</div>
</div>
<div class="callout-body-container callout-body">
<p>Instead of the <code>transpose</code> function as above, could we also use R’s <strong><a href="https://cran.r-project.org/web/packages/base/">base</a></strong> function <code>t</code>?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>In this instance, the values of <code>t(mosq)</code> and <code>transpose(mosq)</code> happen to be the same, but <code>transpose</code> is preferable since it also works with color and multiframe images.</p>
</div>
</div>
</div>
</section>
<section id="spatial-transformations" class="level2 page-columns page-full" data-number="11.7">
<h2 data-number="11.7" class="anchored" data-anchor-id="spatial-transformations"><span class="header-section-number">11.7</span> Spatial transformations</h2>
<p>We just saw one type of spatial transformation, transposition, but there are many more—here are some examples:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>mosqrot   <span class="ot">=</span> EBImage<span class="sc">::</span><span class="fu">rotate</span>(mosq, <span class="at">angle =</span> <span class="dv">30</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>mosqshift <span class="ot">=</span> EBImage<span class="sc">::</span><span class="fu">translate</span>(mosq, <span class="at">v =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">170</span>))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>mosqflip  <span class="ot">=</span> <span class="fu">flip</span>(mosq)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>mosqflop  <span class="ot">=</span> <span class="fu">flop</span>(mosq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-nrow="1" data-layout-align="center" data-fig-cap-location="margin">
<div id="fig-flipflop" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-flipflop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-flipflop" style="flex-basis: 25.0%;justify-content: center;">
<div id="fig-flipflop-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-flipflop-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-flipflop-1.jpeg" class="lightbox" data-gallery="fig-flipflop" title="Figure&nbsp;11.7&nbsp;(a): "><img src="11-chap_files/figure-html/fig-flipflop-1.jpeg" id="fig-flipflop-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-flipflop" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-flipflop-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-flipflop" style="flex-basis: 25.0%;justify-content: center;">
<div id="fig-flipflop-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-flipflop-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-flipflop-2.jpeg" class="lightbox" data-gallery="fig-flipflop" title="Figure&nbsp;11.7&nbsp;(b): "><img src="11-chap_files/figure-html/fig-flipflop-2.jpeg" id="fig-flipflop-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-flipflop" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-flipflop-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-flipflop" style="flex-basis: 25.0%;justify-content: center;">
<div id="fig-flipflop-3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-flipflop-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-flipflop-3.jpeg" class="lightbox" data-gallery="fig-flipflop" title="Figure&nbsp;11.7&nbsp;(c): "><img src="11-chap_files/figure-html/fig-flipflop-3.jpeg" id="fig-flipflop-3" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-flipflop" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-flipflop-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-flipflop" style="flex-basis: 25.0%;justify-content: center;">
<div id="fig-flipflop-4" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="373.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-flipflop-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-flipflop-4.jpeg" class="lightbox" data-gallery="fig-flipflop" title="Figure&nbsp;11.7&nbsp;(d): "><img src="11-chap_files/figure-html/fig-flipflop-4.jpeg" id="fig-flipflop-4" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-flipflop" width="373"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-flipflop-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-flipflop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.7: Spatial transformations: (a) rotation, (b) translation, (c) reflection about the central horizontal axis (<code>flip</code>), (d) reflection about the central vertical axis (<code>flop</code>).
</figcaption>
</figure>
</div>
</div>
<p>In the code above, the function <code>rotate</code><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> rotates the image clockwise with the given angle, <code>translate</code> moves the image by the specified two-dimensional vector (pixels that end up outside the image region are cropped, and pixels that enter into the image region are set to zero). The functions <code>flip</code> and <code>flop</code> reflect the image around the central horizontal and vertical axis, respectively. The results of these operations are shown in <a href="#fig-flipflop" class="quarto-xref">Figure&nbsp;<span>11.7</span></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;Here we call the function with its namespace qualifier <code>EBImage::</code> to avoid confusion with a function of the same name in the namespace of the <strong><a href="https://cran.r-project.org/web/packages/spatstat/">spatstat</a></strong> package, which we will attach later.</p></div></div></section>
<section id="sec-linearfilters" class="level2 page-columns page-full" data-number="11.8">
<h2 data-number="11.8" class="anchored" data-anchor-id="sec-linearfilters"><span class="header-section-number">11.8</span> Linear filters</h2>
<p>Let’s now switch to an application in cell biology. We load images of human cancer cells that were studied by Laufer, Fischer and co-workers <span class="citation" data-cites="Laufer:NatMeth:2013">(<a href="16-chap.html#ref-Laufer:NatMeth:2013" role="doc-biblioref">Laufer et al. 2013</a>)</span>. They are shown in <a href="#fig-LauferCells" class="quarto-xref">Figure&nbsp;<span>11.8</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>imagefiles <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">"images"</span>, <span class="fu">c</span>(<span class="st">"image-DAPI.tif"</span>, <span class="st">"image-FITC.tif"</span>, <span class="st">"image-Cy3.tif"</span>), <span class="at">package =</span> <span class="st">"MSMB"</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>cells <span class="ot">=</span> <span class="fu">readImage</span>(imagefiles)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-LauferCells" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-cap-location="margin" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-LauferCells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-LauferCells-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17" title="Figure&nbsp;11.8: Human colon cancer cells (HCT116). The four images show the same cells: the leftmost image corresponds to DAPI staining of the cells’ DNA, the second to immunostaining against alpha-tubulin, the third to actin. They are displayed as gray-scale images. The rightmost image is obtained by overlaying the three images as color channels of an RGB image (red: actin, green: alpha-tubulin, blue: DNA)."><img src="11-chap_files/figure-html/fig-LauferCells-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="666"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-LauferCells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.8: Human colon cancer cells (HCT116). The four images show the same cells: the leftmost image corresponds to DAPI staining of the cells’ DNA, the second to immunostaining against alpha-tubulin, the third to actin. They are displayed as gray-scale images. The rightmost image is obtained by overlaying the three images as color channels of an RGB image (red: actin, green: alpha-tubulin, blue: DNA).
</figcaption>
</figure>
</div>
</div>
</div>
<p>The <em>Image</em> object <code>cells</code> is a three-dimensional array of size 340 <span class="math inline">\(\times\)</span> 490 <span class="math inline">\(\times\)</span> 3, where the last dimension indicates that there are three individual grayscale frames. Our goal now is to computationally identify and quantitatively characterize the cells in these images. That by itself would be a modest goal, but note that the dataset of Laufer et al.contains over 690,000 images, each of which has 2,048 <span class="math inline">\(\times\)</span> 2,048 pixels. Here, we are looking at three of these, out of which a small region was cropped. Once we know how to achieve our stated goal, we can apply our abilities to such large image collections, and that is no longer a modest aim!</p>
<section id="interlude-the-intensity-scale-of-images" class="level3 page-columns page-full" data-number="11.8.1">
<h3 data-number="11.8.1" class="anchored" data-anchor-id="interlude-the-intensity-scale-of-images"><span class="header-section-number">11.8.1</span> Interlude: the intensity scale of images</h3>
<p>However, before we can start with real work, we need to deal with a slightly mundane data conversion issue. This is, of course, not unusual. Let us inspect the dynamic range (the minimum and the maximum value) of the images.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(cells, <span class="dv">3</span>, range)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      image-DAPI  image-FITC   image-Cy3
[1,] 0.001586938 0.002899214 0.001663233
[2,] 0.031204700 0.062485695 0.055710689</code></pre>
</div>
</div>
<p>We see that the maximum values are small numbers well below 1. The reason for this is that the <code>readImage</code> function recognizes that the <code>TIFF</code> images uses 16 bit integers to represent each pixel, and it returns the data – as is common for numeric variables in R – in an array of double precision floating point numbers, with the integer values (whose theoretical range is from 0 to <span class="math inline">\(2^{16}-1=65535\)</span>) stored in the mantissa of the floating point representation and the exponents chosen so that the theoretical range is mapped to the interval <span class="math inline">\([0,1]\)</span>. However, the scanner that was used to create these images only used the lower 11 or 12 bits, and this explains the small maximum values in the images. We can rescale these data to approximately cover the range <span class="math inline">\([0,1]\)</span> as follows<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;The function <code>normalize</code> provides a more flexible interface to the scaling of images.</p></div></div><div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>cells[,,<span class="dv">1</span>]   <span class="ot">=</span> <span class="dv">32</span> <span class="sc">*</span> cells[,,<span class="dv">1</span>]</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>cells[,,<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>] <span class="ot">=</span> <span class="dv">16</span> <span class="sc">*</span> cells[,,<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(cells, <span class="dv">3</span>, range)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     image-DAPI image-FITC  image-Cy3
[1,] 0.05078202 0.04638743 0.02661173
[2,] 0.99855039 0.99977111 0.89137102</code></pre>
</div>
</div>
<p>We can keep in mind that these multiplications with a multiple of 2 have no impact on the underlying precision of the stored data.</p>
</section>
<section id="sec-filter" class="level3 page-columns page-full" data-number="11.8.2">
<h3 data-number="11.8.2" class="anchored" data-anchor-id="sec-filter"><span class="header-section-number">11.8.2</span> Noise reduction by smoothing</h3>
<p>Now we are ready to get going with analyzing the images. As our first goal is segmentation of the images to identify the individual cells, we can start by removing local artifacts or noise from the images through smoothing. An intuitive approach is to define a window of a selected size around each pixel and average the values within that window. After applying this procedure to all pixels, the new, smoothed image is obtained. Mathematically, we can express this as</p>
<p><span class="anchored-eq" data-anchor-id="eq-scmdnhyxbglw" id="eq-scmdnhyxbglw"><span class="math display">\[
f^*(x,y) = \frac{1}{N} \sum_{s=-a}^{a}\sum_{t=-a}^{a} f(x+s, y+t),
\tag{11.1}\]</span></span></p>
<p>where <span class="math inline">\(f(x,y)\)</span> is the value of the pixel at position <span class="math inline">\(x\)</span>, <span class="math inline">\(y\)</span>, and <span class="math inline">\(a\)</span> determines the window size, which is <span class="math inline">\(2a+1\)</span> in each direction. <span class="math inline">\(N=(2a+1)^2\)</span> is the number of pixels averaged over, and <span class="math inline">\(f^*\)</span> is the new, smoothed image.</p>
<p>More generally, we can replace the moving average by a weighted average, using a weight function <span class="math inline">\(w\)</span>, which typically has highest weight at the window midpoint (<span class="math inline">\(s=t=0\)</span>) and then decreases towards the edges.</p>
<p><span class="anchored-eq" data-anchor-id="eq-linfilt" id="eq-linfilt"><span class="math display">\[
(w * f)(x,y) = \sum_{s=-\infty}^{+\infty} \sum_{t=-\infty}^{+\infty} w(s,t)\, f(x+s, y+s)
\tag{11.2}\]</span></span></p>
<p>For notational convenience, we let the summations range from <span class="math inline">\(-\infty\)</span> to <span class="math inline">\(\infty\)</span>, even if in practice the sums are finite as <span class="math inline">\(w\)</span> has only a finite number of non-zero values. In fact, we can think of the weight function <span class="math inline">\(w\)</span> as another image, and this operation is also called the <em>convolution</em> of the images <span class="math inline">\(f\)</span> and <span class="math inline">\(w\)</span>, indicated by the the symbol <span class="math inline">\(*\)</span>. In <strong><a href="https://bioconductor.org/packages/EBImage/">EBImage</a></strong>, the 2-dimensional convolution is implemented by the function <code>filter2</code>, and the auxiliary function <code>makeBrush</code> can be used to generate weight functions <span class="math inline">\(w\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>w <span class="ot">=</span> <span class="fu">makeBrush</span>(<span class="at">size =</span> <span class="dv">51</span>, <span class="at">shape =</span> <span class="st">"gaussian"</span>, <span class="at">sigma =</span> <span class="dv">7</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>nucSmooth <span class="ot">=</span> <span class="fu">filter2</span>(<span class="fu">getFrame</span>(cells, <span class="dv">1</span>), w)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-nucSmooth" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nucSmooth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-nucSmooth-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18" title="Figure&nbsp;11.9: nucSmooth, a smoothed version of the DNA channel in the image object cells (the original version is shown in the leftmost panel of Figure&nbsp;fig-LauferCells)."><img src="11-chap_files/figure-html/fig-nucSmooth-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nucSmooth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.9: <code>nucSmooth</code>, a smoothed version of the DNA channel in the image object <code>cells</code> (the original version is shown in the leftmost panel of <a href="#fig-LauferCells" class="quarto-xref">Figure&nbsp;<span>11.8</span></a>).
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-images-brush" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.9
</div>
</div>
<div class="callout-body-container callout-body">
<p>How does the weight matrix <code>w</code> look like?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>See <a href="#fig-image-filter2" class="quarto-xref">Figure&nbsp;<span>11.10</span></a></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tibble"</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">w =</span> w[(<span class="fu">nrow</span>(w)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="dv">2</span>, ]) <span class="sc">|&gt;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> w, <span class="at">x =</span> <span class="fu">seq</span>(<span class="at">along =</span> w))) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-image-filter2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-image-filter2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-image-filter2-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19" title="Figure&nbsp;11.10: The middle row of the weight matrix, w[26, ]."><img src="11-chap_files/figure-html/fig-image-filter2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-image-filter2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.10: The middle row of the weight matrix, <code>w[</code>26<code>, ]</code>.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>In fact, the <code>filter2</code> function does not directly perform the summation indicated in <a href="#eq-linfilt" class="quarto-xref">Equation&nbsp;<span>11.2</span></a>. Instead, it uses the Fast Fourier Transformation in a way that is mathematically equivalent and computationally more efficient.</p>
<p>The convolution in <a href="#eq-linfilt" class="quarto-xref">Equation&nbsp;<span>11.2</span></a> is a <em>linear</em> operation, in the sense that <span class="math inline">\(w*(c_1f_1+c_2f_2)=
c_1w*f_1 + c_2w*f_2\)</span> for any two images <span class="math inline">\(f_1\)</span>, <span class="math inline">\(f_2\)</span> and numbers <span class="math inline">\(c_1\)</span>, <span class="math inline">\(c_2\)</span>. There is beautiful and powerful theory underlying linear filters <span class="citation" data-cites="FoundationSignalProcessing">(<a href="16-chap.html#ref-FoundationSignalProcessing" role="doc-biblioref">Vetterli, Kovačević, and Goyal 2014</a>)</span>.</p>
<p>To proceed we now use smaller smoothing bandwidths than what we displayed in <a href="#fig-nucSmooth" class="quarto-xref">Figure&nbsp;<span>11.9</span></a> for demonstration. Let’s use a <code>sigma</code> of 1 pixel for the DNA channel and 3 pixels for actin and tubulin.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>cellsSmooth <span class="ot">=</span> <span class="fu">Image</span>(<span class="at">dim =</span> <span class="fu">dim</span>(cells))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(sigma))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  cellsSmooth[,,i] <span class="ot">=</span> <span class="fu">filter2</span>( cells[,,i],</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">filter =</span> <span class="fu">makeBrush</span>(<span class="at">size =</span> <span class="dv">51</span>, <span class="at">shape =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sigma =</span> sigma[i]) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The smoothed images have reduced pixel noise, yet still the needed resolution.</p>
</section>
</section>
<section id="sec-images-adapthresh" class="level2 page-columns page-full" data-number="11.9">
<h2 data-number="11.9" class="anchored" data-anchor-id="sec-images-adapthresh"><span class="header-section-number">11.9</span> Adaptive thresholding</h2>
<p>The idea of adaptive thresholding is that, compared to straightforward thresholding as we did for <a href="#fig-manip5" class="quarto-xref">Figure&nbsp;<span>11.6</span></a>b, the threshold is allowed to be different in different regions of the image. In this way, one can anticipate spatial dependencies of the underlying background signal caused, for instance, by uneven illumination or by stray signal from nearby bright objects. In fact, we have already seen an example for uneven background in the bottom right image of <a href="#fig-image-oneminus" class="quarto-xref">Figure&nbsp;<span>11.3</span></a>.</p>
<p>Our colon cancer images (<a href="#fig-LauferCells" class="quarto-xref">Figure&nbsp;<span>11.8</span></a>) do not have such artefacts, but for demonstration, let’s simulate uneven illumination by multiplying the image with a two-dimensional bell function <code>illuminationGradient</code>, which has highest value in the middle and falls off to the sides (<a href="#fig-illumination" class="quarto-xref">Figure&nbsp;<span>11.11</span></a>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>py <span class="ot">=</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">+</span><span class="dv">1</span>, <span class="at">length.out =</span> <span class="fu">dim</span>(cellsSmooth)[<span class="dv">1</span>])</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>px <span class="ot">=</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">+</span><span class="dv">1</span>, <span class="at">length.out =</span> <span class="fu">dim</span>(cellsSmooth)[<span class="dv">2</span>])</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>illuminationGradient <span class="ot">=</span> <span class="fu">Image</span>(<span class="fu">outer</span>(py, px, <span class="cf">function</span>(x, y) <span class="fu">exp</span>(<span class="sc">-</span>(x<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> y<span class="sc">^</span><span class="dv">2</span>))))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>nucBadlyIlluminated <span class="ot">=</span> cellsSmooth[,,<span class="dv">1</span>] <span class="sc">*</span> illuminationGradient</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now define a smoothing window, <code>disc</code>, whose size is 21 pixels, and therefore bigger than the nuclei we want to detect, but small compared to the length scales of the illumination artifact. We use it to compute the image <code>localBackground</code> (shown in <a href="#fig-illumination-3" class="quarto-xref">Figure&nbsp;<span>11.11 (c)</span></a>) and the thresholded image <code>nucBadThresh</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>disc <span class="ot">=</span> <span class="fu">makeBrush</span>(<span class="dv">21</span>, <span class="st">"disc"</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>disc <span class="ot">=</span> disc <span class="sc">/</span> <span class="fu">sum</span>(disc)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>localBackground <span class="ot">=</span> <span class="fu">filter2</span>(nucBadlyIlluminated, disc)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">=</span> <span class="fl">0.02</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>nucBadThresh <span class="ot">=</span> (nucBadlyIlluminated <span class="sc">-</span> localBackground <span class="sc">&gt;</span> offset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-illumination" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-illumination-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-illumination" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-illumination-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-illumination-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-illumination-1.png" class="lightbox" data-gallery="fig-illumination" title="Figure&nbsp;11.11&nbsp;(a): "><img src="11-chap_files/figure-html/fig-illumination-1.png" id="fig-illumination-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-illumination" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-illumination-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-illumination" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-illumination-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-illumination-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-illumination-2.png" class="lightbox" data-gallery="fig-illumination" title="Figure&nbsp;11.11&nbsp;(b): "><img src="11-chap_files/figure-html/fig-illumination-2.png" id="fig-illumination-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-illumination" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-illumination-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-illumination" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-illumination-3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-illumination-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-illumination-3.png" class="lightbox" data-gallery="fig-illumination" title="Figure&nbsp;11.11&nbsp;(c): "><img src="11-chap_files/figure-html/fig-illumination-3.png" id="fig-illumination-3" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-illumination" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-illumination-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-illumination" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-illumination-4" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-illumination-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-illumination-4.png" class="lightbox" data-gallery="fig-illumination" title="Figure&nbsp;11.11&nbsp;(d): "><img src="11-chap_files/figure-html/fig-illumination-4.png" id="fig-illumination-4" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-illumination" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-illumination-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-illumination-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.11: a: <code>illuminationGradient</code>, a function that has its maximum at the center and falls off towards the sides, and which simulates uneven illumination sometimes seen in images. (b) <code>nucBadlyIlluminated</code>, the image that results from multiplying the DNA channel in <code>cellsSmooth</code> with <code>illuminationGradient</code>. (c) <code>localBackground</code>, the result of applying a linear filter with a bandwidth that is larger than the objects to be detected. (d) <code>nucBadThresh</code>, the result of adaptive thresholding. The nuclei at the periphery of the image are reasonably well identified, despite the drop off in signal strength.
</figcaption>
</figure>
</div>
<p>After having seen that this may work, let’s do the same again for the actual (not artificially degraded) image, as we need this for the next steps.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>nucThresh <span class="ot">=</span> (cellsSmooth[,,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">filter2</span>(cellsSmooth[,,<span class="dv">1</span>], disc) <span class="sc">&gt;</span> offset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By comparing each pixel’s intensity to a background determined from the values in a local neighborhood, we assume that the objects are relatively sparse distributed in the image, so that the signal distribution in the neighborhood is dominated by background. For the nuclei in our images, this assumption makes sense, for other situations, you may need to make different assumptions. The adaptive thresholding that we have done here uses a linear filter, <code>filter2</code>, and therefore amounts to (weighted) local averaging. Other distribution summaries, e.g.&nbsp;the median or a low quantile, tend to be preferable, even if they are computationally more expensive. For local median filtering, <strong><a href="https://bioconductor.org/packages/EBimage/">EBimage</a></strong> provides the function <code>medianFilter</code>.</p>
</section>
<section id="morphological-operations-on-binary-images" class="level2 page-columns page-full" data-number="11.10">
<h2 data-number="11.10" class="anchored" data-anchor-id="morphological-operations-on-binary-images"><span class="header-section-number">11.10</span> Morphological operations on binary images</h2>
<p>The thresholded image <code>nucThresh</code> (shown in the left panel of Figure [morphop] is not yet satisfactory. The boundaries of the nuclei are slightly rugged, and there is noise at the single-pixel level. An effective and simple way to remove these nuisances is given by a set of morphological operations <span class="citation" data-cites="MathematicalMorphology">(<a href="16-chap.html#ref-MathematicalMorphology" role="doc-biblioref">Serra 1983</a>)</span>.</p>
<p>Provided a binary image (with values, say, 0 and 1, representing back- and foreground pixels), and a binary mask<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> (which is sometimes also called the structuring element), these operations work as follows.</p>
<div class="no-row-height column-margin column-container"><div id="fn9"><p><sup>9</sup>&nbsp;An example for a mask is a circle with a given radius, or more precisely, the set of pixels within a certain distance from a center pixel.</p></div></div><ul>
<li><p><code>erode</code>: For every foreground pixel, put the mask around it, and if any pixel under the mask is from the background, then set all these pixels to background.</p></li>
<li><p><code>dilate</code>: For every background pixel, put the mask around it, and if any pixel under the mask is from the foreground, then set all these pixels to foreground.</p></li>
<li><p><code>open</code>: perform <code>erode</code> followed by <code>dilate</code>.</p></li>
</ul>
<p>We can also think of these operations as filters, however, in contrast to the linear filters of <a href="#sec-linearfilters" class="quarto-xref"><span>Section 11.8</span></a> they operate on binary images only, and there is no linearity.</p>
<p>Let us apply morphological opening to our image.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>nucOpened <span class="ot">=</span> EBImage<span class="sc">::</span><span class="fu">opening</span>(nucThresh, <span class="at">kern =</span> <span class="fu">makeBrush</span>(<span class="dv">5</span>, <span class="at">shape =</span> <span class="st">"disc"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result of this is subtle, and you will have to zoom into the images in <a href="#fig-morphop" class="quarto-xref">Figure&nbsp;<span>11.12</span></a> to spot the differences, but this operation manages to smoothen out some pixel-level features in the binary images that for our application are undesirable.</p>
</section>
<section id="sec-segbin" class="level2 page-columns page-full" data-number="11.11">
<h2 data-number="11.11" class="anchored" data-anchor-id="sec-segbin"><span class="header-section-number">11.11</span> Segmentation of a binary image into objects</h2>
<p>The binary image <code>nucOpened</code> represents a segmentation of the image into foreground and background pixels, but not into individual nuclei. We can take one step further and extract individual objects defined as connected sets of pixels. In <strong><a href="https://bioconductor.org/packages/EBImage/">EBImage</a></strong>, there is a handy function for this purpose, <code>bwlabel</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>nucSeed <span class="ot">=</span> <span class="fu">bwlabel</span>(nucOpened)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nucSeed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>nucSeed
     0      1      2      3      4      5      6      7      8      9     10 
155408    511    330    120    468    222    121    125    159    116    520 
    11     12     13     14     15     16     17     18     19     20     21 
   115    184    179    116    183    187    303    226    164    309    194 
    22     23     24     25     26     27     28     29     30     31     32 
   148    345    287    203    379    371    208    222    320    443    409 
    33     34     35     36     37     38     39     40     41     42     43 
   493    256    169    225    376    214    228    341    269    119    315 </code></pre>
</div>
</div>
<p>The function returns an image, <code>nucSeed</code>, of integer values, where 0 represents the background, and the numbers from 1 to 43 index the different identified objects.</p>
<div id="wrn-images-tablenucseed" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.10
</div>
</div>
<div class="callout-body-container callout-body">
<p>What are the numbers in the above table?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>They correspond to the area (in pixels) of each of the objects. We could use this information to remove objects that are too large or too small compared to what we expect.</p>
</div>
</div>
</div>
<p>To visualize such images, the function <code>colorLabels</code> is convenient, which converts the (grayscale) integer image into a color image, using distinct, arbitrarily chosen colors for each object.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>EBImage<span class="sc">::</span><span class="fu">display</span>(<span class="fu">colorLabels</span>(nucSeed))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is shown in the middle panel of <a href="#fig-morphop" class="quarto-xref">Figure&nbsp;<span>11.12</span></a>. The result is already encouraging, although we can spot two types of errors:</p>
<ul>
<li><p>Some neighboring objects were not properly separated.</p></li>
<li><p>Some objects contain holes.</p></li>
</ul>
<p>Indeed, we could change the occurrences of these by playing with the disc size and the parameter <code>offset</code> in <a href="#sec-images-adapthresh" class="quarto-xref"><span>Section 11.9</span></a>: making the offset higher reduces the probability that two neighboring object touch and are seen as one object by <code>bwlabel</code>; on the other hand, that leads to even more and even bigger holes. Vice versa for making it lower.</p>
<p>Segmentation is a rich and diverse field of research and engineering, with a large body of literature, software tools <span class="citation" data-cites="schindelin2012fiji chaumont2012icy carpenter2006cellprofiler held2010cellcognition">(<a href="16-chap.html#ref-schindelin2012fiji" role="doc-biblioref">Schindelin et al. 2012</a>; <a href="16-chap.html#ref-chaumont2012icy" role="doc-biblioref">Chaumont et al. 2012</a>; <a href="16-chap.html#ref-carpenter2006cellprofiler" role="doc-biblioref">Carpenter et al. 2006</a>; <a href="16-chap.html#ref-held2010cellcognition" role="doc-biblioref">Held et al. 2010</a>)</span> and practical experience in the image analysis and machine learning communities. What is the adequate approach to a given task depends hugely on the data and the underlying question, and there is no universally best method. It is typically even difficult to obtain a “ground truth” or “gold standards” by which to evaluate an analysis – relying on manual annotation of a modest number of selected images is not uncommon. Despite the bewildering array of choices, it is easy to get going, and we need not be afraid of starting out with a simple solution, which we can successively refine. Improvements can usually be gained from methods that allow inclusion of more prior knowledge of the expected shapes, sizes and relations between the objects to be identified.</p>
<p>For statistical analyses of high-throughput images, we may choose to be satisfied with a simple method that does not rely on too many parameters or assumptions and results in a perhaps sub-optimal but rapid and good enough result <span class="citation" data-cites="PhenoRipper">(<a href="16-chap.html#ref-PhenoRipper" role="doc-biblioref">Rajaram et al. 2012</a>)</span>. In this spirit, let us proceed with what we have. We generate a lenient foreground mask, which surely covers all nuclear stained regions, even though it also covers some regions between nuclei. To do so, we simply apply a second, less stringent adaptive thresholding.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>nucMask <span class="ot">=</span> cellsSmooth[,,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">filter2</span>(cellsSmooth[,,<span class="dv">1</span>], disc) <span class="sc">&gt;</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and apply another morphological operation, <code>fillHull</code>, which fills holes that are surrounded by foreground pixels.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>nucMask <span class="ot">=</span> <span class="fu">fillHull</span>(nucMask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To improve <code>nucSeed</code>, we can now <em>propagate</em> its segmented objects until they fill the mask defined by <code>nucMask</code>. Boundaries between nuclei, in those places where the mask is connected, can be drawn by Voronoi tessellation, which is implemented in the function <code>propagate</code>, and will be explained in the next section.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>nuclei <span class="ot">=</span> <span class="fu">propagate</span>(cellsSmooth[,,<span class="dv">1</span>], nucSeed, <span class="at">mask =</span> nucMask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is displayed in the rightmost panel of <a href="#fig-morphop" class="quarto-xref">Figure&nbsp;<span>11.12</span></a>.</p>
<div id="fig-morphop" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-morphop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-morphop" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-morphop-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-morphop-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-morphop-1.png" class="lightbox" data-gallery="fig-morphop" title="Figure&nbsp;11.12&nbsp;(a): "><img src="11-chap_files/figure-html/fig-morphop-1.png" id="fig-morphop-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-morphop" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-morphop-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-morphop" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-morphop-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-morphop-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-morphop-2.png" class="lightbox" data-gallery="fig-morphop" title="Figure&nbsp;11.12&nbsp;(b): "><img src="11-chap_files/figure-html/fig-morphop-2.png" id="fig-morphop-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-morphop" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-morphop-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-morphop" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-morphop-3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-morphop-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-morphop-3.png" class="lightbox" data-gallery="fig-morphop" title="Figure&nbsp;11.12&nbsp;(c): "><img src="11-chap_files/figure-html/fig-morphop-3.png" id="fig-morphop-3" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-morphop" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-morphop-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-morphop" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-morphop-4" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-morphop-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-morphop-4.png" class="lightbox" data-gallery="fig-morphop" title="Figure&nbsp;11.12&nbsp;(d): "><img src="11-chap_files/figure-html/fig-morphop-4.png" id="fig-morphop-4" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-morphop" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-morphop-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-morphop" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-morphop-5" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-morphop-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-morphop-5.png" class="lightbox" data-gallery="fig-morphop" title="Figure&nbsp;11.12&nbsp;(e): "><img src="11-chap_files/figure-html/fig-morphop-5.png" id="fig-morphop-5" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-morphop" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-morphop-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(e)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-morphop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.12: Different steps in the segmentation of the nuclei. From (a-e): <code>nucThresh</code>, <code>nucOpened</code>, <code>nucSeed</code>, <code>nucMask</code>, <code>nuclei</code>.
</figcaption>
</figure>
</div>
</section>
<section id="sec-voronoi" class="level2 page-columns page-full" data-number="11.12">
<h2 data-number="11.12" class="anchored" data-anchor-id="sec-voronoi"><span class="header-section-number">11.12</span> Voronoi tessellation</h2>
<p>Voronoi tessellation is useful if we have a set of seed points (or regions) and want to partition the space that lies between these seeds in such a way that each point in the space is assigned to its closest seed. As this is an intuitive and powerful idea, we’ll use this section for a short digression on it. Let us consider a basic example. We use the image <code>nuclei</code> as seeds. To call the function <code>propagate</code>, we also need to specify another image: for now we just provide a trivial image of all zeros, and we set the parameter <code>lambda</code> to a large positive value (we will come back to these choices).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>zeros        <span class="ot">=</span> <span class="fu">Image</span>(<span class="at">dim =</span> <span class="fu">dim</span>(nuclei))</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>voronoiExamp <span class="ot">=</span> <span class="fu">propagate</span>(<span class="at">seeds =</span> nuclei, <span class="at">x =</span> zeros, <span class="at">lambda =</span> <span class="dv">100</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>voronoiPaint <span class="ot">=</span> <span class="fu">paintObjects</span>(voronoiExamp, <span class="dv">1</span> <span class="sc">-</span> nucOpened)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-voronoiPaint" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-voronoiPaint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-voronoiPaint-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-29" title="Figure&nbsp;11.13: Example of a Voronoi segmentation, indicated by the gray lines, using the nuclei (indicated by black regions) as seeds."><img src="11-chap_files/figure-html/fig-voronoiPaint-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-voronoiPaint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.13: Example of a Voronoi segmentation, indicated by the gray lines, using the nuclei (indicated by black regions) as seeds.
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-images-voronoipart" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.11
</div>
</div>
<div class="callout-body-container callout-body">
<p>How do you select partition elements from the tessellation?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The result, <code>voronoiExamp</code>, of the above call to <code>propagate</code> is simply an image of integers whose values indicate the different partitions.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">table</span>(voronoiExamp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>voronoiExamp
   1    2    3    4    5    6 
5645 4735  370 5964 3333 1377 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>ind <span class="ot">=</span> <span class="fu">which</span>(voronoiExamp <span class="sc">==</span> <span class="dv">13</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ind, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     row col
[1,] 112 100
[2,] 113 100
[3,] 114 100</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>The result is shown in <a href="#fig-voronoiPaint" class="quarto-xref">Figure&nbsp;<span>11.13</span></a>. This looks interesting, but perhaps not yet as useful as the image <code>nuclei</code> in Figure [morphop]. We note that the basic definition of Voronoi tessellation, which we have given above, allows for two generalizations:</p>
<ul>
<li><p>By default, the space that we partition is the full, rectangular image area – but indeed we could restrict ourselves to any arbitrary subspace. This is akin to finding the shortest distance from each point to the next seed not in a simple flat landscape, but in a landscape that is interspersed by lakes and rivers (which you cannot cross), so that all paths need to remain on the land. <code>propagate</code> allows for this generalization through its <code>mask</code> parameter.</p></li>
<li><p>By default, we think of the space as flat – but in fact it could have hills and canyons, so that the distance between two points in the landscape not only depends on their <span class="math inline">\(x\)</span>- and <span class="math inline">\(y\)</span>-positions but also on the ascents and descents, up and down in <span class="math inline">\(z\)</span>-direction, that lie in between. We can think of <span class="math inline">\(z\)</span> as an “elevation”. You can specify such a landscape to <code>propagate</code> through its <code>x</code> argument.</p></li>
</ul>
<p>Mathematically, we say that instead of the simple default case (a flat rectangle, or image, with a Euclidean metric on it), we perform the Voronoi segmentation on a Riemann manifold that has a special shape and a special metric. Let us use the notation <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> for the column and row coordinates of the image, and <span class="math inline">\(z\)</span> for the elevation. For two neighboring points, defined by coordinates <span class="math inline">\((x, y, z)\)</span> and <span class="math inline">\((x+\text{d}x, y+\text{d}y, z+\text{d}z)\)</span>, the distance <span class="math inline">\(\text{d}s\)</span> between them is thus not obtained by the usual Euclidean metric on the 2D image,</p>
<p><span class="anchored-eq" data-anchor-id="eq-eukldist" id="eq-eukldist"><span class="math display">\[
\text{d}s^2 = \text{d}x^2 + \text{d}y^2
\tag{11.3}\]</span></span></p>
<p>but instead</p>
<p><span class="anchored-eq" data-anchor-id="eq-riemandist" id="eq-riemandist"><span class="math display">\[
\text{d}s^2 =  \frac{2}{\lambda+1} \left[ \lambda \left( \text{d}x^2 + \text{d}y^2 \right) + \text{d}z^2 \right],
\tag{11.4}\]</span></span></p>
<p>where the parameter <span class="math inline">\(\lambda\)</span> is a real number <span class="math inline">\(\ge0\)</span>. To understand this, lets look at some important cases:</p>
<p><span class="anchored-eq" data-anchor-id="eq-Image" id="eq-Image-lambdaspecialcases"><span class="math display">\[
\begin{aligned}
\lambda=1:&amp;\quad        \text{d}s^2 = \text{d}x^2 + \text{d}y^2 + \text{d}z^2\\
\lambda=0:&amp;\quad        \text{d}s^2 = 2\, \text{d}z^2\\
\lambda\to\infty:&amp;\quad \text{d}s^2 = 2 \left( \text{d}x^2 + \text{d}y^2 \right)\\
\end{aligned}
\tag{11.5}\]</span></span></p>
<p>For <span class="anchored-eq" data-anchor-id="eq-Image" class="math inline">\(\lambda=1\)</span>, the metric becomes the isotropic Euclidean metric, i.e., a movement in <span class="math inline">\(z\)</span>-direction is equally “expensive” or “far” as in <span class="math inline">\(x\)</span>- or <span class="math inline">\(y\)</span>-direction. In the extreme case of <span class="math inline">\(\lambda=0\)</span>, only the <span class="math inline">\(z\)</span>-movements matter, whereas lateral movements (in <span class="math inline">\(x\)</span>- or <span class="math inline">\(y\)</span>-direction) do not contribute to the distance. In the other extreme case, <span class="math inline">\(\lambda\to\infty\)</span>, only lateral movements matter, and movement in <span class="math inline">\(z\)</span>-direction is “free”. Distances between points further apart are obtained by summing <span class="math inline">\(\text{d}s\)</span> along the shortest path between them. The parameter <span class="math inline">\(\lambda\)</span> serves as a convenient control of the relative weighting between sideways movement (along the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> axes) and vertical movement. Intuitively, if you imagine yourself as a hiker in such a landscape, by choosing <span class="math inline">\(\lambda\)</span> you can specify how much you are prepared to climb up and down to overcome a mountain, versus walking around it. When we used <code>lambda = 100</code> in our call to <code>propagate</code> at the begin of this section, this value was effectively infinite, so we were in the third boundary case of <a href="#eq-Image-lambdaspecialcases" class="quarto-xref">Equation&nbsp;<span>11.5</span></a>.</p>
<p>For the purpose of cell segmentation, these ideas were put forward by Thouis Jones et al. <span class="citation" data-cites="jones2005voronoi carpenter2006cellprofiler">(<a href="16-chap.html#ref-jones2005voronoi" role="doc-biblioref">Jones, Carpenter, and Golland 2005</a>; <a href="16-chap.html#ref-carpenter2006cellprofiler" role="doc-biblioref">Carpenter et al. 2006</a>)</span>, who also wrote the efficient algorithm that is used by <code>propagate</code>.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Try out the effect of using different <span class="math inline">\(\lambda\)</span>s.</p>
</div>
</div>
</section>
<section id="sec-bodies" class="level2 page-columns page-full" data-number="11.13">
<h2 data-number="11.13" class="anchored" data-anchor-id="sec-bodies"><span class="header-section-number">11.13</span> Segmenting the cell bodies</h2>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-histcellbody-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-histcellbody-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-histcellbody-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-30" title="Figure&nbsp;11.14: Histogram of the actin channel in cellsSmooth, after taking the logarithm."><img src="11-chap_files/figure-html/fig-histcellbody-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-histcellbody-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.14: Histogram of the actin channel in <code>cellsSmooth</code>, after taking the logarithm.
</figcaption>
</figure>
</div>
</div></div></div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-histcellbody-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-histcellbody-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-histcellbody-2-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-31" title="Figure&nbsp;11.15: Zoom into Figure&nbsp;fig-histcellbody-1."><img src="11-chap_files/figure-html/fig-histcellbody-2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-histcellbody-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.15: Zoom into <a href="#fig-histcellbody-1" class="quarto-xref">Figure&nbsp;<span>11.14</span></a>.
</figcaption>
</figure>
</div>
</div></div></div>
<p>To determine a mask of cytoplasmic area in the images, let us explore a different way of thresholding, this time using a global threshold which we find by fitting a mixture model to the data. The histograms show the distributions of the pixel intensities in the actin image. We look at the data on the logarithmic scale, and in <a href="#fig-histcellbody-2" class="quarto-xref">Figure&nbsp;<span>11.15</span></a> zoom into the region where most of the data lie.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">log</span>(cellsSmooth[,,<span class="dv">3</span>]) )</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">log</span>(cellsSmooth[,,<span class="dv">3</span>]), <span class="at">xlim =</span> <span class="sc">-</span><span class="fu">c</span>(<span class="fl">3.6</span>, <span class="fl">3.1</span>), <span class="at">breaks =</span> <span class="dv">300</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looking at the these histograms for many images, we can set up the following model for the purpose of segmentation: the signal in the cytoplasmic channels of the <em>Image</em> <code>cells</code> is a mixture of two distributions, a log-Normal background and a foreground with another, unspecified, rather flat, but mostly non-overlapping distribution<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>. Moreover the majority of pixels are from the background. We can then find robust estimates for the location and width parameters of the log-Normal component from the half range mode (implemented in the package <strong><a href="https://bioconductor.org/packages/genefilter/">genefilter</a></strong>) and from the root mean square of the values that lie left of the mode.</p>
<div class="no-row-height column-margin column-container"><div id="fn10"><p><sup>10</sup>&nbsp;This is an application of the ideas we saw in <a href="04-chap.html" class="quarto-xref"><span>Chapter 4</span></a> on mixture models.</p></div></div><div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"genefilter"</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>bgPars <span class="ot">=</span> <span class="cf">function</span>(x) {</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  x    <span class="ot">=</span> <span class="fu">log</span>(x)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  loc  <span class="ot">=</span> <span class="fu">half.range.mode</span>( x )</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  left <span class="ot">=</span> (x <span class="sc">-</span> loc)[ x <span class="sc">&lt;</span> loc ]</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  wid  <span class="ot">=</span> <span class="fu">sqrt</span>( <span class="fu">mean</span>(left<span class="sc">^</span><span class="dv">2</span>) )</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">loc =</span> loc, <span class="at">wid =</span> wid, <span class="at">thr =</span> loc <span class="sc">+</span> <span class="dv">6</span><span class="sc">*</span>wid)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>cellBg <span class="ot">=</span> <span class="fu">apply</span>(cellsSmooth, <span class="at">MARGIN =</span> <span class="dv">3</span>, <span class="at">FUN =</span> bgPars)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>cellBg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]        [,2]        [,3]
loc -2.90176965 -2.94427499 -3.52191681
wid  0.00635322  0.01121337  0.01528207
thr -2.86365033 -2.87699477 -3.43022437</code></pre>
</div>
</div>
<p>The function defines as a threshold the location <code>loc</code> plus 6 widths <code>wid</code><a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn11"><p><sup>11</sup>&nbsp;The choice of the number 6 here is ad hoc; we could make the choice of threshold more objective by estimating the weights of the two mixture components and assigning each pixel to either fore- or background based on its posterior probability according to the mixture model. More advanced segmentation methods use the fact that this is really a classification problem and include additional features and more complex classifiers to separate foreground and background regions (e.g., <span class="citation" data-cites="ilastik:NatMeth:2019">(<a href="16-chap.html#ref-ilastik:NatMeth:2019" role="doc-biblioref">Berg et al. 2019</a>)</span>).</p></div></div><div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">log</span>(cellsSmooth[,,<span class="dv">3</span>]), <span class="at">xlim =</span> <span class="sc">-</span><span class="fu">c</span>(<span class="fl">3.6</span>, <span class="fl">3.1</span>), <span class="at">breaks =</span> <span class="dv">300</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> cellBg[<span class="fu">c</span>(<span class="st">"loc"</span>, <span class="st">"thr"</span>), <span class="dv">3</span>], <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"brown"</span>, <span class="st">"red"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-histcellbody-3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-histcellbody-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-histcellbody-3-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-32" title="Figure&nbsp;11.16: As in Figure&nbsp;fig-histcellbody-2, but with loc and thr shown by vertical lines."><img src="11-chap_files/figure-html/fig-histcellbody-3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-histcellbody-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.16: As in <a href="#fig-histcellbody-2" class="quarto-xref">Figure&nbsp;<span>11.15</span></a>, but with <code>loc</code> and <code>thr</code> shown by vertical lines.
</figcaption>
</figure>
</div>
</div></div></div>
<p>We can now define <code>cytoplasmMask</code> by the union of all those pixels that are above the threshold in the actin or tubulin image, or that we have already classified as nuclear in the image <code>nuclei</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>cytoplasmMask <span class="ot">=</span> (cellsSmooth[,,<span class="dv">2</span>] <span class="sc">&gt;</span> <span class="fu">exp</span>(cellBg[<span class="st">"thr"</span>, <span class="dv">2</span>])) <span class="sc">|</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>       nuclei <span class="sc">|</span> (cellsSmooth[,,<span class="dv">3</span>] <span class="sc">&gt;</span> <span class="fu">exp</span>(cellBg[<span class="st">"thr"</span>, <span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is shown in the left panel of <a href="#fig-cellbodies" class="quarto-xref">Figure&nbsp;<span class="anchored-eq" data-anchor-id="eq-riemandist">11.17</span></a>. To define the cellular bodies, we can now simply extend the nucleus segmentation within this mask by the Voronoi tessellation based propagation algorithm of <a href="#sec-voronoi" class="quarto-xref"><span>Section 11.12</span></a>. This method makes sure that there is exactly one cell body for each nucleus, and the cell bodies are delineated in such a way that a compromise is reached between compactness of cell shape and following the actin and <span class="math inline">\(\alpha\)</span>-tubulin intensity signal in the images. In the terminology of the <code>propagate</code> algorithm, cell shape is kept compact by the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> components of the distance metric <a href="#eq-riemandist" class="quarto-xref"><span>11.4</span></a>, and the actin signal is used for the <span class="math inline">\(z\)</span> component. <span class="math inline">\(\lambda\)</span> controls the trade-off.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>cellbodies <span class="ot">=</span> <span class="fu">propagate</span>(<span class="at">x =</span> cellsSmooth[,,<span class="dv">3</span>], <span class="at">seeds =</span> nuclei,</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">lambda =</span> <span class="fl">1.0e-2</span>, <span class="at">mask =</span> cytoplasmMask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As an alternative representation to the <code>colorLabel</code> plots, we can also display the segmentations of nuclei and cell bodies on top of the original images using the <code>paintObjects</code> function; the Images <code>nucSegOnNuc</code>, <code>nucSegOnAll</code> and <code>cellSegOnAll</code> that are computed below are show in the middle to right panels of <a href="#fig-cellbodies" class="quarto-xref">Figure&nbsp;<span>11.17</span></a></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>cellsColor <span class="ot">=</span> EBImage<span class="sc">::</span><span class="fu">rgbImage</span>(<span class="at">red   =</span> cells[,,<span class="dv">3</span>],</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">green =</span> cells[,,<span class="dv">2</span>],</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">blue  =</span> cells[,,<span class="dv">1</span>])</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>nucSegOnNuc  <span class="ot">=</span> <span class="fu">paintObjects</span>(nuclei, <span class="at">tgt =</span> EBImage<span class="sc">::</span><span class="fu">toRGB</span>(cells[,,<span class="dv">1</span>]), <span class="at">col =</span> <span class="st">"#ffff00"</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>nucSegOnAll  <span class="ot">=</span> <span class="fu">paintObjects</span>(nuclei,     <span class="at">tgt =</span> cellsColor,    <span class="at">col =</span> <span class="st">"#ffff00"</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>cellSegOnAll <span class="ot">=</span> <span class="fu">paintObjects</span>(cellbodies, <span class="at">tgt =</span> nucSegOnAll,   <span class="at">col =</span> <span class="st">"#ff0080"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-cellbodies" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-cellbodies-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cellbodies" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-cellbodies-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-cellbodies-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-cellbodies-1.png" class="lightbox" data-gallery="fig-cellbodies" title="Figure&nbsp;11.17&nbsp;(a): "><img src="11-chap_files/figure-html/fig-cellbodies-1.png" id="fig-cellbodies-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-cellbodies" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-cellbodies-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cellbodies" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-cellbodies-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-cellbodies-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-cellbodies-2.png" class="lightbox" data-gallery="fig-cellbodies" title="Figure&nbsp;11.17&nbsp;(b): "><img src="11-chap_files/figure-html/fig-cellbodies-2.png" id="fig-cellbodies-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-cellbodies" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-cellbodies-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cellbodies" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-cellbodies-3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-cellbodies-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-cellbodies-3.png" class="lightbox" data-gallery="fig-cellbodies" title="Figure&nbsp;11.17&nbsp;(c): "><img src="11-chap_files/figure-html/fig-cellbodies-3.png" id="fig-cellbodies-3" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-cellbodies" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-cellbodies-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cellbodies" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-cellbodies-4" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-cellbodies-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-cellbodies-4.png" class="lightbox" data-gallery="fig-cellbodies" title="Figure&nbsp;11.17&nbsp;(d): "><img src="11-chap_files/figure-html/fig-cellbodies-4.png" id="fig-cellbodies-4" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-cellbodies" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-cellbodies-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cellbodies" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-cellbodies-5" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="181.333333333333">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-cellbodies-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-cellbodies-5.png" class="lightbox" data-gallery="fig-cellbodies" title="Figure&nbsp;11.17&nbsp;(e): "><img src="11-chap_files/figure-html/fig-cellbodies-5.png" id="fig-cellbodies-5" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-cellbodies" width="181"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-cellbodies-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(e)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-cellbodies-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.17: Steps in the segmentation of the cell bodies. From (a-d): <code>cytoplasmMask</code>, <code>cellbodies</code> (blue: DAPI, red: actin, green: alpha-tubulin), <code>nucSegOnNuc</code>, <code>nucSegOnAll</code>, <code>cellSegOnAll</code>.
</figcaption>
</figure>
</div>
</section>
<section id="sec-featextract" class="level2" data-number="11.14">
<h2 data-number="11.14" class="anchored" data-anchor-id="sec-featextract"><span class="header-section-number">11.14</span> Feature extraction</h2>
<p>Now that we have the segmentations <code>nuclei</code> and <code>cellbodies</code> together with the original image data <code>cells</code>, we can compute various descriptors, or features, for each cell. We already saw in the beginning of <a href="#sec-segbin" class="quarto-xref"><span>Section 11.11</span></a> how to use the base R function <code>table</code> to determine the total number and sizes of the objects. Let us now take this further and compute the mean intensity of the DAPI signal (<code>cells[,,1]</code>) in the segmented nuclei, the mean actin intensity (<code>cells[,,3]</code>) in the segmented nuclei and the mean actin intensity in the cell bodies.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>meanNucInt       <span class="ot">=</span> <span class="fu">tapply</span>(cells[,,<span class="dv">1</span>], nuclei, mean)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>meanActIntInNuc  <span class="ot">=</span> <span class="fu">tapply</span>(cells[,,<span class="dv">3</span>], nuclei, mean)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>meanActIntInCell <span class="ot">=</span> <span class="fu">tapply</span>(cells[,,<span class="dv">3</span>], cellbodies, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can visualize the features in pairwise scatterplots (<a href="#fig-pairsint" class="quarto-xref">Figure&nbsp;<span>11.18</span></a>). We see that they are correlated with each other, although each feature also carries independent information.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"GGally"</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(<span class="fu">tibble</span>(meanNucInt, meanActIntInNuc, meanActIntInCell))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pairsint" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pairsint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-pairsint-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-38" title="Figure&nbsp;11.18: Pairwise scatterplots of per-cell intensity descriptors."><img src="11-chap_files/figure-html/fig-pairsint-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pairsint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.18: Pairwise scatterplots of per-cell intensity descriptors.
</figcaption>
</figure>
</div>
</div>
</div>
<p>With a little more work, we could also compute more sophisticated summary statistics – e.g., the ratio of nuclei area to cell body area; or entropies, mutual information and correlation of the different fluorescent signals in each cell body, as more or less abstract measures of cellular morphology. Such measures can be used, for instance, to detect subtle drug induced changes of cellular architecture.</p>
<p>While it is easy and intuitive to perform these computations using basic R idioms like in the <code>tapply</code> expressions above, the package <strong><a href="https://bioconductor.org/packages/EBImage/">EBImage</a></strong> also provides the function <code>computeFeatures</code> which efficiently computes a large collection of features that have been commonly used in the literature (a pioneering reference is <span class="citation" data-cites="BolandMurphy">Boland and Murphy. (<a href="16-chap.html#ref-BolandMurphy" role="doc-biblioref">2001</a>)</span>). Details about this function are described in its manual page, and an example application is worked through in the <strong><a href="https://bioconductor.org/packages/HD2013SGI/">HD2013SGI</a></strong> vignette. Below, we compute features for intensity, shape and texture for each cell from the DAPI channel using the nucleus segmentation (<code>nuclei</code>) and from the actin and tubulin channels using the cell body segmentation (<code>cytoplasmRegions</code>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>F1 <span class="ot">=</span> <span class="fu">computeFeatures</span>(nuclei,     cells[,,<span class="dv">1</span>], <span class="at">xname =</span> <span class="st">"nuc"</span>,  <span class="at">refnames =</span> <span class="st">"nuc"</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>F2 <span class="ot">=</span> <span class="fu">computeFeatures</span>(cellbodies, cells[,,<span class="dv">2</span>], <span class="at">xname =</span> <span class="st">"cell"</span>, <span class="at">refnames =</span> <span class="st">"tub"</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>F3 <span class="ot">=</span> <span class="fu">computeFeatures</span>(cellbodies, cells[,,<span class="dv">3</span>], <span class="at">xname =</span> <span class="st">"cell"</span>, <span class="at">refnames =</span> <span class="st">"act"</span>)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(F1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 43 89</code></pre>
</div>
</div>
<p><code>F1</code> is a matrix with 43 rows (one for each cell) and 89 columns, one for each of the computed features.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>F1[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  nuc.0.m.cx nuc.0.m.cy nuc.0.m.majoraxis nuc.0.m.eccentricity nuc.0.m.theta
1   119.5523   17.46895          44.86819            0.8372059     -1.314789
2   143.4511   15.83709          26.15009            0.6627672     -1.213444
3   336.5401   11.48175          18.97424            0.8564444      1.470913</code></pre>
</div>
</div>
<p>The column names encode the type of feature, as well the color channel(s) and segmentation mask on which it was computed. We can now use multivariate analysis methods – like those we saw in Chapters <a href="05-chap.html" class="quarto-xref"><span>5</span></a>, <a href="07-chap.html" class="quarto-xref"><span>7</span></a> and <a href="09-chap.html" class="quarto-xref"><span>9</span></a> – for many dfferent tasks, such as</p>
<ul>
<li><p>detecting cell subpopulations (clustering)</p></li>
<li><p>classifying cells into pre-defined cell types or phenotypes (classification)</p></li>
<li><p>seeing whether the absolute or relative frequencies of the subpopulations or cell types differ between images that correspond to different biological conditions</p></li>
</ul>
<p>In addition to these “generic” machine learning tasks, we also know the cell’s spatial positions, and in the following we will explore some ways to make use of these in our analyses.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use explorative multivariate methods to visualize the matrices <code>F1</code>, <code>F2</code>, <code>F3</code>: PCA, heatmap. What’s special about the “outlier” cells?</p>
</div>
</div>
</section>
<section id="sec-spatstat" class="level2 page-columns page-full" data-number="11.15">
<h2 data-number="11.15" class="anchored" data-anchor-id="sec-spatstat"><span class="header-section-number">11.15</span> Spatial statistics: point processes</h2>
<p>In the previous sections, we have seen ways how to use images of cells to extract their positions and various shape and morphological features. We’ll now explore spatial distributions of the position. In order to have interesting data to work on, we’ll change datasets and look at breast cancer lymph node biopsies.</p>
<section id="a-case-study-interaction-between-immune-cells-and-cancer-cells" class="level3 page-columns page-full" data-number="11.15.1">
<h3 data-number="11.15.1" class="anchored" data-anchor-id="a-case-study-interaction-between-immune-cells-and-cancer-cells"><span class="header-section-number">11.15.1</span> A case study: Interaction between immune cells and cancer cells</h3>
<p>The lymph nodes function as an immunologic filter for the bodily fluid known as lymph. Antigens are filtered out of the lymph in the lymph node before returning it to the circulation. Lymph nodes are found throughout the body, and are composed mostly of T cells, B cells, dendritic cells and macrophages. The nodes drain fluid from most of our tissues. The lymph ducts of the breast usually drain to one lymph node first, before draining through the rest of the lymph nodes underneath the arm. That first lymph node is called the <em>sentinel</em> lymph node. In a similar fashion as the spleen, the macrophages and dendritic cells that capture antigens present these foreign materials to T and B cells, consequently initiating an immune response.</p>
<p>T lymphocytes are usually divided into two major subsets that are functionally and phenotypically different.</p>
<ul>
<li><p>CD4+ T-cells, or T helper cells: they are pertinent coordinators of immune regulation. The main function of T helper cells is to augment or potentiate immune responses by the secretion of specialized factors that activate other white blood cells to fight off infection.</p></li>
<li><p>CD8+ T cells, or T killer/suppressor cells: these cells are important in directly killing certain tumor cells, viral-infected cells and sometimes parasites. The CD8+ T cells are also important for the down-regulation of immune responses.</p></li>
</ul>
<p>Both types of T cells can be found throughout the body. They often depend on the secondary lymphoid organs (the lymph nodes and spleen) as sites where activation occurs.</p>
<p>Dendritic Cells or CD1a cells are antigen-presenting cells that process antigen and present peptides to T cells.</p>
<p>Typing the cells can be done by staining the cells with protein antibodies that provide specific signatures. For instance, different types of immune cells have different proteins expressed, mostly in their cell membranes.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-sixpanelslymphsmall" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-cap-location="margin" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-sixpanelslymphsmall-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/SixPanelsLymphsmall.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-39" title="Figure&nbsp;11.19: Biopsy of an enlarged lymph node revealed an intact capsule and obliterated sinuses (upper left panel, stained with hematoxylin and eosin, original magnification \times 100). The infiltrate was composed of an admixture of small lymphocytes, macrophages, and plasma cells (upper right panel, hematoxylin and eosin, original magnification \times 400). The infiltrate was composed of a mixture of CD3 positive T-cells (including both CD4 and CD8 positive cells) and CD20 positive B-cells. Numerous macrophages were also CD4 positive. (From: Hurley et al., Diagnostic Pathology (2008) 3:13)"><img src="imgs/SixPanelsLymphsmall.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-sixpanelslymphsmall-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.19: Biopsy of an enlarged lymph node revealed an intact capsule and obliterated sinuses (upper left panel, stained with hematoxylin and eosin, original magnification <span class="math inline">\(\times\)</span> 100). The infiltrate was composed of an admixture of small lymphocytes, macrophages, and plasma cells (upper right panel, hematoxylin and eosin, original magnification <span class="math inline">\(\times\)</span> 400). The infiltrate was composed of a mixture of CD3 positive T-cells (including both CD4 and CD8 positive cells) and CD20 positive B-cells. Numerous macrophages were also CD4 positive. (From: Hurley et al., Diagnostic Pathology (2008) 3:13)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-stainedlymphnode" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-cap-location="margin" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-stainedlymphnode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/testscan_1_2_RGB99-4525D.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-40" title="Figure&nbsp;11.20: A stained lymph node; this image is the basis for the spatial data in brcalymphnode."><img src="imgs/testscan_1_2_RGB99-4525D.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-stainedlymphnode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.20: A stained lymph node; this image is the basis for the spatial data in <code>brcalymphnode</code>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We’ll look at data by <span class="citation" data-cites="Setiadi2010">Setiadi et al. (<a href="16-chap.html#ref-Setiadi2010" role="doc-biblioref">2010</a>)</span>. After segmentating the image shown in <a href="#fig-stainedlymphnode" class="quarto-xref">Figure&nbsp;<span>11.20</span></a> using the segmentation method <em>GemIdent</em> <span class="citation" data-cites="Holmes2009">(<a href="16-chap.html#ref-Holmes2009" role="doc-biblioref">Holmes, Kapelner, and Lee 2009</a>)</span>, the authors obtained the coordinates and the type of all the cells in the image. We call this type of data a <em>marked point process</em>, and it can be seen as a simple table with 3 columns.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"readr"</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>cellclasses <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"T_cells"</span>, <span class="st">"Tumor"</span>, <span class="st">"DCs"</span>, <span class="st">"other_cells"</span>)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>brcalymphnode <span class="ot">=</span> <span class="fu">lapply</span>(cellclasses, <span class="cf">function</span>(k) {</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_csv</span>(<span class="fu">file.path</span>(<span class="st">".."</span>, <span class="st">"data"</span>, <span class="fu">sprintf</span>(<span class="st">"99_4525D-%s.txt"</span>, k))) <span class="sc">|&gt;</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">x =</span> globalX, <span class="at">y =</span> globalY, <span class="at">class =</span> k)</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">factor</span>(class))</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>brcalymphnode</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 209,462 × 3
       x     y class  
   &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;  
 1  6355 10382 T_cells
 2  6356 10850 T_cells
 3  6357 11070 T_cells
 4  6357 11082 T_cells
 5  6358 10600 T_cells
 6  6361 10301 T_cells
 7  6369 10309 T_cells
 8  6374 10395 T_cells
 9  6377 10448 T_cells
10  6379 10279 T_cells
# ℹ 209,452 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(brcalymphnode<span class="sc">$</span>class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
        DCs other_cells     T_cells       Tumor 
        878       77081      103681       27822 </code></pre>
</div>
</div>
<p>We see that there are over a 100,000 T cells, around 28,000 tumor cells, and only several hundred dendritic cells. Let’s plot the <span class="math inline">\(x\)</span>- and <span class="math inline">\(y\)</span>-positions of the cells (<a href="#fig-brcalntcells" class="quarto-xref">Figure&nbsp;<span>11.21</span></a>).</p>
<div class="cell page-columns page-full" data-layout-align="center" data-pointsize="24">
<div class="sourceCode cell-code" id="cb78" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">filter</span>(brcalymphnode, class <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"T_cells"</span>, <span class="st">"Tumor"</span>)),</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">col =</span> class)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">"."</span>) <span class="sc">+</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">facet_grid</span>( . <span class="sc">~</span> class) <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">col =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div id="fig-brcalntcells" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-cap-location="margin" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-brcalntcells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-brcalntcells-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-41" title="Figure&nbsp;11.21: Scatterplot of the x and y positions of the T- and tumor cells in brcalymphnode. The locations were obtained by a segmentation algorithm from a high resolution version of Figure&nbsp;fig-stainedlymphnode. Some rectangular areas in the T-cells plot are suspiciously empty, this could be because the corresponding image tiles within the overall composite image went missing, or were not analyzed."><img src="11-chap_files/figure-html/fig-brcalntcells-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="640"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-brcalntcells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.21: Scatterplot of the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> positions of the T- and tumor cells in <code>brcalymphnode</code>. The locations were obtained by a segmentation algorithm from a high resolution version of <a href="#fig-stainedlymphnode" class="quarto-xref">Figure&nbsp;<span>11.20</span></a>. Some rectangular areas in the T-cells plot are suspiciously empty, this could be because the corresponding image tiles within the overall composite image went missing, or were not analyzed.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="wrn-images-axesinvert" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.12
</div>
</div>
<div class="callout-body-container callout-body">
<p>Compare Figures <a href="#fig-stainedlymphnode" class="quarto-xref"><span>11.20</span></a> and <a href="#fig-brcalntcells" class="quarto-xref"><span>11.21</span></a>. Why are the <span class="math inline">\(y\)</span>-axis inverted relative to each other?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-24-contents" aria-controls="callout-24" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-24" class="callout-24-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><a href="#fig-stainedlymphnode" class="quarto-xref">Figure&nbsp;<span>11.20</span></a> follows the convention for image data, where the origin is in the top left corner of the image, while <a href="#fig-brcalntcells" class="quarto-xref">Figure&nbsp;<span>11.21</span></a> follows the convention for Cartesian plots, with the origin at the bottom left.</p>
</div>
</div>
</div>
<p>To use the functionality of the <strong><a href="https://cran.r-project.org/web/packages/spatstat/">spatstat</a></strong> package, it is convenient to convert our data in <code>brcalymphnode</code> into an object of class <em>ppp</em>; we do this by calling the eponymous function.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"spatstat"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>ln <span class="ot">=</span> <span class="fu">with</span>(brcalymphnode, <span class="fu">ppp</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">marks =</span> class, </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">xrange =</span> <span class="fu">range</span>(x), <span class="at">yrange =</span> <span class="fu">range</span>(y)))</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>ln</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Marked planar point pattern: 209462 points
Multitype, with levels = DCs, other_cells, T_cells, Tumor 
window: rectangle = [3839, 17276] x [6713, 23006] units</code></pre>
</div>
</div>
<p><em>ppp</em> objects are designed to capture realizations of a <strong>spatial point process</strong>, that is, a set of isolated points located in a mathematical space; in our case, as you can see above, the space is a two-dimensional rectangle that contains the range of the <span class="math inline">\(x\)</span>- and <span class="math inline">\(y\)</span>-coordinates. In addition, the points can be <em>marked</em> with certain properties. In <code>ln</code>, the mark is simply the <em>factor</em> variable <code>class</code>. More generally, it could be several attributes, times, or quantitative data as well. There are similarities between a marked point process and an image, although for the former, the points can lie anywhere within the space, whereas in an image, the pixels are covering the space in regular, rectangular way.</p>
</section>
<section id="sec-chull" class="level3 page-columns page-full" data-number="11.15.2">
<h3 data-number="11.15.2" class="anchored" data-anchor-id="sec-chull"><span class="header-section-number">11.15.2</span> Convex hull</h3>
<p>Above, we (implicitly) confined the point process to lie in a rectangle. In fact, the data generating process is more confined, by the shape of the tissue section. We can approximate this and compute a tighter region from the convex hull of the points<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn12"><p><sup>12</sup>&nbsp;You can use <code>str(cvxhull)</code> to look at the internal structure of this S3 object.</p></div></div><div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>cvxhull <span class="ot">=</span> <span class="fu">convexhull.xy</span>(<span class="fu">cbind</span>(ln<span class="sc">$</span>x, ln<span class="sc">$</span>y))</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">as_tibble</span>(cvxhull<span class="sc">$</span>bdry[[<span class="dv">1</span>]]), <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(<span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">coord_fixed</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-convhull" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-convhull-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-convhull-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-42" title="Figure&nbsp;11.22: Polygon describing the convex hull of the points in ln."><img src="11-chap_files/figure-html/fig-convhull-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-convhull-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.22: Polygon describing the convex hull of the points in <code>ln</code>.
</figcaption>
</figure>
</div>
</div></div></div>
<p>We can see the polygon in <a href="#fig-convhull" class="quarto-xref">Figure&nbsp;<span>11.22</span></a> and now call <code>ppp</code> again, this time with the polygon.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>ln <span class="ot">=</span> <span class="fu">with</span>(brcalymphnode, <span class="fu">ppp</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">marks =</span> class, </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">poly =</span> cvxhull<span class="sc">$</span>bdry[[<span class="dv">1</span>]]))</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>ln</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Marked planar point pattern: 209462 points
Multitype, with levels = DCs, other_cells, T_cells, Tumor 
window: polygonal boundary
enclosing rectangle: [3839, 17276] x [6713, 23006] units</code></pre>
</div>
</div>
</section>
<section id="sec-space" class="level3" data-number="11.15.3">
<h3 data-number="11.15.3" class="anchored" data-anchor-id="sec-space"><span class="header-section-number">11.15.3</span> Other ways of defining the space for the point process</h3>
<p>We do not have to use the convex hull to define the space on which the point process is considered. Alternatively, we could have provided an image mask to <code>ppp</code> that defines the space based on prior knowledge; or we could use density estimation on the sampled points to only identify a region in which there is a high enough point density, ignoring sporadic outliers. These choices are part of the analyst’s job when considering spatial point processes.</p>
</section>
</section>
<section id="sec-intensity" class="level2 page-columns page-full" data-number="11.16">
<h2 data-number="11.16" class="anchored" data-anchor-id="sec-intensity"><span class="header-section-number">11.16</span> First order effects: the intensity</h2>
<p>One of the most basic questions of spatial statistics is whether neighboring points are “clustering”, i.e., whether and to what extent they are closer to each other than expected “by chance”; or perhaps the opposite, whether they seem to repel each other. There are many examples where this kind of question can be asked, for instance</p>
<ul>
<li><p>crime patterns within a city,</p></li>
<li><p>disease patterns within a country,</p></li>
<li><p>soil measurements in a region.</p></li>
</ul>
<p>It is usually not hard to find reasons why such patterns exist: good and bad neighborhoods, local variations in lifestyle or environmental exposure, the common geological history of the soil. Sometimes there may also be mechanisms by which the observed events attract or repel each other – the proverbial “broken windows” in a neighborhood, or the tendency of many cell types to stick close to other cells.</p>
<p>The cell example highlights that spatial clustering (or anticlustering) can depend on the objects’ attributes (or marks, in the parlance of spatial point processes). It also highlights that the answer can depend on the length scale considered. Even if cells attract each other, they have a finite size, and cannot occupy the same space. So there will be some minmal distance between them, on the scale of which they essentially repel each other, while at further distances, they attract.</p>
<p>To attack these questions more quantitatively, we need to define a probabilistic model of what we expect <em>by chance</em>. Let’s count the number of points lying in a subregion, say, a circle of area <span class="math inline">\(a\)</span> around a point <span class="math inline">\(p=(x,y)\)</span>; call this <span class="math inline">\(N(p, a)\)</span><a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> The mean and covariance of <span class="math inline">\(N\)</span> provide first and second order properties. The first order is the intensity of the process:</p>
<div class="no-row-height column-margin column-container"><div id="fn13"><p><sup>13</sup>&nbsp;As usual, we use the uppercase notation <span class="anchored-eq" data-anchor-id="eq-omdpsghrjzyn" class="math inline">\(N(p, a)\)</span> for the random variable, and the lowercase <span class="math inline">\(n(p, a)\)</span> for its realizations, or samples.</p></div></div><p><span id="eq-omdpsghrjzyn"><span class="math display">\[
\lambda(p) = \lim_{a\rightarrow 0} \frac{E[ N(p, a)]}{a}.
\tag{11.6}\]</span></span></p>
<p>Here we used infinitesimal calculus to define the local intensity <span class="math inline">\(\lambda(p)\)</span>. As for time series, a stationary process is one where we have homogeneity all over the region, i.e., <span class="math inline">\(\lambda(p) = \text{const.}\)</span>; then the intensity in an area <span class="math inline">\(A\)</span> is proportional to the area: <span class="math inline">\(E[N(\cdot, A)] = \lambda A\)</span>. Later we’ll also look at higher order statistics, such as the spatial covariance</p>
<p><span class="anchored-eq" data-anchor-id="eq-crwopheibgjt" id="eq-crwopheibgjt"><span class="math display">\[
\gamma(p_1, p_2) = \lim_{a \rightarrow 0}
\frac{E \left[ \left(N(p_1, a) - E[ N(p_1, a)] \right)
\left(N(p_2, a) - E[ N(p_2, a)] \right) \right]}{a^2}.
\tag{11.7}\]</span></span></p>
<p>If the process is stationary, this will only depend on the relative position of the two points (the vector between them). If it only depends on the distance, i.e., only on the length but not on the direction of the vector, it is called second order isotropic.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-raindrops" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-raindrops-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/Rain-Drops-small.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-43" title="Figure&nbsp;11.23: Rain drops falling on the floor are modelled by a Poisson process. The number of drops falling on a particular spot only depends on the rate \lambda (and on the size of the spot), but not on what happens at other spots."><img src="imgs/Rain-Drops-small.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-raindrops-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.23: Rain drops falling on the floor are modelled by a Poisson process. The number of drops falling on a particular spot only depends on the rate <span class="math inline">\(\lambda\)</span> (and on the size of the spot), but not on what happens at other spots.
</figcaption>
</figure>
</div>
</div></div></div>
<section id="poisson-process" class="level3" data-number="11.16.1">
<h3 data-number="11.16.1" class="anchored" data-anchor-id="poisson-process"><span class="header-section-number">11.16.1</span> Poisson Process</h3>
<p>The simplest spatial process is the Poisson process. We will use it as a null model against which to compare our data. It is stationary with intensity <span class="math inline">\(\lambda\)</span>, and there are no further dependencies between occurrences of points in non-overlapping regions of the space. Moreover, the number of points in a region of area <span class="math inline">\(A\)</span> follows a Poisson distribution with rate <span class="math inline">\(\lambda A\)</span>.</p>
</section>
<section id="estimating-the-intensity" class="level3 page-columns page-full" data-number="11.16.2">
<h3 data-number="11.16.2" class="anchored" data-anchor-id="estimating-the-intensity"><span class="header-section-number">11.16.2</span> Estimating the intensity</h3>
<p>To estimate the intensity, divide up the area into subregions, small enough to see potential local variations of <span class="math inline">\(\lambda(p)\)</span>, but big enough to contain a sufficient sample of points. This is analogous to 2D density estimation, and instead of hard region boundaries, we can use a smooth kernel function <span class="math inline">\(K\)</span>.</p>
<p><span class="anchored-eq" data-anchor-id="eq-density" id="eq-density-ppp"><span class="math display">\[
\hat{\lambda}(p) = \sum_i e(p_i) K(p-p_i).
\tag{11.8}\]</span></span></p>
<p>The kernel function depends on a smoothing parameter, <span class="anchored-eq" data-anchor-id="eq-density" class="math inline">\(\sigma\)</span>, the larger it is, the larger the regions over which we compute the local estimate for each <span class="math inline">\(p\)</span>. <span class="math inline">\(e(p)\)</span> is an edge correction factor, and takes into account the estimation bias caused when the support of the kernel (the “smoothing window”) would fall outside the space on which the point process is defined. The function <code>density</code>, which is defined for <em>ppp</em> objects in the <strong><a href="https://cran.r-project.org/web/packages/spatstat/">spatstat</a></strong> package, implements <a href="#eq-density-ppp" class="quarto-xref">Equation&nbsp;<span>11.8</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">=</span> <span class="fu">density</span>(<span class="fu">subset</span>(ln, marks <span class="sc">==</span> <span class="st">"Tumor"</span>), <span class="at">edge=</span><span class="cn">TRUE</span>, <span class="at">diggle=</span><span class="cn">TRUE</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-densityppp1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-densityppp1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-densityppp1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-44" title="Figure&nbsp;11.24: Intensity estimate for the cells marked Tumor in ppp. The support of the estimate is the polygon that we specified earlier on (Figure&nbsp;fig-convhull)."><img src="11-chap_files/figure-html/fig-densityppp1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="300"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-densityppp1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.24: Intensity estimate for the cells marked <code>Tumor</code> in <code>ppp</code>. The support of the estimate is the polygon that we specified earlier on (<a href="#fig-convhull" class="quarto-xref">Figure&nbsp;<span>11.22</span></a>).
</figcaption>
</figure>
</div>
</div></div></div>
<p>The plot is shown in <a href="#fig-densityppp1" class="quarto-xref">Figure&nbsp;<span>11.24</span></a>.</p>
<div id="wrn-images-diggle" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.13
</div>
</div>
<div class="callout-body-container callout-body">
<p>How does the estimate look without edge correction?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-26-contents" aria-controls="callout-26" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-26" class="callout-26-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>d0 <span class="ot">=</span> <span class="fu">density</span>(<span class="fu">subset</span>(ln, marks <span class="sc">==</span> <span class="st">"Tumor"</span>), <span class="at">edge =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-densityppp0" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-densityppp0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-densityppp0-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-45" title="Figure&nbsp;11.25: As Figure&nbsp;fig-densityppp1, but without edge correction."><img src="11-chap_files/figure-html/fig-densityppp0-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-densityppp0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.25: As <a href="#fig-densityppp1" class="quarto-xref">Figure&nbsp;<span>11.24</span></a>, but without edge correction.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now estimated intensity is smaller towards the edge of the space, reflecting edge bias (<a href="#fig-densityppp0" class="quarto-xref">Figure&nbsp;<span>11.25</span></a>).</p>
</div>
</div>
</div>
<p><code>density</code> gives us as estimate of the <em>intensity</em> of the point process. A related, but different task is the estimation of the (conditional) <em>probability</em> of being a particular cell class. The function <code>relrisk</code> computes a nonparametric estimate of the spatially varying risk of a particular event type. We’re interested in the probability that a cell that is present at particular spatial location will be a tumor cell (<a href="#fig-relrisk" class="quarto-xref">Figure&nbsp;<span>11.26</span></a>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">relrisk</span>(ln, <span class="at">sigma =</span> <span class="dv">250</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb88" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div id="fig-relrisk" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-cap-location="margin" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-relrisk-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-relrisk-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-46" title="Figure&nbsp;11.26: Estimates of the spatially varying probability of each of the cell classes, conditional on there being cells."><img src="11-chap_files/figure-html/fig-relrisk-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="560"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-relrisk-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.26: Estimates of the spatially varying probability of each of the cell classes, conditional on there being cells.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="second-order-effects-spatial-dependence" class="level2 page-columns page-full" data-number="11.17">
<h2 data-number="11.17" class="anchored" data-anchor-id="second-order-effects-spatial-dependence"><span class="header-section-number">11.17</span> Second order effects: spatial dependence</h2>
<p>If we pick a point at random in our spatial process, what is the distance <span class="math inline">\(W\)</span> to its nearest neighbor? For a homogenous Poisson process, the cumulative distribution function of this distance is</p>
<p><span class="anchored-eq" data-anchor-id="eq-GPP" id="eq-GPP"><span class="math display">\[
G(w) = P(W\leq w) = 1-e^{-\lambda \pi w^2}.
\tag{11.9}\]</span></span></p>
<p>Plotting <span class="math inline">\(G\)</span> gives a way of noticing departure from the homogenous Poisson process. An estimator of <span class="math inline">\(G\)</span>, which also takes into account edge effects <span class="citation" data-cites="Baddeley1998 RipleySISS1988">(<a href="16-chap.html#ref-Baddeley1998" role="doc-biblioref">A. J. Baddeley 1998</a>; <a href="16-chap.html#ref-RipleySISS1988" role="doc-biblioref">Ripley 1988</a>)</span>, is provided by the function <code>Gest</code> of the <strong><a href="https://cran.r-project.org/web/packages/spatstat/">spatstat</a></strong> package.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>gln <span class="ot">=</span> <span class="fu">Gest</span>(ln)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>gln</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Function value object (class 'fv')
for the function r -&gt; G(r)
.....................................................................
        Math.label      Description                                  
r       r               distance argument r                          
theo    G[pois](r)      theoretical Poisson G(r)                     
han     hat(G)[han](r)  Hanisch estimate of G(r)                     
rs      hat(G)[bord](r) border corrected estimate of G(r)            
km      hat(G)[km](r)   Kaplan-Meier estimate of G(r)                
hazard  hat(h)[km](r)   Kaplan-Meier estimate of hazard function h(r)
theohaz h[pois](r)      theoretical Poisson hazard function h(r)     
.....................................................................
Default plot formula:  .~r
where "." stands for 'km', 'rs', 'han', 'theo'
Recommended range of argument r: [0, 20.998]
Available range of argument r: [0, 52.443]</code></pre>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"RColorBrewer"</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gln, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="fu">brewer.pal</span>(<span class="dv">4</span>, <span class="st">"Set1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-Gest" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Gest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-Gest-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-47" title="Figure&nbsp;11.27: Estimates of G, using three different edge effect corrections –which here happen to essentially lie on top of each other– and the theoretical distribution for a homogenous Poisson process."><img src="11-chap_files/figure-html/fig-Gest-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="340"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Gest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.27: Estimates of <span class="math inline">\(G\)</span>, using three different edge effect corrections –which here happen to essentially lie on top of each other– and the theoretical distribution for a homogenous Poisson process.
</figcaption>
</figure>
</div>
</div></div></div>
<p>The printed summary of the object <code>gln</code> gives an overview of the computed estimates; further explanations are in the manual page of <code>Gest</code>. In <a href="#fig-Gest" class="quarto-xref">Figure&nbsp;<span>11.27</span></a> we see that the empirical distribution function and that of our null model, a homogenous Poisson process with a suitably chosen intensity, cross at around 4.5 units. Cell to cell distances that are shorter than this value are less likely than for the null model, in particular, there are essentially no distances below around 2; this, of course, reflects the fact that our cells have finite size and cannot overlap the same space. There seems to be trend to avoid very large distances –compared to the Poisson process–, perhaps indicative of a tendency of the cells to cluster.</p>
<section id="ripleys-k-function" class="level3 page-columns page-full" data-number="11.17.1">
<h3 data-number="11.17.1" class="anchored" data-anchor-id="ripleys-k-function"><span class="header-section-number">11.17.1</span> Ripley’s <span class="math inline">\(K\)</span> function</h3>
<p>In homogeneous spatial Poisson process, if we randomly pick any point and count the number of points within a distance of at most <span class="math inline">\(r\)</span>, we expect this number to grow as the area of the circle, <span class="math inline">\(\pi r^2\)</span>. For a given dataset, we can compare this expectation to the observed number of neighbors within distance <span class="math inline">\(r\)</span>, averaged across all points.</p>
<p>The <span class="math inline">\(K\)</span> function (variously called <em>Ripley’s <span class="math inline">\(K\)</span>-function</em> or the <em>reduced second moment function</em>) of a stationary point process is defined so that <span class="math inline">\(\lambda K(r)\)</span> is the expected number of (additional) points within a distance <span class="math inline">\(r\)</span> of a given, randomly picked point. Remember that <span class="math inline">\(\lambda\)</span> is the intensity of the process, i.e., the expected number of points per unit area. The <span class="math inline">\(K\)</span> function is a second order moment property of the process.</p>
<p>The definition of <span class="math inline">\(K\)</span> can be generalized to inhomogeneous point processes and written as in <span class="citation" data-cites="Baddeley2000">(<a href="16-chap.html#ref-Baddeley2000" role="doc-biblioref">A. Baddeley, Moller, and Waagepetersen 2000</a>)</span>,</p>
<p><span class="anchored-eq" data-anchor-id="eq-kinhom" id="eq-kinhom"><span class="math display">\[
K_{\scriptsize \mbox{inhom}}(r)= \sum_{i,j} 𝟙_{d(p_i, p_j) \le r} \times \frac{e(p_i, p_j, r)} { \lambda(x_i)  \lambda(x_j) },
\tag{11.10}\]</span></span></p>
<p>where <span class="math inline">\(d(p_i, p_j)\)</span> is the distance between points <span class="math inline">\(p_i\)</span> and <span class="math inline">\(p_j\)</span>, and <span class="math inline">\(e(p_i, p_j, r)\)</span> is an edge correction factor<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a>. For estimation and visualisation, it is useful to consider a transformation of <span class="math inline">\(K\)</span> (and analogously, of <span class="math inline">\(K_{\scriptsize \mbox{inhom}}\)</span>), the so-called <span class="math inline">\(L\)</span> function.</p>
<div class="no-row-height column-margin column-container"><div id="fn14"><p><sup>14</sup>&nbsp;See the manual page of <code>Kinhom</code> for more.</p></div></div><p><span class="anchored-eq" data-anchor-id="eq-Lest" id="eq-Lest"><span class="math display">\[
L(r)=\sqrt{\frac{K(r)}{\pi}}.
\tag{11.11}\]</span></span></p>
<p>For a homogeneous spatial Poisson process, the theoretical value is <span class="anchored-eq" data-anchor-id="eq-Lest" class="math inline">\(L(r) = r\)</span>. By comparing that to the estimate of <span class="math inline">\(L\)</span> for a dataset, we can learn about inter-point dependence and spatial clustering. The square root in <a href="#eq-Lest" class="quarto-xref">Equation&nbsp;<span>11.11</span></a> has the effect of stabilising the variance of the estimator, so that compared to <span class="math inline">\(K\)</span>, <span class="math inline">\(L\)</span> is more appropriate for data analysis and simulations. The computations in the function <code>Linhom</code> of the <strong><a href="https://cran.r-project.org/web/packages/spatstat/">spatstat</a></strong> package take a few minutes for our data (<a href="#fig-images-Lln" class="quarto-xref">Figure&nbsp;<span>11.28</span></a>).</p>
<div class="cell" data-layout-align="center" data-warning.known="fvlabels truncated the function name">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>Lln <span class="ot">=</span> <span class="fu">Linhom</span>(<span class="fu">subset</span>(ln, marks <span class="sc">==</span> <span class="st">"T_cells"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>Lln</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Function value object (class 'fv')</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>for the function r -&gt; L[inhom](r)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>................................................................................
           Math.label                
r          r                         
theo       L[pois](r)                
border     {hat(L)[inhom]^{bord}}(r) 
bord.modif {hat(L)[inhom]^{bordm}}(r)
           Description                                      
r          distance argument r                              
theo       theoretical Poisson L[inhom](r)                  
border     border-corrected estimate of L[inhom](r)         
bord.modif modified border-corrected estimate of L[inhom](r)
................................................................................
Default plot formula:  .~.x
where "." stands for 'bord.modif', 'border', 'theo'
Recommended range of argument r: [0, 694.7]
Available range of argument r: [0, 694.7]</code></pre>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center" data-warning.known="fvlabels truncated the function name">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Lln, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="fu">brewer.pal</span>(<span class="dv">3</span>, <span class="st">"Set1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-images-Lln" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-images-Lln-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-images-Lln-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-48" title="Figure&nbsp;11.28: Estimate of L_{\scriptsize \mbox{inhom}}, Equations eq-kinhom and eq-Lest, of the T cell pattern."><img src="11-chap_files/figure-html/fig-images-Lln-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-images-Lln-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.28: Estimate of <span class="anchored-eq" data-anchor-id="eq-Lest" class="math inline">\(L_{\scriptsize \mbox{inhom}}\)</span>, Equations <a href="#eq-kinhom" class="quarto-xref"><span>11.10</span></a> and <a href="#eq-Lest" class="quarto-xref"><span>11.11</span></a>, of the T cell pattern.
</figcaption>
</figure>
</div>
</div></div></div>
<p>We could now proceed with looking at the <span class="math inline">\(L\)</span> function also for other cell types, and for different tumors as well as for healthy lymph nodes. This is what Setiadi and colleagues did in their report <span class="citation" data-cites="Setiadi2010">(<a href="16-chap.html#ref-Setiadi2010" role="doc-biblioref">Setiadi et al. 2010</a>)</span>, where by comparing the spatial grouping patterns of T and B cells between healthy and breast cancer lymph nodes they saw that B cells appeared to lose their normal localization in the extrafollicular region of the lymph nodes in some tumors.</p>
<section id="the-pair-correlation-function" class="level4 unnumbered page-columns page-full">
<h4 class="unnumbered anchored" data-anchor-id="the-pair-correlation-function">The pair correlation function</h4>
<p>describes how point density varies as a function of distance from a reference point. It provides a perspective inspired by physics for looking at spatial clustering. For a stationary point process, it is defined as</p>
<p><span class="anchored-eq" data-anchor-id="eq-pcf" id="eq-pcf"><span class="math display">\[
g(r)=\frac{1}{2\pi r}\frac{dK}{dr}(r).
\tag{11.12}\]</span></span></p>
<p>For a stationary Poisson process, the pair correlation function is identically equal to 1. Values <span class="math inline">\(g(r) &lt; 1\)</span> suggest inhibition between points; values greater than 1 suggest clustering.</p>
<p>The <strong><a href="https://cran.r-project.org/web/packages/spatstat/">spatstat</a></strong> package allows computing estimates of <span class="anchored-eq" data-anchor-id="eq-pcf" class="math inline">\(g\)</span> even for inhomogeneous processes, if we call <code>pcf</code> as below, the definition <a href="#eq-pcf" class="quarto-xref"><span>11.12</span></a> is applied to the estimate of <span class="math inline">\(K_{\scriptsize \mbox{inhom}}\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>pcfln <span class="ot">=</span> <span class="fu">pcf</span>(<span class="fu">Kinhom</span>(<span class="fu">subset</span>(ln, marks <span class="sc">==</span> <span class="st">"T_cells"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pcfln, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pcfln, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-images-pcf" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-images-pcf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="quarto-layout-row page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-images-pcf" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-images-pcf-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="400">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-images-pcf-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-images-pcf-1.png" class="lightbox" data-gallery="fig-images-pcf" title="Figure&nbsp;11.29&nbsp;(a): "><img src="11-chap_files/figure-html/fig-images-pcf-1.png" id="fig-images-pcf-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-images-pcf" width="400"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-images-pcf-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div></div></div>
<div class="quarto-layout-row page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-images-pcf" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-images-pcf-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="400">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-images-pcf-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-images-pcf-2.png" class="lightbox" data-gallery="fig-images-pcf" title="Figure&nbsp;11.29&nbsp;(b): "><img src="11-chap_files/figure-html/fig-images-pcf-2.png" id="fig-images-pcf-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-images-pcf" width="400"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-images-pcf-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div></div></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-images-pcf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.29: Estimate of the pair correlation function, <a href="#eq-pcf" class="quarto-xref">Equation&nbsp;<span>11.12</span></a>, of the T cell pattern.
</figcaption>
</figure>
</div>
<p>As we see in <a href="#fig-images-pcf" class="quarto-xref">Figure&nbsp;<span>11.29</span></a>, the T cells cluster, although at very short distances, there is also evidence for avoidance.</p>
<div id="wrn-images-samplingpcf" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;11.14
</div>
</div>
<div class="callout-body-container callout-body">
<p>The sampling resolution in the plot of the pair correlation function in the bottom panel of <a href="#fig-images-pcf" class="quarto-xref">Figure&nbsp;<span>11.29</span></a> is low; how can it be increased?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-28-contents" aria-controls="callout-28" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-28" class="callout-28-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The answer lies in the <code>r</code> argument of the <code>Kinhom</code> function; see <a href="#fig-samplingpcf" class="quarto-xref">Figure&nbsp;<span>11.30</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>pcfln2 <span class="ot">=</span> <span class="fu">pcf</span>(<span class="fu">Kinhom</span>(<span class="fu">subset</span>(ln, marks <span class="sc">==</span> <span class="st">"T_cells"</span>),</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">r =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="fl">0.2</span>)))</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pcfln2, <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-samplingpcf" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-samplingpcf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-samplingpcf-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-51" title="Figure&nbsp;11.30: Answer to Question&nbsp;wrn-images-samplingpcf: as in the bottom panel of Figure&nbsp;fig-images-pcf, but with denser sampling."><img src="11-chap_files/figure-html/fig-samplingpcf-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-samplingpcf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.30: Answer to <a href="#wrn-images-samplingpcf" class="quarto-xref">Question&nbsp;<span>11.14</span></a>: as in the bottom panel of <a href="#fig-images-pcf" class="quarto-xref">Figure&nbsp;<span>11.29</span></a>, but with denser sampling.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="summary-of-this-chapter" class="level2" data-number="11.18">
<h2 data-number="11.18" class="anchored" data-anchor-id="summary-of-this-chapter"><span class="header-section-number">11.18</span> Summary of this chapter</h2>
<p>We learned to work with image data in R. Images are basically just arrays, and we can use familiar idioms to manipulate them. We can extract quantitative features from images, and then many of the analytical questions are not unlike those with other high-throughput data: we summarize the features into statistics such as means and variances, do hypothesis testing for differences between conditions, perform analysis of variance, apply dimension reduction, clustering and classification.</p>
<p>Often we want to compute such quantitative features not on the whole image, but for individual objects shown in the image, and then we need to first segment the image to demarcate the boundaries of the objects of interest. We saw how to do this for images of nuclei and cells.</p>
<p>When the interest is on the positions of the objects and how these positions relate to each other, we enter the realm of <em>spatial statistics</em>. We have explored some of the functionality of the <strong><a href="https://cran.r-project.org/web/packages/spatstat/">spatstat</a></strong> package, have encountered the point process class, and we learned some of the specific diagnostic statistics used for point patterns, like Ripley’s <span class="math inline">\(K\)</span> function.</p>
</section>
<section id="further-reading" class="level2" data-number="11.19">
<h2 data-number="11.19" class="anchored" data-anchor-id="further-reading"><span class="header-section-number">11.19</span> Further reading</h2>
<ul>
<li><p>There is a vast amount of literature on image analysis. When navigating it, it is helpful to realize that the field is driven by two forces: specific application domains (we saw the analysis of high-throughput cell-based assays) and available computer hardware. Some algorithms and concepts that were developed in the 1970s are still relevant, others have been superseeded by more systematic and perhaps computationally more intensive methods. Many algorithms imply certain assumptions about the nature of the data and and scientific questions asked, which may be fine for one application, but need a fresh look in another. A classic introduction is <em>The Image Processing Handbook</em> <span class="citation" data-cites="RussImageProcessingHandbook">(<a href="16-chap.html#ref-RussImageProcessingHandbook" role="doc-biblioref">Russ and Neal 2015</a>)</span>, which now is its seventh edition.</p></li>
<li><p>For spatial point pattern analysis, <span class="citation" data-cites="DiggleSPP RipleySISS1988 CressieSSD1991 MeckeSG2013">Diggle (<a href="16-chap.html#ref-DiggleSPP" role="doc-biblioref">2013</a>; <a href="16-chap.html#ref-RipleySISS1988" role="doc-biblioref">Ripley 1988</a>; <a href="16-chap.html#ref-CressieSSD1991" role="doc-biblioref">Cressie 1991</a>; <a href="16-chap.html#ref-MeckeSG2013" role="doc-biblioref">Chiu et al. 2013</a>)</span>.</p></li>
</ul>
</section>
<section id="exercises" class="level2 page-columns page-full" data-number="11.20">
<h2 data-number="11.20" class="anchored" data-anchor-id="exercises"><span class="header-section-number">11.20</span> Exercises</h2>
<div id="imp-images-selfies" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;11.1
</div>
</div>
<div class="callout-body-container callout-body">
<p>Load some images from your personal photo library into R and try out the manipulations from <a href="#sec-manip" class="quarto-xref"><span>Section 11.6</span></a> on them.</p>
</div>
</div>
<div id="imp-images-propagate" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;11.2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Explore the effect of the parameter <code>lambda</code> in the <code>propagate</code> function (Sections <a href="#sec-voronoi" class="quarto-xref"><span>11.12</span></a>, <a href="#sec-bodies" class="quarto-xref"><span>11.13</span></a>) using a <strong><a href="https://cran.r-project.org/web/packages/shiny">shiny</a></strong> app that displays the <code>cellbodies</code> image as in <a href="#fig-cellbodies" class="quarto-xref">Figure&nbsp;<span>11.17</span></a>.</p>
</div>
</div>
<div id="imp-images-autocorr" class="callout callout-style-default callout-important no-icon callout-titled page-columns page-full">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;11.3
</div>
</div>
<div class="callout-body-container callout-body page-columns page-full">
<p>Consider the two-dimensional empirical autocorrelation function,</p>
<p><span class="anchored-eq" data-anchor-id="eq-autocorr1" id="eq-autocorr1"><span class="math display">\[
a(v_x, v_y) = \frac{1}{|I|} \sum_{(x,y)\in I} B(x, y)\;B(x+v_x, \, y+v_y),
\tag{11.13}\]</span></span></p>
<p>where <span class="math inline">\(B\)</span> is an image, i.e., a function over the set of pixels <span class="math inline">\(I\)</span>, the tuple <span class="math inline">\((x,y)\)</span> runs over all the pixel coordinates, and <span class="math inline">\(v=(v_x, v_y)\)</span> is the offset vector. Using the <a href="https://mathworld.wolfram.com/Wiener-KhinchinTheorem.html">Wiener–Khinchin theorem</a>, we can compute this function efficiently using the Fast Fourier Transformation.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>autocorr2d <span class="ot">=</span> <span class="cf">function</span>(x) {</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">fft</span>(x<span class="sc">/</span><span class="fu">sum</span>(x))</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>(gsignal<span class="sc">::</span><span class="fu">fftshift</span>(<span class="fu">fft</span>(y <span class="sc">*</span> <span class="fu">Conj</span>(y), <span class="at">inverse =</span> <span class="cn">TRUE</span>), <span class="at">MARGIN =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)) </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below, we’ll use this little helper function, which shows a matrix as a heatmap with <strong><a href="https://cran.r-project.org/web/packages/ggplot2">ggplot2</a></strong> (similar to base R’s <code>image</code>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>matrix_as_heatmap <span class="ot">=</span> <span class="cf">function</span>(m)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(reshape2<span class="sc">::</span><span class="fu">melt</span>(m), <span class="fu">aes</span>(<span class="at">x =</span> Var1, <span class="at">y =</span> Var2, <span class="at">fill =</span> value)) <span class="sc">+</span> </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span> <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_continuous</span>(<span class="at">type =</span> <span class="st">"viridis"</span>) <span class="sc">+</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s apply <code>autocorr2d</code> to each of the three color channels separately. The result is shown in <a href="#fig-autocorr2d" class="quarto-xref">Figure&nbsp;<span>11.31</span></a>.</p>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>nm <span class="ot">=</span> <span class="fu">dimnames</span>(cells)[[<span class="dv">3</span>]]</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>ac <span class="ot">=</span> <span class="fu">lapply</span>(nm, <span class="cf">function</span>(i) <span class="fu">autocorr2d</span>(cells[,, i])) <span class="sc">|&gt;</span> <span class="fu">setNames</span>(<span class="fu">sub</span>(<span class="st">"^image-"</span>, <span class="st">""</span>, nm))</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (w <span class="cf">in</span> <span class="fu">names</span>(ac)) </span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">matrix_as_heatmap</span>(ac[[w]]) <span class="sc">+</span> <span class="fu">ggtitle</span>(w))</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>cy <span class="ot">=</span> <span class="fu">dim</span>(cells)[<span class="dv">1</span>] <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>cx <span class="ot">=</span> <span class="fu">dim</span>(cells)[<span class="dv">2</span>] <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>r  <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">sqrt</span>((<span class="fu">col</span>(cells[,,<span class="dv">1</span>]) <span class="sc">-</span> cx)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (<span class="fu">row</span>(cells[,,<span class="dv">1</span>]) <span class="sc">-</span> cy)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="fu">matrix_as_heatmap</span>(r) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"radius r"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-autocorr2d" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-autocorr2d-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-autocorr2d" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-autocorr2d-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="320">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-autocorr2d-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-autocorr2d-1.png" class="lightbox" data-gallery="fig-autocorr2d" title="Figure&nbsp;11.31&nbsp;(a): "><img src="11-chap_files/figure-html/fig-autocorr2d-1.png" id="fig-autocorr2d-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-autocorr2d" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-autocorr2d-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-autocorr2d" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-autocorr2d-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="320">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-autocorr2d-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-autocorr2d-2.png" class="lightbox" data-gallery="fig-autocorr2d" title="Figure&nbsp;11.31&nbsp;(b): "><img src="11-chap_files/figure-html/fig-autocorr2d-2.png" id="fig-autocorr2d-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-autocorr2d" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-autocorr2d-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-autocorr2d" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-autocorr2d-3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="320">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-autocorr2d-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-autocorr2d-3.png" class="lightbox" data-gallery="fig-autocorr2d" title="Figure&nbsp;11.31&nbsp;(c): "><img src="11-chap_files/figure-html/fig-autocorr2d-3.png" id="fig-autocorr2d-3" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-autocorr2d" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-autocorr2d-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-autocorr2d" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-autocorr2d-4" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="320">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-autocorr2d-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-autocorr2d-4.png" class="lightbox" data-gallery="fig-autocorr2d" title="Figure&nbsp;11.31&nbsp;(d): "><img src="11-chap_files/figure-html/fig-autocorr2d-4.png" id="fig-autocorr2d-4" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-autocorr2d" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-autocorr2d-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-autocorr2d-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.31: Autocorrelation functions of the three color channels of the <code>cells</code> image, shown as heatmaps. The peaks in the centres correspond to signal correlations over short distances. Also shown is the radial coordinate <code>r</code>.
</figcaption>
</figure>
</div>
<p>Since the images are (or should be) isotropic, i.e., there is no preferred direction, we can average over the angular coordinate. The result is shown in <a href="#fig-autocorr1d" class="quarto-xref">Figure&nbsp;<span>11.32</span></a>. We can see that the signals in the different color channels have different length scales.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>aggregate_by_radius <span class="ot">=</span> <span class="cf">function</span>(x, r)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">as.vector</span>(x),</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">r =</span> <span class="fu">as.vector</span>(r)) <span class="sc">|&gt;</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(r) <span class="sc">|&gt;</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">value =</span> <span class="fu">mean</span>(x))</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(<span class="fu">names</span>(ac), <span class="cf">function</span>(w) </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">channel =</span> w, </span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aggregate_by_radius</span>(ac[[w]], r))</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(r <span class="sc">&lt;=</span> <span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> r, <span class="at">y =</span> value, <span class="at">col =</span> channel)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Cy3</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">`</span><span class="at">FITC</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"green"</span>, <span class="st">`</span><span class="at">DAPI</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"blue"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<p>Extend the <code>autocorr2d</code> function to also compute the cross-correlation between different channels.</p>
<ul>
<li>What is the motivation behind the <code>sum</code> normalization in the above implementation <code>autocorr2d</code>?</li>
<li>Would it make sense to subtract the mean of <code>x</code> before the other computations?</li>
<li>What is the relation between this function and the usual empirical variance or correlation, i.e.&nbsp;the functions <code>var</code> and <code>sd</code> in base R?</li>
<li>How might plots such as <a href="#fig-autocorr1d" class="quarto-xref">Figure&nbsp;<span>11.32</span></a> be used for the construction of quality metrics in a high-throughput screening setting, i.e., when thousands or millions of images need to be analyzed?</li>
<li>How would a 3- or <span class="math inline">\(n\)</span>-dimensional extension of <code>autocorr2d</code> look like? What would it be good for?</li>
</ul>
</div>
</div>
<div class="no-row-height column-margin column-container"><div class="cell-output-display callout-margin-content">
<div id="fig-autocorr1d" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-autocorr1d-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="11-chap_files/figure-html/fig-autocorr1d-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-56" title="Figure&nbsp;11.32: Autocorrelation functions of the three color channels of the cells image, aggregated by radius."><img src="11-chap_files/figure-html/fig-autocorr1d-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="280"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-autocorr1d-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.32: Autocorrelation functions of the three color channels of the <code>cells</code> image, aggregated by radius.
</figcaption>
</figure>
</div>
</div></div><div id="imp-images-working-with-image-data" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;11.4
</div>
</div>
<div class="callout-body-container callout-body">
<p>Have a look at the workshop “Working with Image Data” <a href="https://github.com/wolfganghuber/WorkingWithImageData" class="uri">https://github.com/wolfganghuber/WorkingWithImageData</a>, which goes through some of the same content as this chapter, but on different images, and also has additional examples on segmentation and optical flow.</p>
</div>
</div>
<div id="imp-images-voronoi" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;11.5
</div>
</div>
<div class="callout-body-container callout-body">
<p>Compute and display the Voronoi tessellation for the Ukrainian cities from <a href="09-chap.html" class="quarto-xref"><span>Chapter 9</span></a>. Either use their MDS-coordinates in the 2D plane with Euclidean distances, or the latitudes and longitudes using the great circle distance (Haversine formula).</p>
</div>
</div>
<div id="imp-images-3d" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;11.6
</div>
</div>
<div class="callout-body-container callout-body">
<p>Download 3D image data from light sheet microscopy<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a>, load it into an <strong><a href="https://bioconductor.org/packages/EBImage/">EBImage</a></strong> <em>Image</em> object and explore the data.</p>
</div>
</div>


<div class="no-row-height column-margin column-container"><div id="fn15"><p><sup>15</sup>&nbsp;For instance, <a href="http://www.digital-embryo.org" class="uri">http://www.digital-embryo.org</a></p></div></div><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Baddeley2000" class="csl-entry" role="listitem">
Baddeley, Adrain, Jesper Moller, and Rasmus Waagepetersen. 2000. <span>“Non- and Semiparametric Estimation of Interaction in Inhomogeneous Point Patterns.”</span> <em>Statistica Neerlandica</em> 54: 329–50.
</div>
<div id="ref-Baddeley1998" class="csl-entry" role="listitem">
Baddeley, Adrian J. 1998. <span>“Spatial Sampling and Censoring.”</span> In <em>Stochastic Geometry: Likelihood and Computation</em>, edited by O. E. Barndorff-Nielsen, W. S. Kendall, and M. N. M. van Lieshout, 37–78. Chapman; Hall.
</div>
<div id="ref-ilastik:NatMeth:2019" class="csl-entry" role="listitem">
Berg, Stuart, Dominik Kutra, Thorben Kroeger, Christoph N Straehle, Bernhard X Kausler, Carsten Haubold, Martin Schiegg, et al. 2019. <span>“Ilastik: Interactive Machine Learning for (Bio)image Analysis.”</span> <em>Nature Methods</em> 16 (12): 1226–32.
</div>
<div id="ref-BolandMurphy" class="csl-entry" role="listitem">
Boland, Michael V., and Robert F. Murphy. 2001. <span>“<span class="nocase">A neural network classifier capable of recognizing the patterns of all major subcellular structures in fluorescence microscope images of <span>HeLa</span> cells</span>.”</span> <em>Bioinformatics</em> 17 (12): 1213–23.
</div>
<div id="ref-carpenter2006cellprofiler" class="csl-entry" role="listitem">
Carpenter, Anne E, Thouis R Jones, Michael R Lamprecht, Colin Clarke, In Han Kang, Ola Friman, David A Guertin, Joo Han Chang, Robert A Lindquist, and Jason Moffat. 2006. <span>“<span>CellProfiler</span>: Image Analysis Software for Identifying and Quantifying Cell Phenotypes.”</span> <em>Genome Biology</em> 7: R100.
</div>
<div id="ref-chaumont2012icy" class="csl-entry" role="listitem">
Chaumont, Fabrice de, Stéphane Dallongeville, Nicolas Chenouard, Nicolas Hervé, Sorin Pop, Thomas Provoost, Vannary Meas-Yedid, et al. 2012. <span>“<span class="nocase"><span>I</span>cy: an open bioimage informatics platform for extended reproducible research</span>.”</span> <em>Nature Methods</em> 9: 690–96.
</div>
<div id="ref-MeckeSG2013" class="csl-entry" role="listitem">
Chiu, Sung Nok, Dietrich Stoyan, Wilfrid S. Kendall, and Joseph Mecke. 2013. <em>Stochastic Geometry and Its Applications</em>. Springer.
</div>
<div id="ref-CressieSSD1991" class="csl-entry" role="listitem">
Cressie, Noel A. 1991. <em>Statistics for Spatial Data</em>. John Wiley; Sons.
</div>
<div id="ref-DiggleSPP" class="csl-entry" role="listitem">
Diggle, Peter J. 2013. <em>Statistical Analysis of Spatial and Spatio-Temporal Point Patterns</em>. Chapman; Hall/CRCs.
</div>
<div id="ref-held2010cellcognition" class="csl-entry" role="listitem">
Held, M., M. H. A. Schmitz, B. Fischer, T. Walter, B. Neumann, M. H. Olma, M. Peter, J. Ellenberg, and D. W. Gerlich. 2010. <span>“<span>CellCognition</span>: Time-Resolved Phenotype Annotation in High-Throughput Live Cell Imaging.”</span> <em>Nature Methods</em> 7: 747.
</div>
<div id="ref-Holmes2009" class="csl-entry" role="listitem">
Holmes, Susan, Adam Kapelner, and Peter P Lee. 2009. <span>“An Interactive <span>Java</span> Statistical Image Segmentation System: <span>GemIdent</span>.”</span> <em>Journal of Statistical Software</em> 30 (10).
</div>
<div id="ref-jones2005voronoi" class="csl-entry" role="listitem">
Jones, T., A. Carpenter, and P. Golland. 2005. <span>“Voronoi-Based Segmentation of Cells on Image Manifolds.”</span> <em>Computer Vision for Biomedical Image Applications</em>, 535.
</div>
<div id="ref-Laufer:NatMeth:2013" class="csl-entry" role="listitem">
Laufer, Christina, Bernd Fischer, Maximilian Billmann, Wolfgang Huber, and Michael Boutros. 2013. <span>“<span class="nocase"><span>M</span>apping genetic interactions in human cancer cells with <span>R</span><span>N</span><span>A</span>i and multiparametric phenotyping</span>.”</span> <em>Nature Methods</em> 10: 427–31.
</div>
<div id="ref-EBImage" class="csl-entry" role="listitem">
Pau, Grégoire, Florian Fuchs, Oleg Sklyar, Michael Boutros, and Wolfgang Huber. 2010. <span>“<span>EBI</span>mage <span>R</span> Package for Image Processing with Applications to Cellular Phenotypes.”</span> <em>Bioinformatics</em> 26 (7): 979–81.
</div>
<div id="ref-PhenoRipper" class="csl-entry" role="listitem">
Rajaram, S., B. Pavie, L. F. Wu, and S. J. Altschuler. 2012. <span>“<span class="nocase"><span>P</span>heno<span>R</span>ipper: software for rapidly profiling microscopy images</span>.”</span> <em>Nature Methods</em> 9: 635–37.
</div>
<div id="ref-RipleySISS1988" class="csl-entry" role="listitem">
Ripley, B. D. 1988. <em>Statistical Inference for Spatial Processes.</em> Cambridge University Press.
</div>
<div id="ref-RussImageProcessingHandbook" class="csl-entry" role="listitem">
Russ, John C., and F. Brent Neal. 2015. <em>The Image Processing Handbook</em>. 7th ed. CRC Press;
</div>
<div id="ref-schindelin2012fiji" class="csl-entry" role="listitem">
Schindelin, Johannes, Ignacio Arganda-Carreras, Erwin Frise, Verena Kaynig, Mark Longair, Tobias Pietzsch, Stephan Preibisch, et al. 2012. <span>“<span class="nocase"><span>F</span>iji: an open-source platform for biological-image analysis</span>.”</span> <em>Nature Methods</em> 9: 676–82.
</div>
<div id="ref-MathematicalMorphology" class="csl-entry" role="listitem">
Serra, Jean. 1983. <em>Image Analysis and Mathematical Morphology</em>. Academic Press.
</div>
<div id="ref-Setiadi2010" class="csl-entry" role="listitem">
Setiadi, A Francesca, Nelson C Ray, Holbrook E Kohrt, Adam Kapelner, Valeria Carcamo-Cavazos, Edina B Levic, Sina Yadegarynia, et al. 2010. <span>“Quantitative, Architectural Analysis of Immune Cell Subsets in Tumor-Draining Lymph Nodes from Breast Cancer Patients and Healthy Lymph Nodes.”</span> <em>PLoS One</em> 5 (8): e12420.
</div>
<div id="ref-FoundationSignalProcessing" class="csl-entry" role="listitem">
Vetterli, Martin, Jelena Kovačević, and Vivek Goyal. 2014. <em>Foundations of Signal Processing</em>. Cambridge University Press.
</div>
</div>
</section>


<p>Page built at 01:33 on 2025-09-01 using R version 4.5.1 (2025-06-13)</p></main> <!-- /main --></p><p class="build-date">
Support for maintaining the online version of this book is provided by <a href="http://www.denbi.de">de.NBI</a>
  <img src="imgs/denbi.png" style="vertical-align: text-top;height: 16px"><br>
For website support please contact msmith@embl.de
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
  const anchorJS_eq = new window.AnchorJS();
  anchorJS_eq.options = {
    placement: 'left',
    class: 'eq-link',
    icon: icon
  };
  anchorJS_eq.add('.anchored-eq');
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/www\.huber\.embl\.de\/msmb");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>
