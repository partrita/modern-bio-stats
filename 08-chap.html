<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>8&nbsp; High-Throughput Count Data &amp; Generalized Linear Models – Modern Statistics for Modern Biology</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./imgs/msmb-favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-af5ec82acda093b5ee751184164e9432.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-d63985d606c7f07261ad561a6cfde940.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="msmb.css">
<meta property="og:title" content="8&nbsp; High-Throughput Count Data &amp; Generalized Linear Models – Modern Statistics for Modern Biology">
<meta property="og:description" content="If you are a biologist and want to get the best out of the powerful methods of modern computational statistics, this is your book.">
<meta property="og:image" content="https://www.huber.embl.de/msmb/08-chap_files/figure-html/fig-countdata-MA-1.png">
<meta property="og:site_name" content="Modern Statistics for Modern Biology">
<meta property="og:image:height" content="720">
<meta property="og:image:width" content="720">
<meta name="twitter:title" content="8&nbsp; High-Throughput Count Data &amp; Generalized Linear Models – Modern Statistics for Modern Biology">
<meta name="twitter:description" content="If you are a biologist and want to get the best out of the powerful methods of modern computational statistics, this is your book.">
<meta name="twitter:image" content="https://www.huber.embl.de/msmb/08-chap_files/figure-html/fig-countdata-MA-1.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:image-height" content="720">
<meta name="twitter:image-width" content="720">
<script type="text/javascript">
  var _paq = _paq || [];
  
  // Call disableCookies before calling trackPageView 
  _paq.push(['disableCookies']);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u='//tr-denbi.embl.de/heimdall/';
    _paq.push(['setTrackerUrl', u+'p.php']);
    _paq.push(['setSiteId', '26']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'p.js'; s.parentNode.insertBefore(g,s);
  })();
</script>

</head>

<body class="floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Modern Statistics for Modern Biology</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-chapters" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Chapters</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-chapters">    
        <li>
    <a class="dropdown-item" href="./index.html">
 <span class="dropdown-text">Home</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./00-chap.html">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./01-chap.html">
 <span class="dropdown-text">Generative Models for Discrete Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02-chap.html">
 <span class="dropdown-text">Statistical Modeling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03-chap.html">
 <span class="dropdown-text">Data visualization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04-chap.html">
 <span class="dropdown-text">Mixture Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05-chap.html">
 <span class="dropdown-text">Clustering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06-chap.html">
 <span class="dropdown-text">Testing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07-chap.html">
 <span class="dropdown-text">Multivariate Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./08-chap.html">
 <span class="dropdown-text">High-Throughput Count Data &amp; Generalized Linear Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09-chap.html">
 <span class="dropdown-text">Multivariate methods for heterogeneous data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10-chap.html">
 <span class="dropdown-text">Networks and Trees</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./11-chap.html">
 <span class="dropdown-text">Image data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./12-chap.html">
 <span class="dropdown-text">Supervised Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./13-chap.html">
 <span class="dropdown-text">Design of High Throughput Experiments and their Analyses</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./14-chap.html">
 <span class="dropdown-text">Statistical Concordance</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./15-chap.html">
 <span class="dropdown-text">Acknowledgements</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./16-chap.html">
 <span class="dropdown-text">References</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sections</h2>
   
  <ul class="collapse">
  <li><a href="#goals-of-this-chapter" id="toc-goals-of-this-chapter" class="nav-link active" data-scroll-target="#goals-of-this-chapter"><span class="header-section-number">8.1</span> Goals of this chapter</a></li>
  <li><a href="#some-core-concepts" id="toc-some-core-concepts" class="nav-link" data-scroll-target="#some-core-concepts"><span class="header-section-number">8.2</span> Some core concepts</a></li>
  <li><a href="#sec-countdata-counttable" id="toc-sec-countdata-counttable" class="nav-link" data-scroll-target="#sec-countdata-counttable"><span class="header-section-number">8.3</span> Count data</a></li>
  <li><a href="#modeling-count-data" id="toc-modeling-count-data" class="nav-link" data-scroll-target="#modeling-count-data"><span class="header-section-number">8.4</span> Modeling count data</a></li>
  <li><a href="#sec-countdata-debasic" id="toc-sec-countdata-debasic" class="nav-link" data-scroll-target="#sec-countdata-debasic"><span class="header-section-number">8.5</span> A basic analysis</a></li>
  <li><a href="#sec-countdata-critique" id="toc-sec-countdata-critique" class="nav-link" data-scroll-target="#sec-countdata-critique"><span class="header-section-number">8.6</span> Critique of default choices and possible modifications</a></li>
  <li><a href="#sec-countdata-multifactor" id="toc-sec-countdata-multifactor" class="nav-link" data-scroll-target="#sec-countdata-multifactor"><span class="header-section-number">8.7</span> Multi-factor designs and linear models</a></li>
  <li><a href="#sec:glm" id="toc-sec:glm" class="nav-link" data-scroll-target="#sec\:glm"><span class="header-section-number">8.8</span> Generalized linear models</a></li>
  <li><a href="#sec-countdata-pasillatwofac" id="toc-sec-countdata-pasillatwofac" class="nav-link" data-scroll-target="#sec-countdata-pasillatwofac"><span class="header-section-number">8.9</span> Two-factor analysis of the pasilla data</a></li>
  <li><a href="#further-statistical-concepts" id="toc-further-statistical-concepts" class="nav-link" data-scroll-target="#further-statistical-concepts"><span class="header-section-number">8.10</span> Further statistical concepts</a></li>
  <li><a href="#summary-of-this-chapter" id="toc-summary-of-this-chapter" class="nav-link" data-scroll-target="#summary-of-this-chapter"><span class="header-section-number">8.11</span> Summary of this chapter</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">8.12</span> Further reading</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">8.13</span> Exercises</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-countdata" class="quarto-section-identifier"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">High-Throughput Count Data &amp; Generalized Linear Models</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/xkcd-1725-linear_regression_2x.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="imgs/xkcd-1725-linear_regression_2x.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div></div></div>
<p>Many measurement devices in biotechnology are based on massively parallel sampling and counting of molecules. One example is high-throughput DNA sequencing. Its applications fall broadly into two main classes of data output: in the first case, the output of interest are the sequences themselves, perhaps also their polymorphisms or differences to other sequences seen before. In the second case, the sequences themselves are more or less well-understood (say, we have a well-assembled and annotated genome), and our interest is on how abundant different sequence regions are in our sample.</p>
<p>For instance, in <strong>RNA-Seq</strong> <span class="citation" data-cites="OzsolakMilos">(<a href="16-chap.html#ref-OzsolakMilos" role="doc-biblioref">Ozsolak and Milos 2011</a>)</span>, we sequence the RNA molecules found in a population of cells or in a tissue.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Strictly speaking, we don’t sequence the RNA but the complementary DNA (cDNA) obtained from reverse transcription. The pool of all RNA might be reduced to a subset of interest (e.,g., messenger RNA) by biochemical means, such as poly-A selection or ribosomal RNA depletion. Sensitive variants of RNA-Seq exist that enable assaying single cells, and large numbers of them."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="Strictly speaking, we don’t sequence the RNA but the complementary DNA (cDNA) obtained from reverse transcription. The pool of all RNA might be reduced to a subset of interest (e.,g., messenger RNA) by biochemical means, such as poly-A selection or ribosomal RNA depletion. Sensitive variants of RNA-Seq exist that enable assaying single cells, and large numbers of them."></a></p>
</figure>
</div>
<figcaption>Strictly speaking, we don’t sequence the RNA but the complementary DNA (cDNA) obtained from reverse transcription. The pool of all RNA might be reduced to a subset of interest (e.,g., messenger RNA) by biochemical means, such as poly-A selection or ribosomal RNA depletion. Sensitive variants of RNA-Seq exist that enable assaying single cells, and large numbers of them.</figcaption>
</figure>
</div>
</div></div></div>
<p>In <strong>ChIP-Seq</strong>, we sequence DNA regions that are bound to particular DNA-binding proteins (selected by immuno-precipitation); in <strong>RIP-Seq</strong>, RNA molecules or regions of them bound to a particular RNA-binding protein; in <strong>DNA-Seq</strong>, we sequence genomic DNA and are interested in the prevalence of genetic variants in heterogeneous populations of cells, for instance the clonal composition of a tumor. In high-throughput chromatin conformation capture (<strong>HiC</strong>) we aim to map the 3D spatial arrangement of DNA; in <strong>genetic screens</strong> (using, say, RNAi or CRISPR-Cas9 libraries for perturbation and high-throughput sequencing for readout), we’re interested in the proliferation or survival of cells upon gene knockdown, knockout or modification. In microbiome analysis, we study the abundance of different microbial species in complex microbial habitats.</p>
<p>Ideally we might want to sequence and count <em>all</em> molecules of interest in the sample. Generally this is not possible: the biochemical protocols are not 100% efficient, and some molecules or intermediates get lost along the way. Moreover it’s often also not even necessary. Instead, we sequence and count a <em>statistical sample</em>. The sample size will depend on the complexity of the sequence pool assayed; it can go from tens of thousands to billions. This <em>sampling</em> nature of the data is important when it comes to analyzing them. We hope that the sampling is sufficiently representative for us to identify interesting trends and patterns.</p>
<section id="goals-of-this-chapter" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="goals-of-this-chapter"><span class="header-section-number">8.1</span> Goals of this chapter</h2>
<p>In this chapter, we will become familiar with count data in high-throughput sequencing applications such as RNA-Seq. We will understand and model the sampling processes that underlie the data in order to interpret them. Our main aim is to detect and quantify systematic changes between samples from different conditions, say <em>untreated</em> versus <em>treated</em>, where the task is to distinguish such systematic changes from sampling variations and experimental variability within the same conditions. In order to do this, we will also equip ourselves with a set of needed statistical concepts and tools:</p>
<ul>
<li><p>multifactorial designs, linear models and analysis of variance</p></li>
<li><p>generalized linear models</p></li>
<li><p>robustness and outlier detection</p></li>
<li><p>shrinkage estimation</p></li>
</ul>
<p>In fact, these concepts have a much wider range of applications: they can also be applied to other types of data where want to detect differences in noisy data as a function of some experimental covariate. In particular, the framework of generalized linear models is quite abstract and generic, but this has the advantage that it can be adapted to many different data types, so that we don’t need to reinvent the wheel, but rather can immediately enjoy a wide range of associated tools and diagnostics.</p>
<p>As a bonus, we will also look at data transformations that make the data amenable to unsupervised methods such as those that we saw in Chapters <a href="05-chap.html" class="quarto-xref"><span>5</span></a> and <a href="07-chap.html" class="quarto-xref"><span>7</span></a>, and which make it easier to visualize the data.</p>
</section>
<section id="some-core-concepts" class="level2 page-columns page-full" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="some-core-concepts"><span class="header-section-number">8.2</span> Some core concepts</h2>
<p>Before we start, let’s settle some key terminology.</p>
<ul>
<li><p>A <em>sequencing library</em> is the collection of DNA molecules used as input for the sequencing machine.</p></li>
<li><p><em>Fragments</em> are the molecules being sequenced. Since the currently most widely used technology<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> can only deal with molecules of length around 300–1000 nucleotides, these are obtained by fragmenting the (generally longer) DNA or cDNA molecules of interest.</p></li>
<li><p>A <strong>read</strong> is the sequence obtained from a fragment. With the current technology, the read covers not the whole fragment, but only one or both ends of it, and the read length on either side is up to around 150 nucleotides.</p></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;We refer to <a href="https://www.illumina.com/techniques/sequencing.html" class="uri">https://www.illumina.com/techniques/sequencing.html</a></p></div><div id="fn2"><p><sup>2</sup>&nbsp;For any particular application, it’s best to check the recent literature on the most appropriate approaches and choices.</p></div><div id="fn3"><p><sup>3</sup>&nbsp;E.g., in the case of RNA-Seq, the genome together with an annotation of its transcripts.</p></div></div><p>Between sequencing and counting, there is an important <em>aggregation</em> or clustering step involved, which aggregates sequences that belong together: for instance, all reads belonging to the same gene (in RNA-Seq), or to the same binding region (ChIP-Seq). There are several approaches to this and choices to be made, depending on the aim of the experiment<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. The methods include explicit alignment or hash-based mapping to a reference sequence<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, and reference-independent sequence-similarity based clustering of the reads – especially if there is no obvious reference, such as in metagenomics or metatranscriptomics. We need to choose whether to consider different alleles or isoforms separately, or to merge them into an equivalence class. For simplicity, we’ll use the term <em>gene</em> in this chapter for these operational aggregates, even though they can be various things depending on the particular application.</p>
</section>
<section id="sec-countdata-counttable" class="level2 page-columns page-full" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="sec-countdata-counttable"><span class="header-section-number">8.3</span> Count data</h2>
<p>Let us load an example dataset. It resides in the experiment data package <strong><a href="https://bioconductor.org/packages/pasilla/">pasilla</a></strong>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"pasilla_gene_counts.tsv"</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">package =</span> <span class="st">"pasilla"</span>, <span class="at">mustWork =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">read.csv</span>(fn, <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">row.names =</span> <span class="st">"gene_id"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="In the code shown here, we use the function system.file to locate a file that is shipped together with the pasilla package. When you work with your own data, you will need to prepare the matrix counts yourself."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="In the code shown here, we use the function system.file to locate a file that is shipped together with the pasilla package. When you work with your own data, you will need to prepare the matrix counts yourself."></a></p>
</figure>
</div>
<figcaption>In the code shown here, we use the function <code>system.file</code> to locate a file that is shipped together with the <strong><a href="https://bioconductor.org/packages/pasilla/">pasilla</a></strong> package. When you work with your own data, you will need to prepare the matrix <code>counts</code> yourself.</figcaption>
</figure>
</div>
</div></div></div>
<p>The data are stored as a rectangular table in a tab-delimited file, which we’ve read into the matrix <code>counts</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14599     7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>counts[ <span class="dv">2000</span><span class="sc">+</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            untreated1 untreated2 untreated3 untreated4 treated1 treated2
FBgn0020369       3387       4295       1315       1853     4884     2133
FBgn0020370       3186       4305       1824       2094     3525     1973
FBgn0020371          1          0          1          1        1        0
FBgn0020372         38         84         29         28       63       28
            treated3
FBgn0020369     2165
FBgn0020370     2120
FBgn0020371        0
FBgn0020372       27</code></pre>
</div>
</div>
<p>The matrix tallies the number of reads seen for each gene in each sample. We call it the <strong>count table</strong>. It has 14599 rows, corresponding to the genes, and 7 columns, corresponding to the samples. When loading data from a file, a good plausibility check is to print out some of the data, and maybe not only at the very beginning, but also at some random point in the middle, as we have done above.</p>
<p>The table is a matrix of integer values: the value in the <span class="math inline">\(i\)</span>th row and the <span class="math inline">\(j\)</span>th column of the matrix indicates how many reads have been mapped to gene <span class="math inline">\(i\)</span> in sample <span class="math inline">\(j\)</span>. The statistical sampling models that we discuss in this chapter rely on the fact that the values are the direct, “raw” counts of sequencing reads – not some derived quantity, such as normalized counts, counts of covered base pairs, or the like; this would only lead to nonsensical results.</p>
<section id="the-challenges-of-count-data" class="level3 page-columns page-full" data-number="8.3.1">
<h3 data-number="8.3.1" class="anchored" data-anchor-id="the-challenges-of-count-data"><span class="header-section-number">8.3.1</span> The challenges of count data</h3>
<p>What are the challenges that we need to overcome with such count data?</p>
<ul>
<li><p>The data have a large dynamic range, starting from zero up to millions. The variance, and more generally, the distribution shape of the data in different parts of the dynamic range are very different. We need to take this phenomenon, called <strong>heteroskedasticity</strong>, into account.</p></li>
<li><p>The data are non-negative integers, and their distribution is not symmetric – thus normal or log-normal distribution models may be a poor fit.</p></li>
<li><p>We need to understand the systematic sampling biases and adjust for them. Confusingly, this is often called <strong>normalization</strong>. Examples are the total sequencing depth of an experiment (even if the true abundance of a gene in two libraries is the same, we expect different numbers of reads for it depending on the total number of reads sequenced), or differing sampling probabilities (even if the true abundance of two genes within a biological sample is the same, we expect different numbers of reads for them if their biophysical properties differ, such as length, GC content, secondary structure, binding partners).</p></li>
<li><p>We need to understand the stochastic properties of the sampling, as well as other sources of stochastic experimental variation. For studies with large numbers of biological samples, this is usually straightforward, and we can even fall back on resampling- or permutation-based methods. For designed experiments, however, sample sizes tend to be limited.</p></li>
</ul>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="There are important conceptual and practical differences between experiments and studies – see also sec-design."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="There are important conceptual and practical differences between experiments and studies – see also sec-design."></a></p>
</figure>
</div>
<figcaption>There are important conceptual and practical differences between experiments and studies – see also <a href="13-chap.html" class="quarto-xref"><span>Chapter 13</span></a>.</figcaption>
</figure>
</div>
</div></div></div>
<p>For instance, there are four replicates from the <em>untreated</em> and three from the <em>treated</em> condition in the pasilla data. This means that resampling- or permutation-based methods will not have enough power. To proceed, we need to make distributional assumptions. Essentially, what such assumptions do is that they let us compute the probabilities of rare events in the tails of the distribution – i.e., extraordinarily high or low counts – from a small number of distribution parameters.</p>
<ul>
<li>But even that is often not enough, in particular the estimation of dispersion parameters<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> is difficult with small sample sizes. In that case, we need to make further assumptions, such as that genes with similar locations also have similar dispersions. This is called sharing of information across genes, and we’ll come back to it in <a href="#sec-countdata-sharingInformation" class="quarto-xref"><span>Section 8.10.1</span></a>.</li>
</ul>
<!-- -->
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;Distributions can be parameterized in various ways; often the parameters correspond to some measure of location and some measure of dispersion; a familiar measure of location is the mean, and a familiar measure of dispersion is the variance (or standard deviation), but for some distributions other measures are also in use.</p></div></div></section>
<section id="rna-seq-what-about-gene-structures-splicing-isoforms" class="level3" data-number="8.3.2">
<h3 data-number="8.3.2" class="anchored" data-anchor-id="rna-seq-what-about-gene-structures-splicing-isoforms"><span class="header-section-number">8.3.2</span> RNA-Seq: what about gene structures, splicing, isoforms?</h3>
<p>Eukaryotic genes are complex: most of them consist of multiple exons, and mRNAs result from concatenation of exons through a process called splicing. Alternative splicing and multiple possible choices of start and stop sites enable the generation of multiple, alternative isoforms from the same gene locus. It is possible to use high-throughput sequencing to detect the isoform structures of transcripts. From the fragments that are characteristic for specific isoforms, it is also possible to detect isoform specific abundances. With current RNA-Seq data, which only give us relatively short fragments of the full-length isoforms, it tends to be difficult to assemble and deconvolute full-length isoform structures and abundances <span class="citation" data-cites="SteijgerBertone:2013">(<a href="16-chap.html#ref-SteijgerBertone:2013" role="doc-biblioref">Steijger et al. 2013</a>)</span>. Because of that, procedures with the more modest aim of making only local statements (e.g., inclusion or exclusion of individual exons) have been formulated <span class="citation" data-cites="Reyes:GnomeResearch:2012">(<a href="16-chap.html#ref-Reyes:GnomeResearch:2012" role="doc-biblioref">Anders, Reyes, and Huber 2012</a>)</span>, and these can be more robust. We can expect that future technologies will sequence full-length transcripts.</p>
</section>
</section>
<section id="modeling-count-data" class="level2 page-columns page-full" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="modeling-count-data"><span class="header-section-number">8.4</span> Modeling count data</h2>
<section id="dispersion" class="level3 page-columns page-full" data-number="8.4.1">
<h3 data-number="8.4.1" class="anchored" data-anchor-id="dispersion"><span class="header-section-number">8.4.1</span> Dispersion</h3>
<p>Consider a sequencing library that contains <span class="math inline">\(n_1\)</span> fragments corresponding to gene 1, <span class="math inline">\(n_2\)</span> fragments for gene 2, and so on, with a total library size of <span class="math inline">\(n = n_1+n_2+\cdots\)</span>. We submit the library to sequencing and determine the identity of <span class="math inline">\(r\)</span> randomly sampled fragments. A welcome simplification comes from looking at the orders of magnitude of these numbers:</p>
<ul>
<li><p>the number of genes is in the tens of thousands;</p></li>
<li><p>the value of <span class="math inline">\(n\)</span> depends on the amount of cells that were used to prepare, but for bulk RNA-Seq it will be in the billions or trillions;</p></li>
<li><p>the number of reads <span class="math inline">\(r\)</span> is usually in the tens of millions, and thus much smaller than <span class="math inline">\(n\)</span>.</p></li>
</ul>
<p>From this we can conclude that the probability that a given read maps to the <span class="math inline">\(i^{\text{th}}\)</span> gene is <span class="math inline">\(p_i=n_i/n\)</span>, and that this is pretty much independent of the outcomes for all the other reads. So we can model the number of reads for gene <span class="math inline">\(i\)</span> by a Poisson distribution, where the <em>rate</em> of the Poisson process is the product of <span class="math inline">\(p_i\)</span>, the initial proportion of fragments for the <span class="math inline">\(i^{\text{th}}\)</span> gene, times <span class="math inline">\(r\)</span>, that is: <span class="math inline">\(\lambda_i=rp_i\)</span>.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="In principle, we should consider sampling without replacement and the multinomial distribution here: the probability of sampling a read for the i^{\text{th}} gene depends on how many times the same gene, and other genes, have already been sampled. However, these dependencies are so negligibly small that we’ll ignore them. This is because n is so much larger than r, the number of genes is large, and each individual n_i is small compared to n."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="In principle, we should consider sampling without replacement and the multinomial distribution here: the probability of sampling a read for the i^{\text{th}} gene depends on how many times the same gene, and other genes, have already been sampled. However, these dependencies are so negligibly small that we’ll ignore them. This is because n is so much larger than r, the number of genes is large, and each individual n_i is small compared to n."></a></p>
</figure>
</div>
<figcaption>In principle, we should consider <strong>sampling without replacement</strong> and the multinomial distribution here: the probability of sampling a read for the <span class="math inline">\(i^{\text{th}}\)</span> gene depends on how many times the same gene, and other genes, have already been sampled. However, these dependencies are so negligibly small that we’ll ignore them. This is because <span class="math inline">\(n\)</span> is so much larger than <span class="math inline">\(r\)</span>, the number of genes is large, and each individual <span class="math inline">\(n_i\)</span> is small compared to <span class="math inline">\(n\)</span>.</figcaption>
</figure>
</div>
</div></div></div>
<p>In practice, we are usually not interested in modeling the read counts within a single library, but in comparing the counts between libraries. That is, we want to know whether any differences that we see between different biological conditions – say, the same cell line with and without drug treatment – are larger than expected “by chance”, i.e., larger than what we may expect even between biological replicates. Empirically, it turns out that replicate experiments vary more than what the Poisson distribution predicts. Intuitively, what happens is that <span class="math inline">\(p_i\)</span> and therefore also <span class="math inline">\(\lambda_i\)</span> vary even between biological replicates; perhaps the temperature at which the cells grew was slightly different, or the amount of drug added varied by a few percent, or the incubation time was slightly longer. To account for that, we need to add another layer of modeling on top. We already saw hierarchical models and mixtures in <a href="04-chap.html" class="quarto-xref"><span>Chapter 4</span></a>. It turns out that the <strong>gamma-Poisson</strong> (a.k.a. negative binomial) distribution suits our modeling needs. Instead of a single <span class="math inline">\(\lambda\)</span> – which represents both mean and variance –, this distribution has two parameters. In principle, these can be different for each gene, and we will come back to the question of how to estimate them from the data.</p>
</section>
<section id="sec-countdata-normalization" class="level3 page-columns page-full" data-number="8.4.2">
<h3 data-number="8.4.2" class="anchored" data-anchor-id="sec-countdata-normalization"><span class="header-section-number">8.4.2</span> Normalization</h3>
<p>Often, there are systematic biases that have affected the data generation and are worth taking into account. Unfortunately, the term <strong>normalization</strong> is commonly used for that aspect of the analysis, even though it is misleading: it has nothing to do with the normal distribution, norms in a vector space, or normal vectors. Rather, what we aim for is identifying the nature and estimating the magnitude of systematic biases, and take them into account in our model-based analysis of the data.</p>
<p>The most important systematic bias stems from variations in the total number of reads in each sample. If we have more reads for one library than in another, then we might assume that, everything else being equal, the counts are proportional to each other with some proportionality factor <span class="math inline">\(s\)</span>. Naively, we could propose that a decent estimate of <span class="math inline">\(s\)</span> for each sample is simply given by the sum of the counts of all genes. However, it turns out that we can do better. To understand this, a toy example helps.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-countdata-normalization" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-normalization-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-normalization-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;8.1: Size factor estimation. The points correspond to hypothetical genes whose counts in two samples are indicated by their x- and y-coordinates. The lines indicate two different ways of size factor estimation explained in the text."><img src="08-chap_files/figure-html/fig-countdata-normalization-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="200"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-normalization-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.1: Size factor estimation. The points correspond to hypothetical genes whose counts in two samples are indicated by their <span class="math inline">\(x\)</span>- and <span class="math inline">\(y\)</span>-coordinates. The lines indicate two different ways of size factor estimation explained in the text.
</figcaption>
</figure>
</div>
</div></div></div>
<p>Consider a dataset with 5 genes and two samples as displayed in <a href="#fig-countdata-normalization" class="quarto-xref">Figure&nbsp;<span>8.1</span></a>. If we estimate <span class="math inline">\(s\)</span> for each of the two samples by its sum of counts, then the slope of the blue line represents their ratio. According to this, gene C is down-regulated in sample 2 compared to sample 1, while the other genes are all somewhat up-regulated. If we now instead estimate <span class="math inline">\(s\)</span> such that their ratios correspond to the red line, then we will still conclude that gene C is down-regulated, while the other genes are unchanged. The second version is more parsimonious and is often preferred by scientists. The slope of the red line can be obtained by robust regression. This is what the <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> method does.</p>
<div id="wrn-countdata-estimateSizeFactorsForMatrix" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.1
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the example dataset <code>count</code> of <a href="#sec-countdata-counttable" class="quarto-xref"><span>Section 8.3</span></a>, how does the output of <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong>’s <code>estimateSizeFactorsForMatrix</code> compare to what you get by simply taking the column sums?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>See <a href="#fig-countdata-sfvssum" class="quarto-xref">Figure&nbsp;<span>8.2</span></a>, produced by the code below. In this case, there is not much difference, the results are nearly proportional.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tibble"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"DESeq2"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">size factor</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">estimateSizeFactorsForMatrix</span>(counts),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">sum</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colSums</span>(counts)), <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">`</span><span class="at">size factor</span><span class="st">`</span>, <span class="at">y =</span> <span class="st">`</span><span class="at">sum</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-countdata-sfvssum" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-sfvssum-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-sfvssum-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;8.2: Size factors versus sums for the pasilla data."><img src="08-chap_files/figure-html/fig-countdata-sfvssum-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-sfvssum-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.2: Size factors versus sums for the pasilla data.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Locate the R sources for this book and have a look at the code that produces <a href="#fig-countdata-normalization" class="quarto-xref">Figure&nbsp;<span>8.1</span></a>.</p>
</div>
</div>
<div id="wrn-countdata-meanvar" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Plot the mean-variance relationship for the biological replicates in the pasilla dataset.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>See <a href="#fig-countdata-varmean" class="quarto-xref">Figure&nbsp;<span>8.3</span></a>, produced by the following code.</p>
<div class="cell" data-layout-align="center" data-warning.known="rows containing non-finite">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"matrixStats"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sf <span class="ot">=</span> <span class="fu">estimateSizeFactorsForMatrix</span>(counts)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>ncounts  <span class="ot">=</span> counts <span class="sc">/</span> <span class="fu">matrix</span>(sf,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">ncol =</span> <span class="fu">ncol</span>(counts), <span class="at">nrow =</span> <span class="fu">nrow</span>(counts))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>uncounts <span class="ot">=</span> ncounts[, <span class="fu">grep</span>(<span class="st">"^untreated"</span>, <span class="fu">colnames</span>(ncounts)),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                     drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean =</span> <span class="fu">rowMeans</span>(uncounts),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">var  =</span> <span class="fu">rowVars</span>( uncounts)),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>     <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(mean), <span class="at">y =</span> <span class="fu">log</span>(var))) <span class="sc">+</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hex</span>() <span class="sc">+</span> <span class="fu">coord_fixed</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">color =</span> <span class="fu">c</span>(<span class="st">"forestgreen"</span>, <span class="st">"red"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-countdata-varmean" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-varmean-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-varmean-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure&nbsp;8.3: Variance versus mean for the (size factor adjusted) counts data. The axes are logarithmic. Also shown are lines through the origin with slopes 1 (green) and 2 (red)."><img src="08-chap_files/figure-html/fig-countdata-varmean-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-varmean-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.3: Variance versus mean for the (size factor adjusted) <code>counts</code> data. The axes are logarithmic. Also shown are lines through the origin with slopes 1 (green) and 2 (red).
</figcaption>
</figure>
</div>
</div>
</div>
<p>The green line (slope 1) is what we expect if the variance (<span class="math inline">\(v\)</span>) equals the mean (<span class="math inline">\(m\)</span>), as is the case for a Poisson-distributed random variable: <span class="math inline">\(v=m\)</span>. We see that this approximately fits the data in the lower range. The red line (slope 2) corresponds to the quadratic mean-variance relationship <span class="math inline">\(v=m^2\)</span>; lines parallel to it (not shown) would represent <span class="math inline">\(v = cm^2\)</span> for various values of <span class="math inline">\(c\)</span>. We can see that in the upper range of the data, the quadratic relationship approximately fits the data, for some value of <span class="math inline">\(c&lt;1\)</span>.</p>
</div>
</div>
</div>
</section>
</section>
<section id="sec-countdata-debasic" class="level2 page-columns page-full" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="sec-countdata-debasic"><span class="header-section-number">8.5</span> A basic analysis</h2>
<section id="example-dataset-the-pasilla-data" class="level3 page-columns page-full" data-number="8.5.1">
<h3 data-number="8.5.1" class="anchored" data-anchor-id="example-dataset-the-pasilla-data"><span class="header-section-number">8.5.1</span> Example dataset: the pasilla data</h3>
<p>Let’s return to the <strong><a href="https://bioconductor.org/packages/pasilla/">pasilla</a></strong> data from <a href="#sec-countdata-counttable" class="quarto-xref"><span>Section 8.3</span></a>. These data are from an experiment on <em>Drosophila melanogaster</em> cell cultures that investigated the effect of RNAi knock-down of the splicing factor <em>pasilla</em> <span class="citation" data-cites="Brooks2010">(<a href="16-chap.html#ref-Brooks2010" role="doc-biblioref">Brooks et al. 2011</a>)</span> on the cells’ transcriptome. There were two experimental conditions, termed <em>untreated</em> and <em>treated</em> in the header of the count table that we loaded. They correspond to negative control and to siRNA against <em>pasilla</em>. The experimental metadata of the 7 samples in this dataset are provided in a spreadsheet-like table, which we load.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="In the code shown here, we load the file pasilla_sample_annotation.csv that comes with the pasilla package. We locate it with the function system.file. When you work with your own data, you will need to prepare an analogous file, or directly a dataframe like pasillaSampleAnno."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="In the code shown here, we load the file pasilla_sample_annotation.csv that comes with the pasilla package. We locate it with the function system.file. When you work with your own data, you will need to prepare an analogous file, or directly a dataframe like pasillaSampleAnno."></a></p>
</figure>
</div>
<figcaption>In the code shown here, we load the file <code>pasilla_sample_annotation.csv</code> that comes with the <strong><a href="https://bioconductor.org/packages/pasilla/">pasilla</a></strong> package. We locate it with the function <code>system.file</code>. When you work with your own data, you will need to prepare an analogous file, or directly a dataframe like <code>pasillaSampleAnno</code>.</figcaption>
</figure>
</div>
</div></div></div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>annotationFile <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">"extdata"</span>,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pasilla_sample_annotation.csv"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">package =</span> <span class="st">"pasilla"</span>, <span class="at">mustWork =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>pasillaSampleAnno <span class="ot">=</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(annotationFile)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>pasillaSampleAnno</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 6
  file    condition type  `number of lanes` total number of read…¹ `exon counts`
  &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt;                          &lt;dbl&gt;
1 treate… treated   sing…                 5 35158667                    15679615
2 treate… treated   pair…                 2 12242535 (x2)               15620018
3 treate… treated   pair…                 2 12443664 (x2)               12733865
4 untrea… untreated sing…                 2 17812866                    14924838
5 untrea… untreated sing…                 6 34284521                    20764558
6 untrea… untreated pair…                 2 10542625 (x2)               10283129
7 untrea… untreated pair…                 2 12214974 (x2)               11653031
# ℹ abbreviated name: ¹​`total number of reads`</code></pre>
</div>
</div>
<p>As we see here, the overall dataset was produced in two batches, the first one consisting of three sequencing libraries that were subjected to single read sequencing, the second batch consisting of four libraries for which paired end sequencing was used. As so often, we need to do some data wrangling: we replace the hyphens in the <code>type</code> column by underscores, as arithmetic operators in factor levels are discouraged by <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong>, and convert the <code>type</code> and <code>condition</code> columns into factors, explicitly specifying our prefered order of the levels (the default is alphabetical).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>pasillaSampleAnno <span class="ot">=</span> <span class="fu">mutate</span>(pasillaSampleAnno,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="at">condition =</span> <span class="fu">factor</span>(condition, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"untreated"</span>, <span class="st">"treated"</span>)),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="at">type =</span> <span class="fu">factor</span>(<span class="fu">sub</span>(<span class="st">"-.*"</span>, <span class="st">""</span>, type), <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"single"</span>, <span class="st">"paired"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We note that the design is approximately balanced between the factor of interest, <code>condition</code>, and the “nuisance factor” <code>type</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(pasillaSampleAnno,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">table</span>(condition, type))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           type
condition   single paired
  untreated      2      2
  treated        1      2</code></pre>
</div>
</div>
<p><strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> uses a specialized data container, called <em>DESeqDataSet</em> to store the datasets it works with. Such use of specialized containers – or, in R terminology, <em>classes</em> – is a common principle of the Bioconductor project, as it helps users to keep together related data. While this way of doing things requires users to invest a little more time upfront to understand the classes, compared to just using basic R data types like <em>matrix</em> and dataframe, it helps avoiding bugs due to loss of synchronization between related parts of the data. It also enables the abstraction and encapsulation of common operations that could be quite wordy if always expressed in basic terms<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. <em>DESeqDataSet</em> is an extension of the class <em>SummarizedExperiment</em> in Bioconductor. The <em>SummarizedExperiment</em> class is also used by many other packages, so learning to work with it will enable you to use quite a range of tools.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;Another advantage is that classes can contain <em>validity</em> methods, which make sure that the data always fulfill certain expectations, for instance, that the counts are positive integers, or that the columns of the counts matrix align with the rows of the sample annotation dataframe.</p></div><div id="fn6"><p><sup>6</sup>&nbsp;Note how in the code below, we have to put in extra work to match the column names of the <code>counts</code> object with the <code>file</code> column of the <code>pasillaSampleAnno</code> dataframe, in particular, we need to remove the <code>"fb"</code> that happens to be used in the <code>file</code> column for some reason. Such data wrangling is very common. One of the reasons for storing the data in a <em>DESeqDataSet</em> object is that we then no longer have to worry about such things.</p></div></div><p>We use the constructor function <code>DESeqDataSetFromMatrix</code> to create a <em>DESeqDataSet</em> from the count data matrix <code>counts</code> and the sample annotation dataframe <code>pasillaSampleAnno</code><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>mt <span class="ot">=</span> <span class="fu">match</span>(<span class="fu">colnames</span>(counts), <span class="fu">sub</span>(<span class="st">"fb$"</span>, <span class="st">""</span>, pasillaSampleAnno<span class="sc">$</span>file))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(mt)))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>pasilla <span class="ot">=</span> <span class="fu">DESeqDataSetFromMatrix</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">countData =</span> counts,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">colData   =</span> pasillaSampleAnno[mt, ],</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">design    =</span> <span class="sc">~</span> condition)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(pasilla)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "DESeqDataSet"
attr(,"package")
[1] "DESeq2"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is</span>(pasilla, <span class="st">"SummarizedExperiment"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>The <em>SummarizedExperiment</em> class – and therefore <em>DESeqDataSet</em> – also contains facilities for storing annotation of the rows of the count matrix. For now, we are content with the gene identifiers from the row names of the <code>counts</code> table.</p>
<div id="wrn-countdata-rowData" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.3
</div>
</div>
<div class="callout-body-container callout-body">
<p>How can we access the row metadata of a <em>SummarizedExperiment</em> object, i.e., how can we read it out, how can we change it?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Check the manual page of the <em>SummarizedExperiment</em> class and of the methods <code>rowData</code> and <code>rowData&lt;-</code>.</p>
</div>
</div>
</div>
</section>
<section id="sec-countdata-deseq2" class="level3" data-number="8.5.2">
<h3 data-number="8.5.2" class="anchored" data-anchor-id="sec-countdata-deseq2"><span class="header-section-number">8.5.2</span> The <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> method</h3>
<p>After these preparations, we are now ready to jump straight into differential expression analysis. Our aim is to identify genes that are differentially abundant between the treated and the untreated cells. To this end, we will apply a test that is conceptually similar to the <span class="math inline">\(t\)</span>-test, which we encountered in <a href="06-chap.html#sec-testing-ttest" class="quarto-xref"><span>Section 6.5</span></a>, although mathematically somewhat more involved. We will postpone these details for now, and will come back to them in <a href="#sec-countdata-multifactor" class="quarto-xref"><span>Section 8.7</span></a>. A choice of standard analysis steps are wrapped into a single function, <code>DESeq</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pasilla <span class="ot">=</span> <span class="fu">DESeq</span>(pasilla)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>DESeq</code> function is simply a wrapper that calls, in order, the functions <code>estimateSizeFactors</code> (for normalization, as discussed in <a href="#sec-countdata-normalization" class="quarto-xref"><span>Section 8.4.2</span></a>), <code>estimateDispersions</code> (dispersion estimation) and <code>nbinomWaldTest</code> (hypothesis tests for differential abundance). The test is between the two levels exttt<span>untreated</span> and exttt<span>treated</span> of the factor <code>condition</code>, since this is what we specified when we constructed the <code>pasilla</code> object through the argument <code>design=\simcondition</code>. You can always call each of these three functions individually if you want to modify their behavior or interject custom steps. Let us look at the results.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">results</span>(pasilla)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>res[<span class="fu">order</span>(res<span class="sc">$</span>padj), ] <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>log2 fold change (MLE): condition treated vs untreated 
Wald test p-value: condition treated vs untreated 
DataFrame with 6 rows and 6 columns
             baseMean log2FoldChange     lfcSE      stat       pvalue
            &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;    &lt;numeric&gt;
FBgn0039155   730.596       -4.61901 0.1687068  -27.3789 4.88599e-165
FBgn0025111  1501.411        2.89986 0.1269205   22.8479 1.53430e-115
FBgn0029167  3706.117       -2.19700 0.0969888  -22.6521 1.33042e-113
FBgn0003360  4343.035       -3.17967 0.1435264  -22.1539 9.56283e-109
FBgn0035085   638.233       -2.56041 0.1372952  -18.6490  1.28772e-77
FBgn0039827   261.916       -4.16252 0.2325888  -17.8965  1.25663e-71
                    padj
               &lt;numeric&gt;
FBgn0039155 4.06661e-161
FBgn0025111 6.38497e-112
FBgn0029167 3.69104e-110
FBgn0003360 1.98979e-105
FBgn0035085  2.14354e-74
FBgn0039827  1.74316e-68</code></pre>
</div>
</div>
</section>
<section id="sec-countdata-explore" class="level3 page-columns page-full" data-number="8.5.3">
<h3 data-number="8.5.3" class="anchored" data-anchor-id="sec-countdata-explore"><span class="header-section-number">8.5.3</span> Exploring the results</h3>
<p>The first step after a differential expression analysis is the visualization of the following three or four basic plots:</p>
<ul>
<li><p>the histogram of p-values (<a href="#fig-countdata-hist1" class="quarto-xref">Figure&nbsp;<span>8.4</span></a>),</p></li>
<li><p>the MA plot (<a href="#fig-countdata-MA" class="quarto-xref">Figure&nbsp;<span>8.5</span></a>) and</p></li>
<li><p>an ordination plot (<a href="#fig-countdata-PCA" class="quarto-xref">Figure&nbsp;<span>8.6</span></a>).</p></li>
<li><p>In addition, a heatmap (<a href="#fig-figHeatmap-1" class="quarto-xref">Figure&nbsp;<span>8.7</span></a>) can be instructive.</p></li>
</ul>
<p>These are essential data quality assessment measures – and the general advice on quality assessment and control given in <a href="13-chap.html#sec-design-quality" class="quarto-xref"><span>Section 13.6</span></a> also applies here.</p>
<p>The p-value histogram is straightforward (<a href="#fig-countdata-hist1" class="quarto-xref">Figure&nbsp;<span>8.4</span></a>).</p>
<div class="cell page-columns page-full" data-layout-align="center" data-warning.known="rows containing non-finite outside">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">as</span>(res, <span class="st">"data.frame"</span>), <span class="fu">aes</span>(<span class="at">x =</span> pvalue)) <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.01</span>, <span class="at">fill =</span> <span class="st">"Royalblue"</span>, <span class="at">boundary =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-countdata-hist1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-hist1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-hist1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure&nbsp;8.4: Histogram of p-values of a differential expression analysis."><img src="08-chap_files/figure-html/fig-countdata-hist1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="360"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-hist1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.4: Histogram of p-values of a differential expression analysis.
</figcaption>
</figure>
</div>
</div></div></div>
<p>The distribution displays two main components: a uniform background with values between 0 and 1, and a peak of small p-values at the left. The uniform background corresponds to the non-differentially expressed genes. Usually this is the majority of genes. The left hand peak corresponds to differentially expressed genes<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>. As we already saw in <a href="06-chap.html" class="quarto-xref"><span>Chapter 6</span></a>, the ratio of the level of the background to the height of the peak gives us a rough indication of the false discovery rate (FDR) that would be associated with calling the genes in the leftmost bin differentially expressed. In our case, the leftmost bin contains all p-values between 0 and 0.01, which correspond to 993 genes. The background level is at around 100, so the FDR associated with calling all genes in the leftmost bin would be around 10%.</p>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;For the data shown here, the histogram also contains a few isolated peaks in the middle or towards the right; these stem from genes with small counts and reflect the discreteness of the data.</p></div></div><p>Sometimes it turns out that the background distribution is not uniform, but shows a tilted shape with an increase towards the right. This tends to be an indication of batch effects; you can explore this further in <a href="#imp-countdata-batch" class="quarto-xref">Exercise&nbsp;<span>8.1</span></a>.</p>
<p>To produce the MA plot, we can use the function <code>plotMA</code> in the <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> package (<a href="#fig-countdata-MA" class="quarto-xref">Figure&nbsp;<span>8.5</span></a>).</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotMA</span>(pasilla, <span class="at">ylim =</span> <span class="fu">c</span>( <span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-countdata-MA" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-MA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-MA-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure&nbsp;8.5: MA plot: fold change versus mean of size-factor normalized counts. Logarithmic scaling is used for both axes. By default, points are colored red if the adjusted p-value is less than 0.1. Points which fall out of the y-axis range are plotted as triangles."><img src="08-chap_files/figure-html/fig-countdata-MA-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="360"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-MA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.5: <a href="https://en.wikipedia.org/wiki/MA_plot">MA plot</a>: fold change versus mean of size-factor normalized counts. Logarithmic scaling is used for both axes. By default, points are colored red if the adjusted p-value is less than 0.1. Points which fall out of the <span class="math inline">\(y\)</span>-axis range are plotted as triangles.
</figcaption>
</figure>
</div>
</div></div></div>
<p>To produce PCA plots similar to those we saw in <a href="07-chap.html" class="quarto-xref"><span>Chapter 7</span></a>, we can use the <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> function <code>plotPCA</code> (<a href="#fig-countdata-PCA" class="quarto-xref">Figure&nbsp;<span>8.6</span></a>).</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pas_rlog <span class="ot">=</span> <span class="fu">rlogTransformation</span>(pasilla)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotPCA</span>(pas_rlog, <span class="at">intgroup=</span><span class="fu">c</span>(<span class="st">"condition"</span>, <span class="st">"type"</span>)) <span class="sc">+</span> <span class="fu">coord_fixed</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-countdata-PCA" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-PCA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-PCA-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure&nbsp;8.6: PCA plot. The 7 samples are shown in the 2D plane spanned by their first two principal components."><img src="08-chap_files/figure-html/fig-countdata-PCA-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-PCA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.6: PCA plot. The 7 samples are shown in the 2D plane spanned by their first two principal components.
</figcaption>
</figure>
</div>
</div></div></div>
<p>As we saw in the previous chapter, this type of plot is useful for visualizing the overall effect of experimental covariates and/or to detect batch effects. Here, the first principal axis, PC1, is mostly aligned with the experimental covariate of interest (untreated / treated), while the second axis is roughly aligned with the sequencing protocol (single / paired).</p>
<p>We used a data transformation, the <strong>regularized logarithm</strong> or <strong>rlog</strong>, which we will investigate more closely in <a href="#sec-countdata-rnaseq" class="quarto-xref"><span>Section 8.10.2</span></a>.</p>
<div id="wrn-countdata-pca" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.4
</div>
</div>
<div class="callout-body-container callout-body">
<p>Do the axes of PCA plot always have to align with known experimental covariates?</p>
</div>
</div>
<p>Heatmaps can be a powerful way of quickly getting an overview over a matrix-like dataset, count tables included. Below you see how to make a heatmap from the rlog-transformed data. For a matrix as large as <code>counts(pasilla)</code>, it is not practical to plot all of it, so we plot the submatrix of the 30 genes with the highest average expression.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"pheatmap"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>select <span class="ot">=</span> <span class="fu">order</span>(<span class="fu">rowMeans</span>(<span class="fu">assay</span>(pas_rlog)), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>( <span class="fu">assay</span>(pas_rlog)[select, ],</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">scale =</span> <span class="st">"row"</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">annotation_col =</span> <span class="fu">as.data.frame</span>(</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colData</span>(pas_rlog)[, <span class="fu">c</span>(<span class="st">"condition"</span>, <span class="st">"type"</span>)] ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-figHeatmap-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-figHeatmap-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-figHeatmap-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13" title="Figure&nbsp;8.7: Heatmap of regularized log transformed data of the top 30 genes."><img src="08-chap_files/figure-html/fig-figHeatmap-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-figHeatmap-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.7: Heatmap of regularized log transformed data of the top 30 genes.
</figcaption>
</figure>
</div>
</div></div></div>
<p>In <a href="#fig-figHeatmap-1" class="quarto-xref">Figure&nbsp;<span>8.7</span></a>, <code>pheatmap</code> arranged the rows and columns of the matrix by the dendrogram from an unsupervised clustering, and the clustering of the columns (samples) is dominated by the <code>type</code> factor. This highlights that our differential expression analysis above was probably too naive, and that we should adjust for this strong “nuisance” factor when we are interested in testing for differentially expressed genes between conditions. We will do this in <a href="#sec-countdata-pasillatwofac" class="quarto-xref"><span>Section 8.9</span></a>.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Produce a plot similar to <a href="#fig-figHeatmap-1" class="quarto-xref">Figure&nbsp;<span>8.7</span></a>, but selecting the 30 most highly variable genes instead. What is different? How do the genes with very high mean and those with very high variance relate? How does their data look?</p>
</div>
</div>
</section>
<section id="exporting-the-results" class="level3" data-number="8.5.4">
<h3 data-number="8.5.4" class="anchored" data-anchor-id="exporting-the-results"><span class="header-section-number">8.5.4</span> Exporting the results</h3>
<p>An HTML report of the results with plots and sortable/filterable columns can be exported using the <strong><a href="https://bioconductor.org/packages/ReportingTools/">ReportingTools</a></strong> package on a <em>DESeqDataSet</em> that has been processed by the <code>DESeq</code> function. For a code example, see the <em>RNA-Seq differential expression</em> vignette of the <strong><a href="https://bioconductor.org/packages/ReportingTools/">ReportingTools</a></strong> package or the manual page for the <code>publish</code> method for the <em>DESeqDataSet</em> class.</p>
<p>A CSV file of the results can be exported using <code>write.csv</code> (or its counterpart from the <strong><a href="https://cran.r-project.org/web/packages/readr/">readr</a></strong> package).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(<span class="fu">as.data.frame</span>(res), <span class="at">file =</span> <span class="st">"treated_vs_untreated.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="sec-countdata-critique" class="level2 page-columns page-full" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="sec-countdata-critique"><span class="header-section-number">8.6</span> Critique of default choices and possible modifications</h2>
<section id="the-few-changes-assumption" class="level3 page-columns page-full" data-number="8.6.1">
<h3 data-number="8.6.1" class="anchored" data-anchor-id="the-few-changes-assumption"><span class="header-section-number">8.6.1</span> The few changes assumption</h3>
<p>Underlying the default normalization and the dispersion estimation in <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> (and many other differential expression methods) is that most genes are not differentially expressed.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14" title="For the normalization, although not for the dispersion estimation, one can slightly relax this assumption: it is still valid if many genes are changing, but in a way that is balanced between up- and downward directions."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="For the normalization, although not for the dispersion estimation, one can slightly relax this assumption: it is still valid if many genes are changing, but in a way that is balanced between up- and downward directions."></a></p>
</figure>
</div>
<figcaption>For the normalization, although not for the dispersion estimation, one can slightly relax this assumption: it is still valid if many genes are changing, but in a way that is balanced between up- and downward directions.</figcaption>
</figure>
</div>
</div></div></div>
<p>This assumption is often reasonable (well-designed experiments usually ask specific questions, so that not everything changes all at once), but what should we do if it does not hold? Instead of applying these operations on the data from all genes, we will then need to identify a subset of (“negative control”) genes for which we believe the assumption is tenable, either because of prior biological knowledge, or because we explicitly controlled their abundance as external “spiked in” features.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Run the <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> workflow with size factors and dispersion parameters estimated only from a predefined subset of genes.</p>
</div>
</div>
</section>
<section id="point-like-null-hypothesis" class="level3" data-number="8.6.2">
<h3 data-number="8.6.2" class="anchored" data-anchor-id="point-like-null-hypothesis"><span class="header-section-number">8.6.2</span> Point-like null hypothesis</h3>
<p>As a default, the <code>DESeq</code> function tests against the null hypothesis that each gene has the same abundance across conditions; this is a simple and pragmatic choice. Indeed, if the sample size is limited, what is statistically significant also tends to be strong enough to be biologically interesting. But as sample size increases, statistical significance in these tests may be present without much biological relevance. For instance, many genes may be slightly perturbed by downstream, indirect effects. We can modify the test to use a more permissive, interval-based null hypothesis; we will further explore this in <a href="#sec-countdata-bandedtests" class="quarto-xref"><span>Section 8.10.4</span></a>.</p>
</section>
</section>
<section id="sec-countdata-multifactor" class="level2 page-columns page-full" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="sec-countdata-multifactor"><span class="header-section-number">8.7</span> Multi-factor designs and linear models</h2>
<section id="sec-countdata-lm" class="level3 page-columns page-full" data-number="8.7.1">
<h3 data-number="8.7.1" class="anchored" data-anchor-id="sec-countdata-lm"><span class="header-section-number">8.7.1</span> What is a multifactorial design?</h3>
<p>Let’s assume that in addition to the siRNA knockdown of the pasilla gene, we also want to test the effect of a certain drug. We could then envisage an experiment in which the experimenter treats the cells either with negative control, with the siRNA against pasilla, with the drug, or with both. To analyse this experiment, we can use the notation</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-basiclm"><span class="math display">\[
y = \beta_0 + x_1 \beta_1 + x_2 \beta_2 + x_1x_2\beta_{12}.
\tag{8.1}\]</span></span></p>
<p>This equation can be parsed as follows. The left hand side, <span class="anchored-eq" data-anchor-id="eq-countdata" class="math inline">\(y\)</span>, is the experimental measurement of interest. In our case, this is the suitably transformed expression level (we’ll discuss this in <a href="#sec-countdata-glmdeseq2" class="quarto-xref"><span>Section 8.8.3</span></a>) of a gene. Since in an RNA-Seq experiment there are lots of genes, we’ll have as many copies of <a href="#eq-countdata-basiclm" class="quarto-xref">Equation&nbsp;<span>8.1</span></a>, one for each. The coefficient <span class="math inline">\(\beta_0\)</span> is the base level of the measurement in the negative control; often it is called the <strong>intercept</strong>.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15" title="Sometimes Equation&nbsp;eq-countdata-basiclm is written with an additional term x_0 that is multiplied with \beta_0, where it is understood that x_0=1 always. It turns out that this makes subsequent notation and bookkeeping easier since then the intercept can be handled consistently together with the other \betas, instead of being a separate case."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="Sometimes Equation&nbsp;eq-countdata-basiclm is written with an additional term x_0 that is multiplied with \beta_0, where it is understood that x_0=1 always. It turns out that this makes subsequent notation and bookkeeping easier since then the intercept can be handled consistently together with the other \betas, instead of being a separate case."></a></p>
</figure>
</div>
<figcaption>Sometimes <a href="#eq-countdata-basiclm" class="quarto-xref">Equation&nbsp;<span>8.1</span></a> is written with an additional term <span class="math inline">\(x_0\)</span> that is multiplied with <span class="math inline">\(\beta_0\)</span>, where it is understood that <span class="math inline">\(x_0=1\)</span> always. It turns out that this makes subsequent notation and bookkeeping easier since then the intercept can be handled consistently together with the other <span class="math inline">\(\beta\)</span>s, instead of being a separate case.</figcaption>
</figure>
</div>
</div></div></div>
<p>The design factors <span class="anchored-eq" data-anchor-id="eq-countdata" class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> are binary indicator variables: <span class="math inline">\(x_1\)</span> takes the value 1 if the siRNA was transfected and 0 if not, and similarly, <span class="math inline">\(x_2\)</span> indicates whether the drug was administered. In the experiment where only the siRNA is used, <span class="math inline">\(x_1=1\)</span> and <span class="math inline">\(x_2=0\)</span>, and the third and fourth terms of <a href="#eq-countdata-basiclm" class="quarto-xref">Equation&nbsp;<span>8.1</span></a> vanish. Then, the equation simplifies to <span class="math inline">\(y=\beta_0+\beta_1\)</span>. This means that <span class="math inline">\(\beta_1\)</span> represents the difference between treatment and control. If our measurements are on a logarithmic scale, then</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-examplebeta1"><span class="math display">\[
\begin{align}
\beta_1 = y-\beta_0
&amp;=\log_2(\text{expression}_{\text{treated}})
-\log_2(\text{expression}_{\text{untreated}})\\
&amp;=\log_2\frac
{\text{expression}_{\text{treated}}}
{\text{expression}_{\text{untreated}}}
\end{align}
\tag{8.2}\]</span></span></p>
<p>is the logarithmic fold change due to treatment with the siRNA. In exactly the same way, <span class="anchored-eq" data-anchor-id="eq-countdata" class="math inline">\(\beta_2\)</span> is the logarithmic fold change due to treatment with the drug. What happens if we treat the cells with both siRNA and drug? In that case, <span class="math inline">\(x_1=x_2=1\)</span>, and <a href="#eq-countdata-basiclm" class="quarto-xref">Equation&nbsp;<span>8.1</span></a> can be rewritten as</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-exampleinteract"><span class="math display">\[
\beta_{12} = y - (\beta_0 + \beta_1 + \beta_2).
\tag{8.3}\]</span></span></p>
<p>This means that <span class="math inline">\(\beta_{12}\)</span> is the difference between the observed outcome, <span class="math inline">\(y\)</span>, and the outcome expected from the individual treatments, obtained by adding to the baseline the effect of siRNA alone, <span class="math inline">\(\beta_1\)</span>, and of drug alone, <span class="math inline">\(\beta_2\)</span>.</p>
<p>We call <span class="math inline">\(\beta_{12}\)</span> the <em>interaction</em> effect of siRNA and drug. It has nothing to do with a physical interaction, the terminology indicates that the effects of these two different experimental factors do not simply add up, but combine in a more complicated fashion.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16" title="Note that the addition is on the logarithmic scale, which corresponds to multiplication on the original scale."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="Note that the addition is on the logarithmic scale, which corresponds to multiplication on the original scale."></a></p>
</figure>
</div>
<figcaption>Note that the addition is on the logarithmic scale, which corresponds to multiplication on the original scale.</figcaption>
</figure>
</div>
</div></div></div>
<p>For instance, if the target of the drug and of the siRNA were equivalent, leading to the same effect on the cells, then we biologically expect that <span class="math inline">\(\beta_1=\beta_2\)</span>. We also expect that their combination has no further effect, so that <span class="math inline">\(\beta_{12}=-\beta_1\)</span>. If, on the other hand, the targets of the drug and of the siRNA are in parallel pathways that can buffer each other, we’ll expect that <span class="math inline">\(\beta_1\)</span> and <span class="math inline">\(\beta_2\)</span> are both relatively small, but that the combined effect is synergistic, and <span class="math inline">\(\beta_{12}\)</span> is large.</p>
<p>Not always do we care about interactions. Many experiments are designed with multiple factors where we care most about each of their individual effects. In that case, the combinatorial treatment might not be present in the experimental design, and the model to use for the analysis is a version of <a href="#eq-countdata-basiclm" class="quarto-xref">Equation&nbsp;<span>8.1</span></a> with the rightmost term removed.</p>
<p>We can succinctly encode the design of the experiment in the <em>design matrix</em>. For instance, for the combinatorial experiment described above, the design matrix is</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-designmatrix"><span class="math display">\[
\begin{array}{c|c|c} x_0 &amp; x_1 &amp; x_2\\
\hline
1&amp;0&amp;0\\
1&amp;1&amp;0\\
1&amp;0&amp;1\\
1&amp;1&amp;1\end{array}
\tag{8.4}\]</span></span></p>
<p>The columns of the design matrix correspond to the experimental factors, and its rows represent the different experimental conditions, four in our case. If, instead, the combinatorial treatment is not performed, then the design matrix is reduced to only the first three rows of <a href="#eq-countdata-designmatrix" class="quarto-xref"><span>8.4</span></a>.</p>
</section>
<section id="what-about-noise-and-replicates" class="level3 page-columns page-full" data-number="8.7.2">
<h3 data-number="8.7.2" class="anchored" data-anchor-id="what-about-noise-and-replicates"><span class="header-section-number">8.7.2</span> What about noise and replicates?</h3>
<p><a href="#eq-countdata-basiclm" class="quarto-xref">Equation&nbsp;<span>8.1</span></a> provides a conceptual decomposition of the observed data into the effects caused by the different experimental variables. If our data (the <span class="math inline">\(y\)</span>s) were absolutely precise, we could set up a linear system of equations, one equation for each of the four possible experimental conditions represented by the <span class="math inline">\(x\)</span>s, and solve for the <span class="math inline">\(\beta\)</span>s.</p>
<p>Of course, we usually wish to analyze real data that are affected by noise. We then need replicates to estimate the levels of noise and assess the uncertainty of our estimated <span class="math inline">\(\beta\)</span>s. Only then we can empirically assess whether any of the observed changes between conditions are significantly larger than those occuring just due to experimental or natural variation. We need to slightly extend the equation,</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-lmwithnoise"><span class="math display">\[
y_{j} = x_{j0} \; \beta_0 + x_{j1} \; \beta_1 + x_{j2} \; \beta_2 + x_{j1}\,x_{j2}\;\beta_{12} + \varepsilon_j.
\tag{8.5}\]</span></span></p>
<p>We have added the index <span class="math inline">\(j\)</span> and a new term <span class="math inline">\(\varepsilon_j\)</span>. The index <span class="math inline">\(j\)</span> now explicitly counts over our individual replicate experiments; for instance, if for each of the four conditions we perform three replicates, then <span class="math inline">\(j\)</span> counts from 1 to 12. The design matrix has now 12 rows, and <span class="math inline">\(x_{jk}\)</span> is the value of the matrix in its <span class="math inline">\(j\)</span>th row and <span class="math inline">\(k\)</span>th column.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17" title="Remember that since \beta_0 is the intercept, x_{j0}=1 for all j."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="Remember that since \beta_0 is the intercept, x_{j0}=1 for all j."></a></p>
</figure>
</div>
<figcaption>Remember that since <span class="math inline">\(\beta_0\)</span> is the intercept, <span class="math inline">\(x_{j0}=1\)</span> for all <span class="math inline">\(j\)</span>.</figcaption>
</figure>
</div>
</div></div></div>
<p>The additional terms <span class="anchored-eq" data-anchor-id="eq-countdata" class="math inline">\(\varepsilon_j\)</span>, which we call the <strong>residuals</strong>, are there to absorb differences between replicates. However, one additional modeling component is needed: the system of twelve equations <a href="#eq-countdata-lmwithnoise" class="quarto-xref"><span>8.5</span></a> would be underdetermined without further information, since it has now more variables (twelve epsilons and four betas) than it has equations (twelve, one for each <span class="math inline">\(j\)</span>). To fix this, we require that the <span class="math inline">\(\varepsilon_j\)</span> be small. One popular way – we’ll encounter others – to overcome this is to minimize the sum of squared residuals,</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-lss"><span class="math display">\[
\sum_j \varepsilon_j^2 \quad\to\quad\text{min}.
\tag{8.6}\]</span></span></p>
<p>It turns out that with this requirement satisfied, the <span class="math inline">\(\beta\)</span>s represent the <em>average</em> effects of each of the experimental factors, while the residuals <span class="math inline">\(\varepsilon_j\)</span> reflect the experimental fluctuations around the mean between the replicates. This approach, which is called the <strong>least sum of squares fitting</strong>, is mathematically convenient, since it can achieved by straightforward matrix algebra. It is what the R function <code>lm</code> does.</p>
<div id="wrn-countdata-moregeneral" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.5
</div>
</div>
<div class="callout-body-container callout-body">
<p>An alternative way to write <a href="#eq-countdata-lmwithnoise" class="quarto-xref">Equation&nbsp;<span>8.5</span></a> is</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-generalizedlmwithnoise"><span class="math display">\[
y_{j} = \sum_k x_{jk} \; \beta_k + \varepsilon_j.
\tag{8.7}\]</span></span></p>
<p>How can this be mapped to <a href="#eq-countdata-lmwithnoise" class="quarto-xref">Equation&nbsp;<span>8.5</span></a>, i.e., what’s with the interaction term <span class="math inline">\(x_{j1}\,x_{j2}\;\beta_{12}\)</span>?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This is really just a trivial matter of notation: the sum extends over <span class="anchored-eq" data-anchor-id="eq-countdata" class="math inline">\(k=0,...,3\)</span>, where the terms for <span class="math inline">\(k=0,1,2\)</span> are exactly as we know them already. We write <span class="math inline">\(\beta_{3}\)</span> instead of <span class="math inline">\(\beta_{12}\)</span>, and <span class="math inline">\(x_{j3}\)</span> is defined to be <span class="math inline">\(x_{j1}x_{j2}\)</span>. The generic notation <a href="#eq-countdata-generalizedlmwithnoise" class="quarto-xref"><span>8.7</span></a> is practical to use in computer software that implements linear models and in mathematical proofs. It also highlights that the “scientific content” of a linear model is condensed in its design matrix.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Show that if we have fit <a href="#eq-countdata-lmwithnoise" class="quarto-xref">Equation&nbsp;<span class="anchored-eq" data-anchor-id="eq-countdata">8.5</span></a> to data such that objective <a href="#eq-countdata-lss" class="quarto-xref"><span>8.6</span></a> holds, the fit residuals <span class="math inline">\(\hat{\varepsilon}_j\)</span> have an average of 0.</p>
</div>
</div>
</section>
<section id="analysis-of-variance" class="level3 page-columns page-full" data-number="8.7.3">
<h3 data-number="8.7.3" class="anchored" data-anchor-id="analysis-of-variance"><span class="header-section-number">8.7.3</span> Analysis of variance</h3>
<p>A model like <a href="#eq-countdata-lmwithnoise" class="quarto-xref"><span class="anchored-eq" data-anchor-id="eq-countdata">8.5</span></a> is called a <strong>linear model</strong>, and often it is implied that criterion <a href="#eq-countdata-lss" class="quarto-xref"><span>8.6</span></a> is used to fit it to data. This approach is elegant and powerful, but for novices it can take some time to appreciate all its facets. What is the advantage over just simply taking, for each distinct experimental condition, the average over replicates and comparing these values across conditions? In simple cases, the latter approach can be intuitive and effective. However, it comes to its limits when the replicate numbers are not all the same in the different groups, or when one or more of the <span class="math inline">\(x\)</span>-variables is continuous-valued. In these cases, one will invariably end up with something like fitting <a href="#eq-countdata-lmwithnoise" class="quarto-xref"><span>8.5</span></a> to the data. A useful way to think about <a href="#eq-countdata-lmwithnoise" class="quarto-xref"><span>8.5</span></a> is contained in the term <strong>analysis of variance</strong>, abbreviated ANOVA. In fact, what <a href="#eq-countdata-lmwithnoise" class="quarto-xref">Equation&nbsp;<span>8.5</span></a> does is decompose the variability of <span class="math inline">\(y\)</span> that we observed in the course of our experiments into elementary components: its baseline value <span class="math inline">\(\beta_0\)</span>, its variability caused by the effect of the first variable, <span class="math inline">\(\beta_1\)</span>, its variability caused by the effect of the second variable, <span class="math inline">\(\beta_2\)</span>, its variability caused by the effect of the interaction, <span class="math inline">\(\beta_{12}\)</span>, and variability that is unaccounted for. The last of these we commonly call <em>noise</em>, the other ones, <em>systematic variability</em>.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18" title="The distinction between noise and systematic variability is in the eye of the beholder, and depends on our model, not on reality."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="The distinction between noise and systematic variability is in the eye of the beholder, and depends on our model, not on reality."></a></p>
</figure>
</div>
<figcaption>The distinction between noise and systematic variability is in the eye of the beholder, and depends on our model, not on reality.</figcaption>
</figure>
</div>
</div></div></div>
</section>
<section id="robustness" class="level3 page-columns page-full" data-number="8.7.4">
<h3 data-number="8.7.4" class="anchored" data-anchor-id="robustness"><span class="header-section-number">8.7.4</span> Robustness</h3>
<p>The sum <a href="#eq-countdata-lss" class="quarto-xref"><span>8.6</span></a> is sensitive to outliers in the data. A single measurement <span class="math inline">\(y_{j}\)</span> with an outlying value can draw the <span class="math inline">\(\beta\)</span> estimates far away from the values implied by the other replicates. This is the well-known fact that methods based on least sum of squares have a low <strong>breakdown point</strong>: if even only a single data point is outlying, the whole statistical result can be strongly affected. For instance, the average of a set of <span class="math inline">\(n\)</span> numbers has a breakdown point of <span class="math inline">\(\frac{1}{n}\)</span>, meaning that it can be arbitrarily changed by changing only a single one of the numbers. On the other hand, the median has a much higher breakdown point. Changing a single number often has no effect at all, and when it does, the effect is limited to the range of the data points in the middle of the ranking (i.e., those adjacent to rank <span class="math inline">\(\frac{n}{2}\)</span>). To change the median by an arbitrarily high amount, you need to change half the observations. We call the median <strong>robust</strong>, and its breakdown point is <span class="math inline">\(\frac{1}{2}\)</span>. Remember that the median of a set of numbers <span class="math inline">\(y_1, y_2, ...\)</span> minimizes the sum <span class="math inline">\(\sum_j|y_j-\beta_0|\)</span>.</p>
<p>To achieve a higher degree of robustness against outliers, other choices than the sum of squares <a href="#eq-countdata-lss" class="quarto-xref"><span>8.6</span></a> can be used as the objective of minimization. Among these are:</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-R"><span class="math display">\[
\begin{align}
R &amp;= \sum_j |\varepsilon_j|
  &amp; \text{Least absolute deviations} \\
R &amp;= \sum_j \rho_s(\varepsilon_j)
  &amp; \text{M-estimation} \\
R &amp;= Q_{\theta}\left( \{\varepsilon_1^2, \varepsilon_2^2,... \} \right)
  &amp; \text{LTS, LQS} \\
R &amp;= \sum_j w_j \varepsilon_j^2
  &amp; \text{general weighted regression}
\end{align}
\tag{8.8}\]</span></span></p>
<p>Here, <span class="anchored-eq" data-anchor-id="eq-countdata" class="math inline">\(R\)</span> is the quantity to be minimized. The first choice in <a href="#eq-countdata-R" class="quarto-xref">Equation&nbsp;<span>8.8</span></a> is called <strong>least absolute deviations</strong> regression. It can be viewed as a generalization of the median. Although conceptually simple, and attractive on first sight, it is harder to minimize than the sum of squares, and it can be less stable and less efficient especially if the data are limited, or do not fit the model<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>. The second choice in <a href="#eq-countdata-R" class="quarto-xref">Equation&nbsp;<span>8.8</span></a>, also called <strong>M-estimation</strong>, uses a penalization function <span class="math inline">\(\rho_s\)</span> (least-squares regression is the special case with <span class="math inline">\(\rho_s(\varepsilon)=\varepsilon^2\)</span>) that looks like a quadratic function for a limited range of <span class="math inline">\(\varepsilon\)</span>, but has a smaller slope, flattens out, or even drops back to zero, for absolute values <span class="math inline">\(|\varepsilon|\)</span> that are larger than the scale parameter <span class="math inline">\(s\)</span>. The intention behind this is to downweight the effect of outliers, i.e.&nbsp;of data points that have large residuals <span class="citation" data-cites="Huber:AMS:1964">(<a href="16-chap.html#ref-Huber:AMS:1964" role="doc-biblioref">Huber 1964</a>)</span>. A choice of <span class="math inline">\(s\)</span> needs to be made and determines what is called an outlier. One can even drop the requirement that <span class="math inline">\(\rho_s\)</span> is quadratic around 0 (as long as its second derivative is positive), and a variety of choices for the function <span class="math inline">\(\rho_s\)</span> have been proposed in the literature. The aim is to give the estimator desirable statistical properties (say, bias and efficiency) when and where the data fit the model, but to limit or nullify the influence of those data points that do not, and to keep computations tractable.</p>
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;The <a href="https://en.wikipedia.org/wiki/Least_absolute_deviations">Wikipedia article</a> gives an overview.</p></div></div><div id="wrn-countdata-Huber" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.6
</div>
</div>
<div class="callout-body-container callout-body">
<p>Plot the graph of the function <span class="math inline">\(\rho_s(\varepsilon)\)</span> proposed by <span class="citation" data-cites="Huber:AMS:1964">Huber (<a href="16-chap.html#ref-Huber:AMS:1964" role="doc-biblioref">1964</a>)</span> for M-estimators.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Huber’s paper defines, on Page 75:</p>
<p><span class="math display">\[
\rho_s(\varepsilon) = \left\{
  \begin{array}{cc}
\frac{1}{2}\varepsilon^2, \quad\text{for }|\varepsilon|&lt; s\\
s|\varepsilon|-\frac{1}{2}s^2, \quad\text{for }|\varepsilon|\ge s\\
  \end{array}
\right.
\]</span></p>
<p>The graph produced by the below code is shown in <a href="#fig-countdata-mestimator" class="quarto-xref">Figure&nbsp;<span>8.8</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">=</span> <span class="cf">function</span>(x, s)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="fu">abs</span>(x) <span class="sc">&lt;</span> s, x<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>,  s <span class="sc">*</span> <span class="fu">abs</span>(x) <span class="sc">-</span> s<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x        =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">7</span>, <span class="dv">7</span>, <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">parabola =</span> x <span class="sc">^</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Huber    =</span> <span class="fu">rho</span>(x, <span class="at">s =</span> <span class="dv">2</span>))</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(reshape2<span class="sc">::</span><span class="fu">melt</span>(df, <span class="at">id.vars =</span> <span class="st">"x"</span>),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> value, <span class="at">col =</span> variable)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-countdata-mestimator" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-mestimator-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-mestimator-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19" title="Figure&nbsp;8.8: Graph of \rho_s(\varepsilon), for a choice of s=2."><img src="08-chap_files/figure-html/fig-countdata-mestimator-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-mestimator-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.8: Graph of <span class="math inline">\(\rho_s(\varepsilon)\)</span>, for a choice of <span class="math inline">\(s=2\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Choice three in <a href="#eq-countdata-R" class="quarto-xref"><span>8.8</span></a> generalises the least sum of squares method in yet another way. In <strong>least quantile of squares</strong> (LQS) regression, the the sum over the squared residuals is replaced with a quantile, for instance, <span class="math inline">\(Q_{50}\)</span>, the median, or <span class="math inline">\(Q_{90}\)</span>, the 90%-quantile <span class="citation" data-cites="Rousseeuw:1987">(<a href="16-chap.html#ref-Rousseeuw:1987" role="doc-biblioref">Peter J. Rousseeuw 1987</a>)</span>. In a variation thereof, <strong>least trimmed sum of squares</strong> (LTS) regression, a sum of squared residuals is used, but the sum extends not over all residuals, but only over the fraction <span class="math inline">\(0\le\theta\le1\)</span> of smallest residuals. The motivation in either case is that outlying data points lead to large residuals, and as long as they are rare, they do not affect the quantile or the trimmed sum.</p>
<p>However, there is a price: while the least sum of squares optimization <a href="#eq-countdata-lss" class="quarto-xref"><span>8.6</span></a> can be done through straightforward linear algebra, more complicated iterative optimization algorithms are needed for M-estimation, LQS and LTS regression.</p>
<p>The final approach in <a href="#eq-countdata-R" class="quarto-xref"><span>8.8</span></a> represents an even more complex way of weighting down outliers. It assumes that we have some way of deciding what weight <span class="math inline">\(w_j\)</span> we want to give to each observation, presumably down-weighting outliers. For instance, in <a href="#sec-countdata-dealingCooks" class="quarto-xref"><span>Section 8.10.3</span></a>, we will encounter the approach used by the <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> package, in which the leverage of each data point on the estimated <span class="math inline">\(\beta\)</span>s is assessed using a measure called Cook’s distance. For those data whose Cook’s distance is deemed too large, the weight <span class="math inline">\(w_j\)</span> is set to zero, whereas the other data points get <span class="math inline">\(w_j=1\)</span>. In effect, this means that the outlying data points are discarded and that ordinary regression is performed on the others. The extra computational effort of carrying the weights along is negligible, and the optimization is still straightforward linear algebra.</p>
<p>All of these approaches to outlier robustness introduce a degree of subjectiveness and rely on sufficient replication. The subjectiveness is reflected by the parameter choices that need to be made: <span class="anchored-eq" data-anchor-id="eq-countdata" class="math inline">\(s\)</span> in <a href="#eq-countdata-R" class="quarto-xref"><span>8.8</span></a> (2), <span class="math inline">\(\theta\)</span> in <a href="#eq-countdata-R" class="quarto-xref"><span>8.8</span></a> (3), the weights in <a href="#eq-countdata-R" class="quarto-xref"><span>8.8</span></a> (4). One scientist’s outlier may be the Nobel prize of another. On the other hand, outlier removal is no remedy for sloppy experiments and no justification for wishful thinking.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Search the documentation of R and CRAN packages for implementations of the above robust regression methods. A good place to start is the <a href="https://cran.r-project.org/web/views/Robust.html">CRAN task view on robust statistical methods</a>.</p>
</div>
</div>
</section>
</section>
<section id="sec:glm" class="level2 page-columns page-full" data-number="8.8">
<h2 data-number="8.8" class="anchored" data-anchor-id="sec:glm"><span class="header-section-number">8.8</span> Generalized linear models</h2>
<p>We need to explore two more theoretical concepts before we can proceed to our next application example. Equations of the form <a href="#eq-countdata-lmwithnoise" class="quarto-xref"><span class="anchored-eq" data-anchor-id="eq-countdata">8.5</span></a> model the expected value of the outcome variable, <span class="math inline">\(y\)</span>, as a linear function of the design matrix, and they are fit to data according to the least sum of squares criterion <a href="#eq-countdata-lss" class="quarto-xref"><span>8.6</span></a>; or a robust variant thereof. We now want to generalize these assumptions.</p>
<section id="modeling-the-data-on-a-transformed-scale" class="level3 page-columns page-full" data-number="8.8.1">
<h3 data-number="8.8.1" class="anchored" data-anchor-id="modeling-the-data-on-a-transformed-scale"><span class="header-section-number">8.8.1</span> Modeling the data on a transformed scale</h3>
<p>We already saw that it can be fruitful to consider the data not on the scale that we obtained them, but after some transformation, for instance, the logarithm. This idea can be generalized, since depending on the context, other transformations are useful. For instance, the linear model <a href="#eq-countdata-lmwithnoise" class="quarto-xref"><span>8.5</span></a> would not directly be useful for modeling outcomes that are bounded within an interval, say, <span class="math inline">\([0,1]\)</span> as an indicator of disease risk. In a linear model, the values of <span class="math inline">\(y\)</span> cover, in principle, the whole real axis. However, if we transform the expression on the right hand with a sigmoid function, for instance, <span class="math inline">\(f(y) = 1/(1+e^{-y})\)</span>, then the range of this function<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>, is bounded between 0 and 1 and can be used to model such an outcome.</p>
<div class="no-row-height column-margin column-container"><div id="fn9"><p><sup>9</sup>&nbsp;It is called the logistic function <span class="citation" data-cites="Verhulst:1845">(<a href="16-chap.html#ref-Verhulst:1845" role="doc-biblioref">Verhulst 1845</a>)</span>, and the associated regression model is called <strong>logistic regression</strong>.</p></div></div></section>
<section id="other-error-distributions" class="level3 page-columns page-full" data-number="8.8.2">
<h3 data-number="8.8.2" class="anchored" data-anchor-id="other-error-distributions"><span class="header-section-number">8.8.2</span> Other error distributions</h3>
<p>The other generalization regards the minimization criterion <a href="#eq-countdata-lss" class="quarto-xref"><span>8.6</span></a>. In fact, this criterion can be derived from a specific probabilistic model and the <strong>maximum likelihood</strong> principle (we already encountered this in <a href="02-chap.html" class="quarto-xref"><span>Chapter 2</span></a>). To see this, consider the probabilistic model</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-pnorm"><span class="math display">\[
p(\varepsilon_j) = \frac{1}{\sqrt{2\pi}\sigma} \exp \left(-\frac{\varepsilon_j^2}{2\sigma^2}\right),
\tag{8.9}\]</span></span></p>
<p>that is, we believe that the residuals follow a normal distribution with mean 0 and standard deviation <span class="math inline">\(\sigma\)</span>. Then it is plausible to demand from a good model (i.e., from a good set of <span class="math inline">\(\beta\)</span>s) that these probabilities are large. Formally,</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-likelihood"><span class="math display">\[
\prod_j p(\varepsilon_j) \quad\to\quad\text{max}.
\tag{8.10}\]</span></span></p>
<div id="wrn-countdata-mlls" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.7
</div>
</div>
<div class="callout-body-container callout-body">
<p>Show that the maximizing the likelihood <a href="#eq-countdata-likelihood" class="quarto-xref"><span class="anchored-eq" data-anchor-id="eq-countdata">8.10</span></a> is equivalent to minimizing the sum of squared residuals <a href="#eq-countdata-lss" class="quarto-xref"><span>8.6</span></a>.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Insert <a href="#eq-countdata-pnorm" class="quarto-xref"><span class="anchored-eq" data-anchor-id="eq-countdata">8.9</span></a> into <a href="#eq-countdata-likelihood" class="quarto-xref"><span>8.10</span></a> and take the logarithm.</p>
</div>
</div>
</div>
<p>Let’s revise some core concepts: the left hand side of <a href="#eq-countdata-likelihood" class="quarto-xref">Equation&nbsp;<span class="anchored-eq" data-anchor-id="eq-countdata">8.10</span></a>, i.e., the product of the probabilities of the residuals, is a function of both the model parameters <span class="math inline">\(\beta_1, \beta_2, ...\)</span> and the data <span class="math inline">\(y_1, y_2, ...\)</span>; call it <span class="math inline">\(f(\beta,y)\)</span>. If we think of the model parameters <span class="math inline">\(\beta\)</span> as given and fixed, then the collapsed function <span class="math inline">\(f(y)\)</span> simply indicates the probability of the data. We could use it, for instance, to simulate data. If, on the other hand, we consider the data as given, then <span class="math inline">\(f(\beta)\)</span> is a function of the model parameters, and it is called the <em>likelihood</em>. The second view is the one we take when we optimise <a href="#eq-countdata-lss" class="quarto-xref"><span>8.6</span></a> (and thus <a href="#eq-countdata-likelihood" class="quarto-xref"><span>8.10</span></a>), and hence the <span class="math inline">\(\beta\)</span>s obtained this way are what is called <em>maximum-likelihood estimates</em>.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20" title="It is good to remember that, while we can use the normal distribution as a convenient argument to motivate least sum of squares regression through the maximum likelihood principle, the data do not have to be distributed according to the normal for least sum of squares regression to provide a useful result. In fact, least sum of squares fitting often provides useful estimates for the \betas even when the data are non-normal, although that depends on the specific circumstances."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="It is good to remember that, while we can use the normal distribution as a convenient argument to motivate least sum of squares regression through the maximum likelihood principle, the data do not have to be distributed according to the normal for least sum of squares regression to provide a useful result. In fact, least sum of squares fitting often provides useful estimates for the \betas even when the data are non-normal, although that depends on the specific circumstances."></a></p>
</figure>
</div>
<figcaption>It is good to remember that, while we can use the normal distribution as a convenient argument to motivate least sum of squares regression through the maximum likelihood principle, the data do not have to be distributed according to the normal for least sum of squares regression to provide a useful result. In fact, least sum of squares fitting often provides useful estimates for the <span class="math inline">\(\beta\)</span>s even when the data are non-normal, although that depends on the specific circumstances.</figcaption>
</figure>
</div>
</div></div></div>
<p>The generalization that we can now make is to use a different probabilistic model. We can use the densities of other distributions than the normal instead of <a href="#eq-countdata-pnorm" class="quarto-xref">Equation&nbsp;<span>8.9</span></a>. For instance, to be able to deal with count data, we will use the gamma-Poisson distribution.</p>
</section>
<section id="sec-countdata-glmdeseq2" class="level3 page-columns page-full" data-number="8.8.3">
<h3 data-number="8.8.3" class="anchored" data-anchor-id="sec-countdata-glmdeseq2"><span class="header-section-number">8.8.3</span> A generalized linear model for count data</h3>
<p>The differential expression analysis in <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> uses a generalized linear model of the form:</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-DESeq2-LM"><span class="math display">\[
\begin{align}
K_{ij}         &amp; \sim \text{GP}(\mu_{ij}, \alpha_i) \\
\mu_{ij}       &amp;= s_j\, q_{ij} \\
\log_2(q_{ij}) &amp;= \sum_k x_{jk} \beta_{ik}.
\end{align}
\tag{8.11}\]</span></span></p>
<!-- check with Wolfang and Susan if this is okay
{#eq-countdata-kij}
{#eq-countdata-muij}
{#eq-countdata-qij}-->
<p>Let us unpack this step by step. The counts <span class="anchored-eq" data-anchor-id="eq-countdata" class="math inline">\(K_{ij}\)</span> for gene <span class="math inline">\(i\)</span>, sample <span class="math inline">\(j\)</span> are modeled using a gamma-Poisson (GP) distribution with two parameters, the mean <span class="math inline">\(\mu_{ij}\)</span> and the dispersion <span class="math inline">\(\alpha_i\)</span>. By default, the dispersion is different for each gene <span class="math inline">\(i\)</span>, but the same across all samples, therefore it has no index <span class="math inline">\(j\)</span>. The second line in <a href="#eq-countdata-DESeq2-LM" class="quarto-xref">Equation&nbsp;<span>8.11</span></a> states that the mean is composed of a sample-specific size factor <span class="math inline">\(s_j\)</span><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> and <span class="math inline">\(q_{ij}\)</span>, which is proportional to the true expected concentration of fragments for gene <span class="math inline">\(i\)</span> in sample <span class="math inline">\(j\)</span>. The value of <span class="math inline">\(q_{ij}\)</span> is given by the linear model in the third line via the <em>link function</em>, <span class="math inline">\(\log_2\)</span>. The design matrix <span class="math inline">\((x_{jk})\)</span> is the same for all genes (and therefore does not depend on <span class="math inline">\(i\)</span>). Its rows <span class="math inline">\(j\)</span> correspond to the samples, its columns <span class="math inline">\(k\)</span> to the experimental factors. In the simplest case, for a pairwise comparison, the design matrix has only two columns, one of them everywhere filled with 1 (corresponding to <span class="math inline">\(\beta_0\)</span> of <a href="#sec-countdata-lm" class="quarto-xref"><span>Section 8.7.1</span></a>) and the other one containing 0 or 1 depending on whether the sample belongs to one or the other group. The coefficients <span class="math inline">\(\beta_{ik}\)</span> give the <span class="math inline">\(\log_2\)</span> fold changes for gene <span class="math inline">\(i\)</span> for each column of the design matrix <span class="math inline">\(X\)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="fn10"><p><sup>10</sup>&nbsp;The model can be generalized to use sample- <strong>and</strong> gene-dependent normalization factors <span class="math inline">\(s_{ij}\)</span>. This is explained in the documentation of the <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> package.</p></div></div></section>
</section>
<section id="sec-countdata-pasillatwofac" class="level2 page-columns page-full" data-number="8.9">
<h2 data-number="8.9" class="anchored" data-anchor-id="sec-countdata-pasillatwofac"><span class="header-section-number">8.9</span> Two-factor analysis of the pasilla data</h2>
<p>Besides the treatment with siRNA, which we have already considered in <a href="#sec-countdata-debasic" class="quarto-xref"><span>Section 8.5</span></a>, the <strong><a href="https://bioconductor.org/packages/pasilla/">pasilla</a></strong> data have another covariate, <code>type</code>, which indicates the type of sequencing that was performed.</p>
<p>We saw in the exploratory data analysis (EDA) plots in <a href="#sec-countdata-explore" class="quarto-xref"><span>Section 8.5.3</span></a> that the latter had a considerable systematic effect on the data. Our basic analysis of <a href="#sec-countdata-debasic" class="quarto-xref"><span>Section 8.5</span></a> did not take this account, but we will do so now. This should help us get a more correct picture of which differences in the data are attributable to the treatment, and which are confounded – or masked – by the sequencing type.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>pasillaTwoFactor <span class="ot">=</span> pasilla</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">design</span>(pasillaTwoFactor) <span class="ot">=</span> <span class="fu">formula</span>(<span class="sc">~</span> type <span class="sc">+</span> condition)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>pasillaTwoFactor <span class="ot">=</span> <span class="fu">DESeq</span>(pasillaTwoFactor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Of the two variables <code>type</code> and <code>condition</code>, the one of primary interest is <code>condition</code>, and in <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong>, the convention is to put it at the end of the formula. This convention has no effect on the model fitting, but it helps simplify some of the subsequent results reporting. Again, we access the results using the <code>results</code> function, which returns a dataframe with the statistics of each gene.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>res2 <span class="ot">=</span> <span class="fu">results</span>(pasillaTwoFactor)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res2, <span class="at">n =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>log2 fold change (MLE): condition treated vs untreated 
Wald test p-value: condition treated vs untreated 
DataFrame with 3 rows and 6 columns
             baseMean log2FoldChange     lfcSE       stat    pvalue      padj
            &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt;  &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;
FBgn0000003  0.171569      0.6745518  3.871091  0.1742537  0.861666        NA
FBgn0000008 95.144079     -0.0406731  0.222215 -0.1830351  0.854770  0.951975
FBgn0000014  1.056572     -0.0849880  2.111821 -0.0402439  0.967899        NA</code></pre>
</div>
</div>
<p>It is also possible to retrieve the <span class="math inline">\(\log_2\)</span> fold changes, p-values and adjusted p-values associated with the <code>type</code> variable. The function <code>results</code> takes an argument <code>contrast</code> that lets users specify the name of the variable, the level that corresponds to the numerator of the fold change and the level that corresponds to the denominator of the fold change.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>resType <span class="ot">=</span> <span class="fu">results</span>(pasillaTwoFactor,</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">contrast =</span> <span class="fu">c</span>(<span class="st">"type"</span>, <span class="st">"single"</span>, <span class="st">"paired"</span>))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(resType, <span class="at">n =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>log2 fold change (MLE): type single vs paired 
Wald test p-value: type single vs paired 
DataFrame with 3 rows and 6 columns
             baseMean log2FoldChange     lfcSE      stat    pvalue      padj
            &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;
FBgn0000003  0.171569      -1.611546  3.871083 -0.416304  0.677188        NA
FBgn0000008 95.144079      -0.262255  0.220686 -1.188362  0.234691  0.543822
FBgn0000014  1.056572       3.290586  2.087243  1.576522  0.114905        NA</code></pre>
</div>
</div>
<p>So what did we gain from this analysis that took into account <code>type</code> as a nuisance factor (sometimes also called, more politely, a <em>blocking factor</em>), compared to the simple comparison between two groups of <a href="#sec-countdata-debasic" class="quarto-xref"><span>Section 8.5</span></a>? Let us plot the p-values from both analyses against each other.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>trsf <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">is.na</span>(x), <span class="dv">0</span>, (<span class="sc">-</span><span class="fu">log10</span>(x)) <span class="sc">^</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">tibble</span>(<span class="at">pOne =</span> res<span class="sc">$</span>pvalue,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">pTwo =</span> res2<span class="sc">$</span>pvalue),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">trsf</span>(pOne), <span class="at">y =</span> <span class="fu">trsf</span>(pTwo))) <span class="sc">+</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">75</span>) <span class="sc">+</span> <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Single factor analysis (condition)"</span>) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Two factor analysis (type + condition)"</span>) <span class="sc">+</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">col =</span> <span class="st">"orange"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-countdata-scpres1res2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-scpres1res2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-scpres1res2-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21" title="Figure&nbsp;8.9: Comparison of p-values from the models with a single factor (condition) and with two factors (type + condition). The axes correspond to (-\log_{10}p)^{\frac{1}{6}}, an arbitrarily chosen monotonically decreasing transformation that compresses the dynamic range of the p-values for the purpose of visualization. We can see a trend for the joint distribution to lie above the bisector, indicating that the small p-values in the two-factor analysis are generally smaller than those in the one-factor analysis."><img src="08-chap_files/figure-html/fig-countdata-scpres1res2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-scpres1res2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.9: Comparison of p-values from the models with a single factor (condition) and with two factors (type + condition). The axes correspond to <span class="math inline">\((-\log_{10}p)^{\frac{1}{6}}\)</span>, an arbitrarily chosen monotonically decreasing transformation that compresses the dynamic range of the p-values for the purpose of visualization. We can see a trend for the joint distribution to lie above the bisector, indicating that the small p-values in the two-factor analysis are generally smaller than those in the one-factor analysis.
</figcaption>
</figure>
</div>
</div></div></div>
<p>As we can see in <a href="#fig-countdata-scpres1res2" class="quarto-xref">Figure&nbsp;<span>8.9</span></a>, the p-values in the two-factor analysis are similar to those from the one-factor analysis, but are generally smaller. The more sophisticated analysis has led to an, albeit modest, increase in power. We can also see this by counting the number of genes that pass a certain significance threshold in each case:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>compareRes <span class="ot">=</span> <span class="fu">table</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>   <span class="st">`</span><span class="at">simple analysis</span><span class="st">`</span> <span class="ot">=</span> res<span class="sc">$</span>padj <span class="sc">&lt;</span> <span class="fl">0.1</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>   <span class="st">`</span><span class="at">two factor</span><span class="st">`</span> <span class="ot">=</span> res2<span class="sc">$</span>padj <span class="sc">&lt;</span> <span class="fl">0.1</span> )</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">addmargins</span>( compareRes )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               two factor
simple analysis FALSE TRUE  Sum
          FALSE  6973  289 7262
          TRUE     25 1036 1061
          Sum    6998 1325 8323</code></pre>
</div>
</div>
<p>The two-factor analysis found 1325 genes differentially expressed at an FDR threshold of 10%, while the one-factor analysis found 1061. The two-factor analysis has increased detection power. In general, the gain can be even much larger, or also smaller, depending on the data. The proper choice of the model requires informed adaptation to the experimental design and data quality.</p>
<div id="wrn-countdata-gain" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.8
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>Why</em> do we detect fewer significant genes when we do not take into account the <code>type</code> variable? More generally, what does this mean about the benefit of taking into account (or not) blocking factors?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Without modeling the blocking factor, the variability in the data that is due to it has to be absorbed by the <span class="math inline">\(\varepsilon\)</span>s. This means that they are generally larger than in the model with the blocking factor. The higher level of noise leads to higher uncertainty in the <span class="math inline">\(\beta\)</span>-estimates. On the other hand, the model with the blocking factor has more parameters that need to be estimated. In statistical parlance, the fit has fewer “degrees of freedom”. Both of these effects are counteracting, and which of them prevails, and which of the modeling choices yields more or fewer significant results depends on the data.</p>
</div>
</div>
</div>
<div id="wrn-countdata-confounding" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.9
</div>
</div>
<div class="callout-body-container callout-body">
<p>What is confounding? Can <em>not</em> taking into account a blocking factor also lead to the detection of <em>more</em> genes?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Yes. Imagine the variables <code>condition</code> and <code>type</code> were not as nicely balanced as they are, but partially or fully confounded. In that case, differences in the data due to <code>type</code> could be attributed to <code>condition</code> if a model is fit that does not make it possible to absorb them in the <code>type</code>-effect. Scientifically, such an experiment (and analysis) can be quite an embarrassment.</p>
</div>
</div>
</div>
<div id="wrn-countdata-paired" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.10
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider a paired experimenal design, say, 10 different cell lines each with and without drug treatment. How should this be analyzed?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-24-contents" aria-controls="callout-24" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-24" class="callout-24-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>If we just did a simple two-group comparison (treated versus untreated) many of the treatment effects would probably go under in the strong cell line to cell line variation. However, we can set up a <em>paired</em> analysis simply by adding cell line identity as a blocking factor. (Cell line is then really an R <em>factor</em> with 10 different levels, rather than just a 0 vs 1 indicator variable as with the variables that we looked at so far; R’s linear modeling facilities, and also <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong>, have no problem dealing with that.)</p>
</div>
</div>
</div>
<div id="wrn-countdata-sva" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.11
</div>
</div>
<div class="callout-body-container callout-body">
<p>What can you do if you suspect there are “hidden” factors that affect your data, but they are not documented? (Sometimes, such undocumented covariates are also called <strong>batch effects</strong>.)</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-26-contents" aria-controls="callout-26" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-26" class="callout-26-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>There are methods that try to identify blocking factors in an unsupervised fashion, see e.g., <span class="citation" data-cites="LeekStorey:2007 Stegle:2010">Leek and Storey (<a href="16-chap.html#ref-LeekStorey:2007" role="doc-biblioref">2007</a>; <a href="16-chap.html#ref-Stegle:2010" role="doc-biblioref">Stegle et al. 2010</a>)</span>.</p>
</div>
</div>
</div>
</section>
<section id="further-statistical-concepts" class="level2 page-columns page-full" data-number="8.10">
<h2 data-number="8.10" class="anchored" data-anchor-id="further-statistical-concepts"><span class="header-section-number">8.10</span> Further statistical concepts</h2>
<section id="sec-countdata-sharingInformation" class="level3 page-columns page-full" data-number="8.10.1">
<h3 data-number="8.10.1" class="anchored" data-anchor-id="sec-countdata-sharingInformation"><span class="header-section-number">8.10.1</span> Sharing of dispersion information across genes</h3>
<p>We already saw an explanation of Bayesian (or empirical Bayes) analysis in <a href="06-chap.html#fig-testing-sunexplode" class="quarto-xref">Figure&nbsp;<span class="anchored-eq" data-anchor-id="eq-countdata">6.16</span></a>. The idea is to use additional information to improve our estimates (information that we either known a priori, or have from analysis of other, but similar data). This idea is particularly useful if the data per se are relatively noisy. <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> uses an empirical Bayes approach for the estimation of the dispersion parameters (the <span class="math inline">\(\alpha\)</span>s in the third line of <a href="#eq-countdata-DESeq2-LM" class="quarto-xref">Equation&nbsp;<span>8.11</span></a>) and, optionally, the logarithmic fold changes (the <span class="math inline">\(\beta\)</span>s). The priors are, in both cases, taken from the distributions of the maximum-likelihood estimates (MLEs) across all genes. It turns out that both of these distributions are uni-modal; in the case of the <span class="math inline">\(\beta\)</span>s, with a peak at around 0, in the case of the <span class="math inline">\(\alpha\)</span>, at a particular value, the typical dispersion. The empirical Bayes machinery then shrinks each per-gene MLE towards that peak, by an amount that depends on the sharpness of the empirical prior distribution and the precision of the ML estimate (the better the latter, the less shrinkage will be done). The mathematics are explained in <span class="citation" data-cites="LoveDESeq2">(<a href="16-chap.html#ref-LoveDESeq2" role="doc-biblioref">Michael I. Love, Huber, and Anders 2014</a>)</span>, and <a href="#fig-countdata-posterior" class="quarto-xref">Figure&nbsp;<span>8.10</span></a> visualizes the approach for the <span class="math inline">\(\beta\)</span>s.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Advanced: check the R code that produces <a href="#fig-countdata-posterior" class="quarto-xref">Figure&nbsp;<span>8.10</span></a>.</p>
</div>
</div>
<div id="fig-countdata-posterior" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-countdata-posterior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="quarto-layout-row page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-countdata-posterior" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-countdata-posterior-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="240">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-countdata-posterior-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-posterior-1.png" class="lightbox" data-gallery="fig-countdata-posterior" title="Figure&nbsp;8.10&nbsp;(a): "><img src="08-chap_files/figure-html/fig-countdata-posterior-1.png" id="fig-countdata-posterior-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-countdata-posterior" width="240"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-countdata-posterior-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div></div></div>
<div class="quarto-layout-row page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-countdata-posterior" style="flex-basis: 100.0%;justify-content: center;">
<div id="fig-countdata-posterior-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" width="240">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-countdata-posterior-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-posterior-2.png" class="lightbox" data-gallery="fig-countdata-posterior" title="Figure&nbsp;8.10&nbsp;(b): "><img src="08-chap_files/figure-html/fig-countdata-posterior-2.png" id="fig-countdata-posterior-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-countdata-posterior" width="240"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-countdata-posterior-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div></div></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-posterior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.10: Shrinkage estimation of logarithmic fold change estimates by use of an empirical prior in <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong>. Two genes with similar mean count and MLE logarithmic fold change are highlighted in green and blue. The normalized counts for these genes (a) reveal low dispersion for the gene in blue and high dispersion for the gene in green. In (b), the density plots are shown of the normalized likelihoods (solid lines) and of the posteriors (dashed lines) for the green and blue gene. In addition, the solid black line shows the prior estimated from the MLEs of all genes. Due to the higher dispersion of the green gene, its likelihood is wider and less sharp (indicating less information), and the prior has more influence on its posterior than in the case of the blue gene.
</figcaption>
</figure>
</div>
</section>
<section id="sec-countdata-rnaseq" class="level3 page-columns page-full" data-number="8.10.2">
<h3 data-number="8.10.2" class="anchored" data-anchor-id="sec-countdata-rnaseq"><span class="header-section-number">8.10.2</span> Count data transformations</h3>
<p>For testing for differential expression we operate on raw counts and use discrete distributions. For other downstream analyses – e.g., for visualization or clustering – it might however be useful to work with transformed versions of the count data.</p>
<p>Maybe the most obvious choice of transformation is the logarithm. However, since count values for a gene can become zero, some advocate the use of <strong>pseudocounts</strong>, i.e., transformations of the form</p>
<p><span class="anchored-eq" data-anchor-id="eq-countdata" id="eq-countdata-shiftedlog"><span class="math display">\[
y = \log_2(n + 1)\quad\mbox{or more generally,}\quad y = \log_2(n + n_0),
\tag{8.12}\]</span></span></p>
<p>where <span class="math inline">\(n\)</span> represents the count values and <span class="math inline">\(n_0\)</span> is a somehow chosen positive constant.</p>
<p>Let’s look at two alternative approaches that offer more theoretical justification, and a rational way of choosing the parameter equivalent to <span class="math inline">\(n_0\)</span> above. One method incorporates priors on the sample differences, and the other uses the concept of variance-stabilizing transformations.</p>
<section id="sec-countdata-varstab" class="level4 unnumbered page-columns page-full">
<h4 class="unnumbered anchored" data-anchor-id="sec-countdata-varstab">Variance-stabilizing transformation</h4>
<p>We already explored <strong>variance-stabilizing transformations</strong> in <a href="04-chap.html#sec-mixtures-vst" class="quarto-xref"><span>Section 4.4.4</span></a>. There we computed a piece-wise linear transformation for a discrete set of random variables (<a href="04-chap.html#fig-pcwlin-1" class="quarto-xref">Figure&nbsp;<span>4.26</span></a>) and also saw how to use calculus to derive a smooth variance-stabilizing transformation for a gamma-Poisson mixture. These computations are implemented in the <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> package <span class="citation" data-cites="Anders:2010:GB">(<a href="16-chap.html#ref-Anders:2010:GB" role="doc-biblioref">Anders and Huber 2010</a>)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>vsp <span class="ot">=</span> <span class="fu">varianceStabilizingTransformation</span>(pasilla)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us explore the effect of this on the data, using the first sample as an example, and comparing it to the <span class="math inline">\(\log_2\)</span> transformation; the plot is shown in <a href="#fig-countdata-plotvst" class="quarto-xref">Figure&nbsp;<span>8.11</span></a> and is made with the following:</p>
<div class="cell page-columns page-full" data-layout-align="center" data-warning.known="containing missing values">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">counts =</span> <span class="fu">rep</span>(<span class="fu">assay</span>(pasilla)[, j], <span class="dv">2</span>),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">transformed =</span> <span class="fu">c</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">assay</span>(vsp)[, j],</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log2</span>(<span class="fu">assay</span>(pasilla)[, j])</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">transformation =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"VST"</span>, <span class="st">"log2"</span>), <span class="at">each =</span> <span class="fu">nrow</span>(pasilla))</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> counts, <span class="at">y =</span> transformed, <span class="at">col =</span> transformation)) <span class="sc">+</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">600</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">9</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-countdata-plotvst" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-plotvst-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-plotvst-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-24" title="Figure&nbsp;8.11: Graph of variance-stabilizing transformation for the data of one of the samples, and for comparison also of the \log_2 transformation. The variance-stabilizing transformation has finite values and finite slope even for counts close to zero, whereas the slope of \log_2 becomes very steep for small counts and is undefined for counts of zero. For large counts, the two transformation are essentially the same."><img src="08-chap_files/figure-html/fig-countdata-plotvst-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="280"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-plotvst-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.11: Graph of variance-stabilizing transformation for the data of one of the samples, and for comparison also of the <span class="math inline">\(\log_2\)</span> transformation. The variance-stabilizing transformation has finite values and finite slope even for counts close to zero, whereas the slope of <span class="math inline">\(\log_2\)</span> becomes very steep for small counts and is undefined for counts of zero. For large counts, the two transformation are essentially the same.
</figcaption>
</figure>
</div>
</div></div></div>
</section>
<section id="sec-countdata-rlog" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="sec-countdata-rlog">Regularized logarithm (rlog) transformation</h4>
<p>There is a second way to come up with a data transformation. It is conceptually distinct from variance stabilization. Instead, it builds upon the shrinkage estimation that we already explored in <a href="#sec-countdata-sharingInformation" class="quarto-xref"><span class="anchored-eq" data-anchor-id="eq-countdata">Section 8.10.1</span></a>. It works by transforming the original count data to a <span class="math inline">\(\log_2\)</span>-like scale by fitting a “trivial” model with a separate term for each sample and a prior distribution on the coefficients which is estimated from the data. The fitting employs the same regularization as what we discussed in <a href="#sec-countdata-sharingInformation" class="quarto-xref"><span>Section 8.10.1</span></a>. The transformed data <span class="math inline">\(q_{ij}\)</span> are defined by the third line of <a href="#eq-countdata-DESeq2-LM" class="quarto-xref">Equation&nbsp;<span>8.11</span></a>, where the design matrix <span class="math inline">\(\left(x_{jk}\right)\)</span> is of size <span class="math inline">\(K
\times (K+1)\)</span> – here <span class="math inline">\(K\)</span> is the number of samples– and has the form</p>
<p><span class="anchored-eq" data-anchor-id="eq-axvyntzijgqh" id="eq-axvyntzijgqh"><span class="math display">\[
X=\left(\begin{array}{ccccc}1&amp;1&amp;0&amp;0&amp;\cdot\\1&amp;0&amp;1&amp;0&amp;\cdot\\1&amp;0&amp;0&amp;1&amp;\cdot\\\cdot&amp;\cdot&amp;\cdot&amp;\cdot&amp;\cdot\end{array}\right).
\tag{8.13}\]</span></span></p>
<p>Without priors, this design matrix would lead to a non-unique solution, however the addition of a prior on non-intercept <span class="math inline">\(\beta\)</span>s allows for a unique solution to be found.</p>
<p>In <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong>, this functionality is implemented in the function <code>rlogTransformation</code>. It turns out in practice that the rlog transformation is also approximately variance-stabilizing, but in contrast to the variance-stabilizing transformation of <a href="#sec-countdata-rnaseq" class="quarto-xref"><span>Section 8.10.2</span></a> it deals better with data in which the size factors of the different samples are very distinct.</p>
<div id="wrn-countdata-meandsPlot" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.12
</div>
</div>
<div class="callout-body-container callout-body">
<p>Plot mean against standard deviation between replicates for the shifted logarithm <a href="#eq-countdata-shiftedlog" class="quarto-xref"><span>8.12</span></a>, the regularized log transformation and the variance-stabilizing transformation.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-29-contents" aria-controls="callout-29" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-29" class="callout-29-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>See <a href="#fig-countdata-meansd" class="quarto-xref">Figure&nbsp;<span>8.12</span></a>.</p>
<div class="cell" data-layout-align="center" data-warning.known="[&quot;rows containing missing values&quot;,&quot;rows containing non-finite&quot;]">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"vsn"</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>rlp <span class="ot">=</span> <span class="fu">rlogTransformation</span>(pasilla)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>msd <span class="ot">=</span> <span class="cf">function</span>(x)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">meanSdPlot</span>(x, <span class="at">plot =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>gg <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">msd</span>(<span class="fu">log2</span>(<span class="fu">counts</span>(pasilla, <span class="at">normalized =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"sd(log2)"</span>),</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">msd</span>(<span class="fu">assay</span>(vsp)) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"sd(vst)"</span>),</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">msd</span>(<span class="fu">assay</span>(rlp)) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"sd(rlog)"</span>),</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">3</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-countdata-meansd" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-meansd-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-meansd-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-25" title="Figure&nbsp;8.12: Per-gene standard deviation (sd, taken across samples) against the rank of the mean, for the shifted logarithm \log_2(n+1), the variance-stabilizing transformation (vst) and the rlog. Note that for the leftmost \approx 2,500 genes, the counts are all zero, and hence their standard deviation is zero. The mean-sd dependence becomes more interesting for genes with non-zero counts. Note also the high value of the standard deviation for genes that are weakly detected (but not with all zero counts) when the shifted logarithm is used, and compare to the relatively flat shape of the mean-sd relationship for the variance-stabilizing transformation."><img src="08-chap_files/figure-html/fig-countdata-meansd-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="800"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-meansd-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.12: Per-gene standard deviation (sd, taken across samples) against the rank of the mean, for the shifted logarithm <span class="math inline">\(\log_2(n+1)\)</span>, the variance-stabilizing transformation (vst) and the rlog. Note that for the leftmost <span class="math inline">\(\approx\)</span> 2,500 genes, the counts are all zero, and hence their standard deviation is zero. The mean-sd dependence becomes more interesting for genes with non-zero counts. Note also the high value of the standard deviation for genes that are weakly detected (but not with all zero counts) when the shifted logarithm is used, and compare to the relatively flat shape of the mean-sd relationship for the variance-stabilizing transformation.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="sec-countdata-dealingCooks" class="level3" data-number="8.10.3">
<h3 data-number="8.10.3" class="anchored" data-anchor-id="sec-countdata-dealingCooks"><span class="header-section-number">8.10.3</span> Dealing with outliers</h3>
<p>The data sometimes contain isolated instances of very large counts that are apparently unrelated to the experimental or study design, and which may be considered outliers. There are many reasons why outliers can arise, including rare technical or experimental artifacts, read mapping problems in the case of genetically differing samples, and genuine, but rare biological events. In many cases, users appear primarily interested in genes that show a consistent behaviour, and this is the reason why by default, genes that are affected by such outliers are set aside by <code>DESeq</code>. The function calculates, for every gene and for every sample, a diagnostic test for outliers called <strong>Cook’s distance</strong><span class="citation" data-cites="Cook1977Detection">(<a href="16-chap.html#ref-Cook1977Detection" role="doc-biblioref">Cook 1977</a>)</span>. Cook’s distance is a measure of how much a single sample is influencing the fitted coefficients for a gene, and a large value of Cook’s distance is intended to indicate an outlier count. <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> automatically flags genes with Cook’s distance above a cutoff and sets their p-values and adjusted p-values to <code>NA</code>.</p>
<p>The default cutoff depends on the sample size and number of parameters to be estimated; <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> uses the <span class="math inline">\(99\%\)</span> quantile of the <span class="math inline">\(F(p,m-p)\)</span> distribution (with <span class="math inline">\(p\)</span> the number of parameters including the intercept and <span class="math inline">\(m\)</span> number of samples).</p>
<div id="wrn-countdata-dealingCooks" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;8.13
</div>
</div>
<div class="callout-body-container callout-body">
<p>Check the documentation to see how the default cutoff can be changed, and how the outlier removal functionality can be disabled altogether. How can the computed Cook’s distances be accessed?</p>
</div>
</div>
<p>With many degrees of freedom – i.e., many more samples than number of parameters to be estimated – it might be undesirable to remove entire genes from the analysis just because their data include a single count outlier. An alternate strategy is to replace the outlier counts with the trimmed mean over all samples, adjusted by the size factor for that sample. This approach is conservative: it will not lead to false positives, as it replaces the outlier value with the value predicted by the null hypothesis.</p>
</section>
<section id="sec-countdata-bandedtests" class="level3 page-columns page-full" data-number="8.10.4">
<h3 data-number="8.10.4" class="anchored" data-anchor-id="sec-countdata-bandedtests"><span class="header-section-number">8.10.4</span> Tests of <span class="math inline">\(\log_2\)</span> fold change above or below a threshold</h3>
<p>Let’s come back to the point we raised in <a href="#sec-countdata-critique" class="quarto-xref"><span>Section 8.6</span></a>: how to build into the tests our requirement that we want to detect effects that have a strong enough size, as opposed to ones that are statistically significant, but very small. Two arguments to the <code>results</code> function allow for threshold-based Wald tests: <code>lfcThreshold</code>, which takes a numeric of a non-negative threshold value, and <code>altHypothesis</code>, which specifies the kind of test. It can take one of the following four values, where <span class="math inline">\(\beta\)</span> is the <span class="math inline">\(\log_2\)</span> fold change specified by the <code>name</code> argument, and <span class="math inline">\(\theta\)</span> represents <code>lfcThreshold</code>:</p>
<ul>
<li><p><code>greater</code>: <span class="math inline">\(\beta &gt; \theta\)</span></p></li>
<li><p><code>less</code>: <span class="math inline">\(\beta &lt; (-\theta)\)</span></p></li>
<li><p><code>greaterAbs</code>: <span class="math inline">\(\left|\beta\right| &gt; \theta\)</span> (two-tailed test)</p></li>
<li><p><code>lessAbs</code>: <span class="math inline">\(|\beta| &lt; \theta\)</span> (p-values are the maximum of the upper and lower tests)</p></li>
</ul>
<p>These are demonstrated in the following code and visually by MA-plots in <a href="#fig-countdata-lfcThresh" class="quarto-xref">Figure&nbsp;<span>8.13</span></a>. (Note that the <code>plotMA</code> method, which is defined in the <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> package, uses base graphics.)</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>myMA <span class="ot">=</span> <span class="cf">function</span>(h, v, <span class="at">theta =</span> <span class="fl">0.5</span>) {</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plotMA</span>(pasilla, <span class="at">lfcThreshold =</span> theta, <span class="at">altHypothesis =</span> h,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.5</span>, <span class="fl">2.5</span>))</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">h =</span> v <span class="sc">*</span> theta, <span class="at">col =</span> <span class="st">"dodgerblue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="fu">myMA</span>(<span class="st">"greaterAbs"</span>, <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="fu">myMA</span>(<span class="st">"lessAbs"</span>,    <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="fu">myMA</span>(<span class="st">"greater"</span>,          <span class="dv">1</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="fu">myMA</span>(<span class="st">"less"</span>,         <span class="sc">-</span><span class="dv">1</span>   )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-countdata-lfcThresh" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-lfcThresh-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-lfcThresh-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-26" title="Figure&nbsp;8.13: MA-plots of tests of \log_2 fold change with respect to a threshold value. From top to bottom, the tests are for altHypothesis = &quot;greaterAbs&quot;, &quot;lessAbs&quot;, &quot;greater&quot;, and &quot;less&quot;."><img src="08-chap_files/figure-html/fig-countdata-lfcThresh-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="216"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-lfcThresh-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.13: MA-plots of tests of <span class="math inline">\(\log_2\)</span> fold change with respect to a threshold value. From top to bottom, the tests are for <code>altHypothesis = "greaterAbs"</code>, <code>"lessAbs"</code>, <code>"greater"</code>, and <code>"less"</code>.
</figcaption>
</figure>
</div>
</div></div></div>
<p>To produce the results tables instead of MA plots, the same arguments as to <code>plotMA</code> (except <code>ylim</code>) would be provided to the <code>results</code> function.</p>
</section>
</section>
<section id="summary-of-this-chapter" class="level2" data-number="8.11">
<h2 data-number="8.11" class="anchored" data-anchor-id="summary-of-this-chapter"><span class="header-section-number">8.11</span> Summary of this chapter</h2>
<p>We have seen how to analyze count tables from high-throughput sequencing (and analagous data types) for differential abundance. We built upon the powerful and elegant framework of linear models. In this framework, we can analyze a basic two-groups comparison as well as more complex multifactorial designs, or experiments with covariates that have more than two levels or are continuous. In ordinary linear models, the sampling distribution of the data around the expected value is assumed to be independent and normal, with zero mean and the same variances. For count data, the distributions are discrete and tend to be skewed (asymmetric) with highly different variances across the dynamic range. We therefore employed a generalization of ordinary linear models, called generalized linear models (GLMs), and in particular considered gamma-Poisson distributed data with dispersion parameters that we needed to estimate from the data.</p>
<p>Since the sampling depth is typically different for different sequencing runs (replicates), we need to estimate the effect of this variable parameter and take it into account in our model. We did this through the size factors <span class="math inline">\(s_i\)</span>. Often this part of the analysis is called <em>normalization</em> (the term is not particularly descriptive, but unfortunately it is now well-settled in the literature).</p>
<p>For designed experiments, the number of replicates is (and should be) usually too small to estimate the dispersion parameter (and perhaps even the model coefficients) from the data for each gene alone. Therefore we use shrinkage or empirical Bayes techniques, which promise large gains in precision for relatively small costs of bias.</p>
<p>While GLMs let us model the data on their original scale, sometimes it is useful to transform the data to a scale where the data are more homoskedastic and fill out the range more uniformly – for instance, for plotting the data, or for subjecting them to general purpose clustering, dimension reduction or learning methods. To this end, we saw the variance stabilizing transformation.</p>
<p>A major, and quite valid critique of differential expression testing such as exercised here is that the null hypothesis – the effect size is exactly zero – is almost never true, and therefore our approach does not provide consistent estimates of what the differentially expressed gene are. In practice, this may be overcome by considering effect size as well as statistical significance. Moreover, we saw how to use “banded” null hypotheses.</p>
</section>
<section id="further-reading" class="level2" data-number="8.12">
<h2 data-number="8.12" class="anchored" data-anchor-id="further-reading"><span class="header-section-number">8.12</span> Further reading</h2>
<ul>
<li><p>The <strong><a href="https://bioconductor.org/packages/DESeq2/">DESeq2</a></strong> method is explained in the paper by <span class="citation" data-cites="LoveDESeq2">Michael I. Love, Huber, and Anders (<a href="16-chap.html#ref-LoveDESeq2" role="doc-biblioref">2014</a>)</span>, and practical aspects of the software in the package vignette. See also the <strong><a href="https://bioconductor.org/packages/edgeR/">edgeR</a></strong> package and paper <span class="citation" data-cites="edgeR:Robinson:2009">(<a href="16-chap.html#ref-edgeR:Robinson:2009" role="doc-biblioref">Robinson, McCarthy, and Smyth 2009</a>)</span> for a related approach.</p></li>
<li><p>A classic textbook on robust regression and outlier detection is the book by <span class="citation" data-cites="Rousseeuw:RobustBook:1987">Peter J. Rousseeuw and Leroy (<a href="16-chap.html#ref-Rousseeuw:RobustBook:1987" role="doc-biblioref">1987</a>)</span>. For more recent developments the <a href="https://cran.r-project.org/web/views/Robust.html">CRAN task view on Robust Statistical Methods</a> is a good starting point.</p></li>
<li><p>The Bioconductor RNA-Seq workflow at <a href="https://www.bioconductor.org/help/workflows/rnaseqGene" class="uri">https://www.bioconductor.org/help/workflows/rnaseqGene</a> <span class="citation" data-cites="BiocRNASeqWorkflow">(<a href="16-chap.html#ref-BiocRNASeqWorkflow" role="doc-biblioref">Michael I. Love et al. 2015</a>)</span> covers a number of issues related specifically to RNA-Seq that we have sidestepped here.</p></li>
<li><p>An extension of the generalized linear model that we saw to detecting alternative exon usage from RNA-Seq data is presented in the <strong><a href="https://bioconductor.org/packages/DEXSeq/">DEXSeq</a></strong> paper <span class="citation" data-cites="Reyes:GnomeResearch:2012">(<a href="16-chap.html#ref-Reyes:GnomeResearch:2012" role="doc-biblioref">Anders, Reyes, and Huber 2012</a>)</span>, and applications of these ideas to biological discovery were described by <span class="citation" data-cites="Reyes:PNAS:2013">Reyes et al. (<a href="16-chap.html#ref-Reyes:PNAS:2013" role="doc-biblioref">2013</a>)</span> and <span class="citation" data-cites="Reyes:NAR:2017">Reyes and Huber (<a href="16-chap.html#ref-Reyes:NAR:2017" role="doc-biblioref">2017</a>)</span>.</p></li>
<li><p>For some sequencing-based assays, such as RIP-Seq, CLIP-Seq, the biological analysis goal boils down to testing whether the ratio of <em>input</em> and <em>immunoprecipitate</em> (IP) has changed between conditions. Mike Love’s post on the Bioconductor forum provides a clear and quick how-to: <a href="https://support.bioconductor.org/p/61509" class="uri">https://support.bioconductor.org/p/61509</a>.</p></li>
</ul>
</section>
<section id="exercises" class="level2 page-columns page-full" data-number="8.13">
<h2 data-number="8.13" class="anchored" data-anchor-id="exercises"><span class="header-section-number">8.13</span> Exercises</h2>
<div id="imp-countdata-batch" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;8.1
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Depletion of small p-values.</strong> Consider the following simple generative model for a histogram of p-values that shows a depletion of small p-values. In <a href="#fig-countdata-exbatch" class="quarto-xref">Figure&nbsp;<span>8.14</span></a>, p-values are shown from a differential expression analysis (in this case, simple <span class="math inline">\(t\)</span>-tests) in the absence of an association with the tested two-level categorical variable <code>groups</code>. While the histogram is approximately uniform for <code>x1</code>, small p-values are depleted for <code>x2</code>. This is because the batch (encoded by the eponymous variable), which is orthogonal to <code>groups</code> and balanced, introduces additional variability that inflates the denominator of the test statistic.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"magrittr"</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>ng <span class="ot">=</span> <span class="dv">10000</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>ns <span class="ot">=</span> <span class="dv">12</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">=</span> x2 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(ns <span class="sc">*</span> ng), <span class="at">ncol =</span> ns, <span class="at">nrow=</span> ng)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>group <span class="ot">=</span> <span class="fu">factor</span>(letters[<span class="dv">1</span> <span class="sc">+</span> <span class="fu">seq_len</span>(ns) <span class="sc">%%</span> <span class="dv">2</span>])  <span class="sc">%T&gt;%</span> print</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] b a b a b a b a b a b a
Levels: a b</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>batch <span class="ot">=</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(<span class="fu">seq_len</span>(ns) <span class="sc">&lt;=</span> ns<span class="sc">/</span><span class="dv">2</span>, <span class="st">"B1"</span>, <span class="st">"B2"</span>)) <span class="sc">%T&gt;%</span> print</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] B1 B1 B1 B1 B1 B1 B2 B2 B2 B2 B2 B2
Levels: B1 B2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(group, batch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     batch
group B1 B2
    a  3  3
    b  3  3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>x2[, batch<span class="sc">==</span><span class="st">"B2"</span>] <span class="ot">=</span> x2[, batch<span class="sc">==</span><span class="st">"B2"</span>] <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">rnorm</span>(ng)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>pvals <span class="ot">=</span> <span class="fu">rbind</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">type =</span> <span class="st">"x1"</span>, genefilter<span class="sc">::</span><span class="fu">rowttests</span>(x1, <span class="at">fac =</span> group)),</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">type =</span> <span class="st">"x2"</span>, genefilter<span class="sc">::</span><span class="fu">rowttests</span>(x2, <span class="at">fac =</span> group)))</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pvals, <span class="fu">aes</span>(<span class="at">x =</span> p.value)) <span class="sc">+</span> </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.02</span>, <span class="at">boundary =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(type <span class="sc">~</span> .)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<p>Replace the <span class="math inline">\(t\)</span>-test by a linear model, first, one with only <code>group</code> as a factor, second, one with <code>group + batch</code> (in R’s formula language). Show that the histogram of p-values for the coefficient of <code>group</code> is uniform in both cases, <code>x1</code> and <code>x2</code>.</p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div class="cell-output-display callout-margin-content">
<div id="fig-countdata-exbatch" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-countdata-exbatch-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="08-chap_files/figure-html/fig-countdata-exbatch-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-27" title="Figure&nbsp;8.14: p-values for the tests performed on x1 and x2 (see code)."><img src="08-chap_files/figure-html/fig-countdata-exbatch-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="240"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-countdata-exbatch-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.14: p-values for the tests performed on <code>x1</code> and <code>x2</code> (see code).
</figcaption>
</figure>
</div>
</div></div><div id="imp-countdata-edgeR" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;8.2
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>edgeR.</strong> Do the analyses of <a href="#sec-countdata-debasic" class="quarto-xref"><span>Section 8.5</span></a> with the <strong><a href="https://bioconductor.org/packages/edgeR/">edgeR</a></strong> package and compare the results: make a scatterplot of the <span class="math inline">\(\log_{10}\)</span> p-values, pick some genes where there are large differences, and visualize the raw data to see what is going on. Based on this can you explain the differences?</p>
</div>
</div>
<div id="imp-countdata-robustness" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;8.3
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Robustness.</strong> Write a <strong><a href="https://cran.r-project.org/web/packages/shiny/">shiny</a></strong> app that performs linear regression on an example <span class="math inline">\((x, y)\)</span> dataset (for instance, from the <code>mtcars</code> data) and displays the data as well as the fitted line. Add a widget that lets you move one of the points in <span class="math inline">\(x\)</span>- and/or <span class="math inline">\(y\)</span>- direction in a wide range (extending a few times outside the original data range). Add a radio buttons widget that lets you choose between <code>lm</code>, <code>rlm</code> and <code>lqs</code> with its different choices of <code>method</code> (the latter two are in the <strong><a href="https://cran.r-project.org/web/packages/MASS/">MASS</a></strong> package). Bonus: add functions from the <strong><a href="https://cran.r-project.org/web/packages/robustbase/">robustbase</a></strong> package.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-34-contents" aria-controls="callout-34" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-34" class="callout-34-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Code for the file <code>ui.R</code> in the app:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"shiny"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">shinyUI</span>(<span class="fu">fluidPage</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">titlePanel</span>(<span class="st">"Breakdown"</span>),</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sidebarLayout</span>(</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sidebarPanel</span>(     <span class="co"># select oulier shift</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sliderInput</span>(<span class="st">"shift"</span>, <span class="st">"Outlier:"</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">100</span>, <span class="at">value =</span> <span class="dv">0</span>),</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">radioButtons</span>(<span class="st">"method"</span>, <span class="st">"Method:"</span>,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="st">"Non-robust least squares"</span> <span class="ot">=</span> <span class="st">"lm"</span>,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"M-estimation"</span> <span class="ot">=</span> <span class="st">"rlm"</span>))</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mainPanel</span>(       <span class="co"># show fit</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plotOutput</span>(<span class="st">"regPlot"</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Code for the file <code>server.R</code> in the app:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"shiny"</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"MASS"</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">shinyServer</span>(<span class="cf">function</span>(input, output) {</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>regPlot <span class="ot">=</span> <span class="fu">renderPlot</span>({</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    whpt <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    mtcars_new <span class="ot">=</span> mtcars</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    mtcars_new<span class="sc">$</span>mpg[whpt] <span class="ot">=</span> mtcars_new<span class="sc">$</span>mpg[whpt] <span class="sc">+</span> input<span class="sc">$</span>shift</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    reg <span class="ot">=</span> <span class="cf">switch</span>(input<span class="sc">$</span>method,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">lm =</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> disp, <span class="at">data =</span> mtcars_new),</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">rlm =</span> <span class="fu">rlm</span>(mpg <span class="sc">~</span> disp, <span class="at">data =</span> mtcars_new),</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Unimplemented method:"</span>, input<span class="sc">$</span>method)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(mtcars_new, <span class="fu">aes</span>(<span class="at">x =</span> disp, <span class="at">y =</span> mpg)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_abline</span>(<span class="at">intercept =</span> reg<span class="sc">$</span>coefficients[<span class="st">"(Intercept)"</span>],</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">slope =</span> reg<span class="sc">$</span>coefficients[<span class="st">"disp"</span>], <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Of course you can add many more features.</p>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Anders:2010:GB" class="csl-entry" role="listitem">
Anders, Simon, and Wolfgang Huber. 2010. <span>“<span>D</span>ifferential Expression Analysis for Sequence Count Data.”</span> <em>Genome Biology</em> 11: R106. <a href="http://genomebiology.com/2010/11/10/R106">http://genomebiology.com/2010/11/10/R106</a>.
</div>
<div id="ref-Reyes:GnomeResearch:2012" class="csl-entry" role="listitem">
Anders, Simon, Alejandro Reyes, and Wolfgang Huber. 2012. <span>“<span class="nocase"><span>D</span>etecting differential usage of exons from <span>RNA</span>-Seq data</span>.”</span> <em>Genome Research</em> 22 (10): 2008–17.
</div>
<div id="ref-Brooks2010" class="csl-entry" role="listitem">
Brooks, Angela N, Li Yang, Michael O Duff, Kasper D Hansen, Jung W Park, Sandrine Dudoit, Steven E Brenner, and Brenton R Graveley. 2011. <span>“Conservation of an <span>RNA</span> Regulatory Map Between <span>D</span>rosophila and Mammals.”</span> <em>Genome Research</em>, 193–202. <a href="https://doi.org/10.1101/gr.108662.110">https://doi.org/10.1101/gr.108662.110</a>.
</div>
<div id="ref-Cook1977Detection" class="csl-entry" role="listitem">
Cook, R. Dennis. 1977. <span>“Detection of Influential Observation in Linear Regression.”</span> <em>Technometrics</em>.
</div>
<div id="ref-Huber:AMS:1964" class="csl-entry" role="listitem">
Huber, Peter J. 1964. <span>“Robust Estimation of a Location Parameter.”</span> <em>The Annals of Mathematical Statistics</em> 35: 73–101.
</div>
<div id="ref-LeekStorey:2007" class="csl-entry" role="listitem">
Leek, Jeffrey T., and John D. Storey. 2007. <span>“<span class="nocase"><span>C</span>apturing heterogeneity in gene expression studies by surrogate variable analysis</span>.”</span> <em>PLoS Genetics</em> 3 (9): 1724–35.
</div>
<div id="ref-BiocRNASeqWorkflow" class="csl-entry" role="listitem">
Love, Michael I., Simon Anders, Vladislav Kim, and Wolfgang Huber. 2015. <span>“<span>RNA</span>-Seq Workflow: Gene-Level Exploratory Analysis and Differential Expression.”</span> <em>F1000Research</em> 4 (1070). <a href="https://doi.org/10.12688/f1000research.7035.1">https://doi.org/10.12688/f1000research.7035.1</a>.
</div>
<div id="ref-LoveDESeq2" class="csl-entry" role="listitem">
Love, Michael I, Wolfgang Huber, and Simon Anders. 2014. <span>“Moderated Estimation of Fold Change and Dispersion for <span class="nocase">RNA-seq</span> Data with <span>DESeq2</span>.”</span> <em>Gnome Biology</em> 15 (12): 1–21.
</div>
<div id="ref-OzsolakMilos" class="csl-entry" role="listitem">
Ozsolak, Fatih, and Patrice M Milos. 2011. <span>“<span class="nocase"><span>R</span><span>N</span><span>A</span> sequencing: advances, challenges and opportunities</span>.”</span> <em>Nature Reviews Genetics</em> 12: 87–98.
</div>
<div id="ref-Reyes:PNAS:2013" class="csl-entry" role="listitem">
Reyes, Alejandro, Simon Anders, Robert J. Weatheritt, Toby J. Gibson, Lars M. Steinmetz, and Wolfgang Huber. 2013. <span>“Drift and Conservation of Differential Exon Usage Across Tissues in Primate Species.”</span> <em>Proceedings of the National Academy of Sciences</em> 110 (38): 15377–82. <a href="https://doi.org/10.1073/pnas.1307202110">https://doi.org/10.1073/pnas.1307202110</a>.
</div>
<div id="ref-Reyes:NAR:2017" class="csl-entry" role="listitem">
Reyes, Alejandro, and Wolfgang Huber. 2017. <span>“Alternative Start and Termination Sites of Transcription Drive Most Transcript Isoform Differences Across Human Tissues.”</span> <em>Nucleic Acids Research</em> 46 (2): 582–92. <a href="https://doi.org/10.1093/nar/gkx1165">https://doi.org/10.1093/nar/gkx1165</a>.
</div>
<div id="ref-edgeR:Robinson:2009" class="csl-entry" role="listitem">
Robinson, M. D., D. J. McCarthy, and G. K. Smyth. 2009. <span>“<span class="nocase">edgeR</span>: A <span>Bioconductor</span> Package for Differential Expression Analysis of Digital Gene Expression Data.”</span> <em>Bioinformatics</em> 26 (1): 139–40. <a href="https://doi.org/10.1093/bioinformatics/btp616">https://doi.org/10.1093/bioinformatics/btp616</a>.
</div>
<div id="ref-Rousseeuw:1987" class="csl-entry" role="listitem">
Rousseeuw, Peter J. 1987. <span>“Silhouettes: A Graphical Aid to the Interpretation and Validation of Cluster Analysis.”</span> <em>Journal of Computational and Applied Mathematics</em> 20: 53–65.
</div>
<div id="ref-Rousseeuw:RobustBook:1987" class="csl-entry" role="listitem">
Rousseeuw, Peter J., and Annick M. Leroy. 1987. <em>Robust Regression and Outlier Detection</em>. Wiley. <a href="https://doi.org/10.1002/0471725382">https://doi.org/10.1002/0471725382</a>.
</div>
<div id="ref-Stegle:2010" class="csl-entry" role="listitem">
Stegle, O., L. Parts, R. Durbin, and J. Winn. 2010. <span>“<span class="nocase"><span>A</span> <span>B</span>ayesian framework to account for complex non-genetic factors in gene expression levels greatly increases power in e<span>Q</span><span>T</span><span>L</span> studies</span>.”</span> <em>PLoS Computational Biology</em> 6 (5): e1000770.
</div>
<div id="ref-SteijgerBertone:2013" class="csl-entry" role="listitem">
Steijger, T., J. F. Abril, P. G. Engstrom, F. Kokocinski, T. J. Hubbard, R. Guigo, J. Harrow, et al. 2013. <span>“<span class="nocase"><span>A</span>ssessment of transcript reconstruction methods for <span class="nocase">RNA-seq</span></span>.”</span> <em>Nature Methods</em> 10 (12): 1177–84.
</div>
<div id="ref-Verhulst:1845" class="csl-entry" role="listitem">
Verhulst, Pierre-François. 1845. <span>“Recherches <span class="nocase">mathématiques</span> Sur La Loi d’accroissement de La Population.”</span> <em>Nouveaux <span>Mémoires</span> de l’<span>Académie</span> <span>Royale</span> Des <span>Sciences</span> Et <span>Belles</span>-<span>Lettres</span> de <span>Bruxelles</span></em> 18: 1–42.
</div>
</div>
</section>


<p>Page built at 01:33 on 2025-09-01 using R version 4.5.1 (2025-06-13)</p></main> <!-- /main --></p><p class="build-date">
Support for maintaining the online version of this book is provided by <a href="http://www.denbi.de">de.NBI</a>
  <img src="imgs/denbi.png" style="vertical-align: text-top;height: 16px"><br>
For website support please contact msmith@embl.de
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
  const anchorJS_eq = new window.AnchorJS();
  anchorJS_eq.options = {
    placement: 'left',
    class: 'eq-link',
    icon: icon
  };
  anchorJS_eq.add('.anchored-eq');
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/www\.huber\.embl\.de\/msmb");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>
