<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>5&nbsp; Clustering – Modern Statistics for Modern Biology</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./imgs/msmb-favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-af5ec82acda093b5ee751184164e9432.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-d63985d606c7f07261ad561a6cfde940.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="msmb.css">
<meta property="og:title" content="5&nbsp; Clustering – Modern Statistics for Modern Biology">
<meta property="og:description" content="If you are a biologist and want to get the best out of the powerful methods of modern computational statistics, this is your book.">
<meta property="og:image" content="https://www.huber.embl.de/msmb/imgs/MSFMB-Cover2-cropped.jpg">
<meta property="og:site_name" content="Modern Statistics for Modern Biology">
<meta name="twitter:title" content="5&nbsp; Clustering – Modern Statistics for Modern Biology">
<meta name="twitter:description" content="If you are a biologist and want to get the best out of the powerful methods of modern computational statistics, this is your book.">
<meta name="twitter:image" content="https://www.huber.embl.de/msmb/imgs/MSFMB-Cover2-cropped.jpg">
<meta name="twitter:card" content="summary">
<script type="text/javascript">
  var _paq = _paq || [];
  
  // Call disableCookies before calling trackPageView 
  _paq.push(['disableCookies']);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u='//tr-denbi.embl.de/heimdall/';
    _paq.push(['setTrackerUrl', u+'p.php']);
    _paq.push(['setSiteId', '26']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'p.js'; s.parentNode.insertBefore(g,s);
  })();
</script>

</head>

<body class="floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Modern Statistics for Modern Biology</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-chapters" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Chapters</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-chapters">    
        <li>
    <a class="dropdown-item" href="./index.html">
 <span class="dropdown-text">Home</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./00-chap.html">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./01-chap.html">
 <span class="dropdown-text">Generative Models for Discrete Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02-chap.html">
 <span class="dropdown-text">Statistical Modeling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03-chap.html">
 <span class="dropdown-text">Data visualization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04-chap.html">
 <span class="dropdown-text">Mixture Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05-chap.html">
 <span class="dropdown-text">Clustering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06-chap.html">
 <span class="dropdown-text">Testing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07-chap.html">
 <span class="dropdown-text">Multivariate Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./08-chap.html">
 <span class="dropdown-text">High-Throughput Count Data &amp; Generalized Linear Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09-chap.html">
 <span class="dropdown-text">Multivariate methods for heterogeneous data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10-chap.html">
 <span class="dropdown-text">Networks and Trees</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./11-chap.html">
 <span class="dropdown-text">Image data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./12-chap.html">
 <span class="dropdown-text">Supervised Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./13-chap.html">
 <span class="dropdown-text">Design of High Throughput Experiments and their Analyses</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./14-chap.html">
 <span class="dropdown-text">Statistical Concordance</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./15-chap.html">
 <span class="dropdown-text">Acknowledgements</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./16-chap.html">
 <span class="dropdown-text">References</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sections</h2>
   
  <ul class="collapse">
  <li><a href="#goals-for-this-chapter" id="toc-goals-for-this-chapter" class="nav-link active" data-scroll-target="#goals-for-this-chapter"><span class="header-section-number">5.1</span> Goals for this chapter</a></li>
  <li><a href="#what-are-the-data-and-why-do-we-cluster-them" id="toc-what-are-the-data-and-why-do-we-cluster-them" class="nav-link" data-scroll-target="#what-are-the-data-and-why-do-we-cluster-them"><span class="header-section-number">5.2</span> What are the data and why do we cluster them?</a></li>
  <li><a href="#how-do-we-measure-similarity" id="toc-how-do-we-measure-similarity" class="nav-link" data-scroll-target="#how-do-we-measure-similarity"><span class="header-section-number">5.3</span> How do we measure similarity?</a></li>
  <li><a href="#nonparametric-mixture-detection" id="toc-nonparametric-mixture-detection" class="nav-link" data-scroll-target="#nonparametric-mixture-detection"><span class="header-section-number">5.4</span> Nonparametric mixture detection</a></li>
  <li><a href="#clustering-examples-flow-cytometry-and-mass-cytometry" id="toc-clustering-examples-flow-cytometry-and-mass-cytometry" class="nav-link" data-scroll-target="#clustering-examples-flow-cytometry-and-mass-cytometry"><span class="header-section-number">5.5</span> Clustering examples: flow cytometry and mass cytometry</a></li>
  <li><a href="#hierarchical-clustering" id="toc-hierarchical-clustering" class="nav-link" data-scroll-target="#hierarchical-clustering"><span class="header-section-number">5.6</span> Hierarchical clustering</a></li>
  <li><a href="#sec-clustervalidation" id="toc-sec-clustervalidation" class="nav-link" data-scroll-target="#sec-clustervalidation"><span class="header-section-number">5.7</span> Validating and choosing the number of clusters</a></li>
  <li><a href="#clustering-as-a-means-for-denoising" id="toc-clustering-as-a-means-for-denoising" class="nav-link" data-scroll-target="#clustering-as-a-means-for-denoising"><span class="header-section-number">5.8</span> Clustering as a means for denoising</a></li>
  <li><a href="#summary-of-this-chapter" id="toc-summary-of-this-chapter" class="nav-link" data-scroll-target="#summary-of-this-chapter"><span class="header-section-number">5.9</span> Summary of this chapter</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">5.10</span> Further reading</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">5.11</span> Exercises</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-clustering" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Clustering</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/starlings_copyrightfree.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="imgs/starlings_copyrightfree.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div></div></div>
<p>Finding categories of cells, illnesses, organisms and then naming them is a core activity in the natural sciences. In <a href="04-chap.html" class="quarto-xref"><span>Chapter 4</span></a> we’ve seen that some data can be modeled as mixtures from different groups or populations with a clear parametric generative model. We saw how in those examples we could use the EM algorithm to disentangle the components. We are going to extend the idea of unraveling of different groups to cases where the <strong>clusters</strong> do not necessarily have nice elliptic<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> shapes.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Mixture modeling with multivariate normal distributions implies elliptic cluster boundaries.</p></div></div><p>Clustering takes data (continuous or quasi-continuous) and adds to them a new categorical <em>group</em> variable that can often simplify decision making; even if this sometimes comes at a cost of ignoring <em>intermediate</em> states. For instance, medical decisions are simplified by replacing possibly complex, high-dimensional diagnostic measurements by simple groupings: a full report of numbers associated with fasting glucose, glycated hemoglobin and plasma glucose two hours after intake is replaced by assigning the patient to a diabetes mellitus “group”.</p>
<p>In this chapter, we will study how to find meaningful clusters or groups in both low-dimensional and high-dimensional <strong>nonparametric</strong> settings. However, there is a caveat: clustering algorithms are designed to find clusters, so they will find clusters, even where there are none<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. So, cluster <em>validation</em> is an essential component of our process, especially if there is no prior domain knowledge that supports the existence of clusters.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;This is reminescent of humans: we like to see patterns—even in randomness.</p></div></div><section id="goals-for-this-chapter" class="level2 page-columns page-full" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="goals-for-this-chapter"><span class="header-section-number">5.1</span> Goals for this chapter</h2>
<p>In this chapter we will</p>
<ul>
<li><p>Study the different types of data that can be beneficially clustered.</p></li>
<li><p>See measures of (dis)similarity and <strong>distances</strong> that help us define clusters.</p></li>
<li><p>Uncover hidden or latent clustering by partitioning the data into <em>tighter</em> sets.</p></li>
<li><p>Use clustering when given biomarkers on each of hundreds of thousands cells. We’ll see that for instance immune cells can be naturally grouped into tight subpopulations.</p></li>
<li><p>Run nonparametric algorithms such as <strong><span class="math inline">\(k\)</span>-means</strong>, <strong><span class="math inline">\(k\)</span>-medoids</strong> on real single cell data.</p></li>
<li><p>Experiment with recursive approaches to clustering that combine observations and groups into a hierarchy of sets; these methods are known as <strong>hierarchical clustering</strong>.</p></li>
<li><p>Study how to validate clusters through resampling-based bootstrap approaches, which we will demonstrate on a single-cell dataset.</p></li>
</ul>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-SnowMapSmallest-web" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-SnowMapSmallest-web-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/SnowMapSmallest_web.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;5.1: John Snow’s map of cholera cases: small barcharts at each house indicate a clustering of diagnosed cases."><img src="imgs/SnowMapSmallest_web.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SnowMapSmallest-web-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.1: John Snow’s map of cholera cases: small barcharts at each house indicate a clustering of diagnosed cases.
</figcaption>
</figure>
</div>
</div></div></div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/book_icon.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="David Freedman has a wonderful detailed account of all the steps that led to this discovery [@freedman1991]."><img src="imgs/book_icon.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="126" alt="David Freedman has a wonderful detailed account of all the steps that led to this discovery (Freedman 1991)."></a></p>
</figure>
</div>
<figcaption>David Freedman has a wonderful detailed account of all the steps that led to this discovery <span class="citation" data-cites="freedman1991">(<a href="16-chap.html#ref-freedman1991" role="doc-biblioref">Freedman 1991</a>)</span>.</figcaption>
</figure>
</div>
</div></div></div>
</section>
<section id="what-are-the-data-and-why-do-we-cluster-them" class="level2 page-columns page-full" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="what-are-the-data-and-why-do-we-cluster-them"><span class="header-section-number">5.2</span> What are the data and why do we cluster them?</h2>
<section id="clustering-can-sometimes-lead-to-discoveries." class="level3 page-columns page-full" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="clustering-can-sometimes-lead-to-discoveries."><span class="header-section-number">5.2.1</span> Clustering can sometimes lead to discoveries.</h3>
<p>John Snow made a map of cholera cases and identified <em>clusters</em> of cases. He then collected additional information about the situation of the pumps. The proximity of dense clusters of cases to the Broadstreet pump pointed to the water as a possible culprit. He collected separate sources of information that enabled him to infer the source of the cholera outbreak.</p>
<p>Now, let’s look at another map of London, shown in <a href="#fig-bombings" class="quarto-xref">Figure&nbsp;<span>5.2</span></a>. The red dots designate locations that were bombed during World War II. Many theories were put forward during the war by the analytical teams. They attempted to find a rational explanation for the bombing patterns (proximity to utility plants, arsenals, <span class="math inline">\(...\)</span>). In fact, after the war it was revealed that the bombings were randomly distributed without any attempt at hitting particular targets.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-bombings" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center" data-cap-location="margin">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-bombings-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/RedBombsLondon_web.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;5.2: Here is a map of the location of the bombs that were dropped on London on September, 7th, 1940 as depicted by the website of the British National Archives http://bombsight.org."><img src="imgs/RedBombsLondon_web.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-bombings-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.2: Here is a map of the location of the bombs that were dropped on London on September, 7th, 1940 as depicted by the website of the British National Archives <a href="http://bombsight.org">http://bombsight.org</a>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Clustering is a useful technique for understanding complex multivariate data; it is an <strong>unsupervised</strong><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. Exploratory techniques show groupings that can be important in interpreting the data.</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;Thus named because all variables have the same status, we are not trying to predict or learn the value of one variable (the supervisory response) based on the information from explanatory variables.</p></div></div><p>For instance, clustering has enabled researchers to enhance their understanding of cancer biology. Tumors that appeared to be the same based on their anatomical location and histopathology fell into multiple clusters based on their molecular signatures, such as gene expression data <span class="citation" data-cites="Hallett2012">(<a href="16-chap.html#ref-Hallett2012" role="doc-biblioref">Hallett et al. 2012</a>)</span>. Eventually, such clusterings might lead to the definition of new, more relevant disease types. Relevance is evidenced, e.g., by the fact that they are associated with different patient outcomes. What we aim to do in this chapter is understand how pictures like <a href="#fig-cancerHC" class="quarto-xref">Figure&nbsp;<span>5.3</span></a> are constructed and how to interpret them.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-cancerHC" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center" data-cap-location="margin">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-cancerHC-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/BreastCancerSubType_Biomed.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;5.3: The breast cancer samples (shown from The Cancer Genome Atlas (TCGA) and the Molecular Taxonomy of Breast Cancer International Consortium (METABRIC)) can be split into groups using their miRNA expression [@Aure2017]. The authors show in the lower plots that the survival times in different % groups were different. Thus these clusters were biologically and clinically relevant. The promise of such analyses is that the groups can be used to provide more specific, optimized treatments."><img src="imgs/BreastCancerSubType_Biomed.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-cancerHC-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.3: The breast cancer samples (shown from The Cancer Genome Atlas (TCGA) and the Molecular Taxonomy of Breast Cancer International Consortium (METABRIC)) can be split into groups using their miRNA expression <span class="citation" data-cites="Aure2017">(<a href="16-chap.html#ref-Aure2017" role="doc-biblioref">Aure et al. 2017</a>)</span>. The authors show in the lower plots that the survival times in different % groups were different. Thus these clusters were biologically and clinically relevant. The promise of such analyses is that the groups can be used to provide more specific, optimized treatments.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In <a href="04-chap.html" class="quarto-xref"><span>Chapter 4</span></a>, we have already studied one technique, the EM algorithm, for uncovering groups. The techniques we explore in this chapter are more general and can be applied to more complex data. Many of them are based on distances between pairs of observations (this can be all versus all, or sometimes only all versus some), and they make no explicit assumptions about the generative mechanism of the data involving particular families of distributions, such as normal, gamma-Poisson, etc. There is a proliferation of clustering algorithms in the literature and in the scientific software landscape; this can be intimidating. In fact it is linked to the diversity of the types of data and the objectives pursued in different domains.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Look up the <a href="http://www.bioconductor.org/packages/release/BiocViews.html">BiocViews Clustering</a> or the <a href="https://cran.r-project.org/web/views/Cluster.html">Cluster view on CRAN</a> and count the number of packages providing clustering tools.</p>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-ClusteringA" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center" data-cap-location="margin">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-ClusteringA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/ClusteringA.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;5.4: We decompose the choices made in a clustering algorithm according to the steps taken: starting from an observations-by-features rectangular table X, we choose an observations-to-observations distance measure and compute the distance matrix, here schematized by the triangle. The distances are used to construct the clusters. On the left, we schematize agglomerative methods, that build a hierarchical clustering tree; on the right, partitioning methods that separate the data into subsets. Both types of methods require a choice to be made: the number k of clusters. For partitionning approaches such as k-means this choice has to be made at the outset; for hierarchical clustering this can be deferred to the end of the analysis."><img src="imgs/ClusteringA.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-ClusteringA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.4: We decompose the choices made in a clustering algorithm according to the steps taken: starting from an observations-by-features rectangular table <span class="math inline">\(X\)</span>, we choose an observations-to-observations distance measure and compute the distance matrix, here schematized by the triangle. The distances are used to construct the clusters. On the left, we schematize agglomerative methods, that build a hierarchical clustering tree; on the right, partitioning methods that separate the data into subsets. Both types of methods require a choice to be made: the number <span class="math inline">\(k\)</span> of clusters. For partitionning approaches such as <span class="math inline">\(k\)</span>-means this choice has to be made at the outset; for hierarchical clustering this can be deferred to the end of the analysis.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="how-do-we-measure-similarity" class="level2 page-columns page-full" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="how-do-we-measure-similarity"><span class="header-section-number">5.3</span> How do we measure similarity?</h2>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Of a feather: how the distances are measured and similarities between observations defined has a strong impact on the clustering result."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="Of a feather: how the distances are measured and similarities between observations defined has a strong impact on the clustering result."></a></p>
</figure>
</div>
<figcaption><strong>Of a feather</strong>: how the distances are measured and similarities between observations defined has a strong impact on the clustering result.</figcaption>
</figure>
</div>
</div></div></div>
<p>Our first step is to decide what we mean by <em>similar</em>. There are multiple ways of comparing birds: for instance, a distance using size and weight will give a different clustering than one using diet or habitat. Once we have chosen the relevant features, we have to decide how we combine differences between the multiple features into a single number. Here is a selection of choices, some of them are illustrated in <a href="#fig-fourdistances" class="quarto-xref">Figure&nbsp;<span>5.5</span></a>.</p>
<div class="cell page-columns page-full" data-layout-nrow="2" data-layout-align="center">
<div id="fig-fourdistances" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-fourdistances-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="quarto-layout-row page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-fourdistances" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fourdistances-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-fourdistances-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/FourDistances_a.png" class="lightbox" data-gallery="fig-fourdistances" title="Figure&nbsp;5.5&nbsp;(a): "><img src="imgs/FourDistances_a.png" id="fig-fourdistances-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-fourdistances"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-fourdistances-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-fourdistances" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fourdistances-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-fourdistances-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/FourDistances_b.png" class="lightbox" data-gallery="fig-fourdistances" title="Figure&nbsp;5.5&nbsp;(b): "><img src="imgs/FourDistances_b.png" id="fig-fourdistances-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-fourdistances"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-fourdistances-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div></div>
</div>
<div class="quarto-layout-row page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-fourdistances" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fourdistances-3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-fourdistances-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/FourDistances_c.png" class="lightbox" data-gallery="fig-fourdistances" title="Figure&nbsp;5.5&nbsp;(c): "><img src="imgs/FourDistances_c.png" id="fig-fourdistances-3" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-fourdistances"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-fourdistances-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div><div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-fourdistances" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fourdistances-4" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-fourdistances-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/FourDistances_d.png" class="lightbox" data-gallery="fig-fourdistances" title="Figure&nbsp;5.5&nbsp;(d): "><img src="imgs/FourDistances_d.png" id="fig-fourdistances-4" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-fourdistances"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-fourdistances-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div></div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fourdistances-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.5: Equal-distance contour plots according to four different distances: points on any one curve are all the same distance from the center point.
</figcaption>
</figure>
</div>
</div>
<p><strong>Euclidean</strong> The Euclidean distance between two points <span class="math inline">\(A=(a_1,...,a_p)\)</span> and <span class="math inline">\(B= (b_1,...,b_p)\)</span> in a <span class="math inline">\(p\)</span>-dimensional space (for the <span class="math inline">\(p\)</span> features) is the square root of the sum of squares of the differences in all <span class="math inline">\(p\)</span> coordinate directions:</p>
<p><span class="math display">\[
d(A,B)=\sqrt{(a_1-b_1)^2+(a_2-b_2)^2+... +(a_p-b_p)^2}.
\]</span></p>
<p><strong>Manhattan</strong> The Manhattan, City Block, Taxicab or <span class="math inline">\(L_1\)</span> distance takes the sum of the absolute differences in all coordinates.</p>
<p><span class="math display">\[
d(A,B)=|a_1-b_1|+|a_2-b_2|+... +|a_p-b_p|.
\]</span></p>
<p><strong>Maximum</strong> The maximum of the absolute differences between coordinates is also called the <span class="math inline">\(L_\infty\)</span> distance:</p>
<p><span class="math display">\[
d_\infty(A,B)= \max_{i}|a_i-b_i|.
\]</span></p>
<p><strong>Weighted Euclidean distance</strong> is a generalization of the ordinary Euclidean distance, by giving different directions in feature space different weights. We have already encountered one example of a weighted Euclidean distance in <a href="02-chap.html" class="quarto-xref"><span>Chapter 2</span></a>, the <span class="math inline">\(\chi^2\)</span> distance. It is used to compare rows in contingency tables, and the weight of each feature is the inverse of the expected value. The <em>Mahalanobis</em> distance is another weighted Euclidean distance that takes into account the fact that different features may have a different dynamic range, and that some features may be positively or negatively correlated with each other. The weights in this case are derived from the covariance matrix of the features. See also <a href="#wrn-clustering-Maha" class="quarto-xref">Question&nbsp;<span>5.1</span></a>.</p>
<p><strong>Minkowski</strong> Allowing the exponent to be <span class="math inline">\(m\)</span> instead of <span class="math inline">\(2\)</span>, as in the Euclidean distance, gives the Minkowski distance</p>
<p><span class="anchored-eq" data-anchor-id="eq-cluster" id="eq-cluster-minkowski"><span class="math display">\[
d(A,B) = \left( (a_1-b_1)^m+(a_2-b_2)^m+... +(a_p-b_p)^m \right)^\frac{1}{m}.
\tag{5.1}\]</span></span></p>
<p><strong>Edit, Hamming</strong> This distance is the simplest way to compare character sequences. It simply counts the number of differences between two character strings. This could be applied to nucleotide or amino acid sequences – although in that case, the different character substitutions are usually associated with different contributions to the distance (to account for physical or evolutionary similarity), and deletions and insertions may also be allowed.</p>
<p><strong>Binary</strong> When the two vectors have binary bits as coordinates, we can think of the non-zero elements as ‘on’ and the zero elements as ‘off’. The binary distance is the proportion of features having only one bit on amongst those features that have at least one bit on.</p>
<p><strong>Jaccard Distance</strong> Occurrence of traits or features in ecological or mutation data can be translated into presence and absence and encoded as 1’s and 0’s. In such situations, co-occurence is often more informative than co-absence. For instance, when comparing mutation patterns in HIV, the co-existence in two different strains of a mutation tends to be a more important observation than its co-absence. For this reason, biologists use the <strong>Jaccard index</strong>. Let’s call our two observation vectors <span class="math inline">\(S\)</span> and <span class="math inline">\(T\)</span>, <span class="math inline">\(f_{11}\)</span> the number of times a feature co-occurs in <span class="math inline">\(S\)</span> and <span class="math inline">\(T\)</span>, <span class="math inline">\(f_{10}\)</span> (and <span class="math inline">\(f_{01}\)</span>) the number of times a feature occurs in <span class="math inline">\(S\)</span> but not in <span class="math inline">\(T\)</span> (and vice versa), and <span class="math inline">\(f_{00}\)</span> the number of times a feature is co-absent. The Jaccard index is</p>
<p><span class="anchored-eq" data-anchor-id="eq-cluster" id="eq-cluster-jaccardindex"><span class="math display">\[
J(S,T) = \frac{f_{11}}{f_{01}+f_{10}+f_{11}},
\tag{5.2}\]</span></span></p>
<p>(i.e., it ignores <span class="math inline">\(f_{00}\)</span>), and the <strong>Jaccard dissimilarity</strong> is</p>
<p><span class="anchored-eq" data-anchor-id="eq-cluster" id="eq-cluster-jaccarddissimilarity"><span class="math display">\[
d_J(S,T) = 1-J(S,T) = \frac{f_{01}+f_{10}}{f_{01}+f_{10}+f_{11}}.
\tag{5.3}\]</span></span></p>
<p><strong>Correlation based distance</strong></p>
<p><span class="math display">\[
d(A,B)=\sqrt{2(1-\text{cor}(A,B))}.
\]</span></p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-Mahalanobis" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Mahalanobis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-Mahalanobis-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure&nbsp;5.6: An example for the use of Mahalanobis distances to measure the distance of a new data point (red) from two cluster centers."><img src="05-chap_files/figure-html/fig-Mahalanobis-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="376"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Mahalanobis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.6: An example for the use of Mahalanobis distances to measure the distance of a new data point (red) from two cluster centers.
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-clustering-Maha" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.1
</div>
</div>
<div class="callout-body-container callout-body">
<p>Which of the two cluster centers in <a href="#fig-Mahalanobis" class="quarto-xref">Figure&nbsp;<span>5.6</span></a> is the red point closest to?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>A naïve answer would use the Euclidean metric and decide that the point is closer to the left cluster. However, as we see that the features have different ranges and correlations, and that these even differ between the two clusters, it makes sense to use cluster-specific Mahalanobis distances. The figure shows contour lines for both clusters. These were obtained from a density estimate; the Mahalanobis distance approximates these contours with ellipses. The distance between the red point and each of the cluster centers corresponds to the number of contour lines crossed. We see that as the group on the right is more spread out, the red point is in fact closer to it.</p>
</div>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-DistanceTriangle" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-DistanceTriangle-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/DistanceTriangle.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13" title="Figure&nbsp;5.7: The lower triangle of distances can be computed by any of a hundred different functions in various R packages (vegdist in vegan, daisy in cluster, genetic_distance in gstudio, dist.dna in ape, Dist in amap, distance in ecodist, dist.multiPhylo in distory, shortestPath in gdistance, % dudi.dist and dist.genet in ade4)."><img src="imgs/DistanceTriangle.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-DistanceTriangle-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.7: The lower triangle of distances can be computed by any of a hundred different functions in various R packages (<code>vegdist</code> in <strong><a href="https://cran.r-project.org/web/packages/vegan/">vegan</a></strong>, <code>daisy</code> in <strong><a href="https://cran.r-project.org/web/packages/cluster/">cluster</a></strong>, <code>genetic_distance</code> in <strong><a href="https://cran.r-project.org/web/packages/gstudio/">gstudio</a></strong>, <code>dist.dna</code> in <strong><a href="https://cran.r-project.org/web/packages/ape/">ape</a></strong>, <code>Dist</code> in <strong><a href="https://cran.r-project.org/web/packages/amap/">amap</a></strong>, <code>distance</code> in <strong><a href="https://cran.r-project.org/web/packages/ecodist/">ecodist</a></strong>, <code>dist.multiPhylo</code> in <strong><a href="https://cran.r-project.org/web/packages/distory/">distory</a></strong>, <code>shortestPath</code> in <strong><a href="https://cran.r-project.org/web/packages/gdistance/">gdistance</a></strong>, % <code>dudi.dist</code> and <code>dist.genet</code> in <strong><a href="https://cran.r-project.org/web/packages/ade4/">ade4</a></strong>).
</figcaption>
</figure>
</div>
</div></div></div>
<section id="computations-related-to-distances-in-r" class="level3 page-columns page-full" data-number="5.3.1">
<h3 data-number="5.3.1" class="anchored" data-anchor-id="computations-related-to-distances-in-r"><span class="header-section-number">5.3.1</span> Computations related to distances in R</h3>
<p>The <code>dist</code> function in R is designed to use less space than the full <span class="math inline">\(n^2\)</span> positions a complete <span class="math inline">\(n \times n\)</span> distance matrix between <span class="math inline">\(n\)</span> objects would require. The function computes one of six choices of distance (<code>euclidean</code>, <code>maximum</code>, <code>manhattan</code>, <code>canberra</code>, <code>binary</code>, <code>minkowski</code>) and outputs a vector of values sufficient to reconstruct the complete distance matrix. The function returns a special object of class <code>dist</code> that encodes the relevant vector of size <span class="math inline">\(n\times(n-1)/2\)</span>. Here is the output for a <span class="math inline">\(3\)</span> by <span class="math inline">\(3\)</span> matrix:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>mx  <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>my  <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>mz  <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">=</span> <span class="fu">rbind</span>(mx, my, mz)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dist</span>(mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         mx       my
my 1.732051         
mz 2.000000 1.732051</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dist</span>(mat, <span class="at">method =</span> <span class="st">"binary"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mx        my
my 0.6000000          
mz 0.6666667 0.5000000</code></pre>
</div>
</div>
<p>In order to access a particular distance (for example the distance between observations 1 and 2), one has to turn the <code>dist</code> class object back into a matrix.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/Morder.RData"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="fu">sum</span>((Morder[<span class="dv">1</span>, ] <span class="sc">-</span> Morder[<span class="dv">2</span>, ])<span class="sc">^</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.593667</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.matrix</span>(<span class="fu">dist</span>(Morder))[<span class="dv">2</span>, <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.593667</code></pre>
</div>
</div>
<p>Let’s look at how we would compute the Jaccard distance we defined above between HIV strains.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>mut <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"../data/HIVmutations.csv"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>mut[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">10</span><span class="sc">:</span><span class="dv">16</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  p32I p33F p34Q p35G p43T p46I p46L
1    0    1    0    0    0    0    0
2    0    1    0    0    0    1    0
3    0    1    0    0    0    0    0</code></pre>
</div>
</div>
<div id="wrn-clustering-comparejaccard" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Compare the Jaccard distance (available as the function <code>vegdist</code> in the R package <strong><a href="https://cran.r-project.org/web/packages/vegan/">vegan</a></strong>) between mutations in the HIV data <code>mut</code> to the correlation based distance.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"vegan"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>mutJ <span class="ot">=</span> <span class="fu">vegdist</span>(mut, <span class="st">"jaccard"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>mutC <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">cor</span>(<span class="fu">t</span>(mut))))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>mutJ</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      1     2     3     4
2 0.800                  
3 0.750 0.889            
4 0.900 0.778 0.846      
5 1.000 0.800 0.889 0.900</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.dist</span>(mutC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     1    2    3    4
2 1.19               
3 1.10 1.30          
4 1.32 1.13 1.30     
5 1.45 1.19 1.30 1.32</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-xkcd-birds" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-xkcd-birds-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/birds_and_dinosaurs.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14" title="Figure&nbsp;5.8: An example of computing the cophenetic distance (xkcd)."><img src="imgs/birds_and_dinosaurs.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-xkcd-birds-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.8: An example of computing the cophenetic distance (xkcd).
</figcaption>
</figure>
</div>
</div></div></div>
<p>It can also be interesting to compare complex objects that are not traditional vectors or real numbers using dissimilarities or distances. Gower’s distance for data of mixed modalities (both categorical factors and continuous variables) can be computed with the <code>daisy</code> function. In fact, distances can be defined between any pairs of objects, not just points in <span class="math inline">\({\mathbb R}^p\)</span> or character sequences. For instance, the <code>shortest.paths</code> function from the <strong><a href="https://cran.r-project.org/web/packages/igraph/">igraph</a></strong> package that we will see in <a href="10-chap.html" class="quarto-xref"><span>Chapter 10</span></a> computes the distance between vertices on a graph and the function <code>cophenetic</code> computes the distance between leaves of a tree as illustrated in <a href="#fig-xkcd-birds" class="quarto-xref">Figure&nbsp;<span>5.8</span></a>. We can compute the distance between trees using <code>dist.multiPhylo</code> in the <strong><a href="https://cran.r-project.org/web/packages/distory/">distory</a></strong> package.</p>
<p>The Jaccard index between graphs can be computed by looking at two graphs built on the same nodes and counting the number of co-occurring edges. This is implemented in the function <code>similarity</code> in the <strong><a href="https://cran.r-project.org/web/packages/igraph/">igraph</a></strong> package. Distances and dissimilarities are also used to compare images, sounds, maps and documents. A distance can usefully encompass domain knowledge and, if carefully chosen, can lead to the solution of many hard problems involving heterogeneous data. Asking yourself what is the <em>relevant</em> notion of “closeness” or similarity for your data can provide useful ways of representing them, as we will explore in <a href="09-chap.html" class="quarto-xref"><span>Chapter 9</span></a>.</p>
</section>
</section>
<section id="nonparametric-mixture-detection" class="level2 page-columns page-full" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="nonparametric-mixture-detection"><span class="header-section-number">5.4</span> Nonparametric mixture detection</h2>
<section id="k-methods-k-means-k-medoids-and-pam" class="level3 page-columns page-full" data-number="5.4.1">
<h3 data-number="5.4.1" class="anchored" data-anchor-id="k-methods-k-means-k-medoids-and-pam"><span class="header-section-number">5.4.1</span> <span class="math inline">\(k\)</span>-methods: <span class="math inline">\(k\)</span>-means, <span class="math inline">\(k\)</span>-medoids and PAM</h3>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15" title="The centers of the groups are sometimes called medoids, thus the name PAM (partitioning around medoids)."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="The centers of the groups are sometimes called medoids, thus the name PAM (partitioning around medoids)."></a></p>
</figure>
</div>
<figcaption>The centers of the groups are sometimes called medoids, thus the name PAM (partitioning around medoids).</figcaption>
</figure>
</div>
</div></div></div>
<p>Partitioning or iterative relocation methods work well in high-dimensional settings, where we cannot<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> easily use probability densities, the EM algorithm and parametric mixture modeling in the way we did in <a href="04-chap.html" class="quarto-xref"><span>Chapter 4</span></a>. Besides the distance measure, the main choice to be made is the number of clusters <span class="math inline">\(k\)</span>. The PAM (partitioning around medoids, <span class="citation" data-cites="Kaufman2009">Kaufman and Rousseeuw (<a href="16-chap.html#ref-Kaufman2009" role="doc-biblioref">2009</a>)</span>) method is as follows:</p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;This is due to the so-called curse of dimensionality. We will discuss this in more detail in <a href="12-chap.html" class="quarto-xref"><span>Chapter 12</span></a>.</p></div></div><ol type="1">
<li><p>Starts from a matrix of <span class="math inline">\(p\)</span> features measured on a set of <span class="math inline">\(n\)</span> observations.</p></li>
<li><p>Randomly pick <span class="math inline">\(k\)</span> distinct <em>cluster centers</em> out of the <span class="math inline">\(n\)</span> observations (“seeds”).</p></li>
<li><p>Assign each of the remaining observation to the group to whose center it is the closest.</p></li>
<li><p>For each group, choose a new center from the observations in the group, such that the sum of the distances of group members to the center is minimal; this is called the <em>medoid</em>.</p></li>
<li><p>Repeat Steps 3 and 4 until the groups stabilize.</p></li>
</ol>
<p>Each time the algorithm is run, different initial seeds will be picked in Step 2, and in general, this can lead to different final results. A popular implementation is the <code>pam</code> function in the package <strong><a href="https://cran.r-project.org/web/packages/cluster/">cluster</a></strong>.</p>
<p>A slight variation of the method replaces the medoids by the arithmetic means (centers of gravity) of the clusters and is called <span class="math inline">\(k\)</span>-means. While in PAM, the centers are observations, this is not, in general, the case with <span class="math inline">\(k\)</span>-means. The function <code>kmeans</code> comes with every installation of R in the <strong><a href="https://cran.r-project.org/web/packages/stats/">stats</a></strong> package; an example run is shown in <a href="#fig-clust-kmeansastep1" class="quarto-xref">Figure&nbsp;<span>5.9</span></a>.</p>
<div class="cell" data-layout-nrow="1" data-layout-align="center" data-warning.known="did not converge in 1 iteration">
<div id="fig-clust-kmeansastep1" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-clust-kmeansastep1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-clust-kmeansastep1" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-clust-kmeansastep1-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="320" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-clust-kmeansastep1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-clust-kmeansastep1-1.png" class="lightbox" data-gallery="fig-clust-kmeansastep1" title="Figure&nbsp;5.9&nbsp;(a): "><img src="05-chap_files/figure-html/fig-clust-kmeansastep1-1.png" id="fig-clust-kmeansastep1-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-clust-kmeansastep1" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-clust-kmeansastep1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-clust-kmeansastep1" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-clust-kmeansastep1-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="320" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-clust-kmeansastep1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-clust-kmeansastep1-2.png" class="lightbox" data-gallery="fig-clust-kmeansastep1" title="Figure&nbsp;5.9&nbsp;(b): "><img src="05-chap_files/figure-html/fig-clust-kmeansastep1-2.png" id="fig-clust-kmeansastep1-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-clust-kmeansastep1" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-clust-kmeansastep1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-clust-kmeansastep1" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-clust-kmeansastep1-3" class="quarto-float quarto-figure quarto-figure-center anchored" width="320" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-clust-kmeansastep1-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-clust-kmeansastep1-3.png" class="lightbox" data-gallery="fig-clust-kmeansastep1" title="Figure&nbsp;5.9&nbsp;(c): "><img src="05-chap_files/figure-html/fig-clust-kmeansastep1-3.png" id="fig-clust-kmeansastep1-3" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-clust-kmeansastep1" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-clust-kmeansastep1-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-clust-kmeansastep1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.9: An example run of the <span class="math inline">\(k\)</span>-means algorithm. The initial, randomly chosen centers (black circles) and groups (colors) are shown in (a). The group memberships are assigned based on their distance to centers. At each iteration (b) and (c), the group centers are redefined, and the points reassigned to the cluster centers.
</figcaption>
</figure>
</div>
</div>
<p>These so-called <span class="math inline">\(k\)</span>-methods are the most common off-the-shelf methods for clustering; they work particularly well when the clusters are of comparable size and convex (blob-shaped). On the other hand, if the true clusters are very different in size, the larger ones will tend to be broken up; the same is true for groups that have pronounced non-spherical or non-elliptic shapes.</p>
<div id="wrn-clustering-kmeansem" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.3
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <span class="math inline">\(k\)</span>-means algorithm alternates between computing the average point and assigning the points to clusters. How does this alternating, iterative method differ from an EM-algorithm?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>In the EM algorithm, each point participates in the computation of the mean of all the groups through a probabilistic weight assigned to it. In the <span class="math inline">\(k\)</span>-means method, the points are either attributed to a cluster or not, so each point participates only, and entirely, in the computation of the center of one cluster.</p>
</div>
</div>
</div>
</section>
<section id="tight-clusters-with-resampling" class="level3" data-number="5.4.2">
<h3 data-number="5.4.2" class="anchored" data-anchor-id="tight-clusters-with-resampling"><span class="header-section-number">5.4.2</span> Tight clusters with resampling</h3>
<p>There are clever schemes that repeat the process many times using different initial centers or resampled datasets. Repeating a clustering procedure multiple times on the same data, but with different starting points creates <em>strong forms</em> according to <span class="citation" data-cites="Diday1989">Diday and Brito (<a href="16-chap.html#ref-Diday1989" role="doc-biblioref">1989</a>)</span>. Repeated subsampling of the dataset and applying a clustering method will result in groups of observations that are “almost always” grouped together; these are called <em>tight clusters</em> <span class="citation" data-cites="Tseng:2005">(<a href="16-chap.html#ref-Tseng:2005" role="doc-biblioref">Tseng and Wong 2005</a>)</span>. The study of strong forms or tight clusters facilitates the choice of the number of clusters. A recent package developed to combine and compare the output from many different clusterings is <strong><a href="https://bioconductor.org/packages/clusterExperiment/">clusterExperiment</a></strong>. Here we give an example from its vignette. Single-cell RNA-Seq experiments provide counts of reads, representing gene transcripts, from individual cells. The single cell resolution enables scientists, among other things, to follow cell lineage dynamics. Clustering has proved very useful for analysing such data.</p>
<div id="wrn-clustering-clusterExp" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.4
</div>
</div>
<div class="callout-body-container callout-body">
<p>Follow the vignette of the package <strong><a href="https://bioconductor.org/packages/clusterExperiment/">clusterExperiment</a></strong>. Call the ensemble clustering function <code>clusterMany</code>, using <code>pam</code> for the individual clustering efforts. Set the choice of genes to include at either the 60, 100 or 150 most variable genes. Plot the clustering results for <span class="math inline">\(k\)</span> varying between 4 and 9. What do you notice?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The following code produces <a href="#fig-quiltclust-1" class="quarto-xref">Figure&nbsp;<span>5.10</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"clusterExperiment"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>fluidigm <span class="ot">=</span> scRNAseq<span class="sc">::</span><span class="fu">ReprocessedFluidigmData</span>()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>se <span class="ot">=</span> fluidigm[, fluidigm<span class="sc">$</span>Coverage_Type <span class="sc">==</span> <span class="st">"High"</span>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">assays</span>(se) <span class="ot">=</span> <span class="fu">list</span>(<span class="at">normalized_counts =</span> <span class="fu">as.matrix</span>(limma<span class="sc">::</span><span class="fu">normalizeQuantiles</span>(<span class="fu">assay</span>(se))))</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>ce <span class="ot">=</span> <span class="fu">clusterMany</span>(se, <span class="at">clusterFunction =</span> <span class="st">"pam"</span>, <span class="at">ks =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">9</span>), <span class="at">run =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">isCount =</span> <span class="cn">TRUE</span>, <span class="at">reduceMethod =</span> <span class="st">"var"</span>, <span class="at">nFilterDims =</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">100</span>, <span class="dv">150</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>9 parameter combinations, 0 use sequential method, 0 use subsampling method
Running Clustering on Parameter Combinations...
done.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterLabels</span>(ce) <span class="ot">=</span> <span class="fu">sub</span>(<span class="st">"FilterDims"</span>, <span class="st">""</span>, <span class="fu">clusterLabels</span>(ce))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotClusters</span>(ce, <span class="at">whichClusters =</span> <span class="st">"workflow"</span>, <span class="at">axisLine =</span> <span class="sc">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-quiltclust-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-quiltclust-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-quiltclust-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19" title="Figure&nbsp;5.10: Comparison of clustering results (rows), for different numbers of included genes and for varying numbers of clusters, k. Each column of the heatmap corresponds to a cell, and the colors represent the cluster assignments."><img src="05-chap_files/figure-html/fig-quiltclust-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-quiltclust-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.10: Comparison of clustering results (rows), for different numbers of included genes and for varying numbers of clusters, <span class="math inline">\(k\)</span>. Each column of the heatmap corresponds to a cell, and the colors represent the cluster assignments.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="clustering-examples-flow-cytometry-and-mass-cytometry" class="level2 page-columns page-full" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="clustering-examples-flow-cytometry-and-mass-cytometry"><span class="header-section-number">5.5</span> Clustering examples: flow cytometry and mass cytometry</h2>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/book_icon.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20" title="You can find reviews of bioinformatics methods for flow cytometry in [@oneill2013flow] and a well-kept wikipedia article."><img src="imgs/book_icon.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="126" alt="You can find reviews of bioinformatics methods for flow cytometry in (O’Neill et al. 2013) and a well-kept wikipedia article."></a></p>
</figure>
</div>
<figcaption>You can find reviews of bioinformatics methods for flow cytometry in <span class="citation" data-cites="oneill2013flow">(<a href="16-chap.html#ref-oneill2013flow" role="doc-biblioref">O’Neill et al. 2013</a>)</span> and <a href="https://en.wikipedia.org/wiki/Flow_cytometry_bioinformatics">a well-kept wikipedia article</a>.</figcaption>
</figure>
</div>
</div></div></div>
<p>Studying measurements on single cells improves both the focus and resolution with which we can analyze cell types and dynamics. Flow cytometry enables the simultaneous measurement of about 10 different cell markers. Mass cytometry expands the collection of measurements to as many as 80 proteins per cell. A particularly promising application of this technology is the study of immune cell dynamics.</p>
<section id="flow-cytometry-and-mass-cytometry" class="level3" data-number="5.5.1">
<h3 data-number="5.5.1" class="anchored" data-anchor-id="flow-cytometry-and-mass-cytometry"><span class="header-section-number">5.5.1</span> Flow cytometry and mass cytometry</h3>
<p>At different stages of their development, immune cells express unique combinations of proteins on their surfaces. These protein-markers are called <strong>CD</strong>s (<strong>clusters of differentiation</strong>) and are collected by flow cytometry (using fluorescence, see <span class="citation" data-cites="flowsort">Hulett et al. (<a href="16-chap.html#ref-flowsort" role="doc-biblioref">1969</a>)</span>) or mass cytometry (using single-cell atomic mass spectrometry of heavy element reporters, see <span class="citation" data-cites="BendallCell">Bendall et al. (<a href="16-chap.html#ref-BendallCell" role="doc-biblioref">2012</a>)</span>). An example of a commonly used CD is CD4, this protein is expressed by helper T cells that are referred to as being “CD4+”. Note however that some cells express CD4 (thus are CD4+), but are not actually helper T cells. We start by loading some useful Bioconductor packages for cytometry data, <strong><a href="https://bioconductor.org/packages/flowCore/">flowCore</a></strong> and <strong><a href="https://bioconductor.org/packages/flowViz/">flowViz</a></strong>, and read in an examplary data object <code>fcsB</code> as follows:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"flowCore"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"flowViz"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>fcsB <span class="ot">=</span> <span class="fu">read.FCS</span>(<span class="st">"../data/Bendall_2011.fcs"</span>, <span class="at">truncate_max_range =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">slotNames</span>(fcsB)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "exprs"       "parameters"  "description"</code></pre>
</div>
</div>
<p><a href="#fig-ObviousClusters" class="quarto-xref">Figure&nbsp;<span>5.11</span></a> shows a scatterplot of two of the variables available in the <code>fcsB</code> data. (We will see how to make such plots below.) We can see clear bimodality and clustering in these two dimensions.</p>
<div id="wrn-clustering-explorationflow" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.5
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="a">
<li>Look at the structure of the <code>fcsB</code> object (hint: the <code>colnames</code> function). How many variables were measured?<br>
</li>
<li>Subset the data to look at the first few rows (hint: use <code>Biobase::exprs(fcsB)</code>). How many cells were measured?</li>
</ol>
</div>
</div>
</section>
<section id="data-preprocessing" class="level3 page-columns page-full" data-number="5.5.2">
<h3 data-number="5.5.2" class="anchored" data-anchor-id="data-preprocessing"><span class="header-section-number">5.5.2</span> Data preprocessing</h3>
<p>First we load the table data that reports the mapping between isotopes and markers (antibodies), and then we replace the isotope names in the column names of <code>fcsB</code> with the marker names. This makes the subsequent analysis and plotting code more readable:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>markersB <span class="ot">=</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"../data/Bendall_2011_markers.csv"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>mt <span class="ot">=</span> <span class="fu">match</span>(markersB<span class="sc">$</span>isotope, <span class="fu">colnames</span>(fcsB))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(mt)))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(fcsB)[mt] <span class="ot">=</span> markersB<span class="sc">$</span>marker</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are ready to generate <a href="#fig-ObviousClusters" class="quarto-xref">Figure&nbsp;<span>5.11</span></a></p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">flowPlot</span>(fcsB, <span class="at">plotParameters =</span> <span class="fu">colnames</span>(fcsB)[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>], <span class="at">logy =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-ObviousClusters" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ObviousClusters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-ObviousClusters-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21" title="Figure&nbsp;5.11: Cell measurements that show clear clustering in two dimensions."><img src="05-chap_files/figure-html/fig-ObviousClusters-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ObviousClusters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.11: Cell measurements that show clear clustering in two dimensions.
</figcaption>
</figure>
</div>
</div></div></div>
<p>Plotting the data in two dimensions as in <a href="#fig-ObviousClusters" class="quarto-xref">Figure&nbsp;<span>5.11</span></a> already shows that the cells can be grouped into subpopulations. Sometimes just one of the markers can be used to define populations on their own; in that case simple <strong>rectangular gating</strong> is used to separate the populations; for instance, CD4+ cells can be gated by taking the subpopulation with high values for the CD4 marker. Cell clustering can be improved by carefully choosing transformations of the data. The left part of <a href="#fig-plotTransformations" class="quarto-xref">Figure&nbsp;<span>5.12</span></a> shows a simple one dimensional histogram before transformation; on the right of <a href="#fig-plotTransformations" class="quarto-xref">Figure&nbsp;<span>5.12</span></a> we see the distribution after transformation. It reveals a bimodality and the existence of two cell populations.</p>
<p><strong>Data Transformation: hyperbolic arcsin (asinh)</strong>. It is standard to transform both flow and mass cytometry data using one of several special functions. We take the example of the inverse hyperbolic sine (asinh):</p>
<p><span class="math display">\[
\operatorname{asinh}(x) = \log{(x + \sqrt{x^2 + 1})}.
\]</span></p>
<p>From this we can see that for large values of <span class="math inline">\(x\)</span>, <span class="math inline">\(\operatorname{asinh}(x)\)</span> behaves like the logarithm and is practically equal to <span class="math inline">\(\log(x)+\log(2)\)</span>; for small <span class="math inline">\(x\)</span> the function is close to linear in <span class="math inline">\(x\)</span>.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Try running the following code to see the two main regimes of the transformation: small values and large values.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>v1 <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(v1), <span class="fu">asinh</span>(v1), <span class="at">type =</span> <span class="st">'l'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v1, <span class="fu">asinh</span>(v1), <span class="at">type =</span> <span class="st">'l'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>v3 <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">30</span>, <span class="dv">3000</span>, <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(v3), <span class="fu">asinh</span>(v3), <span class="at">type=</span> <span class="st">'l'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>This is another example of a variance stabilizing transformation, also mentioned in Chapters <a href="04-chap.html" class="quarto-xref"><span>4</span></a> and <a href="08-chap.html" class="quarto-xref"><span>8</span></a>. <a href="#fig-plotTransformations" class="quarto-xref">Figure&nbsp;<span>5.12</span></a> is produced by the following code, which uses the <code>arcsinhTransform</code> function in the <strong><a href="https://bioconductor.org/packages/flowCore/">flowCore</a></strong> package.</p>
<div class="cell page-columns page-full" data-layout-nrow="1" data-layout-align="center" data-fig-cap-location="margin">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>asinhtrsf <span class="ot">=</span> <span class="fu">arcsinhTransform</span>(<span class="at">a =</span> <span class="fl">0.1</span>, <span class="at">b =</span> <span class="dv">1</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>fcsBT <span class="ot">=</span> <span class="fu">transform</span>(fcsB, <span class="fu">transformList</span>(<span class="fu">colnames</span>(fcsB)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">41</span>)], asinhtrsf))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(<span class="sc">~</span><span class="st">`</span><span class="at">CD3all</span><span class="st">`</span>, fcsB)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(<span class="sc">~</span><span class="st">`</span><span class="at">CD3all</span><span class="st">`</span>, fcsBT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-plotTransformations" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-plotTransformations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-plotTransformations" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-plotTransformations-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="75%" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-plotTransformations-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-plotTransformations-1.png" class="lightbox" data-gallery="fig-plotTransformations" title="Figure&nbsp;5.12&nbsp;(a): "><img src="05-chap_files/figure-html/fig-plotTransformations-1.png" id="fig-plotTransformations-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" style="width:75.0%" data-ref-parent="fig-plotTransformations"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-plotTransformations-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-plotTransformations" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-plotTransformations-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="75%" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-plotTransformations-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-plotTransformations-2.png" class="lightbox" data-gallery="fig-plotTransformations" title="Figure&nbsp;5.12&nbsp;(b): "><img src="05-chap_files/figure-html/fig-plotTransformations-2.png" id="fig-plotTransformations-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" style="width:75.0%" data-ref-parent="fig-plotTransformations"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-plotTransformations-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-plotTransformations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.12: Panel (a) shows the histogram of the CD3all variable: the cells are clustered around 0 with a few large values. In (b), we see that after an asinh transformation, the cells cluster and fall into two groups or types.
</figcaption>
</figure>
</div>
</div>
<div id="wrn-clustering-dimkmeans" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.6
</div>
</div>
<div class="callout-body-container callout-body">
<p>How many dimensions does the following code use to split the data into 2 groups using <span class="math inline">\(k\)</span>-means ?</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>kf <span class="ot">=</span> <span class="fu">kmeansFilter</span>(<span class="st">"CD3all"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Pop1"</span>,<span class="st">"Pop2"</span>), <span class="at">filterId=</span><span class="st">"myKmFilter"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>fres <span class="ot">=</span> flowCore<span class="sc">::</span><span class="fu">filter</span>(fcsBT, kf)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fres)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Pop1: 33434 of 91392 events (36.58%)
Pop2: 57958 of 91392 events (63.42%)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>fcsBT1 <span class="ot">=</span> flowCore<span class="sc">::</span><span class="fu">split</span>(fcsBT, fres, <span class="at">population =</span> <span class="st">"Pop1"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>fcsBT2 <span class="ot">=</span> flowCore<span class="sc">::</span><span class="fu">split</span>(fcsBT, fres, <span class="at">population =</span> <span class="st">"Pop2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p><a href="#fig-flowCD3CD56-1" class="quarto-xref">Figure&nbsp;<span>5.13</span></a>, generated by the following code, shows a naïve projection of the data into the two dimensions spanned by the CD3 and CD56 markers:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"flowPeaks"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>fp <span class="ot">=</span> <span class="fu">flowPeaks</span>(Biobase<span class="sc">::</span><span class="fu">exprs</span>(fcsBT)[, <span class="fu">c</span>(<span class="st">"CD3all"</span>, <span class="st">"CD56"</span>)])</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-flowCD3CD56-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-flowCD3CD56-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-flowCD3CD56-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-24" title="Figure&nbsp;5.13: After transformation these cells were clustered using kmeans."><img src="05-chap_files/figure-html/fig-flowCD3CD56-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-flowCD3CD56-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.13: After transformation these cells were clustered using <code>kmeans</code>.
</figcaption>
</figure>
</div>
</div></div></div>
<p>When plotting points that densely populate an area we should try to avoid overplotting. We saw some of the preferred techniques in <a href="03-chap.html" class="quarto-xref"><span>Chapter 3</span></a>; here we use contours and shading. This is done as follows:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">flowPlot</span>(fcsBT, <span class="at">plotParameters =</span> <span class="fu">c</span>(<span class="st">"CD3all"</span>, <span class="st">"CD56"</span>), <span class="at">logy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(fcsBT[, <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">19</span>)], <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-groupcontourCD3CD56" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-groupcontourCD3CD56-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-groupcontourCD3CD56-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-25" title="Figure&nbsp;5.14: Like Figure&nbsp;fig-flowCD3CD56-1, using contours."><img src="05-chap_files/figure-html/fig-groupcontourCD3CD56-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="400"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-groupcontourCD3CD56-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.14: Like <a href="#fig-flowCD3CD56-1" class="quarto-xref">Figure&nbsp;<span>5.13</span></a>, using contours.
</figcaption>
</figure>
</div>
</div></div></div>
<p>This produces <a href="#fig-groupcontourCD3CD56" class="quarto-xref">Figure&nbsp;<span>5.14</span></a>—a more informative version of <a href="#fig-flowCD3CD56-1" class="quarto-xref">Figure&nbsp;<span>5.13</span></a>.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Bioconductor package <strong><a href="https://bioconductor.org/packages/ggcyto/">ggcyto</a></strong> enables the plotting of each patient’s data in a different facet using <code>ggplot</code>. Try comparing the output using this approach to what we did above, along the following lines:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggcyto"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"labeling"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> <span class="fu">ggcyto</span>(fcsB, <span class="fu">aes</span>(<span class="at">x =</span> CD4)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">60</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> <span class="fu">ggcyto</span>(fcsB, <span class="fu">aes</span>(<span class="at">x =</span> CD8)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">60</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">=</span> <span class="fu">ggcyto</span>(fcsB, <span class="fu">aes</span>(<span class="at">x =</span> CD4, <span class="at">y =</span> CD8)) <span class="sc">+</span> <span class="fu">geom_density2d</span>(<span class="at">colour =</span> <span class="st">"black"</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>fcsBT <span class="ot">=</span> <span class="fu">transform</span>(fcsB, <span class="fu">transformList</span>(<span class="fu">colnames</span>(fcsB)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">41</span>)], </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">arcsinhTransform</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)))</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                                      </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>p1t <span class="ot">=</span> <span class="fu">ggcyto</span>(fcsBT, <span class="fu">aes</span>(<span class="at">x =</span> CD4))            <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">90</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>p2t <span class="ot">=</span> <span class="fu">ggcyto</span>(fcsBT, <span class="fu">aes</span>(<span class="at">x =</span> CD4,<span class="at">y =</span> CD8))    <span class="sc">+</span> <span class="fu">geom_density2d</span>(<span class="at">colour =</span> <span class="st">"black"</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>p3t <span class="ot">=</span> <span class="fu">ggcyto</span>(fcsBT, <span class="fu">aes</span>(<span class="at">x =</span> CD45RA,<span class="at">y =</span> CD20))<span class="sc">+</span> <span class="fu">geom_density2d</span>(<span class="at">colour =</span> <span class="st">"black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="density-based-clustering" class="level3 page-columns page-full" data-number="5.5.3">
<h3 data-number="5.5.3" class="anchored" data-anchor-id="density-based-clustering"><span class="header-section-number">5.5.3</span> Density-based clustering</h3>
<p>Data sets such as flow cytometry, that contain only a few markers and a large number of cells, are amenable to density-based clustering. This method looks for regions of high density separated by sparser regions. It has the advantage of being able to cope with clusters that are not necessarily convex. One implementation of such a method is called dbscan. Let’s look at an example by running the following code.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dbscan"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>mc5 <span class="ot">=</span> Biobase<span class="sc">::</span><span class="fu">exprs</span>(fcsBT)[, <span class="fu">c</span>(<span class="dv">15</span>,<span class="dv">16</span>,<span class="dv">19</span>,<span class="dv">40</span>,<span class="dv">33</span>)]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>res5 <span class="ot">=</span> dbscan<span class="sc">::</span><span class="fu">dbscan</span>(mc5, <span class="at">eps =</span> <span class="fl">0.65</span>, <span class="at">minPts =</span> <span class="dv">30</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>mc5df <span class="ot">=</span> <span class="fu">data.frame</span>(mc5, <span class="at">cluster =</span> <span class="fu">as.factor</span>(res5<span class="sc">$</span>cluster))</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mc5df<span class="sc">$</span>cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    0     1     2     3     4     5     6     7     8 
76053  4031  5450  5310   257   160    63    25    43 </code></pre>
</div>
</div>
<div class="cell page-columns page-full" data-layout-nrow="1" data-layout-align="center" data-warning.known="[&quot;zero contours were generated&quot;,&quot;no non-missing arguments to&quot;]" data-fig-cap-location="margin">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mc5df, <span class="fu">aes</span>(<span class="at">x=</span>CD4,    <span class="at">y=</span>CD8,  <span class="at">col=</span>cluster))<span class="sc">+</span><span class="fu">geom_density2d</span>()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mc5df, <span class="fu">aes</span>(<span class="at">x=</span>CD3all, <span class="at">y=</span>CD20, <span class="at">col=</span>cluster))<span class="sc">+</span><span class="fu">geom_density2d</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-dbscanfcs5" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-dbscanfcs5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-dbscanfcs5" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-dbscanfcs5-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="75%" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-dbscanfcs5-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-dbscanfcs5-1.png" class="lightbox" data-gallery="fig-dbscanfcs5" title="Figure&nbsp;5.15&nbsp;(a): "><img src="05-chap_files/figure-html/fig-dbscanfcs5-1.png" id="fig-dbscanfcs5-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" style="width:75.0%" data-ref-parent="fig-dbscanfcs5"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-dbscanfcs5-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-dbscanfcs5" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-dbscanfcs5-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="75%" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-dbscanfcs5-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-dbscanfcs5-2.png" class="lightbox" data-gallery="fig-dbscanfcs5" title="Figure&nbsp;5.15&nbsp;(b): "><img src="05-chap_files/figure-html/fig-dbscanfcs5-2.png" id="fig-dbscanfcs5-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" style="width:75.0%" data-ref-parent="fig-dbscanfcs5"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-dbscanfcs5-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-dbscanfcs5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.15: These two plots show the results of clustering with <code>dbscan</code> using five markers. Here we only show the projections of the data into the CD4-CD8 and C3all-CD20 planes.
</figcaption>
</figure>
</div>
</div>
<p>The output is shown in <a href="#fig-dbscanfcs5" class="quarto-xref">Figure&nbsp;<span>5.15</span></a>. The overlaps of the clusters in the 2D projections enable us to appreciate the multidimensional nature of the clustering.</p>
<div id="wrn-clustering-changedim" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.7
</div>
</div>
<div class="callout-body-container callout-body">
<p>Try increasing the dimension to 6 by adding one CD marker-variables from the input data.<br>
Then vary <code>eps</code>, and try to find four clusters such that at least two of them have more than 100 points.<br>
Repeat this will 7 CD marker-variables, what do you notice?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>An example with the following 6 markers</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>mc6 <span class="ot">=</span> Biobase<span class="sc">::</span><span class="fu">exprs</span>(fcsBT)[, <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">16</span>, <span class="dv">19</span>, <span class="dv">33</span>, <span class="dv">25</span>, <span class="dv">40</span>)]</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> dbscan<span class="sc">::</span><span class="fu">dbscan</span>(mc6, <span class="at">eps =</span> <span class="fl">0.65</span>, <span class="at">minPts =</span> <span class="dv">20</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>mc6df <span class="ot">=</span> <span class="fu">data.frame</span>(mc6, <span class="at">cluster =</span> <span class="fu">as.factor</span>(res<span class="sc">$</span>cluster))</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mc6df<span class="sc">$</span>cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    0     1     2     3     4     5     6 
91068    34    61    20    67   121    21 </code></pre>
</div>
</div>
<p>We see that with eps= 0.75 it is easier to find large enough clusters than if we take eps=0.65, with eps=0.55 it is impossible. As we increase the dimensionality to 7, we have to make eps even larger.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>mc7 <span class="ot">=</span> Biobase<span class="sc">::</span><span class="fu">exprs</span>(fcsBT)[, <span class="fu">c</span>(<span class="dv">11</span>, <span class="dv">15</span>, <span class="dv">16</span>, <span class="dv">19</span>, <span class="dv">25</span>, <span class="dv">33</span>, <span class="dv">40</span>)]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> dbscan<span class="sc">::</span><span class="fu">dbscan</span>(mc7, <span class="at">eps =</span> <span class="fl">0.95</span>, <span class="at">minPts =</span> <span class="dv">20</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>mc7df <span class="ot">=</span> <span class="fu">data.frame</span>(mc7, <span class="at">cluster =</span> <span class="fu">as.factor</span>(res<span class="sc">$</span>cluster))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mc7df<span class="sc">$</span>cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    0     1     2     3     4     5     6     7     8     9    10 
90249    21   102   445   158   119    19   224    17    20    18 </code></pre>
</div>
</div>
<p>This shows us the so-called <strong>curse of dimensionality</strong> in action, of which more in <a href="12-chap.html" class="quarto-xref"><span>Chapter 12</span></a>.</p>
</div>
</div>
</div>
<section id="how-does-density-based-clustering-dbscan-work" class="level4 unnumbered page-columns page-full">
<h4 class="unnumbered anchored" data-anchor-id="how-does-density-based-clustering-dbscan-work">How does density-based clustering (dbscan) work ?</h4>
<p>The dbscan method clusters points in dense regions according to the <em>density-connectedness</em> criterion. It looks at small neighborhood spheres of radius <span class="math inline">\(\epsilon\)</span> to see if points are connected.</p>
<p>The building block of dbscan is the concept of density-reachability: a point <span class="math inline">\(q\)</span> is directly <strong>density-reachable</strong> from a point <span class="math inline">\(p\)</span> if it is not further away than a given threshold <span class="math inline">\(\epsilon\)</span>, and if <span class="math inline">\(p\)</span> is surrounded by sufficiently many points such that one may consider <span class="math inline">\(p\)</span> (and <span class="math inline">\(q\)</span>) be part of a dense region. We say that <span class="math inline">\(q\)</span> is <em>density-reachable</em> from <span class="math inline">\(p\)</span> if there is a sequence of points <span class="math inline">\(p_1,...,p_n\)</span> with <span class="math inline">\(p_1 = p\)</span> and <span class="math inline">\(p_n = q\)</span>, so that each <span class="math inline">\(p_{i + 1}\)</span> is directly density-reachable from <span class="math inline">\(p_i\)</span>.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-28" title="It is important that the method looks for high density of points in a neighborhood. Other methods exist that try to define clusters by a void, or “missing points” between clusters. But these are vulnerable to the curse of dimensionality; these can create spurious “voids”."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="It is important that the method looks for high density of points in a neighborhood. Other methods exist that try to define clusters by a void, or “missing points” between clusters. But these are vulnerable to the curse of dimensionality; these can create spurious “voids”."></a></p>
</figure>
</div>
<figcaption>It is important that the method looks for high density of points in a neighborhood. Other methods exist that try to define clusters by a void, or “missing points” between clusters. But these are vulnerable to the curse of dimensionality; these can create spurious “voids”.</figcaption>
</figure>
</div>
</div></div></div>
<p>A <em>cluster</em> is then a subset of points that satisfy the following properties:</p>
<ol type="1">
<li><p>All points within the cluster are mutually density-connected.</p></li>
<li><p>If a point is density-connected to any point of the cluster, it is part of the cluster as well.</p></li>
<li><p>Groups of points must have at least <code>MinPts</code> points to count as a cluster.</p></li>
</ol>
</section>
</section>
</section>
<section id="hierarchical-clustering" class="level2 page-columns page-full" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="hierarchical-clustering"><span class="header-section-number">5.6</span> Hierarchical clustering</h2>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-LinnaeusClass" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-LinnaeusClass-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/LinnaeusClass-01.png" class="lightbox" data-gallery="quarto-lightbox-gallery-29" title="Figure&nbsp;5.16: A snippet of Linnus’ taxonomy that clusters organisms according to feature similarities."><img src="imgs/LinnaeusClass-01.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-LinnaeusClass-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.16: A snippet of Linnus’ taxonomy that clusters organisms according to feature similarities.
</figcaption>
</figure>
</div>
</div></div></div>
<p>Hierarchical clustering is a bottom-up approach, where similar observations and subclasses are assembled iteratively. <a href="#fig-LinnaeusClass" class="quarto-xref">Figure&nbsp;<span>5.16</span></a> shows how Linnæus made nested clusters of organisms according to specific characteristics. Such hierarchical organization has been useful in many fields and goes back to Aristotle who postulated a <em>ladder of nature</em>.</p>
<p><strong>Dendrogram ordering</strong>. As you can see in the example of <a href="#fig-Cluster-dendrogramorder" class="quarto-xref">Figure&nbsp;<span>5.17</span></a>, the order of the labels does not matter within sibling pairs. Horizontal distances are usually meaningless, while the vertical distances do encode some information. These properties are important to remember when making interpretations about neighbors that are not monophyletic (i.e., not in the same subtree or clade), but appear as neighbors in the plot (for instance B and D in the right hand tree are non-monophyletic neighbors).</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-Cluster-dendrogramorder" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center" data-cap-location="margin">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-Cluster-dendrogramorder-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/SameTree-01.png" class="lightbox" data-gallery="quarto-lightbox-gallery-30" title="Figure&nbsp;5.17: Three representations of the same hierarchical clustering tree."><img src="imgs/SameTree-01.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-Cluster-dendrogramorder-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.17: Three representations of the <strong>same</strong> hierarchical clustering tree.
</figcaption>
</figure>
</div>
</div>
</div>
<p><strong>Top-down hierarchies</strong>. An alternative, top-down, approach takes all the objects and splits them sequentially according to a chosen criterion. Such so-called <strong>recursive partitioning</strong> methods are often used to make decision trees. They can be useful for prediction (say, survival time, given a medical diagnosis): we are hoping in those instances to split heterogeneous populations into more homogeneous subgroups by partitioning. In this chapter, we concentrate on the bottom-up approaches. We will return to partitioning when we talk about supervised learning and classification in <a href="12-chap.html" class="quarto-xref"><span>Chapter 12</span></a>.</p>
<section id="how-to-compute-dissimilarities-between-aggregated-clusters" class="level3 page-columns page-full" data-number="5.6.1">
<h3 data-number="5.6.1" class="anchored" data-anchor-id="how-to-compute-dissimilarities-between-aggregated-clusters"><span class="header-section-number">5.6.1</span> How to compute (dis)similarities between aggregated clusters?</h3>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-single" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-single-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/ClusterStepChoiceSingle1b.png" class="lightbox" data-gallery="quarto-lightbox-gallery-31" title="Figure&nbsp;5.18: In the single linkage method, the distance between groups C_1 and C_2 is defined as the distance between the closest two points from the groups."><img src="imgs/ClusterStepChoiceSingle1b.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-single-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.18: In the single linkage method, the distance between groups <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span> is defined as the distance between the closest two points from the groups.
</figcaption>
</figure>
</div>
</div></div></div>
<p>A hierarchical clustering algorithm, which works by aggregation, is easy enough to get started, by grouping the most similar observations together. But we will need more than just the distances between all pairs of individual objects. Once an aggregation is made, one is required to say how the distance between the newly formed cluster and all other points (or existing clusters) is computed. There are different choices, all based on the object-object distances, and each choice results in a different type of hierarchical clustering.</p>
<p>The <strong>minimal jump</strong> method, also called <strong>single linkage</strong> or nearest neighbor method computes the distance between clusters as the smallest distance between any two points in the two clusters (as shown in <a href="#fig-single" class="quarto-xref">Figure&nbsp;<span>5.18</span></a>):</p>
<p><span class="math display">\[
d_{12} = \min_{i \in C_1, j \in C_2 } d_{ij}.
\]</span></p>
<p>This method tends to create clusters that look like contiguous strings of points. The cluster tree often looks like a comb.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-complete" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-complete-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/ClusterStepChoiceComplete1b.png" class="lightbox" data-gallery="quarto-lightbox-gallery-32" title="Figure&nbsp;5.19: In the complete linkage method, the distance between groups C_1 and C_2 is defined as the maximum distance between pairs of points from the two groups."><img src="imgs/ClusterStepChoiceComplete1b.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-complete-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.19: In the complete linkage method, the distance between groups <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span> is defined as the maximum distance between pairs of points from the two groups.
</figcaption>
</figure>
</div>
</div></div></div>
<p>The <strong>maximum jump</strong> (or <strong>complete linkage</strong>) method defines the distance between clusters as the largest distance between any two objects in the two clusters, as represented in <a href="#fig-complete" class="quarto-xref">Figure&nbsp;<span>5.19</span></a>:</p>
<p><span class="math display">\[
d_{12} = \max_{i \in C_1, j \in C_2 } d_{ij}.
\]</span></p>
<p>The <strong>average linkage</strong> method is half way between the two above (here, <span class="math inline">\(|C_k|\)</span> denotes the number of elements of cluster <span class="math inline">\(k\)</span>):</p>
<p><span class="math display">\[
d_{12} = \frac{1}{|C_1| |C_2|}\sum_{i \in C_1, j \in C_2 } d_{ij}
\]</span></p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-betweenwithin" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-betweenwithin-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/BetweenWithinb.png" class="lightbox" data-gallery="quarto-lightbox-gallery-33" title="Figure&nbsp;5.20: The Ward method maximizes the between group sum of squares (red edges), while minimizing the sums of squares within groups (black edges)."><img src="imgs/BetweenWithinb.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-betweenwithin-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.20: The Ward method maximizes the between group sum of squares (red edges), while minimizing the sums of squares within groups (black edges).
</figcaption>
</figure>
</div>
</div></div></div>
<p><strong>Ward’s method</strong> takes an analysis of variance approach, where the goal is to minimize the variance within clusters. This method is very efficient, however, it tends to create clusters of smaller sizes.</p>
<table class="caption-top table">
<caption>Advantages and disadvantages of various choices of defining distances between aggregates <span class="citation" data-cites="distory-paper">(<a href="16-chap.html#ref-distory-paper" role="doc-biblioref">Chakerian and Holmes 2012</a>)</span>.</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Method</th>
<th style="text-align: left;">Pros</th>
<th style="text-align: left;">Cons</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Single linkage</td>
<td style="text-align: left;">number of clusters</td>
<td style="text-align: left;">comblike trees</td>
</tr>
<tr class="even">
<td style="text-align: left;">Complete linkage</td>
<td style="text-align: left;">compact classes</td>
<td style="text-align: left;">one observation can alter groups</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Average linkage</td>
<td style="text-align: left;">similar size and variance</td>
<td style="text-align: left;">not robust</td>
</tr>
<tr class="even">
<td style="text-align: left;">Centroid</td>
<td style="text-align: left;">robust to outliers</td>
<td style="text-align: left;">smaller number of clusters</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ward</td>
<td style="text-align: left;">minimising an inertia</td>
<td style="text-align: left;">classes small if high variability</td>
</tr>
</tbody>
</table>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-mobile" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mobile-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/CalderHand.png" class="lightbox" data-gallery="quarto-lightbox-gallery-34" title="Figure&nbsp;5.21: Hierarchical clustering output has similar properties to a mobile: the branches can rotate freely from their suspension points."><img src="imgs/CalderHand.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mobile-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.21: Hierarchical clustering output has similar properties to a mobile: the branches can rotate freely from their suspension points.
</figcaption>
</figure>
</div>
</div></div></div>
<p>These are the choices we have to make building hierarchical clustering trees. An advantage of hierarchical clustering compared to the partitioning methods is that it offers a graphical diagnostic of the strength of groupings: the length of the inner edges in the tree.</p>
<p>When we have prior knowledge that the clusters are about the same size, using average linkage or Ward’s method of minimizing the within class variance is the best tactic.</p>
<div id="wrn-clustering-hclustcellpop" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.8
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Hierarchical clustering for cell populations</strong> The <code>Morder</code> data are gene expression measurements for 156 genes on T cells of 3 types (naïve, effector, memory) from 10 patients <span class="citation" data-cites="holmes2005memory">(<a href="16-chap.html#ref-holmes2005memory" role="doc-biblioref">Holmes et al. 2005</a>)</span>. Using the <strong><a href="https://cran.r-project.org/web/packages/pheatmap/">pheatmap</a></strong> package, make two simple heatmaps, without dendogram or reordering, for Euclidean and Manhattan distances of these data.</p>
</div>
</div>
<div id="wrn-clustering-difftrees" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.9
</div>
</div>
<div class="callout-body-container callout-body">
<p>Now, look at the differences in orderings in the hierarchical clustering trees with these two distances. What differences are noticeable?</p>
</div>
</div>
<div class="cell page-columns page-full" data-layout-nrow="1" data-layout-align="center" data-fig-cap-location="margin">
<div id="fig-treeshapes" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-treeshapes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-treeshapes" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-treeshapes-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-treeshapes-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/single14heatmap.png" class="lightbox" data-gallery="fig-treeshapes" title="Figure&nbsp;5.22&nbsp;(a): "><img src="imgs/single14heatmap.png" id="fig-treeshapes-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-treeshapes"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-treeshapes-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-treeshapes" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-treeshapes-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-treeshapes-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/average14heatmap.png" class="lightbox" data-gallery="fig-treeshapes" title="Figure&nbsp;5.22&nbsp;(b): "><img src="imgs/average14heatmap.png" id="fig-treeshapes-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-treeshapes"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-treeshapes-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-treeshapes" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-treeshapes-3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-treeshapes-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/complete14heatmap.png" class="lightbox" data-gallery="fig-treeshapes" title="Figure&nbsp;5.22&nbsp;(c): "><img src="imgs/complete14heatmap.png" id="fig-treeshapes-3" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-treeshapes"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-treeshapes-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-treeshapes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.22: Three hierarchical clustering plots made with different agglomeration choices. Note the comb-like structure for single linkage in (a). The average (b) and complete linkage (c) trees only differ by the lengths of their inner branches.
</figcaption>
</figure>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-apeclust14" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-apeclust14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/apeclust14.png" class="lightbox" data-gallery="quarto-lightbox-gallery-38" title="Figure&nbsp;5.23: This tree can be drawn in many different ways. The ordering of the leaves as it is appears here is (8,11,9,10,7,5,6,1,4,2,3)."><img src="imgs/apeclust14.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-apeclust14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.23: This tree can be drawn in many different ways. The ordering of the leaves as it is appears here is <span class="math inline">\((8,11,9,10,7,5,6,1,4,2,3)\)</span>.
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-clustering-caldermobile" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.10
</div>
</div>
<div class="callout-body-container callout-body">
<p>A hierarchical clustering tree is like the Calder mobile in <a href="#fig-mobile" class="quarto-xref">Figure&nbsp;<span>5.21</span></a> that can swing around many internal pivot points, giving many orderings of the tips consistent with a given tree. Look at the tree in <a href="#fig-apeclust14" class="quarto-xref">Figure&nbsp;<span>5.23</span></a>. How many ways are there of ordering the tip labels and still maintain consistence with that tree?</p>
</div>
</div>
<p>It is common to see heatmaps whose rows and/or columns are ordered based on a hierarchical clustering tree. Sometimes this makes some clusters look very strong – stronger than what the tree really implies. There are alternative ways of ordering the rows and columns in heatmaps, for instance, in the package <strong><a href="https://cran.r-project.org/web/packages/NeatMap/">NeatMap</a></strong>, that uses ordination methods<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> to find orderings.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;These will be explained in <a href="09-chap.html" class="quarto-xref"><span>Chapter 9</span></a>.</p></div></div></section>
</section>
<section id="sec-clustervalidation" class="level2 page-columns page-full" data-number="5.7">
<h2 data-number="5.7" class="anchored" data-anchor-id="sec-clustervalidation"><span class="header-section-number">5.7</span> Validating and choosing the number of clusters</h2>
<p>The clustering methods we have described are tailored to deliver good groupings of the data under various constraints. However, keep in mind that clustering methods will always deliver groups, even if there are none. If, in fact, there are no real clusters in the data, a hierarchical clustering tree may show relatively short inner branches; but it is difficult to quantify this. In general it is important to validate your choice of clusters with more objective criteria.</p>
<p>One criterion to assess the quality of a clustering result is to ask to what extent it maximizes the between group differences while keeping the within-group distances small (maximizing the lengths of red lines and minimizing those of the black lines in <a href="#fig-betweenwithin" class="quarto-xref">Figure&nbsp;<span>5.20</span></a>). We formalize this with the within-groups sum of squared distances (WSS):</p>
<p><span class="anchored-eq" data-anchor-id="eq-cluster" id="eq-cluster-WSS1"><span class="math display">\[
\text{WSS}_k=\sum_{\ell=1}^k \sum_{x_i \in C_\ell} d^2(x_i, \bar{x}_{\ell})
\tag{5.4}\]</span></span></p>
<p>Here, <span class="anchored-eq" data-anchor-id="eq-cluster" class="math inline">\(k\)</span> is the number of clusters, <span class="math inline">\(C_\ell\)</span> is the set of objects in the <span class="math inline">\(\ell\)</span>-th cluster, and <span class="math inline">\(\bar{x}_\ell\)</span> is the center of mass (the average point) in the <span class="math inline">\(\ell\)</span>-th cluster. We state the dependence on <span class="math inline">\(k\)</span> of the WSS in <a href="#eq-cluster-WSS1" class="quarto-xref">Equation&nbsp;<span>5.4</span></a> as we are interested in comparing this quantity across different values of <span class="math inline">\(k\)</span>, for the same cluster algorithm. Stated as it is, the WSS is however not a sufficient criterion: the smallest value of WSS would simply be obtained by making each point its own cluster. The WSS is a useful building block, but we need more sophisticated ideas than just looking at this number alone.</p>
<p>One idea is to look at <span class="math inline">\(\text{WSS}_k\)</span> as a function of <span class="math inline">\(k\)</span>. This will always be a decreasing function, but if there is a pronounced region where it decreases sharply and then flattens out, we call this an <em>elbow</em> and might take this as a potential sweet spot for the number of clusters.</p>
<div id="wrn-clustering-WSSclusters" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.11
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>An alternative expression for <span class="math inline">\(\text{WSS}_k\)</span></strong>. Use R to compute the sum of distances between all pairs of points in a cluster and compare it to <span class="math inline">\(\text{WSS}_k\)</span>. Can you see how <span class="math inline">\(\text{WSS}_k\)</span> can also be written:</p>
<p><span class="anchored-eq" data-anchor-id="eq-cluster" id="eq-cluster-WSS2"><span class="math display">\[
\text{WSS}_k=\sum_{\ell=1}^k \frac{1}{2 n_\ell} \sum_{x_i \in C_\ell} \sum_{x_j \in C_\ell} d^2(x_i,x_j),
\tag{5.5}\]</span></span></p>
<p>where <span class="math inline">\(n_\ell\)</span> is the size of the <span class="math inline">\(\ell\)</span>-th cluster.</p>
</div>
</div>
<p><a href="#wrn-clustering-WSSclusters" class="quarto-xref">Question&nbsp;<span>5.11</span></a> shows us that the within-cluster sums of squares <span class="math inline">\(\text{WSS}_k\)</span> measures both the distances of all points in a cluster to its center, and the average distance between all pairs of points in the cluster.</p>
<p>When looking at the behavior of various indices and statistics that help us decide how many clusters are appropriate for the data, it can be useful to look at cases where we actually know the right answer.</p>
<p>To start, we simulate data coming from four groups. We use the pipe (<code>%&gt;%</code>) operator and the <code>bind_rows</code> function from <strong><a href="https://cran.r-project.org/web/packages/dplyr/">dplyr</a></strong> to concatenate the four <em>tibble</em>s corresponding to each cluster into one big <em>tibble</em>.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;The pipe operator passes the value to its left into the function to its right. This can make the flow of data easier to follow in code: <code>f(x) %&gt;% g(y)</code> is equivalent to <code>g(f(x), y)</code>.</p></div></div><div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">8</span>), <span class="cf">function</span>(mx) {</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">8</span>), <span class="cf">function</span>(my) {</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span> mx, <span class="at">sd =</span> <span class="dv">2</span>),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span> my, <span class="at">sd =</span> <span class="dv">2</span>),</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">class =</span> <span class="fu">paste</span>(mx, my, <span class="at">sep =</span> <span class="st">":"</span>))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>   }) <span class="sc">%&gt;%</span> bind_rows</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> bind_rows</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>simdat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 400 × 3
        x      y class
    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;
 1 -2.42  -4.59  0:0  
 2  1.89  -1.56  0:0  
 3  0.558  2.17  0:0  
 4  2.51  -0.873 0:0  
 5 -2.52  -0.766 0:0  
 6  3.62   0.953 0:0  
 7  0.774  2.43  0:0  
 8 -1.71  -2.63  0:0  
 9  2.01   1.28  0:0  
10  2.03  -1.25  0:0  
# ℹ 390 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>simdatxy <span class="ot">=</span> simdat[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)] <span class="co"># without class label</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simdat, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">col =</span> class)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-simdat-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simdat-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-simdat-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-39" title="Figure&nbsp;5.24: The simdat data colored by the class labels. Here, we know the labels since we generated the data – usually we do not know them."><img src="05-chap_files/figure-html/fig-simdat-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="240"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simdat-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.24: The <code>simdat</code> data colored by the class labels. Here, we know the labels since we generated the data – usually we do not know them.
</figcaption>
</figure>
</div>
</div></div></div>
<p>We compute the within-groups sum of squares for the clusters obtained from the <span class="math inline">\(k\)</span>-means method:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>wss <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="at">value =</span> <span class="cn">NA_real_</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>wss<span class="sc">$</span>value[<span class="dv">1</span>] <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">scale</span>(simdatxy, <span class="at">scale =</span> <span class="cn">FALSE</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">nrow</span>(wss)) {</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  km  <span class="ot">=</span> <span class="fu">kmeans</span>(simdatxy, <span class="at">centers =</span> wss<span class="sc">$</span>k[i])</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  wss<span class="sc">$</span>value[i] <span class="ot">=</span> <span class="fu">sum</span>(km<span class="sc">$</span>withinss)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(wss, <span class="fu">aes</span>(<span class="at">x =</span> k, <span class="at">y =</span> value)) <span class="sc">+</span> <span class="fu">geom_col</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-WSS" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-WSS-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-WSS-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-40" title="Figure&nbsp;5.25: The barchart of the WSS statistic as a function of k shows that the last substantial jump is just before k=4. This indicates that the best choice for these data is k=4."><img src="05-chap_files/figure-html/fig-WSS-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="240"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-WSS-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.25: The barchart of the WSS statistic as a function of <span class="math inline">\(k\)</span> shows that the last substantial jump is just before <span class="math inline">\(k=4\)</span>. This indicates that the best choice for these data is <span class="math inline">\(k=4\)</span>.
</figcaption>
</figure>
</div>
</div></div></div>
<div id="wrn-clustering-WSSresample" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.12
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Run the code above several times and compare the <code>wss</code> values for different runs. Why are they different?<br>
</li>
<li>Create a set of data with uniform instead of normal distributions with the same range and dimensions as <code>simdat</code>. Compute the WSS values for for thess data. What do you conclude?</li>
</ol>
</div>
</div>
<div id="wrn-clustering-CalinskiHarabaszIndex" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.13
</div>
</div>
<div class="callout-body-container callout-body">
<p>The so-called <strong>Calinski-Harabasz</strong> index uses the WSS and BSS (between group sums of squares). It is inspired by the <span class="math inline">\(F\)</span> statistic — the ratio of the mean sum of squares explained by a factor to the mean residual sum of squares — used in analysis of variance:</p>
<p><span class="math display">\[
\text{CH}(k)=\frac{\text{BSS}_k}{\text{WSS}_k}\times\frac{N-k}{N-1}
\qquad \text{where} \quad \text{BSS}_k = \sum_{\ell=1}^k n_\ell(\bar{x}_{\ell}-\bar{x})^2,
\]</span></p>
<p>where <span class="math inline">\(\bar{x}\)</span> is the overall center of mass (average point). Plot the Calinski-Harabasz index for the <code>simdat</code> data.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Here is the code to generate <a href="#fig-CHIndex-1" class="quarto-xref">Figure&nbsp;<span>5.26</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"fpc"</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"cluster"</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>CH <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">sapply</span>(k, <span class="cf">function</span>(i) {</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">=</span> <span class="fu">pam</span>(simdatxy, i)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calinhara</span>(simdatxy, p<span class="sc">$</span>cluster)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(CH, <span class="fu">aes</span>(<span class="at">x =</span> k, <span class="at">y =</span> value)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"CH index"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-CHIndex-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-CHIndex-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-CHIndex-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-41" title="Figure&nbsp;5.26: The Calinski-Harabasz index, i.,e., the ratio of the between and within group variances for different choices of k, computed on the simdat data."><img src="05-chap_files/figure-html/fig-CHIndex-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:33.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-CHIndex-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.26: The Calinski-Harabasz index, i.,e., the ratio of the between and within group variances for different choices of <span class="math inline">\(k\)</span>, computed on the <code>simdat</code> data.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<section id="using-the-gap-statistic" class="level3 page-columns page-full" data-number="5.7.1">
<h3 data-number="5.7.1" class="anchored" data-anchor-id="using-the-gap-statistic"><span class="header-section-number">5.7.1</span> Using the gap statistic</h3>
<p>Taking the logarithm of the within-sum-of-squares (<span class="math inline">\(\log(\text{WSS}_k)\)</span>) and comparing it to averages from simulated data with less structure can be a good way of choosing <span class="math inline">\(k\)</span>. This is the basic idea of the <strong>gap statistic</strong> introduced by <span class="citation" data-cites="gap2001">Tibshirani, Walther, and Hastie (<a href="16-chap.html#ref-gap2001" role="doc-biblioref">2001</a>)</span>. We compute <span class="math inline">\(\log(\text{WSS}_k)\)</span> for a range of values of <span class="math inline">\(k\)</span>, the number of clusters, and compare it to that obtained on reference data of similar dimensions with various possible ‘non-clustered’ distributions. We can use uniformly distributed data as we did above or data simulated with the same covariance structure as our original data.</p>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/roulette.png" class="lightbox" data-gallery="quarto-lightbox-gallery-42"><img src="imgs/roulette.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="113"></a></p>
</figure>
</div>
</div></div></div>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">This algorithm is a Monte Carlo method that compares the gap statistic for the observed data to an average over simulations of data with similar structure.</span></div></div>
<p><strong>Algorithm for computing the gap statistic <span class="citation" data-cites="gap2001">(<a href="16-chap.html#ref-gap2001" role="doc-biblioref">Tibshirani, Walther, and Hastie 2001</a>)</span>:</strong></p>
<ol type="1">
<li><p>Cluster the data with <span class="math inline">\(k\)</span> clusters and compute <span class="math inline">\(\text{WSS}_k\)</span> for the various choices of <span class="math inline">\(k\)</span>.</p></li>
<li><p>Generate <span class="math inline">\(B\)</span> plausible reference data sets, using Monte Carlo sampling from a homogeneous distribution and redo Step 1 above for these new simulated data. This results in <span class="math inline">\(B\)</span> new within-sum-of-squares for simulated data <span class="math inline">\(W_{kb}^*\)</span>, for <span class="math inline">\(b=1,...,B\)</span>.</p></li>
<li><p>Compute the <span class="math inline">\(\text{gap}(k)\)</span>-statistic:</p></li>
</ol>
<p><span class="math display">\[
\text{gap}(k) = \overline{l}_k - \log \text{WSS}_k
\quad\text{with}\quad
\overline{l}_k =\frac{1}{B}\sum_{b=1}^B \log W^*_{kb}
\]</span></p>
<p>Note that the first term is expected to be bigger than the second one if the clustering is good (i.e., the WSS is smaller); thus the gap statistic will be mostly positive and we are looking for its highest value.</p>
<ol start="4" type="1">
<li>We can use the standard deviation</li>
</ol>
<p><span class="math display">\[
\text{sd}_k^2 = \frac{1}{B-1}\sum_{b=1}^B\left(\log(W^*_{kb})-\overline{l}_k\right)^2
\]</span></p>
<p>to help choose the best <span class="math inline">\(k\)</span>. Several choices are available, for instance, to choose the smallest <span class="math inline">\(k\)</span> such that</p>
<p><span class="math display">\[
\text{gap}(k) \geq \text{gap}(k+1) - s'_{k+1}\qquad \text{where } s'_{k+1}=\text{sd}_{k+1}\sqrt{1+1/B}.
\]</span></p>
<p>The packages <strong><a href="https://cran.r-project.org/web/packages/cluster/">cluster</a></strong> and <strong><a href="https://cran.r-project.org/web/packages/clusterCrit/">clusterCrit</a></strong> provide implementations.</p>
<div id="wrn-clustering-gapstat" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.14
</div>
</div>
<div class="callout-body-container callout-body">
<p>Make a function that plots the gap statistic as in <a href="#fig-GapStat-1" class="quarto-xref">Figure&nbsp;<span>5.27</span></a>. Show the output for the <code>simdat</code> example dataset clustered with the <code>pam</code> function.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-24-contents" aria-controls="callout-24" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-24" class="callout-24-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"cluster"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>pamfun <span class="ot">=</span> <span class="cf">function</span>(x, k)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">cluster =</span> <span class="fu">pam</span>(x, k, <span class="at">cluster.only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>gss <span class="ot">=</span> <span class="fu">clusGap</span>(simdatxy, <span class="at">FUN =</span> pamfun, <span class="at">K.max =</span> <span class="dv">8</span>, <span class="at">B =</span> <span class="dv">50</span>,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>plot_gap <span class="ot">=</span> <span class="cf">function</span>(x) {</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  gstab <span class="ot">=</span> <span class="fu">data.frame</span>(x<span class="sc">$</span>Tab, <span class="at">k =</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(x<span class="sc">$</span>Tab)))</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(gstab, <span class="fu">aes</span>(k, gap)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymax =</span> gap <span class="sc">+</span> SE.sim,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">ymin =</span> gap <span class="sc">-</span> SE.sim), <span class="at">width=</span><span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">col=</span>  <span class="st">"red"</span>)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_gap</span>(gss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-GapStat-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-GapStat-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-GapStat-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-43" title="Figure&nbsp;5.27: The gap statistic, see Question&nbsp;wrn-clustering-gapstat."><img src="05-chap_files/figure-html/fig-GapStat-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:33.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-GapStat-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.27: The gap statistic, see <a href="#wrn-clustering-gapstat" class="quarto-xref">Question&nbsp;<span>5.14</span></a>.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Let’s now use the method on a real example. We load the <strong><a href="https://bioconductor.org/packages/Hiiragi/">Hiiragi</a></strong> data that we already explored in <a href="03-chap.html" class="quarto-xref"><span>Chapter 3</span></a> and will see how the cells cluster.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"Hiiragi2013"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="warning">
<pre class="knitr r">In chunk 'Hiiragi': Warning: replacing previous import 'boot::logit' by 'gtools::logit' whenloading 'Hiiragi2013'</pre>
</div>
<div class="warning">
<pre class="knitr r">In chunk 'Hiiragi': Warning: replacing previous import 'boot::inv.logit' by 'gtools::inv.logit'when loading 'Hiiragi2013'</pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"x"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We start by choosing the 50 most variable genes (features)<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;The intention behind this step is to reduce the influence of technical (or batch) effects. Although individually small, when accumulated over all the 45101 features in <code>x</code>, many of which match genes that are weakly or not expressed, without this feature selection step, such effects are prone to suppress the biological signal.</p></div></div><div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>selFeats <span class="ot">=</span> <span class="fu">order</span>(<span class="fu">rowVars</span>(Biobase<span class="sc">::</span><span class="fu">exprs</span>(x)), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>]</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>embmat <span class="ot">=</span> <span class="fu">t</span>(Biobase<span class="sc">::</span><span class="fu">exprs</span>(x)[selFeats, ])</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>embgap <span class="ot">=</span> <span class="fu">clusGap</span>(embmat, <span class="at">FUN =</span> pamfun, <span class="at">K.max =</span> <span class="dv">24</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>k1 <span class="ot">=</span> <span class="fu">maxSE</span>(embgap<span class="sc">$</span>Tab[, <span class="st">"gap"</span>], embgap<span class="sc">$</span>Tab[, <span class="st">"SE.sim"</span>])</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>k2 <span class="ot">=</span> <span class="fu">maxSE</span>(embgap<span class="sc">$</span>Tab[, <span class="st">"gap"</span>], embgap<span class="sc">$</span>Tab[, <span class="st">"SE.sim"</span>],</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">method =</span> <span class="st">"Tibs2001SEmax"</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(k1, k2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9 7</code></pre>
</div>
</div>
<p>The default choice for the number of clusters, <code>k1</code>, is the first value of <span class="math inline">\(k\)</span> for which the gap is not larger than the first local maximum minus a standard error <span class="math inline">\(s\)</span> (see the manual page of the <code>clusGap</code> function). This gives a number of clusters <span class="math inline">\(k = 9\)</span>, whereas the choice recommended by <span class="citation" data-cites="gap2001">Tibshirani, Walther, and Hastie (<a href="16-chap.html#ref-gap2001" role="doc-biblioref">2001</a>)</span> is the smallest <span class="math inline">\(k\)</span> such that <span class="math inline">\(\text{gap}(k) \geq \text{gap}(k+1) - s_{k+1}'\)</span>, this gives <span class="math inline">\(k = 7\)</span>. Let’s plot the gap statistic (<a href="#fig-gapHiiragi-1" class="quarto-xref">Figure&nbsp;<span>5.28</span></a>).</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(embgap, <span class="at">main =</span> <span class="st">""</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span> <span class="fu">pamfun</span>(embmat, <span class="at">k =</span> k1)<span class="sc">$</span>cluster</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">pData</span>(x)[<span class="fu">names</span>(cl), <span class="st">"sampleGroup"</span>], cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 cl
                   1  2  3  4  5  6  7  8  9
  E3.25           23 11  1  1  0  0  0  0  0
  E3.25 (FGF4-KO)  0  0  1 16  0  0  0  0  0
  E3.5 (EPI)       2  1  0  0  0  8  0  0  0
  E3.5 (FGF4-KO)   0  0  8  0  0  0  0  0  0
  E3.5 (PE)        0  0  0  0  9  2  0  0  0
  E4.5 (EPI)       0  0  0  0  0  0  0  4  0
  E4.5 (FGF4-KO)   0  0  0  0  0  0  0  0 10
  E4.5 (PE)        0  0  0  0  0  0  4  0  0</code></pre>
</div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-gapHiiragi-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gapHiiragi-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-gapHiiragi-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-44" title="Figure&nbsp;5.28: The gap statistic for the Hiiragi2013 data."><img src="05-chap_files/figure-html/fig-gapHiiragi-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="360"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gapHiiragi-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.28: The gap statistic for the <strong><a href="https://bioconductor.org/packages/Hiiragi2013/">Hiiragi2013</a></strong> data.
</figcaption>
</figure>
</div>
</div></div></div>
<p>Above we see the comparison between the clustering that we got from <code>pamfun</code> with the sample labels in the annotation of the data.</p>
<div id="wrn-clustering-noselFeats" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.15
</div>
</div>
<div class="callout-body-container callout-body">
<p>How do the results change if you use all the features in <code>x</code>, rather than subsetting the top 50 most variable genes?</p>
</div>
</div>
</section>
<section id="cluster-validation-using-the-bootstrap" class="level3 page-columns page-full" data-number="5.7.2">
<h3 data-number="5.7.2" class="anchored" data-anchor-id="cluster-validation-using-the-bootstrap"><span class="header-section-number">5.7.2</span> Cluster validation using the bootstrap</h3>
<div class="cell page-columns page-full" data-layout-nrow="1" data-layout-align="center" data-fig-cap-location="margin">
<div id="fig-BootstrapClusterNew" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-BootstrapClusterNew-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-BootstrapClusterNew" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-BootstrapClusterNew-1" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-BootstrapClusterNew-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/BootstrapClusterNew.png" class="lightbox" data-gallery="fig-BootstrapClusterNew" title="Figure&nbsp;5.29&nbsp;(a): "><img src="imgs/BootstrapClusterNew.png" id="fig-BootstrapClusterNew-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-BootstrapClusterNew"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-BootstrapClusterNew-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-BootstrapClusterNew" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-BootstrapClusterNew-2" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-BootstrapClusterNew-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="imgs/BootstrapCluster2New.png" class="lightbox" data-gallery="fig-BootstrapClusterNew" title="Figure&nbsp;5.29&nbsp;(b): "><img src="imgs/BootstrapCluster2New.png" id="fig-BootstrapClusterNew-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-BootstrapClusterNew"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-BootstrapClusterNew-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-BootstrapClusterNew-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.29: Different samples from the same distribution <span class="math inline">\(F\)</span> lead to different clusterings. In (a), we see the true sampling variability. The bootstrap simulates this sampling variability by drawing subsamples using the empirical distribution function <span class="math inline">\(\hat{F}_n\)</span> as shown in (b).
</figcaption>
</figure>
</div>
</div>
<p>We saw the bootstrap principle in <a href="04-chap.html" class="quarto-xref"><span>Chapter 4</span></a>: ideally, we would like to use many new samples (sets of data) from the underlying data generating process, for each of them apply our clustering method, and then see how stable the clusterings are, or how much they change, using an index such as those we used above to compare clusterings. Of course, we don’t have these additional samples. So we are, in fact, going to create new datasets simply by taking different random subsamples of the data, look at the different clusterings we get each time, and compare them. <span class="citation" data-cites="gap2001">Tibshirani, Walther, and Hastie (<a href="16-chap.html#ref-gap2001" role="doc-biblioref">2001</a>)</span> recommend using bootstrap resampling to infer the number of clusters using the gap statistic.</p>
<p>We will continue using the <strong><a href="https://bioconductor.org/packages/Hiiragi2013/">Hiiragi2013</a></strong> data. Here we follow the investigation of the hypothesis that the inner cell mass (ICM) of the mouse blastocyst in embyronic day 3.5 (E3.5) falls “naturally” into two clusters corresponding to pluripotent epiblast (EPI) versus primitive endoderm (PE), while the data for embryonic day 3.25 (E3.25) do not yet show this symmetry breaking.</p>
<p>We will not use the true group labels in our clustering and only use them in the final interpretation of the results. We will apply the bootstrap to the two different data sets (E3.5) and (E3.25) separately. Each step of the bootstrap will generate a clustering of a random subset of the data and we will need to compare these through a consensus of an ensemble of clusters. There is a useful framework for this in the <strong><a href="https://cran.r-project.org/web/packages/clue/">clue</a></strong> package <span class="citation" data-cites="Hornik2005">(<a href="16-chap.html#ref-Hornik2005" role="doc-biblioref">Hornik 2005</a>)</span>. The function <code>clusterResampling</code>, taken from the supplement of <span class="citation" data-cites="Ohnishi2014">Ohnishi et al. (<a href="16-chap.html#ref-Ohnishi2014" role="doc-biblioref">2014</a>)</span>, implements this approach:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>clusterResampling <span class="ot">=</span> <span class="cf">function</span>(x, <span class="at">ngenes =</span> <span class="dv">50</span>, <span class="at">k =</span> <span class="dv">2</span>, <span class="at">B =</span> <span class="dv">250</span>,</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">prob =</span> <span class="fl">0.67</span>) {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">=</span> Biobase<span class="sc">::</span><span class="fu">exprs</span>(x)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  ce <span class="ot">=</span> <span class="fu">cl_ensemble</span>(<span class="at">list =</span> <span class="fu">lapply</span>(<span class="fu">seq_len</span>(B), <span class="cf">function</span>(b) {</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    selSamps <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">ncol</span>(mat), <span class="at">size =</span> <span class="fu">round</span>(prob <span class="sc">*</span> <span class="fu">ncol</span>(mat)),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    submat <span class="ot">=</span> mat[, selSamps, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    sel <span class="ot">=</span> <span class="fu">order</span>(<span class="fu">rowVars</span>(submat), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="fu">seq_len</span>(ngenes)]</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    submat <span class="ot">=</span> submat[sel,, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    pamres <span class="ot">=</span> <span class="fu">pam</span>(<span class="fu">t</span>(submat), <span class="at">k =</span> k)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">=</span> <span class="fu">cl_predict</span>(pamres, <span class="fu">t</span>(mat[sel, ]), <span class="st">"memberships"</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.cl_partition</span>(pred)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  cons <span class="ot">=</span> <span class="fu">cl_consensus</span>(ce)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  ag <span class="ot">=</span> <span class="fu">sapply</span>(ce, cl_agreement, <span class="at">y =</span> cons)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">agreements =</span> ag, <span class="at">consensus =</span> cons)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function <code>clusterResampling</code> performs the following steps:</p>
<ol type="1">
<li><p>Draw a random subset of the data (the data are either all E3.25 or all E3.5 samples) by selecting 67% of the samples without replacement.</p></li>
<li><p>Select the top <code>ngenes</code> features by overall variance (in the subset).</p></li>
<li><p>Apply <span class="math inline">\(k\)</span>-means clustering and predict the cluster memberships of the samples that were not in the subset with the <code>cl_predict</code> method from the <strong><a href="https://cran.r-project.org/web/packages/clue/">clue</a></strong> package, through their proximity to the cluster centres.</p></li>
<li><p>Repeat steps 1-3 <code>B</code> times.</p></li>
<li><p>Apply consensus clustering (<code>cl_consensus</code>).</p></li>
<li><p>For each of the <code>B</code> clusterings, measure the agreement with the consensus through the function(<code>cl_agreement</code>). Here a good agreement is indicated by a value of 1, and less agreement by smaller values. If the agreement is generally high, then the clustering into <span class="math inline">\(k\)</span> classes can be considered stable and reproducible; inversely, if it is low, then no stable partition of the samples into <span class="math inline">\(k\)</span> clusters is evident.</p></li>
</ol>
<p>As a measure of between-cluster distance for the consensus clustering, the <em>Euclidean</em> dissimilarity of the memberships is used, i.e., the square root of the minimal sum of the squared differences of <span class="math inline">\(\mathbf{u}\)</span> and all column permutations of <span class="math inline">\(\mathbf{v}\)</span>, where <span class="math inline">\(\mathbf{u}\)</span> and <span class="math inline">\(\mathbf{v}\)</span> are the cluster membership matrices. As agreement measure for Step [clueagree], the quantity <span class="math inline">\(1 - d/m\)</span> is used, where <span class="math inline">\(d\)</span> is the Euclidean dissimilarity, and <span class="math inline">\(m\)</span> is an upper bound for the maximal Euclidean dissimilarity.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>iswt <span class="ot">=</span> (x<span class="sc">$</span>genotype <span class="sc">==</span> <span class="st">"WT"</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>cr1 <span class="ot">=</span> <span class="fu">clusterResampling</span>(x[, x<span class="sc">$</span>Embryonic.day <span class="sc">==</span> <span class="st">"E3.25"</span> <span class="sc">&amp;</span> iswt])</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>cr2 <span class="ot">=</span> <span class="fu">clusterResampling</span>(x[, x<span class="sc">$</span>Embryonic.day <span class="sc">==</span> <span class="st">"E3.5"</span>  <span class="sc">&amp;</span> iswt])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results are shown in <a href="#fig-figClue1" class="quarto-xref">Figure&nbsp;<span>5.30</span></a>. They confirm the hypothesis that the E.35 data fall into two clusters.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb54" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>ag1 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">agreements =</span> cr1<span class="sc">$</span>agreements, <span class="at">day =</span> <span class="st">"E3.25"</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>ag2 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">agreements =</span> cr2<span class="sc">$</span>agreements, <span class="at">day =</span> <span class="st">"E3.5"</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">bind_rows</span>(ag1, ag2), <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> agreements)) <span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  ggbeeswarm<span class="sc">::</span><span class="fu">geom_beeswarm</span>(<span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">col =</span> <span class="st">"#0000ff40"</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>mem1 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">y =</span> <span class="fu">sort</span>(<span class="fu">cl_membership</span>(cr1<span class="sc">$</span>consensus)[, <span class="dv">1</span>]),</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">x =</span> <span class="fu">seq</span>(<span class="at">along =</span> y), <span class="at">day =</span> <span class="st">"E3.25"</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>mem2 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">y =</span> <span class="fu">sort</span>(<span class="fu">cl_membership</span>(cr2<span class="sc">$</span>consensus)[, <span class="dv">1</span>]),</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">x =</span> <span class="fu">seq</span>(<span class="at">along =</span> y), <span class="at">day =</span> <span class="st">"E3.5"</span>)</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">bind_rows</span>(mem1, mem2), <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">col =</span> day)) <span class="sc">+</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">facet_grid</span>(<span class="sc">~</span> day, <span class="at">scales =</span> <span class="st">"free_x"</span>)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p1, p2, <span class="at">widths =</span> <span class="fu">c</span>(<span class="fl">2.4</span>,<span class="fl">4.0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div id="fig-figClue1" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center" data-cap-location="margin">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-figClue1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-figClue1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-47" title="Figure&nbsp;5.30: Cluster stability analysis with E3.25 and E3.5 samples. Left: beeswarm plots of the cluster agreements with the consensus, for the B clusterings; 1 indicates perfect agreement, lower values indicate lower degrees of agreement. Right: membership probabilities of the consensus clustering. For E3.25, the probabilities are diffuse, indicating that the individual clusterings often disagree, whereas for E3.5, the distribution is bimodal, with only one ambiguous sample."><img src="05-chap_files/figure-html/fig-figClue1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="640"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-figClue1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.30: Cluster stability analysis with E3.25 and E3.5 samples. Left: beeswarm plots of the cluster agreements with the consensus, for the <code>B</code> clusterings; <span class="math inline">\(1\)</span> indicates perfect agreement, lower values indicate lower degrees of agreement. Right: membership probabilities of the consensus clustering. For E3.25, the probabilities are diffuse, indicating that the individual clusterings often disagree, whereas for E3.5, the distribution is bimodal, with only one ambiguous sample.
</figcaption>
</figure>
</div>
</div>
</div>
<section id="computational-and-memory-issues" class="level4 unnumbered page-columns page-full">
<h4 class="unnumbered anchored" data-anchor-id="computational-and-memory-issues">Computational and memory Issues</h4>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/devil.png" class="lightbox" data-gallery="quarto-lightbox-gallery-48" title="Computational complexity. An algorithm is said to be O(n^k), if, as n gets larger, the resource consumption (CPU time or memory) grows proportionally to n^k. There may be other (sometimes considerable) baseline costs, or costs that grow proportionally to lower powers of n, but these always become negligible compared to the leading term as n\to\infty."><img src="imgs/devil.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="123" alt="Computational complexity. An algorithm is said to be O(n^k), if, as n gets larger, the resource consumption (CPU time or memory) grows proportionally to n^k. There may be other (sometimes considerable) baseline costs, or costs that grow proportionally to lower powers of n, but these always become negligible compared to the leading term as n\to\infty."></a></p>
</figure>
</div>
<figcaption><strong>Computational complexity</strong>. An algorithm is said to be <span class="math inline">\(O(n^k)\)</span>, if, as <span class="math inline">\(n\)</span> gets larger, the resource consumption (CPU time or memory) grows proportionally to <span class="math inline">\(n^k\)</span>. There may be other (sometimes considerable) baseline costs, or costs that grow proportionally to lower powers of <span class="math inline">\(n\)</span>, but these always become negligible compared to the leading term as <span class="math inline">\(n\to\infty\)</span>.</figcaption>
</figure>
</div>
</div></div></div>
<p>It is important to remember that the computation of all versus all distances of <span class="math inline">\(n\)</span> objects is an <span class="math inline">\(O(n^2)\)</span> operation (in time and memory). Classic hierarchical clustering approaches (such as <code>hclust</code> in the <strong><a href="https://cran.r-project.org/web/packages/stats/">stats</a></strong> package) are even <span class="math inline">\(O(n^3)\)</span> in time. For large <span class="math inline">\(n\)</span>, this may become impractical<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>. We can avoid the complete computation of the all-vs-all distance matrix. For instance, <span class="math inline">\(k\)</span>-means has the advantage of only requiring <span class="math inline">\(O(n)\)</span> computations, since it only keeps track of the distances between each object and the cluster centers, whose number remains the same even if <span class="math inline">\(n\)</span> increases.</p>
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;E.g., the distance matrix for one million objects, stored as 8-byte floating point numbers, would take up about 4 Terabytes, and an <code>hclust</code>-like algorithm would run 30 years even under the optimistic assumption that each of the iterations only takes a nanosecond.</p></div></div><p>Fast implementations such as <strong><a href="https://cran.r-project.org/web/packages/fastclust/">fastclust</a></strong> <span class="citation" data-cites="Mullner:2013">(<a href="16-chap.html#ref-Mullner:2013" role="doc-biblioref">Müllner 2013</a>)</span> and <strong><a href="https://cran.r-project.org/web/packages/dbscan/">dbscan</a></strong> have been carefully optimized to deal with a large number of observations.</p>
</section>
</section>
</section>
<section id="clustering-as-a-means-for-denoising" class="level2 page-columns page-full" data-number="5.8">
<h2 data-number="5.8" class="anchored" data-anchor-id="clustering-as-a-means-for-denoising"><span class="header-section-number">5.8</span> Clustering as a means for denoising</h2>
<p>Consider a set of measurements that reflect some underlying true values (say, species represented by DNA sequences from their genomes), but have been degraded by technical noise. Clustering can be used to remove such noise.</p>
<section id="subsection:dada2" class="level3 page-columns page-full" data-number="5.8.1">
<h3 data-number="5.8.1" class="anchored" data-anchor-id="subsection:dada2"><span class="header-section-number">5.8.1</span> Noisy observations with different baseline frequencies</h3>
<p>Suppose that we have a bivariate distribution of observations made with the same error variances. However, the sampling is from two groups that have very different baseline frequencies. Suppose, further, that the errors are continuous independent bivariate normally distributed. We have <span class="math inline">\(10^{3}\)</span> of <code>seq1</code> and <span class="math inline">\(10^{5}\)</span> of <code>seq2</code>, as generated for instance by the code:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mixtools"</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>seq1 <span class="ot">=</span> <span class="fu">rmvnorm</span>(<span class="at">n =</span> <span class="fl">1e3</span>, <span class="at">mu =</span> <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">sigma =</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">diag</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)))</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>seq2 <span class="ot">=</span> <span class="fu">rmvnorm</span>(<span class="at">n =</span> <span class="fl">1e5</span>, <span class="at">mu =</span>  <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">sigma =</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">diag</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)))</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>twogr <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(seq1, seq2),</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">seq =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(seq1)),</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">rep</span>(<span class="dv">2</span>, <span class="fu">nrow</span>(seq2))))</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(twogr)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(twogr, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">colour =</span> seq,<span class="at">fill =</span> seq)) <span class="sc">+</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hex</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">bins =</span> <span class="dv">50</span>) <span class="sc">+</span> <span class="fu">coord_fixed</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-seqradius" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-seqradius-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-seqradius-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-49" title="Figure&nbsp;5.31: Although both groups have noise distributions with the same variances, the apparent radii of the groups are very different. The 10^{5} instances in seq2 have many more opportunities for errors than what we see in seq1, of which there are only 10^{3}. Thus we see that frequencies are important in clustering the data."><img src="05-chap_files/figure-html/fig-seqradius-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="248"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-seqradius-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.31: Although both groups have noise distributions with the same variances, the apparent radii of the groups are very different. The <span class="math inline">\(10^{5}\)</span> instances in <code>seq2</code> have many more opportunities for errors than what we see in <code>seq1</code>, of which there are only <span class="math inline">\(10^{3}\)</span>. Thus we see that frequencies are important in clustering the data.
</figcaption>
</figure>
</div>
</div></div></div>
<p>The observed values would look as in <a href="#fig-seqradius" class="quarto-xref">Figure&nbsp;<span>5.31</span></a>.</p>
<div id="wrn-clustering-hardthreshold" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.16
</div>
</div>
<div class="callout-body-container callout-body">
<p>Take the data <code>seq1</code> and <code>seq2</code> and cluster them into two groups according to distance from group center. Do you think the results should depend on the frequencies of each of the two sequence types?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-27-contents" aria-controls="callout-27" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-27" class="callout-27-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Such an approach, often used in taxonomic clustering, also called OTU -operational taxonomic unit clustering <span class="citation" data-cites="caporaso2010qiime mothur">(<a href="16-chap.html#ref-caporaso2010qiime" role="doc-biblioref">Caporaso et al. 2010</a>; <a href="16-chap.html#ref-mothur" role="doc-biblioref">P. D. Schloss et al. 2009</a>)</span>) methods is sub-optimal.</p>
<p>The methods based solely on similarities suffer from the biases inherent in the <em>representativeness</em> heuristic. Let’s make a brief digression into the world of cognitive psychology that helps explain how our natural inclination to use only representativeness and a distance-based heuristic in clustering and taxonomic assignment can lead to biased results.</p>
<p>In the 1970s, <span class="citation" data-cites="tversky1975judgment">Tversky and Kahneman (<a href="16-chap.html#ref-tversky1975judgment" role="doc-biblioref">1975</a>)</span> pointed out that we generally assign groups by looking at the most similar <em>representatives</em>. In clustering and group assignments that would mean assigning a new sequence to the group according to the distance to its center. In fact this is equivalent to taking balls with the same radius regardless of the differences in prevalence of the different groups. This psychological error was first discussed in an important Science paper that covers many different heuristics and biases<span class="citation" data-cites="tversky1974heuristics">(<a href="16-chap.html#ref-tversky1974heuristics" role="doc-biblioref">Tversky and Kahneman 1974</a>)</span>.</p>
</div>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/book_icon.png" class="lightbox" data-gallery="quarto-lightbox-gallery-50" title="See @kahneman2011 for a book-length treatment of our natural heuristics and the ways in which they can mislead us when we make probability calculations (we recommend especially Chapters 14 and 15)."><img src="imgs/book_icon.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="126" alt="See Kahneman (2011) for a book-length treatment of our natural heuristics and the ways in which they can mislead us when we make probability calculations (we recommend especially Chapters 14 and 15)."></a></p>
</figure>
</div>
<figcaption>See <span class="citation" data-cites="kahneman2011">Kahneman (<a href="16-chap.html#ref-kahneman2011" role="doc-biblioref">2011</a>)</span> for a book-length treatment of our natural heuristics and the ways in which they can mislead us when we make probability calculations (we recommend especially Chapters 14 and 15).</figcaption>
</figure>
</div>
</div></div></div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Simulate <code>n=2000</code> binary variables of length <code>len=200</code> that indicate the quality of <code>n</code> sequencing reads of length <code>len</code>. For simplicity, let us assume that sequencing errors occur independently and uniformly with probability <code>perr=0.001</code>. That is, we only care whether a base was called correctly (<code>TRUE</code>) or not (<code>FALSE</code>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>n    <span class="ot">=</span> <span class="dv">2000</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>len  <span class="ot">=</span> <span class="dv">200</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>perr <span class="ot">=</span> <span class="fl">0.001</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>seqs <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(n <span class="sc">*</span> len) <span class="sc">&gt;=</span> perr, <span class="at">nrow =</span> n, <span class="at">ncol =</span> len)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, compute all pairwise distances between reads.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dists <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(seqs, <span class="at">method =</span> <span class="st">"manhattan"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For various values of number of reads <code>k</code> (from 2 to <code>n</code>), the maximum distance within this set of reads is computed by the code below and shown in <a href="#fig-diameter" class="quarto-xref">Figure&nbsp;<span>5.32</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tibble"</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>dfseqs <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">10</span> <span class="sc">^</span> <span class="fu">seq</span>(<span class="fu">log10</span>(<span class="dv">2</span>), <span class="fu">log10</span>(n), <span class="at">length.out =</span> <span class="dv">20</span>),</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">diameter =</span> <span class="fu">vapply</span>(k, <span class="cf">function</span>(i) {</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">=</span> <span class="fu">sample</span>(n, i)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">max</span>(dists[s, s])</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    }, <span class="fu">numeric</span>(<span class="dv">1</span>)))</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfseqs, <span class="fu">aes</span>(<span class="at">x =</span> k, <span class="at">y =</span> diameter)) <span class="sc">+</span> <span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">geom_smooth</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-diameter" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-diameter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-diameter-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-51" title="Figure&nbsp;5.32: The diameter of a set of sequences as a function of the number of sequences."><img src="05-chap_files/figure-html/fig-diameter-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-diameter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.32: The diameter of a set of sequences as a function of the number of sequences.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>We will now improve the 16SrRNA-read clustering using a denoising mechanism that incorporates error probabilities.</p>
</section>
<section id="denoising-16s-rrna-sequences" class="level3 page-columns page-full" data-number="5.8.2">
<h3 data-number="5.8.2" class="anchored" data-anchor-id="denoising-16s-rrna-sequences"><span class="header-section-number">5.8.2</span> Denoising 16S rRNA sequences</h3>
<p><strong>What are the data?</strong> In the bacterial 16SrRNA gene there are so-called <strong>variable regions</strong> that are taxa-specific. These provide fingerprints that enables <em>taxon</em><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> identification. The raw data are FASTQ-files with quality scored sequences of PCR-amplified DNA regions<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>. We use an iterative alternating approach<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> to build a probabilistic noise model from the data. We call this a <em>de novo</em> method, because we use clustering, and we use the cluster centers as our denoised sequence variants (a.k.a. Amplicon Sequence Variants, ASVs, see <span class="citation" data-cites="Callahan:2017">(<a href="16-chap.html#ref-Callahan:2017" role="doc-biblioref">Benjamin J. Callahan, McMurdie, and Holmes 2017</a>)</span>). After finding all the denoised variants, we create contingency tables of their counts across the different samples. We will show in <a href="10-chap.html" class="quarto-xref"><span>Chapter 10</span></a> how these tables can be used to infer properties of the underlying bacterial communities using networks and graphs.</p>
<div class="no-row-height column-margin column-container"><div id="fn9"><p><sup>9</sup>&nbsp;Calling different groups of bacteria <em>taxa</em> rather than <em>species</em> highlights the approximate nature of the concept, as the notion of species is more fluid in bacteria than, say, in animals.</p></div><div id="fn10"><p><sup>10</sup>&nbsp;The <a href="https://en.wikipedia.org/wiki/FASTQ_format">FASTQ format is described here</a>.</p></div><div id="fn11"><p><sup>11</sup>&nbsp;Similar to the EM algorithm we saw in <a href="04-chap.html" class="quarto-xref"><span>Chapter 4</span></a>.</p></div></div><p>In order to improve data quality, one often has to start with the raw data and model all the sources of variation carefully. One can think of this as an example of <em>cooking from scratch</em> (see the gruesome details in <span class="citation" data-cites="Callahan2016Bioc">Ben J. Callahan et al. (<a href="16-chap.html#ref-Callahan2016Bioc" role="doc-biblioref">2016</a>)</span> and <a href="#imp-clustering-dada2" class="quarto-xref">Exercise&nbsp;<span>5.5</span></a>).</p>
<div id="wrn-clustering-seqerror" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.17
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose that we have two sequences of length 200 (<code>seq1</code> and <code>seq2</code>) present in our sample at very different abundances. We are told that the technological sequencing errors occur as independent Bernoulli(0.0005) random events for each nucleotide.<br>
What is the distribution of the number of errors per sequence?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-30-contents" aria-controls="callout-30" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-30" class="callout-30-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Probability theory tells us that the sum of 200 independent Poisson(0.0005) will be Poisson(0.1).</p>
<p>We can also verify this by Monte Carlo simulation:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>simseq10K <span class="ot">=</span> <span class="fu">replicate</span>(<span class="fl">1e5</span>, <span class="fu">sum</span>(<span class="fu">rpois</span>(<span class="dv">200</span>, <span class="fl">0.0005</span>)))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(simseq10K)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.10143</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>vcd<span class="sc">::</span><span class="fu">distplot</span>(simseq10K, <span class="st">"poisson"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-seqradiusex" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-seqradiusex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-seqradiusex-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-52" title="Figure&nbsp;5.33: distplot for the simseq10K data."><img src="05-chap_files/figure-html/fig-seqradiusex-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-seqradiusex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.33: <code>distplot</code> for the <code>simseq10K</code> data.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p><a href="#fig-seqradiusex" class="quarto-xref">Figure&nbsp;<span>5.33</span></a> shows us how close the distribution is to being Poisson distributed.</p>
</section>
<section id="infer-sequence-variants" class="level3 page-columns page-full" data-number="5.8.3">
<h3 data-number="5.8.3" class="anchored" data-anchor-id="infer-sequence-variants"><span class="header-section-number">5.8.3</span> Infer sequence variants</h3>
<p>The DADA method (Divisive Amplicon Denoising Algorithm, <span class="citation" data-cites="Rosen:2012">Rosen et al. (<a href="16-chap.html#ref-Rosen:2012" role="doc-biblioref">2012</a>)</span>) uses a parameterized model of substitution errors that distinguishes sequencing errors from real biological variation. The model computes the probabilities of base substitutions, such as seeing an <span class="math inline">\({\tt A}\)</span> instead of a <span class="math inline">\({\tt C}\)</span>. It assumes that these probabilities are independent of the position along the sequence. Because error rates vary substantially between sequencing runs and PCR protocols, the model parameters are estimated from the data themselves using an EM-type approach. A read is classified as noisy or exact given the current parameters, and the noise model parameters are updated accordingly<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn12"><p><sup>12</sup>&nbsp;In the case of a large data set, the noise model estimation step does not have to be done on the complete set. See <a href="https://benjjneb.github.io/dada2/bigdata.html" class="uri">https://benjjneb.github.io/dada2/bigdata.html</a> for tricks and tools when dealing with large data sets.</p></div><div id="fn13"><p><sup>13</sup>&nbsp;F stands for forward strand and R for reverse strand.</p></div></div><p>The dereplicated sequences<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> are read in and then divisive denoising and estimation is run with the <code>dada</code> function as in the following code:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>derepFs <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="at">file=</span><span class="st">"../data/derepFs.rds"</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>derepRs <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="at">file=</span><span class="st">"../data/derepRs.rds"</span>)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dada2"</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>ddF <span class="ot">=</span> <span class="fu">dada</span>(derepFs, <span class="at">err =</span> <span class="cn">NULL</span>, <span class="at">selfConsist =</span> <span class="cn">TRUE</span>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>ddR <span class="ot">=</span> <span class="fu">dada</span>(derepRs, <span class="at">err =</span> <span class="cn">NULL</span>, <span class="at">selfConsist =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to verify that the error transition rates have been reasonably well estimated, we inspect the fit between the observed error rates (black points) and the fitted error rates (black lines) (<a href="#fig-rerrorprofile1" class="quarto-xref">Figure&nbsp;<span>5.34</span></a>).</p>
<div class="cell page-columns page-full" data-layout-align="center" data-warning.known="transformation introduced infinite values">
<div class="sourceCode cell-code" id="cb63" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotErrors</span>(ddF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="warning">
<pre class="knitr r">In chunk 'fig-rerrorprofile1': Warning: Removed 82 rows containing missing values or values outside the scale range(`geom_line()`).</pre>
</div>
<div class="cell-output-display page-columns page-full">
<div id="fig-rerrorprofile1" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center" data-cap-location="margin">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-rerrorprofile1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-rerrorprofile1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-53" title="Figure&nbsp;5.34: Forward transition error rates as provided by plotErrors(ddF). This shows the frequencies of each type of nucleotide transition as a function of quality."><img src="05-chap_files/figure-html/fig-rerrorprofile1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-rerrorprofile1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.34: Forward transition error rates as provided by <code>plotErrors(ddF)</code>. This shows the frequencies of each type of nucleotide transition as a function of quality.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Once the errors have been estimated, the algorithm is rerun on the data to find the sequence variants:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>dadaFs <span class="ot">=</span> <span class="fu">dada</span>(derepFs, <span class="at">err=</span>ddF[[<span class="dv">1</span>]]<span class="sc">$</span>err_out, <span class="at">pool =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>dadaRs <span class="ot">=</span> <span class="fu">dada</span>(derepRs, <span class="at">err=</span>ddR[[<span class="dv">1</span>]]<span class="sc">$</span>err_out, <span class="at">pool =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Note:</strong> The sequence inference function can run in two different modes: Independent inference by sample (<code>pool = FALSE</code>), and pooled inference from the sequencing reads combined from all samples. Independent inference has two advantages: as a functions of the number of samples, computation time is linear and memory requirements are constant. Pooled inference is more computationally taxing, however it can improve the detection of rare variants that occur just once or twice in an individual sample but more often across all samples. As this dataset is not particularly large, we performed pooled inference.</p>
<p>Sequence inference removes nearly all substitution and <strong>indel</strong><a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> errors from the data. We merge the inferred forward and reverse sequences, while removing paired sequences that do not perfectly overlap as a final control against residual errors.</p>
<div class="no-row-height column-margin column-container"><div id="fn14"><p><sup>14</sup>&nbsp;The term <em>indel</em> stands for insertion-deletion; when comparing two sequences that differ by a small stretch of characters, it is a matter of viewpoint whether this is an insertion or a deletion, thus the name.</p></div></div><div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>mergers <span class="ot">=</span> <span class="fu">mergePairs</span>(dadaFs, derepFs, dadaRs, derepRs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We produce a contingency table of counts of ASVs. This is a higher-resolution analogue of the “OTU<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a> table”, i.e., a samples by features table whose cells contain the number of times each sequence variant was observed in each sample.</p>
<div class="no-row-height column-margin column-container"><div id="fn15"><p><sup>15</sup>&nbsp;operational taxonomic units</p></div></div><div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>seqtab.all <span class="ot">=</span> <span class="fu">makeSequenceTable</span>(mergers[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"Mock"</span>,<span class="fu">names</span>(mergers))])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="wrn-clustering-merger" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.18
</div>
</div>
<div class="callout-body-container callout-body">
<p>Explore the components of the objects <code>dadaRs</code> and <code>mergers</code>.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-32-contents" aria-controls="callout-32" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-32" class="callout-32-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>dadaRs</code> is a list of length 20. Its elements are objects class <em>dada</em> that contain the denoised reads. We will see in <a href="10-chap.html" class="quarto-xref"><span>Chapter 10</span></a> how to align the sequences, assign their taxonomies and combine them with the sample information for downstream analyses.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "F3D0"   "F3D1"   "F3D141" "F3D142" "F3D143" "F3D144" "F3D145" "F3D146"
 [9] "F3D147" "F3D148" "F3D149" "F3D150" "F3D2"   "F3D3"   "F3D5"   "F3D6"  
[17] "F3D7"   "F3D8"   "F3D9"   "Mock"  </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Chimera are sequences that are artificially created during PCR amplification by the melding of two (in rare cases, more) of the original sequences. To complete our denoising workflow, we remove them with a call to the function <code>removeBimeraDenovo</code>, leaving us with a clean contingency table we will use later on.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>seqtab <span class="ot">=</span> <span class="fu">removeBimeraDenovo</span>(seqtab.all)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="wrn-clustering-chimera" class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question&nbsp;5.19
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why do you think the chimera are quite easy to recognize?<br>
What proportion of the reads were chimeric in the <code>seqtab.all</code> data?<br>
What proportion of unique sequence variants are chimeric?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-34-contents" aria-controls="callout-34" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-34" class="callout-34-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Here we observed some sequence variants as chimeric, but these only represent 7% of all reads.</p>
</div>
</div>
</div>
</section>
</section>
<section id="summary-of-this-chapter" class="level2" data-number="5.9">
<h2 data-number="5.9" class="anchored" data-anchor-id="summary-of-this-chapter"><span class="header-section-number">5.9</span> Summary of this chapter</h2>
<p><strong>Of a feather: how to compare observations</strong> We saw at the start of the chapter how finding the <strong>right distance</strong> is an essential first step in a clustering analysis; this is a case where the <em>garbage in, garbage out</em> motto is in full force. Always choose a distance that is scientifically meaningful and compare output from as many distances as possible; sometimes the same data require different distances when different scientific objectives are pursued.</p>
<p><strong>Two ways of clustering</strong> We saw there are two approaches to clustering:</p>
<ul>
<li><p>iterative partitioning approaches such as <span class="math inline">\(k\)</span>-means and <span class="math inline">\(k\)</span>-medoids (PAM) that alternated between estimating the cluster centers and assigning points to them;<br>
</p></li>
<li><p>hierarchical clustering approaches that first agglomerate points, and subsequently the growing clusters, into nested sequences of sets that can be represented by hierarchical clustering <em>trees</em>.</p></li>
</ul>
<p><strong>Biological examples</strong> Clustering is important tool for finding latent classes in single cell measurements, especially in immunology and single cell data analyses. We saw how density-based clustering is useful for lower dimensional data where sparsity is not an issue.</p>
<p><strong>Validating</strong> Clustering algorithms <em>always</em> deliver clusters, so we need to assess their quality and the number of clusters to choose carefully. Such validation steps are performed using visualization tools and repeating the clustering on many resamples of the data. We saw how statistics such as WSS/BSS or <span class="math inline">\(\log(\text{WSS})\)</span> can be calibrated using simulations on data where we understand the group structure and can provide useful benchmarks for choosing the number of clusters on new data. Of course, the use of biologically relevant information to inform and confirm the meaning of clusters is always the best validation approach.</p>
<p>There is arguably no ground truth to compare a clustering result against, in general. The old adage of “all models are wrong, some are useful” also applies here. A good clustering is one that turns out to be useful.</p>
<p><strong>Distances and probabilities</strong> Finally: distances are not everything. We showed how important it was to take into account baseline frequencies and local densities when clustering. This is essential in a cases such as clustering to denoise 16S rRNA sequence reads where the true class or taxa group occur at very different frequencies.</p>
</section>
<section id="further-reading" class="level2" data-number="5.10">
<h2 data-number="5.10" class="anchored" data-anchor-id="further-reading"><span class="header-section-number">5.10</span> Further reading</h2>
<p>For a complete book on <em>Finding groups in data</em>, see <span class="citation" data-cites="Kaufman2009">Kaufman and Rousseeuw (<a href="16-chap.html#ref-Kaufman2009" role="doc-biblioref">2009</a>)</span>. The vignette of the <strong><a href="https://bioconductor.org/packages/clusterExperiment/">clusterExperiment</a></strong> package contains a complete workflow for generating clusters using many different techniques, including preliminary dimension reduction (PCA) that we will cover in <a href="07-chap.html" class="quarto-xref"><span>Chapter 7</span></a>. There is no consensus on methods for deciding how many clusters are needed to describe data in the absence of contiguous biological information. However, making hierarchical clusters of the <em>strong forms</em> is a method that has the advantage of allowing the user to decide how far down to cut the hierarchical tree and be careful not to cut in places where these inner branches are short. See the vignette of <strong><a href="https://bioconductor.org/packages/clusterExperiment/">clusterExperiment</a></strong> for an application to single cell RNA experimental data.</p>
<p>In analyzing the Hiiragi data, we used cluster probabilities, a concept already mentioned in <a href="04-chap.html" class="quarto-xref"><span>Chapter 4</span></a>, where the EM algorithm used them as weights to compute expected value statistics. The notion of probabilistic clustering is well-developed in the Bayesian nonparametric mixture framework, which enriches the mixture models we covered in <a href="04-chap.html" class="quarto-xref"><span>Chapter 4</span></a> to more general settings. See <span class="citation" data-cites="Dundar2014">Dundar et al. (<a href="16-chap.html#ref-Dundar2014" role="doc-biblioref">2014</a>)</span> for a real example using this framework for flow cytometry. In the denoising and assignment of high-throughput sequencing reads to specific strains of bacteria or viruses, clustering is essential. In the presence of noise, clustering into groups of <em>true</em> strains of very unequal sizes can be challenging. Using the data to create a noise model enables both denoising and cluster assignment concurrently. Denoising algorithms such as those by <span class="citation" data-cites="Rosen:2012">Rosen et al. (<a href="16-chap.html#ref-Rosen:2012" role="doc-biblioref">2012</a>)</span> or <span class="citation" data-cites="dada2">Benjamin J. Callahan et al. (<a href="16-chap.html#ref-dada2" role="doc-biblioref">2016</a>)</span> use an iterative workflow inspired by the EM method <span class="citation" data-cites="mclachlan2007algorithm">(<a href="16-chap.html#ref-mclachlan2007algorithm" role="doc-biblioref">McLachlan and Krishnan 2007</a>)</span>.</p>
</section>
<section id="exercises" class="level2 page-columns page-full" data-number="5.11">
<h2 data-number="5.11" class="anchored" data-anchor-id="exercises"><span class="header-section-number">5.11</span> Exercises</h2>
<div id="imp-clustering-SilhouetteIndex" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;5.1
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can define the average dissimilarity of a point <span class="math inline">\(x_i\)</span> to a cluster <span class="math inline">\(C_k\)</span> as the average of the distances from <span class="math inline">\(x_i\)</span> to all points in <span class="math inline">\(C_k\)</span>. Let <span class="math inline">\(A(i)\)</span> be the average dissimilarity of all points in the cluster that <span class="math inline">\(x_i\)</span> belongs to. Let <span class="math inline">\(B(i)\)</span> be the lowest average dissimilarity of <span class="math inline">\(x_i\)</span> to any other cluster of which <span class="math inline">\(x_i\)</span> is not a member. The cluster with this lowest average dissimilarity is said to be the <strong>neighboring cluster</strong> of <span class="math inline">\(x_i\)</span>, because it is the next best fit cluster for point <span class="math inline">\(x_i\)</span>. The <strong>silhouette index</strong> is</p>
<p><span class="math display">\[
S(i)=\frac{B(i)-A(i)}{\max_i(A(i),B(i))}.
\]</span></p>
<p>Compute the silhouette index for the <code>simdat</code> data we simulated in <a href="#sec-clustervalidation" class="quarto-xref"><span>Section 5.7</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"cluster"</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>pam4 <span class="ot">=</span> <span class="fu">pam</span>(simdatxy, <span class="dv">4</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>sil <span class="ot">=</span> <span class="fu">silhouette</span>(pam4, <span class="dv">4</span>)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sil, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"green"</span>,<span class="st">"blue"</span>,<span class="st">"purple"</span>), <span class="at">main=</span><span class="st">"Silhouette"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Change the number of clusters <span class="math inline">\(k\)</span> and assess which <span class="math inline">\(k\)</span> gives the best silhouette index.</p>
<p>Now, repeat this for groups that have uniform (unclustered) data distributions over a whole range of values.</p>
</div>
</div>
<div id="imp-clustering-EcoHeatmap" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;5.2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Make a “character” representation of the distance between the 20 locations in the <code>dune</code> data from the <strong><a href="https://cran.r-project.org/web/packages/vegan/">vegan</a></strong> package using the function <code>symnum</code>.</p>
<p>Make a heatmap plot of these distances.</p>
</div>
</div>
<!-- TODO: solution hidden in the online book? 
::: {.callout-tip collapse="true"}





:::
-->
<div id="imp-clustering-SpiralClusters" class="callout callout-style-default callout-important no-icon callout-titled page-columns page-full">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;5.3
</div>
</div>
<div class="callout-body-container callout-body page-columns page-full">
<p>Load the <code>spirals</code> data from the <strong><a href="https://cran.r-project.org/web/packages/kernlab/">kernlab</a></strong> package. Plot the results of using <span class="math inline">\(k\)</span>-means on the data. This should give you something similar to <a href="#fig-kmeanspital1" class="quarto-xref">Figure&nbsp;<span>5.35</span></a>.</p>
<div class="cell page-columns page-full" data-layout-nrow="1" data-layout-align="center" data-fig-cap-location="margin">
<div id="fig-kmeanspital1" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-kmeanspital1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-kmeanspital1" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-kmeanspital1-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="320" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-kmeanspital1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-kmeanspital1-1.png" class="lightbox" data-gallery="fig-kmeanspital1" title="Figure&nbsp;5.35&nbsp;(a): "><img src="05-chap_files/figure-html/fig-kmeanspital1-1.png" id="fig-kmeanspital1-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-kmeanspital1" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-kmeanspital1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-kmeanspital1" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-kmeanspital1-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="320" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-kmeanspital1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-kmeanspital1-2.png" class="lightbox" data-gallery="fig-kmeanspital1" title="Figure&nbsp;5.35&nbsp;(b): "><img src="05-chap_files/figure-html/fig-kmeanspital1-2.png" id="fig-kmeanspital1-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-kmeanspital1" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-kmeanspital1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-kmeanspital1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.35: An example of non-convex clusters. In (a), we show the result of <span class="math inline">\(k\)</span>-means clustering with <span class="math inline">\(k=2\)</span>. In (b), we have the output from <code>dbscan</code>. The colors represent the three clusters found by the algorithm for the settings .
</figcaption>
</figure>
</div>
</div>
<p>You’ll notice that the clustering in <a href="#fig-kmeanspital1" class="quarto-xref">Figure&nbsp;<span>5.35</span></a> seems unsatisfactory. Show how a different method, such as <code>specc</code> or <code>dbscan</code>, could cluster <code>spirals</code> data in a more useful manner.</p>
<p>Repeat the <code>dbscan</code> clustering with different parameters. How robust is the number of groups?</p>
</div>
</div>
<div id="imp-clustering-maps" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;5.4
</div>
</div>
<div class="callout-body-container callout-body">
<p>Looking at graphical representations in simple two-dimensional maps can often reveal important clumping patterns. We saw an example for this with the map that enabled Snow to discover the source of the London cholera outbreak. Such clusterings can often indicate important information about hidden variables acting on the observations. Look at a map for breast cancer incidence in the US at:<br>
<a href="http://www.huffingtonpost.com/bill-davenhall/post_1663_b_817254.html" class="uri">http://www.huffingtonpost.com/bill-davenhall/post_1663_b_817254.html</a> <span class="citation" data-cites="mandal2009">(<a href="16-chap.html#ref-mandal2009" role="doc-biblioref">Mandal et al. 2009</a>)</span>; the areas of high incidence seem spatially clustered. Can you guess the reason(s) for this clustering and high incidence rates on the West and East coasts and around Chicago?</p>
</div>
</div>
<div id="imp-clustering-dada2" class="callout callout-style-default callout-important no-icon callout-titled page-columns page-full">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;5.5
</div>
</div>
<div class="callout-body-container callout-body page-columns page-full">
<p><strong>Amplicon bioinformatics: from raw reads to dereplicated sequences</strong>. As a supplementary exercise, we provide the intermediate steps necessary to a full data preprocessing workflow for denoising 16S rRNA sequences. We start by setting the directories and loading the downloaded data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>base_dir <span class="ot">=</span> <span class="st">"../data"</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>miseq_path <span class="ot">=</span> <span class="fu">file.path</span>(base_dir, <span class="st">"MiSeq_SOP"</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>filt_path <span class="ot">=</span> <span class="fu">file.path</span>(miseq_path, <span class="st">"filtered"</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>fnFs <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(miseq_path, <span class="at">pattern=</span><span class="st">"_R1_001.fastq"</span>))</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>fnRs <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(miseq_path, <span class="at">pattern=</span><span class="st">"_R2_001.fastq"</span>))</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>sampleNames <span class="ot">=</span> <span class="fu">sapply</span>(<span class="fu">strsplit</span>(fnFs, <span class="st">"_"</span>), <span class="st">`</span><span class="at">[</span><span class="st">`</span>, <span class="dv">1</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file_test</span>(<span class="st">"-d"</span>, filt_path)) <span class="fu">dir.create</span>(filt_path)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>filtFs <span class="ot">=</span> <span class="fu">file.path</span>(filt_path, <span class="fu">paste0</span>(sampleNames, <span class="st">"_F_filt.fastq.gz"</span>))</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>filtRs <span class="ot">=</span> <span class="fu">file.path</span>(filt_path, <span class="fu">paste0</span>(sampleNames, <span class="st">"_R_filt.fastq.gz"</span>))</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>fnFs <span class="ot">=</span> <span class="fu">file.path</span>(miseq_path, fnFs)</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>fnRs <span class="ot">=</span> <span class="fu">file.path</span>(miseq_path, fnRs)</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">length</span>(fnFs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20</code></pre>
</div>
</div>
<p>The data are highly-overlapping Illumina Miseq <span class="math inline">\(2\times 250\)</span> amplicon sequences from the V4 region of the 16S rRNA gene <span class="citation" data-cites="Kozich2013">(<a href="16-chap.html#ref-Kozich2013" role="doc-biblioref">Kozich et al. 2013</a>)</span>. There were originally 360 fecal samples collected longitudinally from 12 mice over the first year of life. These were collected by <span class="citation" data-cites="schloss2012stabilization">P. D. Schloss et al. (<a href="16-chap.html#ref-schloss2012stabilization" role="doc-biblioref">2012</a>)</span> to investigate the development and stabilization of the murine microbiome. We have selected 20 samples to illustrate how to preprocess the data.</p>
<p>We will need to filter out low-quality reads and trim them to a consistent length. While generally recommended filtering and trimming parameters serve as a starting point, no two datasets are identical and therefore it is always worth inspecting the quality of the data before proceeding. We show the sequence quality plots for the two first samples in <a href="#fig-profile-1" class="quarto-xref">Figure&nbsp;<span>5.36</span></a>. They are generated by:</p>
<div class="cell page-columns page-full" data-layout-nrow="1" data-layout-align="center" data-fid-width="4" data-fig-cap-location="margin">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQualityProfile</span>(fnFs[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Forward"</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQualityProfile</span>(fnRs[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Reverse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-profile-1" class="quarto-layout-panel page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-profile-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-profile-1" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-profile-1-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="320" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-profile-1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-profile-1-1.png" class="lightbox" data-gallery="fig-profile-1" title="Figure&nbsp;5.36&nbsp;(a): "><img src="05-chap_files/figure-html/fig-profile-1-1.png" id="fig-profile-1-1" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-profile-1" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-profile-1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-profile-1" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-profile-1-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="320" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-profile-1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="05-chap_files/figure-html/fig-profile-1-2.png" class="lightbox" data-gallery="fig-profile-1" title="Figure&nbsp;5.36&nbsp;(b): "><img src="05-chap_files/figure-html/fig-profile-1-2.png" id="fig-profile-1-2" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" data-ref-parent="fig-profile-1" width="320"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-profile-1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-profile-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.36: Quality scores. The lines show positional summary statistics: green is the mean, orange is the median, and the dashed orange lines are the 25th and 75th quantiles.
</figcaption>
</figure>
</div>
</div>
<p>Note that we also see the background distribution of quality scores at each position in <a href="#fig-profile-1" class="quarto-xref">Figure&nbsp;<span>5.36</span></a> as a grey-scale heat map. The dark colors correspond to higher frequency.</p>
</div>
</div>
<div id="imp-clustering-qualityplots" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;5.6
</div>
</div>
<div class="callout-body-container callout-body">
<p>Generate similar plots for four randomly selected sets of forward and reverse reads. Compare forward and reverse read qualities; what do you notice?</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-41-contents" aria-controls="callout-41" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-41" class="callout-41-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center" data-warning.known="is deprecated. please use">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>ii <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">length</span>(fnFs), <span class="dv">4</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQualityProfile</span>(fnFs[ii]) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Forward"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQualityProfile</span>(fnRs[ii]) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Reverse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div id="imp-clustering-dada3" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;5.7
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here, the forward reads maintain high quality throughout, while the quality of the reverse reads drops significantly at about position 160. Therefore, we truncate the forward reads at position 240, and trimm the first 10 nucleotides as these positions are of lower quality. The reverse reads are trimmed at position 160. Combine these trimming parameters with standard filtering parameters remember to enforce a maximum of 2 expected errors per-read. (Hint: Trim and filter on paired reads jointly, i.e., both reads must pass the filter for the pair to pass. The input arguments should be chosen following the <strong><a href="https://bioconductor.org/packages/dada2/">dada2</a></strong> vignette carefully. We recommend filtering out all reads with any ambiguous nucleotides.)</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-43-contents" aria-controls="callout-43" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-43" class="callout-43-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Most Illumina sequencing data show a trend of decreasing quality towards the end of the reads.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">filterAndTrim</span>(fnFs, filtFs, fnRs, filtRs, <span class="at">truncLen=</span><span class="fu">c</span>(<span class="dv">240</span>,<span class="dv">160</span>),</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">maxN=</span><span class="dv">0</span>, <span class="at">maxEE=</span><span class="dv">2</span>, <span class="at">truncQ=</span><span class="dv">2</span>, <span class="at">rm.phix=</span><span class="cn">TRUE</span>,  <span class="at">trimLeft=</span><span class="dv">10</span>,</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">compress=</span><span class="cn">TRUE</span>, <span class="at">multithread=</span><span class="cn">TRUE</span>) <span class="co"># On Windows set multithread=FALSE</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                              reads.in reads.out
F3D0_S188_L001_R1_001.fastq       7793      7139
F3D1_S189_L001_R1_001.fastq       5869      5314
F3D141_S207_L001_R1_001.fastq     5958      5478
F3D142_S208_L001_R1_001.fastq     3183      2926
F3D143_S209_L001_R1_001.fastq     3178      2955
F3D144_S210_L001_R1_001.fastq     4827      4323</code></pre>
</div>
</div>
<p>The <code>maxN</code> parameter omits all reads with more than <code>maxN = 0</code> ambiguous nucleotides and <code>maxEE</code> at 2 excludes reads with more than 2 expected errors.</p>
<p>The sequence data was imported into R from demultiplexed <em>fastq</em> files (i.e.&nbsp;one <em>fastq</em> for each sample) and simultaneously dereplicated to remove redundancy. Name the resulting objects by their sample provenance; they will have <em>derep</em> as their class.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>derepFs <span class="ot">=</span> <span class="fu">derepFastq</span>(filtFs, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>derepRs <span class="ot">=</span> <span class="fu">derepFastq</span>(filtRs, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(derepFs) <span class="ot">=</span> sampleNames</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(derepRs) <span class="ot">=</span> sampleNames</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div id="imp-clustering-blitzbombs" class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise&nbsp;5.8
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use R to create a map like the one shown in <a href="#fig-bombings" class="quarto-xref">Figure&nbsp;<span>5.2</span></a>. Hint: go to the <a href="http://bombsight.org">website of the British National Archives</a> and download street addresses of hits, use an address resolution service to convert these into geographic coordinates, and display these as points on a map of London.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-45-contents" aria-controls="callout-45" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-45" class="callout-45-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>See the Gist <a href="https://gist.github.com/wolfganghuber/523622aff6a156d26e77a87ccbe7bd0d" class="uri">https://gist.github.com/wolfganghuber/523622aff6a156d26e77a87ccbe7bd0d</a> by Andrzej Oles.</p>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Aure2017" class="csl-entry" role="listitem">
Aure, Miriam Ragle, Valeria Vitelli, Sandra Jernström, Surendra Kumar, Marit Krohn, Eldri U Due, Tonje Husby Haukaas, et al. 2017. <span>“Integrative Clustering Reveals a Novel Split in the Luminal <span>A</span> Subtype of Breast Cancer with Impact on Outcome.”</span> <em>Breast Cancer Research</em> 19 (1): 44.
</div>
<div id="ref-BendallCell" class="csl-entry" role="listitem">
Bendall, Sean C, Garry P Nolan, Mario Roederer, and Pratip K Chattopadhyay. 2012. <span>“A Deep Profiler’s Guide to Cytometry.”</span> <em>Trends in Immunology</em> 33 (7): 323–32.
</div>
<div id="ref-Callahan2016Bioc" class="csl-entry" role="listitem">
Callahan, Ben J, Kris Sankaran, Julia A Fukuyama, Paul J McMurdie, and Susan P Holmes. 2016. <span>“Bioconductor Workflow for Microbiome Data Analysis: From Raw Reads to Community Analyses.”</span> <em>F1000Research</em> 5.
</div>
<div id="ref-Callahan:2017" class="csl-entry" role="listitem">
Callahan, Benjamin J, Paul J McMurdie, and Susan P Holmes. 2017. <span>“Exact Sequence Variants Should Replace Operational Taxonomic Units in Marker Gene Data Analysis.”</span> <em>ISME Journal</em>, 1–5.
</div>
<div id="ref-dada2" class="csl-entry" role="listitem">
Callahan, Benjamin J, Paul J McMurdie, Michael J Rosen, Andrew W Han, Amy J Johnson, and Susan P Holmes. 2016. <span>“<span>DADA2</span>: <span>H</span>igh Resolution Sample Inference from Amplicon Data.”</span> <em>Nature Methods</em>, 1–4.
</div>
<div id="ref-caporaso2010qiime" class="csl-entry" role="listitem">
Caporaso, J. G., J. Kuczynski, J. Stombaugh, K. Bittinger, F. D. Bushman, E. K. Costello, N. Fierer, et al. 2010. <span>“QIIME Allows Analysis of High-Throughput Community Sequencing Data.”</span> <em>Nature Methods</em> 7 (5): 335–36.
</div>
<div id="ref-distory-paper" class="csl-entry" role="listitem">
Chakerian, John, and Susan Holmes. 2012. <span>“Computational Tools for Evaluating Phylogenetic and Hierarchical Clustering Trees.”</span> <em>Journal of Computational and Graphical Statistics</em> 21 (3): 581–99.
</div>
<div id="ref-Diday1989" class="csl-entry" role="listitem">
Diday, Edwin, and M Paula Brito. 1989. <span>“Symbolic Cluster Analysis.”</span> In <em>Conceptual and Numerical Analysis of Data</em>, 45–84. Springer.
</div>
<div id="ref-Dundar2014" class="csl-entry" role="listitem">
Dundar, Murat, Ferit Akova, Halid Z. Yerebakan, and Bartek Rajwa. 2014. <span>“A Non-Parametric <span>B</span>ayesian Model for Joint Cell Clustering and Cluster Matching: Identification of Anomalous Sample Phenotypes with Random Effects.”</span> <em>BMC Bioinformatics</em> 15 (1): 1–15. <a href="https://doi.org/10.1186/1471-2105-15-314">https://doi.org/10.1186/1471-2105-15-314</a>.
</div>
<div id="ref-freedman1991" class="csl-entry" role="listitem">
Freedman, David A. 1991. <span>“Statistical Models and Shoe Leather.”</span> <em>Sociological Methodology</em> 21 (2): 291–313.
</div>
<div id="ref-Hallett2012" class="csl-entry" role="listitem">
Hallett, Robin M, Anna Dvorkin-Gheva, Anita Bane, and John A Hassell. 2012. <span>“A Gene Signature for Predicting Outcome in Patients with Basal-Like Breast Cancer.”</span> <em>Scientific Reports</em> 2.
</div>
<div id="ref-holmes2005memory" class="csl-entry" role="listitem">
Holmes, Susan, Michael He, Tong Xu, and Peter P Lee. 2005. <span>“Memory t Cells Have Gene Expression Patterns Intermediate Between Naive and Effector.”</span> <em>PNAS</em> 102 (15): 5519–23.
</div>
<div id="ref-Hornik2005" class="csl-entry" role="listitem">
Hornik, Kurt. 2005. <span>“A <span>CLUE</span> for <span>CLU</span>ster <span>E</span>nsembles.”</span> <em>Journal of Statistical Software</em> 14 (12).
</div>
<div id="ref-flowsort" class="csl-entry" role="listitem">
Hulett, Henry R, William A Bonner, Janet Barrett, and Leonard A Herzenberg. 1969. <span>“Cell Sorting: Automated Separation of Mammalian Cells as a Function of Intracellular Fluorescence.”</span> <em>Science</em> 166 (3906): 747–49.
</div>
<div id="ref-kahneman2011" class="csl-entry" role="listitem">
Kahneman, Daniel. 2011. <em>Thinking, Fast and Slow</em>. Macmillan.
</div>
<div id="ref-Kaufman2009" class="csl-entry" role="listitem">
Kaufman, Leonard, and Peter J Rousseeuw. 2009. <em>Finding Groups in Data: An Introduction to Cluster Analysis</em>. Vol. 344. John Wiley &amp; Sons.
</div>
<div id="ref-Kozich2013" class="csl-entry" role="listitem">
Kozich, James J, Sarah L Westcott, Nielson T Baxter, Sarah K Highlander, and Patrick D Schloss. 2013. <span>“Development of a Dual-Index Sequencing Strategy and Curation Pipeline for Analyzing Amplicon Sequence Data on the MiSeq Illumina Sequencing Platform.”</span> <em>Applied and Environmental Microbiology</em> 79 (17): 5112–20.
</div>
<div id="ref-mandal2009" class="csl-entry" role="listitem">
Mandal, Rakesh, Sophie St-Hilaire, John G Kie, and DeWayne Derryberry. 2009. <span>“Spatial Trends of Breast and Prostate Cancers in the United States Between 2000 and 2005.”</span> <em>International Journal of Health Geographics</em> 8 (1): 53.
</div>
<div id="ref-mclachlan2007algorithm" class="csl-entry" role="listitem">
McLachlan, Geoffrey, and Thriyambakam Krishnan. 2007. <em>The <span>EM</span> Algorithm and Extensions</em>. Vol. 382. John Wiley &amp; Sons.
</div>
<div id="ref-Mullner:2013" class="csl-entry" role="listitem">
Müllner, Daniel. 2013. <span>“Fastcluster: Fast Hierarchical, Agglomerative Clustering Routines for r and Python.”</span> <em>Journal of Statistical Software</em> 53 (9): 1–18.
</div>
<div id="ref-oneill2013flow" class="csl-entry" role="listitem">
O’Neill, Kieran, Nima Aghaeepour, Josef Špidlen, and Ryan Brinkman. 2013. <span>“Flow Cytometry Bioinformatics.”</span> <em>PLoS Computational Biology</em> 9 (12): e1003365.
</div>
<div id="ref-Ohnishi2014" class="csl-entry" role="listitem">
Ohnishi, Y., W. Huber, A. Tsumura, M. Kang, P. Xenopoulos, K. Kurimoto, A. K. Oles, et al. 2014. <span>“Cell-to-Cell Expression Variability Followed by Signal Reinforcement Progressively Segregates Early Mouse Lineages.”</span> <em>Nature Cell Biology</em> 16 (1): 27–37.
</div>
<div id="ref-Rosen:2012" class="csl-entry" role="listitem">
Rosen, Michael J, Benjamin J Callahan, Daniel S Fisher, and Susan P Holmes. 2012. <span>“Denoising <span>PCR</span>-Amplified Metagenome Data.”</span> <em>BMC <span>B</span>ioinformatics</em> 13 (1): 283.
</div>
<div id="ref-mothur" class="csl-entry" role="listitem">
Schloss, P D, S L Westcott, T Ryabin, J R Hall, M Hartmann, E B Hollister, R A Lesniewski, et al. 2009. <span>“<span class="nocase">Introducing mothur: Open-Source, Platform-Independent, Community-Supported Software for Describing and Comparing Microbial Communities</span>.”</span> <em>Applied and Environmental Microbiology</em> 75 (23): 7537–41.
</div>
<div id="ref-schloss2012stabilization" class="csl-entry" role="listitem">
Schloss, P. D., A. M. Schuber, J. P. Zackular, K. D. Iverson, Young V. B., and Petrosino J. F. 2012. <span>“Stabilization of the Murine Gut Microbiome Following Weaning.”</span> <em>Gut Microbes</em> 3 (4): 383–93.
</div>
<div id="ref-gap2001" class="csl-entry" role="listitem">
Tibshirani, Robert, Guenther Walther, and Trevor Hastie. 2001. <span>“Estimating the Number of Clusters in a Data Set via the Gap Statistic.”</span> <em>JRSSB</em> 63 (2): 411–23.
</div>
<div id="ref-Tseng:2005" class="csl-entry" role="listitem">
Tseng, George C, and Wing H Wong. 2005. <span>“Tight Clustering: A Resampling-Based Approach for Identifying Stable and Tight Patterns in Data.”</span> <em>Biometrics</em> 61 (1): 10–16.
</div>
<div id="ref-tversky1974heuristics" class="csl-entry" role="listitem">
Tversky, Amos, and Daniel Kahneman. 1974. <span>“Heuristics and Biases: Judgement Under Uncertainty.”</span> <em>Science</em> 185: 1124–30.
</div>
<div id="ref-tversky1975judgment" class="csl-entry" role="listitem">
———. 1975. <span>“Judgment Under Uncertainty: Heuristics and Biases.”</span> In <em>Utility, Probability, and Human Decision Making</em>, 141–62. Springer.
</div>
</div>
</section>


<p>Page built at 01:33 on 2025-09-01 using R version 4.5.1 (2025-06-13)</p></main> <!-- /main --></p><p class="build-date">
Support for maintaining the online version of this book is provided by <a href="http://www.denbi.de">de.NBI</a>
  <img src="imgs/denbi.png" style="vertical-align: text-top;height: 16px"><br>
For website support please contact msmith@embl.de
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
  const anchorJS_eq = new window.AnchorJS();
  anchorJS_eq.options = {
    placement: 'left',
    class: 'eq-link',
    icon: icon
  };
  anchorJS_eq.add('.anchored-eq');
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/www\.huber\.embl\.de\/msmb");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>
